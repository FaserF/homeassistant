- id: turn_off_everything_if_nobody_is_at_home
  alias: "Turn off everything if nobody is at home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "home"
      to: "not_home"
      for:
        minutes: 1
  condition:
    condition: not
    conditions:
      - condition: state
        entity_id: person.fabian
        state: home
  action:
    - service: light.turn_off
      target:
        entity_id: all
    - service: switch.turn_off
      data:
        entity_id:
          #- switch.bett_usb_ports
          - switch.fernseher
          - switch.lautsprecher
    - service: media_player.turn_off
      data:
        entity_id: all
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_pc
              state: "home"
            - condition: numeric_state
              entity_id: sensor.fabian_schreibtisch_power
              above: 20
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Keiner ist mehr zu Hause! Fabian-PC ist allerdings noch an!"
                data:
                  inline_keyboard:
                    - "Herunterfahren:/shutdownfpc, Ruhezustand:/hibernatefpc"
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_pc
              state: "not_home"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.fabian_pc_strom
    - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: template
              value_template: "{{state_attr('sensor.weather_ebersberg_daily', 'forecast')[0]['temperature'] | int <= 10 }}"
            - condition: template
              value_template: "{{state_attr('sensor.weather_ebersberg_daily', 'forecast')[0]['temperature'] | int >= 28 }}"
          sequence:
            - service: cover.close_cover
              target:
                entity_id: all

- id: Automations if coming home
  alias: "Automations if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "not_home"
      to: "home"
    - platform: state
      entity_id: person.samuel
      from: "not_home"
      to: "home"
  #condition:
  #  condition: template
  #  value_template: "{{ trigger.from_state.last_changed > utcnow() - timedelta(minutes=4) }}"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.abwesend_modus
    - service: automation.trigger
      entity_id: automation.set_climate_at_night
    - choose:
        - conditions:
            - condition: sun
              after: sunset
            - condition: time
              before: "23:59:00"
            - condition: or
              conditions:
                - condition: or
                  conditions:
                    - condition: time
                      after: "22:00:00"
                    - condition: state
                      entity_id: binary_sensor.workday_sensor
                      state: "off"
                - condition: state
                  entity_id: binary_sensor.workday_sensor
                  state: "on"
          sequence:
            #- choose:
            #    - conditions:
            #        - condition: state
            #          entity_id: person.samuel
            #          state: "home"
            #        - condition: template
            #          value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) }}"
            #      sequence:
            #        - service: light.turn_on
            #          data:
            #            entity_id: light.lampe_samuel
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "home"
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: light.turn_on
                      data:
                        entity_id: light.yeelink_bslamp2_22e2_light
    - choose:
        - conditions:
            - condition: sun
              before: sunset
            - condition: sun
              after: sunrise
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: time
                      after: "07:30:00"
                    - condition: state
                      entity_id: binary_sensor.workday_sensor
                      state: "on"
                - condition: and
                  conditions:
                    - condition: time
                      after: "11:00:00"
                    - condition: state
                      entity_id: binary_sensor.workday_sensor
                      state: "off"
          sequence:
            - choose:
                - conditions:
                    - condition: numeric_state
                      entity_id: sensor.weather_ebersberg_hourly
                      attribute: temperature
                      above: 22
                  sequence:
                    - service: cover.set_cover_position
                      target:
                        entity_id: all
                      data:
                        position: 70
              default:
                - service: cover.open_cover
                  target:
                    entity_id: all
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
            - condition: numeric_state
              entity_id: sensor.smart_life_samuel_distance
              below: 100
            - condition: state
              entity_id: person.fabian
              state: "home"
            - condition: template
              value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_send_daily_weather_forecast_fabian.attributes.last_triggered) | int > 3600 }}"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Welcome back. Samuel ist nicht daheim."
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.vacuum_water_level
              below: 1
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: notify.telegram_fabian
                      data:
                        message: "Der Wassertank des Staubsaugroboters sollte zeitnah aufgef√ºllt werden."
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.samuel
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) }}"
                  sequence:
                    - service: notify.telegram_fabian
                      data:
                        message: "Der Wassertank des Staubsaugroboters sollte zeitnah aufgef√ºllt werden."
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ as_timestamp(states.automation.trigger_a_full_dust_bin_reminder.attributes.last_triggered) > as_timestamp(states.automation.telegram_dust_bin_emptied.attributes.last_triggered) }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: "Der Staubbeh√§lter des Staubsaugroboters k√∂nnte langsam voll sein und sollte geleert werden."
                        target: !secret telegram_chat_fabian
                        inline_keyboard:
                          - "Erledigt:/telegramdustbindone"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ (state_attr('sensor.nachste_abholungen', (now() + timedelta(days=1)).strftime('%Y-%m-%d')) != None) }}"
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_waste_put_outside.attributes.last_triggered) | int > 86400 }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: >
                          {% set tomorrow = (now() + timedelta(days=1)).strftime('%Y-%m-%d') %}
                          {% set pickup = state_attr('sensor.nachste_abholungen', tomorrow) %}
                          {% set weekdays = {'Monday': 'Montag', 'Tuesday': 'Dienstag', 'Wednesday': 'Mittwoch', 'Thursday': 'Donnerstag', 'Friday': 'Freitag', 'Saturday': 'Samstag', 'Sunday': 'Sonntag'} %}
                          {% set day_name = weekdays[strptime(tomorrow, '%Y-%m-%d').strftime('%A')] %}
                          {% set date_german = as_timestamp(tomorrow) | timestamp_custom('%d.%m.%Y') %}
                          {% set verb = 'werden' if ',' in pickup or ' und ' in pickup else 'wird' %}
                          {% set items = pickup | replace('Restm√ºll', 'üóëÔ∏è *Restm√ºll*')
                                                | replace('Biotonne', 'üåø *Biotonne*')
                                                | replace('Gelber Sack', '‚ôªÔ∏è *Gelber Sack*')
                                                | replace('Altpapier', 'üìÑ *Altpapier*')
                                                | replace('Papiersamml', 'üìÑ *Papiersammlung*')
                                                | replace('Problemm√ºll', '‚ö†Ô∏è *Problemm√ºll*')
                                                | replace('Gartenabfall', 'üçÇ *Gartenabfall*') %}
                          üì£ {{ day_name }}, {{ date_german }} (morgen) {{ verb }} {{ items }} abgeholt. Bitte rechtzeitig rausstellen! üöõ
                        target: !secret telegram_chat_fabian
                        inline_keyboard:
                          - "Erledigt:/telegramwastedone"
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ as_timestamp(states.automation.telegram_washer_emptied.attributes.last_triggered) < as_timestamp(states.automation.set_washing_machine_clean_when_power_drops.attributes.last_triggered) }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: Die Waschmaschine muss noch ausger√§umt werden.
                        target: !secret telegram_chat_fabian
                        inline_keyboard:
                          - "Erledigt:/telegramwasherdone"
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.samuel
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: Die Waschmaschine muss noch ausger√§umt werden.
                        target: !secret telegram_chat_samuel_dummy
                        inline_keyboard:
                          - "Erledigt:/telegramwasherdone"
    #- choose:
    #    - conditions:
    #        - condition: template
    #          value_template: "{{ as_timestamp(states.automation.telegram_pouring_done.attributes.last_triggered) < as_timestamp(states.automation.remind_for_pouring.attributes.last_triggered) }}"
    #        - condition: template
    #          value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.automations_if_coming_home.attributes.last_triggered) | int > 10800 }}"
    #      sequence:
    #        - choose:
    #            - conditions:
    #                - condition: state
    #                  entity_id: person.fabian
    #                  state: home
    #                - condition: template
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ as_timestamp(states.automation.telegram_pouring_done.attributes.last_triggered) < as_timestamp(states.automation.remind_for_pouring.attributes.last_triggered) }}"
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.automations_if_coming_home.attributes.last_triggered) | int > 10800 }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: Bitte die Pflanzen gie√üen.
                        target: !secret telegram_chat_fabian
                        inline_keyboard:
                          - "Erledigt:/telegrampouringdone"
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.samuel
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: Bitte die Pflanzen gie√üen.
                        target: !secret telegram_chat_samuel_dummy
                        inline_keyboard:
                          - "Erledigt:/telegrampouringdone"
    - choose:
        - conditions:
            - condition: state
              entity_id: vacuum.valetudo_dreamez10pro
              state: "error"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: >
                          James hatte ein Problem: {{ states.sensor.valetudo_dreamez10pro_error_description.state }}

                          Die Reinigung wurde daher unterbrochen.
                        target: !secret telegram_chat_fabian
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.samuel
                      state: home
                    - condition: template
                      value_template: "{{ (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        message: >
                          James hatte ein Problem: {{ states.sensor.valetudo_dreamez10pro_error_description.state }}

                          Die Reinigung wurde daher unterbrochen.
                        target: !secret telegram_chat_samuel_dummy

    # - choose:
    #     - conditions:
    #         - condition: not
    #           conditions:
    #             - condition: state
    #               entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    #               state: "max"
    #       sequence:
    #         - service: select.select_option
    #           data:
    #             option: max
    #           target:
    #             entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    # - delay: "00:00:40"
    # - choose:
    #     - conditions:
    #         - condition: not
    #           conditions:
    #             - condition: state
    #               entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
    #               state: "max"
    #       sequence:
    #         - service: select.select_option
    #           data:
    #             option: max
    #           target:
    #             entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
    #  - service: switch.turn_off
    #  data:
    #  entity_id: switch.fritzbox_7490_portforward_ssh

#- id: notify_for_cod_bo6_price_drop
#  alias: "Notify on CoD Bo6 Price Drop"
#  initial_state: true
#  trigger:
#    - platform: numeric_state
#      entity_id: sensor.keyforsteam_166331
#      attribute: priceCard
#      below: 52
#  condition:
#    - condition: template
#      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_on_cod_bo6_price_drop.attributes.last_triggered) | int > 86400 }}" #86400 seconds = 7 days -> Do not trigger the automation more than once a week
#  action:
#    - service: telegram_bot.send_message
#      data:
#        message: >
#          Call of Duty Black Ops 6 {{ state_attr('sensor.keyforsteam_166331', 'edition') }} hat den Preis {{ state_attr('sensor.keyforsteam_166331', 'priceCard') }} ‚Ç¨ bei {{ state_attr('sensor.keyforsteam_166331', 'merchant') }} mit dem Code {{ state_attr('sensor.keyforsteam_166331', 'coupon') }} - Jetzt pr√ºfen: https://www.keyforsteam.de/
#        target: !secret telegram_chat_fabian

- id: sync_speaker_state_to_tv
  alias: "Sync: TV to Speaker"
  description: "Synchronizes the speaker state with the TV state."
  mode: single
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.fernseher
      # Triggers only when state changes to 'on' or 'off' (ignores attributes)
      to:
        - "on"
        - "off"
  action:
    # Uses the state of the TV (on/off) to determine the service call
    - service: "switch.turn_{{ trigger.to_state.state }}"
      target:
        entity_id: switch.lautsprecher

- id: open_door_for_fabian
  alias: "Open the door for Fabian if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "not_home"
      to: "home"
    - platform: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      below: 1700
      for:
        seconds: 5
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: Volleyball
        - condition: state
          entity_id: person.fabian
          state: Einkaufen
        - condition: state
          entity_id: device_tracker.pixel_8_pro
          state: home
        - condition: numeric_state
          entity_id: person.fabian
          attribute: gps_accuracy
          above: 500
    - condition: or
      conditions:
        - condition: numeric_state
          entity_id: sensor.smart_life_fabian_distance
          below: 300
        - condition: not
          conditions:
            - condition: state
              entity_id: sensor.smart_life_fabian_direction_of_travel
              state: "away_from"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 300 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_samuel_if_coming_home.attributes.last_triggered) | int > 180 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    # - service: telegram_bot.send_message
    #   data:
    #     target: !secret telegram_chat_fabian
    #     message: "Gartentor wurde automatisch ge√∂ffnet, da du gleich daheim bist."

- id: open_door_for_samuel
  alias: "Open the door for samuel if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.samuel
      from: "not_home"
      to: "home"
    - platform: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 1700
      for:
        seconds: 2
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: device_tracker.redmi_note_10_pro
          state: home
        - condition: state
          entity_id: person.samuel
          state: Volleyball
        - condition: state
          entity_id: person.samuel
          state: Einkaufen
        - condition: numeric_state
          entity_id: person.samuel
          attribute: gps_accuracy
          above: 500
    - condition: or
      conditions:
        - condition: numeric_state
          entity_id: sensor.smart_life_samuel_distance
          below: 300
        - condition: not
          conditions:
            - condition: state
              entity_id: sensor.smart_life_samuel_direction_of_travel
              state: "away_from"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_samuel_if_coming_home.attributes.last_triggered) | int > 300 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss

- id: remind_for_bouldering_parking_fabian
  alias: "Remind for bouldering parking (Fabian)"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      to: "Boulderwelt M√ºnchen S√ºd"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_bouldering_parking_fabian.attributes.last_triggered) | int > 18000 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: >
          Denk an den [Check-In zum parken](https://www.boulderwelt-muenchen-sued.de/neue-parkplatz-dauer-regelungen/)

- id: remind_for_bouldering_parking_kai
  alias: "Remind for bouldering parking (Kai)"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.kai
      to: "Boulderwelt M√ºnchen S√ºd"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_bouldering_parking_kai.attributes.last_triggered) | int > 18000 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_kai
        message: >
          Denk an den [Check-In zum parken](https://www.boulderwelt-muenchen-sued.de/neue-parkplatz-dauer-regelungen/)

- id: remind_for_bouldering_parking_adrian
  alias: "Remind for bouldering parking (Adrian)"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.adrian
      to: "Boulderwelt M√ºnchen S√ºd"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_bouldering_parking_adrian.attributes.last_triggered) | int > 18000 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_adrian
        message: >
          Denk an den [Check-In zum parken](https://www.boulderwelt-muenchen-sued.de/neue-parkplatz-dauer-regelungen/)

#  - id: notify_if_someone_joined_lan_play_server
#    alias: Notify if someone joined lan play server
#    trigger:
#      - platform: numeric_state
#        entity_id: sensor.switch_lan_play_online
#        above: 0
#    condition:
#      - condition: template
#        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_if_someone_joined_lan_play_server.attributes.last_triggered) | int > 300 }}"
#    action:
#      - service: telegram_bot.send_message
#        data:
#          target: !secret telegram_chat_fabian
#          message: 'Jemand ist dem LAN-Play Server beigetreten. Spieleranzahl: {{ states.sensor.switch_lan_play_online.state }}'

#   - id: turn_on_ventilator_if_coming_home
#     alias: 'Turn on ventilator if coming home'
#     initial_state: true
#     trigger:
#       - platform: state
#         entity_id: person.fabian
#         from: 'not_home'
#         to: 'home'
#       - platform: state
#         entity_id: person.samuel
#         from: 'not_home'
#         to: 'home'
#     condition:
#       condition: and
#       conditions:
#         - condition: numeric_state
#           entity_id: 'sensor.weather_ebersberg_hourly'
#           attribute: temperature
#           above: 22
#         - condition: time
#           after: '12:00:00'
#           before: '21:00:00'
#     action:
#       - service: switch.turn_on
#         data:
#           entity_id: switch.ventilator

- id: turn_off_light_at_night_notify
  alias: "Turn off light at night - notify"
  initial_state: true
  trigger:
    platform: time
    at: "00:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: template
      value_template: >
        {% set domain = 'light' %}
        {% set state = 'on' %}
        {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
            - condition: template
              value_template: >
                {% set domain = 'light' %}
                {% set state = 'on' %}
                {{ states[domain] | selectattr('state','eq', state) | list | count > 1 }}
          sequence:
            - choose:
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: person.fabian
                          state: "home"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_fabian
                        message: >
                          Es sind noch nachfolgende Lichter an, diese werden in 20 Minuten ausgeschaltet, au√üer im Keller:

                          {% set lights_on = states.light | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}

                          {% for light in lights_on %}
                            - {{ light }}
                          {% endfor %}
                        inline_keyboard:
                          - "Abbruch:/cancellight, Okay:/telegramno"
            - choose:
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: person.samuel
                          state: "home"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_samuel_dummy
                        message: >
                          Es sind noch nachfolgende Lichter an, diese werden in 20 Minuten ausgeschaltet, au√üer im Keller:

                          {% set lights_on = states.light | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}

                          {% for light in lights_on %}
                            - {{ light }}
                          {% endfor %}
                        inline_keyboard:
                          - "Abbruch:/cancellight, Okay:/telegramno"
      default:
        - service: telegram_bot.send_message
          data:
            target: !secret telegram_chat_fabian
            message: >
              Es sind noch nachfolgende Lichter an, diese werden in 20 Minuten ausgeschaltet, au√üer im Keller:

              {% set lights_on = states.light | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}

              {% for light in lights_on %}
                - {{ light }}
              {% endfor %}
            inline_keyboard:
              - "Abbruch:/cancellight, Okay:/telegramno"
        - service: telegram_bot.send_message
          data:
            target: !secret telegram_chat_samuel_dummy
            message: >
              Es sind noch nachfolgende Lichter an, diese werden in 20 Minuten ausgeschaltet, au√üer im Keller:

              {% set lights_on = states.light | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}

              {% for light in lights_on %}
                - {{ light }}
              {% endfor %}
            inline_keyboard:
              - "Abbruch:/cancellight, Okay:/telegramno"

- id: turn_off_light_at_night
  alias: "Turn off light at night"
  initial_state: true
  trigger:
    platform: time
    at: "00:50:00"
  condition:
    - condition: template
      value_template: >
        {% set domain = 'light' %}
        {% set state = 'on' %}
        {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_answer_cancel_light_turn_off.attributes.last_triggered) | int > 1500 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_off_light_at_night_notify.attributes.last_triggered) | int < 1800 }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {% set domain = 'light' %}
                {% set state = 'on' %}
                {{ states[domain] | selectattr('state','eq', state) | list | count > 1 }}
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: light.turn_off
              data:
                area_id:
                  - 7c05afe47efd44f5a0a064769ad6e105 # Wohnzimmer
                  - 33e9a108bf1948e5848f156e0851d50c # Fabians Zimmer
                  - b67ac5462e454381aa87f812161d8578 # Samuels Zimmer
            - choose:
                - conditions:
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: person.fabian
                          state: "home"
                        - condition: numeric_state
                          entity_id: sensor.smart_life_fabian_distance
                          below: 100
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_fabian
                        message: "Alle Lichter (au√üer im Keller) wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
      default:
        - service: light.turn_off
          data:
            area_id:
              - 7c05afe47efd44f5a0a064769ad6e105 # Wohnzimmer
              - 33e9a108bf1948e5848f156e0851d50c # Fabians Zimmer
              - b67ac5462e454381aa87f812161d8578 # Samuels Zimmer
        - choose:
            - conditions:
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "home"
                    - condition: numeric_state
                      entity_id: sensor.smart_life_fabian_distance
                      below: 100
              sequence:
                - service: telegram_bot.send_message
                  data:
                    target: !secret telegram_chat_fabian
                    message: "Alle Lichter wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."

- id: turn_off_devices_at_night_notify
  alias: "Turn off devices at night - notify"
  initial_state: true
  trigger:
    platform: time
    at: "03:30:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "off"
    - condition: or
      conditions:
        - condition: state
          entity_id: switch.fernseher
          state: "on"
        #- condition: state
        #  entity_id: switch.kuhlschrank
        #  state: "on"
        - condition: state
          entity_id: switch.fernseher_keller
          state: "on"
        - condition: template
          value_template: >
            {% set domain = 'light' %}
            {% set state = 'on' %}
            {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 100
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: >
                  Es sind noch nachfolgende Ger√§te an, diese werden in 20 Minuten ausgeschaltet, au√üer im Keller:

                  {% set lights_on = states.light | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}
                  {% set switches_on = states.switch | selectattr('state', 'eq', 'on') | selectattr('entity_id', 'in', ['switch.fernseher', 'switch.fernseher_samuel']) | map(attribute='name') | list %}

                  {% for light in lights_on %}
                    - {{ light }}
                  {% endfor %}

                  {% for switch in switches_on %}
                    - {{ switch }} ist eingeschaltet
                  {% endfor %}
                inline_keyboard:
                  - "Abbruch:/cancellight, Okay:/telegramno"

    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 5
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: >
                  Es sind noch nachfolgende Ger√§te an, diese werden in 20 Minuten ausgeschaltet, au√üer im Keller:

                  {% set lights_on = states.light | selectattr('state', 'eq', 'on') | map(attribute='name') | list %}
                  {% set switches_on = states.switch | selectattr('state', 'eq', 'on') | selectattr('entity_id', 'in', ['switch.fernseher', 'switch.fernseher_samuel']) | map(attribute='name') | list %}

                  {% for light in lights_on %}
                    - {{ light }}
                  {% endfor %}

                  {% for switch in switches_on %}
                    - {{ switch }} ist eingeschaltet
                  {% endfor %}
                inline_keyboard:
                  - "Abbruch:/cancellight, Okay:/telegramno"

- id: turn_off_devices_at_night
  alias: "Turn off devices at night"
  initial_state: true
  trigger:
    platform: time
    at: "04:50:00"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: switch.fernseher
                  state: "on"
                #- condition: state
                #  entity_id: switch.kuhlschrank
                #  state: "on"
                - condition: state
                  entity_id: switch.fernseher_keller
                  state: "on"
                - condition: template
                  value_template: >
                    {% set domain = 'light' %}
                    {% set state = 'on' %}
                    {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_answer_cancel_light_turn_off.attributes.last_triggered) | int > 1500 }}"
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_off_devices_at_night_notify.attributes.last_triggered) | int < 1800 }}"
          sequence:
            - service: switch.turn_off
              entity_id:
                - switch.fernseher
                #- switch.kuhlschrank
                - switch.fernseher_keller
            - service: light.turn_off
              entity_id: all
            - service: media_player.turn_off
              entity_id: media_player.keller_tv
            - choose:
                - conditions:
                    - condition: or
                      conditions:
                        - condition: numeric_state
                          entity_id: sensor.smart_life_fabian_distance
                          below: 100
                        - condition: state
                          entity_id: person.fabian
                          state: "home"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_fabian
                        message: "Fernseher & Lichter wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
            - choose:
                - conditions:
                    - condition: or
                      conditions:
                        - condition: numeric_state
                          entity_id: sensor.smart_life_samuel_distance
                          below: 100
                        - condition: state
                          entity_id: person.samuel
                          state: "home"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_samuel_dummy
                        message: "Fernseher & Lichter wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.sensor.zorneding_departures_via_starnberg_nord.last_updated) | int > 16400 }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.home_assistant_core_update
                      state: "on"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_fabian
                        message: >
                          Home Assistant {{ states.update.home_assistant_core_update.attributes.latest_version }} wird nun installiert um HA neuzustarten, da DB API Verbindung verloren wurde.

                          Changelog HA: {{ states.update.home_assistant_core_update.attributes.release_url }}
                    - service: update.install
                      data:
                        entity_id: update.home_assistant_core_update
              default:
                - service: telegram_bot.send_message
                  data:
                    target: !secret telegram_chat_fabian
                    message: "Starte Homeassistant neu, da DB API Verbindung verloren wurde."
                - service: homeassistant.restart

- id: set_high_climate_in_bathroom_to_auto
  alias: "Set high climate in bathroom to auto"
  initial_state: true
  trigger:
    - platform: state
      entity_id: "climate.bad"
      to: "heat"
      for:
        minutes: 10
    - platform: state
      entity_id: "climate.bad"
      to: "heat"
      for:
        minutes: 25
  condition:
    - condition: numeric_state
      entity_id: "climate.bad"
      attribute: temperature
      above: 18
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.bad
        hvac_mode: auto

- id: set_high_climate_to_lower_value
  alias: "Set high climate to lower value"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: "climate.samuel_s_zimmer"
      attribute: temperature
      above: 20
      for:
        minutes: 15
    - platform: numeric_state
      entity_id: "climate.fabian_s_zimmer"
      attribute: temperature
      above: 20
      for:
        minutes: 15
    - platform: numeric_state
      entity_id: "climate.bad"
      attribute: temperature
      above: 20
      for:
        minutes: 8
    - platform: numeric_state
      entity_id: "climate.wohnzimmer"
      attribute: temperature
      above: 22
      for:
        minutes: 25
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.samuel_s_zimmer"
              attribute: temperature
              above: 20
            - condition: state
              entity_id: "climate.samuel_s_zimmer"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.samuel_s_zimmer
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.fabian_s_zimmer"
              attribute: temperature
              above: 20
            - condition: state
              entity_id: "climate.fabian_s_zimmer"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.fabian_s_zimmer
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.bad"
              attribute: temperature
              above: 20
            - condition: state
              entity_id: "climate.bad"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.bad
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.wohnzimmer"
              attribute: temperature
              above: 22
            - condition: state
              entity_id: "climate.wohnzimmer"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.wohnzimmer
                temperature: 20
                hvac_mode: heat

- id: set_climate_at_night
  alias: "Set climate at night"
  initial_state: true
  trigger:
    platform: time
    at: "00:50:00"
  action:
    - service: hassio.addon_stop
      data:
        addon: db21ed7f_epicgamesfree
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.thermostate_aus
              state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id:
                  - climate.wohnzimmer
                  - climate.fabian_s_zimmer
                  - climate.samuel_s_zimmer
                  - climate.bad
                hvac_mode: "auto"
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
            - condition: state
              entity_id: person.samuel
              state: "home"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.fabian_s_zimmer
                temperature: 17
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.samuel_s_zimmer
                temperature: 17
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.thermostate_aus
              state: "on"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id:
                  - climate.wohnzimmer
                  - climate.fabian_s_zimmer
                  - climate.samuel_s_zimmer
                  - climate.bad
                hvac_mode: "off"

- id: set_climate_on_weekdays
  alias: "Set climate on weekdays"
  initial_state: true
  trigger:
    - platform: time
      at: "16:15:00"
    - platform: time
      at: "21:00:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - sun
    - condition: state
      entity_id: input_boolean.thermostate_aus
      state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: "auto"

- id: set_wifi_settings_at_night
  alias: "Set wifi settings at night"
  initial_state: true
  trigger:
    - platform: time
      at: "00:00:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: state
      entity_id: switch.fernseher_keller
      state: "off"
    - condition: state
      entity_id: switch.fernseher
      state: "off"
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

# - id: set_wifi_settings_at_morning
#   alias: "Set wifi settings at morning"
#   initial_state: true
#   trigger:
#     - platform: time
#       at: "00:06:15"
#   condition:
#     - condition: time
#       weekday:
#         - mon
#         - tue
#         - wed
#         - thu
#         - fri
#   action:
#     - choose:
#         - conditions:
#             - condition: not
#               conditions:
#                 - condition: state
#                   entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
#                   state: "max"
#           sequence:
#             - service: select.select_option
#               data:
#                 option: max
#               target:
#                 entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
#     - delay: "00:01:00"
#     - choose:
#         - conditions:
#             - condition: not
#               conditions:
#                 - condition: state
#                   entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
#                   state: "max"
#           sequence:
#             - service: select.select_option
#               data:
#                 option: max
#               target:
#                 entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: remind_for_unavailable_device
  alias: "Remind for unavailable device"
  initial_state: false
  mode: single
  trigger:
    platform: time
    at: "17:10:00"
  condition:
    - condition: template
      value_template: >
        {% set relevant_domains = ['switch', 'light', 'input_button', 'climate'] %}
        {% set excluded = ['light.keller_leds_flaschen', 'light.deckenlampe_samuel', 'switch.fernseher_old', 'light.prismatik'] %}
        {% set unavailable_devices = states | selectattr('domain', 'in', relevant_domains)
          | selectattr('state', 'eq', 'unavailable')
          | rejectattr('entity_id', 'in', excluded)
          | list %}
        {{ unavailable_devices | length > 0 }}
    - condition: template
      value_template: >
        {% set last_triggered = states.automation.remind_for_unavailable_device.attributes.last_triggered %}
        {{ not last_triggered or (now() - as_datetime(last_triggered)).total_seconds() > 3200 }}
  action:
    - variables:
        excluded:
          [
            "light.keller_leds_flaschen",
            "light.deckenlampe_samuel",
            "switch.fernseher_old",
            "light.prismatik",
          ]
        unavailable_devices: >
          {{ states | selectattr('domain', 'in', relevant_domains)
            | selectattr('state', 'eq', 'unavailable')
            | rejectattr('entity_id', 'in', excluded)
            | map(attribute='entity_id') | list }}
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        disable_notification: true
        message: >
          {{ unavailable_devices | length }} Ger√§te sind nicht erreichbar, bitte pr√ºfen:

          {{ unavailable_devices | join(', ') }}

- id: activate_guest_mode_if_guest_is_here
  alias: "Activate guest mode if guest is here"
  initial_state: false
  trigger:
    - platform: time
      at: "01:00:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.activate_guest_mode_if_guest_is_here.attributes.last_triggered) | int > 86400 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: person.adri
            state: "home"
          - condition: state
            entity_id: person.kai
            state: "home"
          - condition: state
            entity_id: person.fabio
            state: "home"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.gast_modus
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "Gast Modus wuremand vermutlich √ºbernachtet. Automationen in Samuels Zimmer sind dadurch eingeschr√§nkt."
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_samuel_dummy
        message: "Gast Modus wurde aktiviert, da jemand vermutlich √ºbernachtet. Automationen in Samuels Zimmer sind dadurch eingeschr√§nkt."

- id: deactivate_guest_mode_if_no_guest_is_here
  alias: "Deactivate guest mode if no guest is here"
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.gast_modus
      to: "on"
      for:
        days: 1
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "on"
      - condition: not
        conditions:
          - condition: state
            entity_id: person.adri
            state: "home"
          - condition: state
            entity_id: person.kai
            state: "home"
          - condition: state
            entity_id: person.fabio
            state: "home"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.gast_modus
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "Gast Modus wurde deaktiviert, da niemand mehr zu Besuch ist."

- id: reactivate_adguard_protection
  alias: "Reactivate Adguard Protection"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.adguard_protection
      to: "off"
      for:
        hours: 12
    - platform: state
      entity_id: switch.adguard_filtering
      to: "off"
      for:
        hours: 12
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.adguard_protection
    - service: switch.turn_on
      data:
        entity_id: switch.adguard_filtering
    # - service: telegram_bot.send_message
    #   data_template:
    #     target: !secret telegram_chat_fabian
    #     message: "Adguard wurde wieder eingeschaltet."

- id: deactivate_silent_mode_after_12_hours
  alias: "Deactivate silent mode after 12 hours"
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.leiser_modus
      to: "on"
      for:
        hours: 12
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.leiser_modus
        state: "on"
      - condition: state
        entity_id: input_boolean.abwesend_modus
        state: "off"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "Der Leise Modus sollte deaktiviert werden, da er bereits seit 12 Stunden aktiv ist."

- id: remind_fabi_to_ventilate
  alias: "Remind Fabi to ventilate"
  initial_state: false
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "home"
      for:
        hours: 4
    - platform: state
      entity_id: device_tracker.c_pf38fwqx_pari
      to: "home"
      for:
        hours: 4
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.fabian_s_zimmer
        attribute: current_humidity
        above: 55
      - condition: time
        before: "22:00:00"
      - condition: state
        entity_id: input_boolean.leiser_modus
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.fabian_pc
            state: "home"
          - condition: state
            entity_id: device_tracker.c_pf38fwqx_pari
            state: "home"
  action:
    - service: tts.speak
      continue_on_error: true
      target:
        entity_id: tts.google_de_de
      data:
        media_player_entity_id: media_player.fabians_lautsprecher
        message: >
          Du bist nun seit 4 Stunden am PC und solltest einmal l√ºften und aufstehen.
    - service: notify.telegram_fabian
      data:
        message: "Du bist nun seit 4 Stunden am PC und solltest einmal l√ºften und aufstehen."

- id: automations_if_fpc_starts
  alias: "Automations if Fabian PC starts"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.fabian_schreibtisch
      from: "off"
      to: "on"
      for:
        seconds: 10
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.automations_if_fabian_pc_starts.attributes.last_triggered) | int > 3200 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.wohnzimmer_tv
            state: "not_home"
          - condition: state
            entity_id: switch.fernseher
            state: "off"
  action:
    - choose:
        - conditions:
            - condition: time
              after: "16:00:00"
            - condition: numeric_state
              entity_id: sensor.dwd_illuminance
              below: 2000
            - condition: numeric_state
              entity_id: sensor.fabian_s_zuhause_solar_percentage
              below: 15
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.wohnzimmer_tv
                  state: "not_home"
                - condition: state
                  entity_id: switch.fernseher
                  state: "off"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.leds_tisch
                brightness: 255
                transition: 2
            - delay: "00:04:00"
            - service: light.turn_on
              data:
                entity_id: light.prismatik
    # - choose:
    #     - conditions:
    #         - condition: numeric_state
    #           entity_id: "sensor.weather_ebersberg_hourly"
    #           attribute: temperature
    #           below: 16
    #         - condition: state
    #           entity_id: "input_boolean.thermostate_aus"
    #           state: "off"
    #         - condition: time
    #           after: "08:45:00"
    #         - condition: not
    #           conditions:
    #             - condition: state
    #               entity_id: climate.fabian_s_zimmer
    #               state: "off"
    #         - condition: or
    #           conditions:
    #             - condition: state
    #               entity_id: device_tracker.wohnzimmer_tv
    #               state: "not_home"
    #             - condition: state
    #               entity_id: switch.fernseher
    #               state: "off"
    #       sequence:
    #         - choose:
    #             - conditions:
    #                 - condition: state
    #                   entity_id: binary_sensor.fabian_s_zimmer_open_window
    #                   state: "on"
    #               sequence:
    #                 - delay: "00:25:00"
    # - service: climate.set_temperature
    #   data:
    #     entity_id: climate.fabian_s_zimmer
    #     temperature: 19
    #     hvac_mode: heat
    - choose:
        - conditions:
            - condition: time
              after: "13:30:00"
              before: "17:30:00"
            - condition: not
              conditions:
                - condition: state
                  entity_id: cover.fabians_zimmer_rollo
                  state: "closed"
                - condition: state
                  entity_id: sensor.weather_ebersberg_hourly
                  state: "rainy"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.dwd_illuminance
                  above: 15000
                - condition: numeric_state
                  entity_id: sensor.fabian_s_zuhause_solar_percentage
                  above: 50
          sequence:
            - service: cover.set_cover_position
              target:
                entity_id: cover.fabians_zimmer_rollo
              data:
                position: 62

- id: turn_off_tleds_and_climate_if_fpc_stops
  alias: "Turn off tleds and climate if fpc stops"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      from: "home"
      to: "not_home"
      for:
        minutes: 1
    - platform: state
      entity_id: device_tracker.c_pf38fwqx_pari
      from: "home"
      to: "not_home"
      for:
        minutes: 1
    - platform: numeric_state
      entity_id: sensor.fabian_schreibtisch_power
      below: 20
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.fabian_pc
        state: "not_home"
        for:
          minutes: 1
      - condition: state
        entity_id: device_tracker.c_pf38fwqx_pari
        state: "not_home"
        for:
          seconds: 20
      - condition: numeric_state
        entity_id: sensor.fabian_schreibtisch_power
        below: 20
  action:
    - service: light.turn_off
      data:
        entity_id: light.leds_tisch
    - service: media_player.volume_set
      data:
        volume_level: >
          {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
        entity_id: media_player.fabians_lautsprecher
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_boolean.thermostate_aus
                  state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.fabian_s_zimmer
                hvac_mode: "auto"

- id: turn_on_light_and_climate_if_spc_started
  alias: "Turn on light and climate if samuel pc started"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.schreibtisch_samuel
      to: "on"
      for:
        seconds: 5
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "sensor.weather_ebersberg_hourly"
              attribute: temperature
              below: 17
            - condition: state
              entity_id: "input_boolean.gast_modus"
              state: "off"
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: time
              after: "17:30:00"
            - condition: not
              conditions:
                - condition: state
                  entity_id: "climate.samuel_s_zimmer"
                  state: "off"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.samuel_s_zimmer
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "sensor.weather_ebersberg_hourly"
              attribute: temperature
              below: 17
            - condition: state
              entity_id: "input_boolean.gast_modus"
              state: "off"
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: time
              before: "17:31:00"
            - condition: not
              conditions:
                - condition: state
                  entity_id: "climate.samuel_s_zimmer"
                  state: "off"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.samuel_s_zimmer
                temperature: 19.0
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: numeric_state
                      entity_id: sensor.dwd_illuminance
                      below: 2000
                    - condition: time
                      after: "16:00:00"
                - condition: and
                  conditions:
                    - condition: numeric_state
                      entity_id: sensor.fabian_s_zuhause_solar_percentage
                      below: 20
                    - condition: time
                      after: "16:00:00"
                - condition: and
                  conditions:
                    - condition: numeric_state
                      entity_id: sensor.fabian_s_zuhause_solar_percentage
                      below: 20
                    - condition: numeric_state
                      entity_id: sensor.dwd_illuminance
                      below: 2000
          sequence:
            - service: light.turn_on
              target:
                entity_id: switch.lampe_samuel
            - service: light.turn_on
              target:
                entity_id: light.leds_samuel_s_zimmer
              data:
                transition: 2
                brightness: 255
                rgb_color: [255, 255, 255]

- id: turn_off_strom_if_samuel_pc_stops
  alias: "Turn off strom if samuel pc stops"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.md3f9bmc
      from: "home"
      to: "not_home"
      for:
        minutes: 5
    - platform: numeric_state
      entity_id: sensor.steckerleiste_samuel_energy_power
      below: 25
      for:
        minutes: 10
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.steckerleiste_samuel_energy_power
        below: 25
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.schreibtisch_samuel

- id: turn_off_strom_if_fpc_stops
  alias: "Turn off strom if fpc stops"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.fabian_schreibtisch_power
      below: 25
      for:
        minutes: 10
    - platform: state
      entity_id: device_tracker.c_pf38fwqx_pari
      from: "home"
      to: "not_home"
      for:
        minutes: 5
    - platform: state
      entity_id: device_tracker.fabian_pc
      from: "home"
      to: "not_home"
      for:
        minutes: 60
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.fabian_schreibtisch_power
        below: 25
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.fabian_schreibtisch

- id: adb_uninstall_apps_when_tv_starts
  alias: "ADB uninstall apps when tv starts"
  initial_state: false
  trigger:
    - platform: state
      entity_id: media_player.wohnzimmer_tv
      from: "unavailable"
    - platform: state
      entity_id: media_player.keller_tv
      from: "unavailable"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.smartalexa
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.android.camera2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.inputmethod.international
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.google.android.music
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.appmarket2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 tv.wuaki.apptv
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.MultiScreenInteraction_TV
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer.resource
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.usercenter
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.messagebox
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.waterfall.overseas
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.gallery
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.google.android.videos
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 au.com.stan.and
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.dashboard
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.notereminder
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.useragreement
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.smartalexa
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.android.camera2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.inputmethod.international
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.google.android.music
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.appmarket2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 tv.wuaki.apptv
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.MultiScreenInteraction_TV
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer.resource
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.usercenter
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.messagebox
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.waterfall.overseas
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.gallery
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.google.android.videos
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 au.com.stan.and
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.dashboard
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.notereminder
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.useragreement

- id: automations_if_tv_starts
  alias: "Automations if tv starts"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.wohnzimmer_tv
      from: "not_home"
      to: "home"
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.dwd_illuminance
              below: 3000
            - condition: time
              after: "14:00:00"
            - condition: numeric_state
              entity_id: sensor.fabian_s_zuhause_solar_percentage
              below: 15
          sequence:
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_wohnzimmer_tv
                  - light.leds_wohnzimmer
                  - light.stehlampe
                transition: 2
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: numeric_state
              entity_id: "sensor.weather_ebersberg_hourly"
              attribute: temperature
              below: 17
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.wohnzimmer
                  state: "off"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.wohnzimmer_open_window
                      state: "on"
                  sequence:
                    - delay: "00:25:00"
            - service: climate.set_temperature
              data:
                entity_id: climate.wohnzimmer
                temperature: 21.5
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: cover.wohnzimmer_rollo_fenster
                  state: "closed"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.dwd_illuminance
                  above: 15000
                - condition: numeric_state
                  entity_id: sensor.fabian_s_zuhause_solar_percentage
                  above: 70
          sequence:
            - service: cover.set_cover_position
              target:
                entity_id: cover.wohnzimmer_rollo_fenster
              data:
                position: 75
            - service: cover.set_cover_position
              target:
                entity_id: cover.wohnzimmer_rollo_tur
              data:
                position: 90

- id: turn_off_climate_if_tv_stops
  alias: "Turn off climate if tv stops"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.wohnzimmer_tv
      from: "home"
      to: "not_home"
  condition:
    - condition: state
      entity_id: "input_boolean.thermostate_aus"
      state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: "auto"

- id: turn_off_climates_if_someone_is_not_at_home
  alias: "Turn off climates if someone is not at home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "home"
      to: "not_home"
      for:
        minutes: 30
    - platform: state
      entity_id: person.samuel
      from: "home"
      to: "not_home"
      for:
        minutes: 30
  condition:
    - condition: state
      entity_id: "input_boolean.thermostate_aus"
      state: "off"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: climate.fabian_s_zimmer
                  state: "off"
            - condition: state
              entity_id: person.samuel
              state: "home"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.fabian_s_zimmer
                temperature: 17
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
                - condition: state
                  entity_id: climate.samuel_s_zimmer
                  state: "off"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.samuel_s_zimmer
                temperature: 17
                hvac_mode: heat

- id: remind_for_open_window_bathroom
  alias: "Remind for open window bathroom"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.bad_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.bad_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.bad
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.bad_heating
        above: 35
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: state
              entity_id: person.samuel
              state: "home"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.samuels_lautsprecher
                message: Es wurde vermutlich vergessen das Fenster im Bad zu schlie√üen.
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.wohnzimmer_uhr
                  - media_player.kuche_lautsprecher
                  - media_player.fabians_lautsprecher
                message: Es wurde vermutlich vergessen das Fenster im Bad zu schlie√üen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schlie√üen."
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schlie√üen."

- id: remind_for_open_window_sleeping_room
  alias: "Remind for open window sleeping room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.fabian_s_zimmer_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.fabian_s_zimmer_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.fabian_s_zimmer
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.fabian_s_zimmer_heating
        above: 35
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.wohnzimmer_uhr
                  - media_player.kuche_lautsprecher
                message: Es wurde vermutlich vergessen das Fenster in Fabians Zimmer zu schlie√üen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster in Fabians Zimmer zu schlie√üen."
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster in Fabians Zimmer zu schlie√üen."

- id: remind_for_open_window_living_room
  alias: "Remind for open window living room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.wohnzimmer_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.wohnzimmer_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.wohntimmer
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.wohnzimmer_heating
        above: 35
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: state
              entity_id: person.samuel
              state: "home"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.samuels_lautsprecher
                message: Es wurde vermutlich vergessen das Fenster im Wohnzimmer zu schlie√üen.
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.kuche_lautsprecher
                  - media_player.fabians_lautsprecher
                message: Es wurde vermutlich vergessen das Fenster im Wohnzimmer zu schlie√üen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schlie√üen."
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schlie√üen."

- id: remind_for_open_window_guest_room
  alias: "Remind for open window guest room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.samuel_s_zimmer_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.samuel_s_zimmer_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.samuel_s_zimmer
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.samuel_s_zimmer_heating
        above: 85
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.wohnzimmer_uhr
                  - media_player.kuche_lautsprecher
                  - media_player.fabians_lautsprecher
                message: Es wurde vermutlich vergessen das Fenster in Samuels Zimmer zu schlie√üen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster in Samuels Zimmer zu schlie√üen."
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster in Samuels Zimmer zu schlie√üen."

- id: remind_for_open_window_after_5_minutes_in_bathroom
  alias: "Remind for open window after 5 minutes in bathroom"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.bad_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.bad"
        attribute: current_temperature
        below: 21
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: time
                  after: "21:30:00"
                - condition: time
                  before: "07:50:00"
          sequence:
            - choose:
                - conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: input_boolean.leiser_modus
                          state: "on"
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                            - condition: state
                              entity_id: person.samuel
                              state: home
                  sequence:
                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                          sequence:
                            - service: notify.mobile_app_pixel_10_pro
                              data:
                                message: "Das Fenster im Bad kann wieder geschlossen werden."
                                data:
                                  push:
                                    sound:
                                      name: "default"
                                      critical: 1
                                      volume: 0.1
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster im Bad kann wieder geschlossen werden."
                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: person.samuel
                              state: home
                          sequence:
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster im Bad kann wieder geschlossen werden."
      default:
        - choose:
            - conditions:
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: device_tracker.fabian_pc
                          state: "home"
                        - condition: state
                          entity_id: device_tracker.c_pf38fwqx_pari
                          state: "home"
                    - condition: not
                      conditions:
                        - condition: state
                          entity_id: media_player.fabians_lautsprecher
                          state: "off"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Bad kann wieder geschlossen werden."
                - service: notify.mobile_app_pixel_10_pro
                  data:
                    message: "Das Fenster im Bad kann wieder geschlossen werden."
                    data:
                      push:
                        sound:
                          name: "default"
                          critical: 1
                          volume: 0.1
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.fabians_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.fabians_lautsprecher
                    message: Das Fenster im Bad kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.fabians_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: device_tracker.md3f9bmc
                      state: "home"
                    - condition: state
                      entity_id: input_boolean.samuel_pc_strom
                      state: "home"
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.samuels_lautsprecher
                      state: "off"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Bad kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.gast_modus
                  state: "off"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: state
                  entity_id: input_boolean.samuel_pc_strom
                  state: "off"
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: device_tracker.md3f9bmc
                      state: "home"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.samuels_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.samuels_lautsprecher
                    message: Das Fenster im Bad kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.samuels_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Bad kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Bad kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.kuche_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.kuche_lautsprecher
                    message: Das Fenster im Bad kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.kuche_lautsprecher
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_tv
                      state: "unavailable"
              sequence:
                - service: notify.wohnzimmer_tv
                  continue_on_error: true
                  data:
                    message: Das Fenster im Bad kann wieder geschlossen werden.
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_uhr
                      state: "off"
                    - condition: state
                      entity_id: media_player.wohnzimmer_uhr
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.wohnzimmer_uhr
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.wohnzimmer_uhr
                    message: Das Fenster im Bad kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.wohnzimmer_uhr

- id: remind_for_open_window_after_5_minutes_in_fabians_room
  alias: "Remind for open window after 5 minutes in fabians room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.fabian_s_zimmer_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.fabian_s_zimmer"
        attribute: current_temperature
        below: 19
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: time
                  after: "21:30:00"
                - condition: time
                  before: "07:50:00"
          sequence:
            - choose:
                - conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: input_boolean.leiser_modus
                          state: "on"
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                            - condition: state
                              entity_id: person.samuel
                              state: home
                  sequence:
                    - choose:
                        - conditions:
                            - condition: not
                              conditions:
                                - condition: state
                                  entity_id: person.fabian
                                  state: home
                          sequence:
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster in Fabians Zimmer kann wieder geschlossen werden."
                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                          sequence:
                            - service: notify.mobile_app_pixel_10_pro
                              data:
                                message: "Das Fenster in deinem Zimmer kann wieder geschlossen werden."
                                data:
                                  push:
                                    sound:
                                      name: "default"
                                      critical: 1
                                      volume: 0.1
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster in deinem Zimmer kann wieder geschlossen werden."
      default:
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.samuels_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: person.fabian
                      state: "home"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster in Fabians Zimmer kann wieder geschlossen werden."
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
                    - condition: state
                      entity_id: device_tracker.fabian_pc
                      state: "home"
                    - condition: state
                      entity_id: device_tracker.c_pf38fwqx_pari
                      state: "home"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster in deinem Zimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster in Fabians Zimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.kuche_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.kuche_lautsprecher
                    message: Das Fenster in Fabians Zimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.kuche_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_uhr
                      state: "off"
                    - condition: state
                      entity_id: media_player.wohnzimmer_uhr
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.wohnzimmer_uhr
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.wohnzimmer_uhr
                    message: Das Fenster in Fabians Zimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.wohnzimmer_uhr
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_tv
                      state: "unavailable"
              sequence:
                - service: notify.wohnzimmer_tv
                  continue_on_error: true
                  data:
                    message: Das Fenster in Fabians Zimmer kann wieder geschlossen werden.

- id: remind_for_open_window_after_5_minutes_in_living_room
  alias: "Remind for open window after 5 minutes in living room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.wohnzimmer_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.wohnzimmer"
        attribute: current_temperature
        below: 20
      - condition: state
        entity_id: switch.fernseher
        state: "off"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: time
                  after: "21:30:00"
                - condition: time
                  before: "07:50:00"
          sequence:
            - choose:
                - conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: input_boolean.leiser_modus
                          state: "on"
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                            - condition: state
                              entity_id: person.samuel
                              state: home
                  sequence:
                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                          sequence:
                            - service: notify.mobile_app_pixel_10_pro
                              data:
                                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
                                data:
                                  push:
                                    sound:
                                      name: "default"
                                      critical: 1
                                      volume: 0.1
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: person.samuel
                              state: home
                          sequence:
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
      default:
        - choose:
            - conditions:
                - condition: or
                  conditions:
                    - condition: state
                      entity_id:
                        - device_tracker.c_pf38fwqx_pari
                      state: "home"
                    - condition: state
                      entity_id:
                        - device_tracker.fabian_pc
                      state: "home"
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.fabians_lautsprecher
                      state: "off"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.fabians_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.fabians_lautsprecher
                    message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.fabians_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id:
                    - device_tracker.md3f9bmc
                    - device_tracker.md3f9bmc
                  match: any
                  state: "home"
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.samuels_lautsprecher
                      state: "off"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.gast_modus
                  state: "off"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.samuels_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.samuels_lautsprecher
                    message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.samuels_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
                    - condition: state
                      entity_id: device_tracker.fabian_pc
                      state: "home"
                    - condition: state
                      entity_id: device_tracker.c_pf38fwqx_pari
                      state: "home"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.kuche_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.kuche_lautsprecher
                    message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.kuche_lautsprecher

- id: remind_for_open_window_after_5_minutes_in_samuels_room
  alias: "Remind for open window after 5 minutes in samuels room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.samuel_s_zimmer_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.samuel_s_zimmer"
        attribute: current_temperature
        below: 20
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: time
                  after: "21:30:00"
                - condition: time
                  before: "07:50:00"
          sequence:
            - choose:
                - conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: input_boolean.leiser_modus
                          state: "on"
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: person.fabian
                              state: home
                            - condition: state
                              entity_id: person.samuel
                              state: home
                  sequence:
                    - choose:
                        - conditions:
                            - condition: not
                              conditions:
                                - condition: state
                                  entity_id: person.samuel
                                  state: home
                          sequence:
                            - service: notify.mobile_app_pixel_10_pro
                              data:
                                message: "Das Fenster in Samuels Zimmer kann wieder geschlossen werden."
                                data:
                                  push:
                                    sound:
                                      name: "default"
                                      critical: 1
                                      volume: 0.1
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster in Samuels Zimmer kann wieder geschlossen werden."
                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: person.samuel
                              state: home
                          sequence:
                            - service: notify.telegram_fabian
                              data:
                                message: "Das Fenster in deinem Zimmer kann wieder geschlossen werden."
      default:
        - choose:
            - conditions:
                - condition: or
                  conditions:
                    - condition: state
                      entity_id:
                        - device_tracker.c_pf38fwqx_pari
                      state: "home"
                    - condition: state
                      entity_id:
                        - device_tracker.fabian_pc
                      state: "home"
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.fabians_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: person.samuel
                      state: "home"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster in Samuels Zimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.fabians_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.fabians_lautsprecher
                    message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.fabians_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
                    - condition: state
                      entity_id: device_tracker.fabian_pc
                      state: "home"
                    - condition: state
                      entity_id: device_tracker.c_pf38fwqx_pari
                      state: "home"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster in Samuels Zimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: notify.telegram_fabian
                  data:
                    message: "Das Fenster in Samuels Zimmer kann wieder geschlossen werden."
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "off"
                    - condition: state
                      entity_id: media_player.kuche_lautsprecher
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.kuche_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.kuche_lautsprecher
                    message: Das Fenster in Samuels Zimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.kuche_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_uhr
                      state: "off"
                    - condition: state
                      entity_id: media_player.wohnzimmer_uhr
                      state: "idle"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.wohnzimmer_uhr
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.wohnzimmer_uhr
                    message: Das Fenster in Samuels Zimmer kann wieder geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.wohnzimmer_uhr
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_tv
                      state: "unavailable"
              sequence:
                - service: notify.wohnzimmer_tv
                  continue_on_error: true
                  data:
                    message: Das Fenster in Samuels Zimmer kann wieder geschlossen werden.

- id: turn_off_bett_if_no_device_is_charging
  alias: "Turn off bett if no device is charging"
  initial_state: false
  trigger:
    - platform: state
      entity_id:
        - sensor.fabian_ipadpro_battery_state
        - sensor.fabian_phone_battery_state
        - sensor.samuel_iphone_battery_state
      to: "discharging"
    - platform: state
      entity_id:
        - sensor.fabian_ipadpro_battery_state
        - sensor.fabian_phone_battery_state
        - sensor.samuel_iphone_battery_state
      to: "Not Charging"
    - platform: numeric_state
      entity_id:
        - sensor.fabian_ipadpro_battery_state
        - sensor.pixel_8_pro_battery_level
        - sensor.samuel_iphone_battery_state
      above: 90
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.bett_usb_ports
        state: "on"
      #  - condition: or
      #    conditions:
      #      - condition: state
      #        entity_id: sensor.fabian_ipadpro_battery_state
      #        state: 'discharging'
      #      - condition: numeric_state
      #        entity_id: sensor.fabian_ipadpro_battery_state
      #        above: 90
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.fabian_phone_battery_state
            state: "discharging"
          - condition: numeric_state
            entity_id: sensor.pixel_8_pro_battery_level
            above: 80
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.samuel_iphone_battery_state
            state: "discharging"
          - condition: numeric_state
            entity_id: sensor.samuel_phone_battery_level
            above: 80
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.bett_usb_ports

- id: turn_off_bett_after_x_hours
  alias: "Turn off bett after x hours"
  initial_state: false
  trigger:
    - platform: state
      entity_id: switch.bett_usb_ports
      to: "on"
      for:
        minutes: 180
    - platform: state
      entity_id: switch.bett_usb_ports
      to: "on"
      for:
        minutes: 360
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.bett_usb_ports
        state: "on"
      - condition: time
        before: "20:30:00"
      - condition: time
        after: "06:30:00"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.bett_usb_ports

- id: turn_on_lights_and_cover_in_morning
  alias: "Turn on lights and open cover in morning"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.pixel_8_pro
      from: "not_home"
      to: "home"
    # - platform: state
    #   entity_id: device_tracker.redmi_note_10_pro
    #   from: "not_home"
    #   to: "home"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "05:00:00"
      - condition: time
        before: "11:00:00"
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_and_open_cover_in_morning.attributes.last_triggered) | int > 1800 }}"
  action:
    - delay: "00:04:30"
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: cover.fabians_zimmer_rollo
                  state: "open"
          sequence:
            - service: cover.set_cover_position
              target:
                entity_id: cover.fabians_zimmer_rollo
              data:
                position: 40
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: numeric_state
                  entity_id: sensor.dwd_illuminance
                  below: 2000
                - condition: numeric_state
                  entity_id: sensor.fabian_s_zuhause_solar_percentage
                  below: 20
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.adaptive_lighting_sleeping_room
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_tisch
                  - light.yeelink_bslamp2_22e2_light
                brightness: 2
            - delay: "00:02:30"
            - service: automation.trigger
              entity_id: automation.increase_lights_in_morning
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: time
              after: "07:00:00"
          sequence:
            - service: cover.open_cover
              target:
                entity_id: cover.fabians_zimmer_rollo
    # - choose:
    #     - conditions:
    #         - condition: state
    #           entity_id: input_boolean.leiser_modus
    #           state: "off"
    #         - condition: state
    #           entity_id: input_boolean.gast_modus
    #           state: "off"
    #         - condition: or
    #           conditions:
    #             - condition: numeric_state
    #               entity_id: climate.samuel_s_zimmer
    #               attribute: current_humidity
    #               above: 60
    #             - condition: numeric_state
    #               entity_id: climate.wohnzimmer
    #               attribute: current_humidity
    #               above: 60
    #             - condition: numeric_state
    #               entity_id: climate.fabian_s_zimmer
    #               attribute: current_humidity
    #               above: 60
    #             - condition: numeric_state
    #               entity_id: climate.bad
    #               attribute: current_humidity
    #               above: 60
    #       sequence:
    #         - service: automation.trigger
    #           entity_id: automation.notify_for_high_humidity
    #  - service: light.turn_on
    #    data_template:
    #      entity_id: light.bett_gluhbirne
    #      brightness: 100
    #      rgb_color: >
    #        {% if state_attr('sensor.weather_ebersberg_daily', 'forecast')[0]['condition'] == 'snowy' %}
    #        [255,255,255]
    #        {% elif state_attr('sensor.weather_ebersberg_daily', 'forecast')[0]['condition'] == 'rainy' %}
    #        [0,0,255]
    #        {% elif state_attr('sensor.weather_ebersberg_daily', 'forecast')[0]['condition'] == 'sunny' %}
    #        [0,255,0]
    #        {% else %}
    #        [0,0,0]
    #        {% endif %}
    #  - delay: '00:05:00'
    #  - service: light.turn_off
    #    data:
    #      entity_id:
    #        - light.yeelink_bslamp2_22e2_light
    - delay: "00:20:00"
    - service: switch.turn_on
      data:
        entity_id: switch.adaptive_lighting_sleeping_room
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_pc
              state: "not_home"
            - condition: state
              entity_id: "device_tracker.c_pf38fwqx_pari"
              state: "not_home"
          sequence:
            - service: light.turn_off
              data:
                entity_id:
                  - light.leds_tisch

- id: increase_lights_in_morning
  alias: "Increase lights in morning"
  initial_state: false
  mode: restart
  trigger:
    - platform: state
      entity_id: automation.increase_lights_in_morning
      to: "on"
  condition:
    condition: and
    conditions:
      - condition: not
        conditions:
          - condition: state
            entity_id: light.yeelink_bslamp2_22e2_light
            state: "off"
          - condition: state
            entity_id: light.leds_tisch
            state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: light.leds_tisch
            state: "unavailable"
          - condition: not
            conditions:
              - condition: state
                entity_id: light.leds_tisch
                attribute: brightness
                state: "255"
  action:
    - delay: "00:00:15"
    - choose:
        - conditions:
            - condition: state
              entity_id: light.leds_tisch
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.leds_tisch
                  attribute: brightness
                  state: "255"
          sequence:
            - service: light.turn_on
              entity_id: light.leds_tisch
              data:
                brightness: "{{states.light.leds_tisch.attributes.brightness + 5}}"
            - service: light.turn_on
              data:
                entity_id: light.regal
    - choose:
        - conditions:
            - condition: state
              entity_id: light.yeelink_bslamp2_22e2_light
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.yeelink_bslamp2_22e2_light
                  attribute: brightness
                  state: "255"
          sequence:
            - service: light.turn_on
              entity_id: light.yeelink_bslamp2_22e2_light
              data:
                brightness: "{{states.light.yeelink_bslamp2_22e2_light.attributes.brightness + 5}}"
    - choose:
        - conditions:
            - condition: state
              entity_id: light.leds_tisch
              state: "on"
            - condition: state
              entity_id: light.yeelink_bslamp2_22e2_light
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.leds_tisch
                  attribute: brightness
                  state: "255"
                - condition: state
                  entity_id: light.yeelink_bslamp2_22e2_light
                  attribute: brightness
                  state: "255"
          sequence:
            - service: automation.trigger
              data:
                entity_id: automation.increase_lights_in_morning

- id: Remind for leaving in the morning
  alias: "Remind for leaving in the morning"
  trigger:
    - platform: time
      at: "06:55:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.leiser_modus"
        state: "off"
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.redmi_note_10_pro
            state: home
          - condition: state
            entity_id: device_tracker.pixel_8_pro
            state: home
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: "input_boolean.gast_modus"
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: device_tracker.redmi_note_10_pro
                      state: home
                    - condition: state
                      entity_id: device_tracker.pixel_8_pro
                      state: home
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.1 }}
                    entity_id:
                      - media_player.wohnzimmer_uhr
                      - media_player.kuche_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id:
                      - media_player.wohnzimmer_uhr
                      - media_player.kuche_lautsprecher
                    message: >
                      Es ist {{ now().hour }} Uhr {{ now().minute }} .
                      Die Sbahn um {{ states.sensor.zorneding_departures_via_starnberg_nord.attributes.departure }} Uhr hat voraussichtlich
                      {% if state_attr('sensor.zorneding_departures_via_starnberg_nord', 'delay') == 1 %}
                      eine Minute
                      {% elif state_attr('sensor.zorneding_departures_via_starnberg_nord', 'delay') >= 1 %}
                      {{ states.sensor.zorneding_departures_via_starnberg_nord.attributes.delay }} Minuten
                      {% else %}
                      keine
                      {% endif %} Versp√§tung.
                - delay: "00:00:12"
                - choose:
                    - conditions:
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: binary_sensor.fabian_s_zimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.samuel_s_zimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.wohnzimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.bad_open_window
                              state: "on"
                      sequence:
                        - parallel:
                            - service: tts.speak
                              continue_on_error: true
                              target:
                                entity_id: tts.google_de_de
                              data:
                                media_player_entity_id:
                                  - media_player.wohnzimmer_uhr
                                  - media_player.kuche_lautsprecher
                                message: >
                                  Das Fenster im {% if is_state('binary_sensor.fabian_s_zimmer_open_window', 'on') %}
                                    Fabians Zimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.samuel_s_zimmer_open_window', 'on') %}
                                    Samuels Zimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.wohnzimmer_open_window', 'on') %}
                                    Wohnzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.bad_open_window', 'on') %}
                                    Bad
                                  {% endif %}
                                  muss noch geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id:
                      - media_player.wohnzimmer_uhr
                      - media_player.kuche_lautsprecher
        - choose:
            - conditions:
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: device_tracker.redmi_note_10_pro
                      state: home
                    - condition: state
                      entity_id: device_tracker.pixel_8_pro
                      state: home
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.1 }}
                    entity_id: media_player.fabians_lautsprecher
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.fabians_lautsprecher
                    message: >
                      Es ist {{ now().hour }} Uhr {{ now().minute }} .
                      Die Sbahn um {{ states.sensor.zorneding_departures_via_starnberg_nord.attributes.departure }} Uhr hat voraussichtlich
                      {% if state_attr('sensor.zorneding_departures_via_starnberg_nord', 'delay') == 1 %}
                      eine Minute
                      {% elif state_attr('sensor.zorneding_departures_via_starnberg_nord', 'delay') >= 1 %}
                      {{ states.sensor.zorneding_departures_via_starnberg_nord.attributes.delay }} Minuten
                      {% else %}
                      keine
                      {% endif %} Versp√§tung.
                - delay: "00:00:12"
                - choose:
                    - conditions:
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: binary_sensor.fabian_s_zimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.samuel_s_zimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.wohnzimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.bad_open_window
                              state: "on"
                      sequence:
                        - parallel:
                            - service: tts.speak
                              continue_on_error: true
                              target:
                                entity_id: tts.google_de_de
                              data:
                                media_player_entity_id:
                                  - media_player.fabians_lautsprecher
                                  - media_player.kuche_lautsprecher
                                message: >
                                  Das Fenster im {% if is_state('binary_sensor.fabian_s_zimmer_open_window', 'on') %}
                                    Fabians Zimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.samuel_s_zimmer_open_window', 'on') %}
                                    Samuels Zimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.wohnzimmer_open_window', 'on') %}
                                    Wohnzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.bad_open_window', 'on') %}
                                    Bad
                                  {% endif %}
                                  muss noch geschlossen werden.
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.fabians_lautsprecher

- id: turn_on_light_in_sleeping_room_if_tv_turned_off
  alias: "Turn on light in sleeping room if tv turned off"
  initial_state: false
  trigger:
    - platform: state
      entity_id: device_tracker.wohnzimmer_tv
      from: "home"
      to: "not_home"
      for:
        seconds: 5
    - platform: state
      entity_id: switch.fernseher
      to: "off"
      for:
        seconds: 5
  condition:
    - condition: time
      after: "21:00:00"
      before: "23:50:00"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_light_in_sleeping_room_if_tv_turned_off.attributes.last_triggered) | int > 1800 }}"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.bett_gluhbirne
                  state: unavailable
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.bett_gluhbirne
                brightness: 255
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.yeelink_bslamp2_22e2_light
                  state: unavailable
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.yeelink_bslamp2_22e2_light
                brightness: 255
                color_temp: 279
    - service: light.turn_off
      data:
        entity_id:
          - light.leds_tisch
          - light.regal
    - delay: "00:04:00"
    - service: light.turn_off
      data:
        area_id:
          - 7c05afe47efd44f5a0a064769ad6e105 # Wohnzimmer

- id: turn_off_prismatik_during_the_day
  alias: "Turn off Prismatik during the day"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "home"
      for:
        minutes: 2
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.dwd_illuminance
        above: 2000
      - condition: numeric_state
        entity_id: sensor.fabian_s_zuhause_solar_percentage
        above: 20
  action:
    - delay: "00:04:00"
    - service: light.turn_off
      data:
        entity_id: light.prismatik

- id: turn_on_lights_in_livingroom_when_dark_outside
  alias: "Turn on lights in livingroom when dark outside"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      below: 1800
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      below: 18
    - platform: sun
      event: sunset
      offset: "-00:30:00"
  condition:
    - condition: state
      entity_id: device_tracker.wohnzimmer_tv
      state: home
    - condition: state
      entity_id: "switch.fernseher"
      state: "on"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_livingroom_when_dark_outside.attributes.last_triggered) | int > 1800 }}"
    - condition: or
      conditions:
        - condition: state
          entity_id: person.fabian
          state: home
        - condition: state
          entity_id: person.samuel
          state: home
  action:
    - service: light.turn_on
      data:
        entity_id:
          - light.leds_wohnzimmer_tv
          - light.leds_wohnzimmer
          - light.stehlampe
        transition: 2

- id: turn_on_lights_in_samuel_room_when_dark_outside
  alias: "Turn on lights in samuel room when dark outside"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      below: 2000
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      below: 27
    - platform: sun
      event: sunset
      offset: "-00:30:00"
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: sensor.dwd_illuminance
                below: 2000
              - condition: time
                after: "15:00:00"
          - condition: numeric_state
            entity_id: sensor.fabian_s_zuhause_solar_percentage
            below: 20
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_samuel_room_when_dark_outside.attributes.last_triggered) | int > 1800 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: "person.fabian"
            state: "home"
          - condition: state
            entity_id: "person.samuel"
            state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "device_tracker.md3f9bmc"
            state: "home"
  action:
    - service: light.turn_on
      data:
        area_id:
          - b67ac5462e454381aa87f812161d8578 # Samuels Zimmer
        transition: 2

- id: turn_on_lights_in_sleeping_room_when_dark_outside
  alias: "Turn on lights in sleeping room when dark outside"
  trigger:
    - platform: sun
      event: sunset
      offset: "-00:20:00"
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      below: 2000
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      below: 27
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: "device_tracker.fabian_pc"
            state: "home"
          - condition: state
            entity_id: "device_tracker.c_pf38fwqx_pari"
            state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "person.fabian"
            state: "home"
          - condition: state
            entity_id: "person.samuel"
            state: "home"
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: sensor.dwd_illuminance
                below: 2000
              - condition: time
                after: "15:00:00"
          - condition: numeric_state
            entity_id: sensor.fabian_s_zuhause_solar_percentage
            below: 20
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_sleeping_room_when_dark_outside.attributes.last_triggered) | int > 1800 }}"
  action:
    - service: light.turn_on
      data:
        entity_id: light.leds_tisch
        brightness: 255
        transition: 2
    - choose:
        - conditions:
            - condition: state
              entity_id: "device_tracker.fabian_pc"
              state: "home"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.prismatik
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_tisch
                  - light.yeelink_bslamp2_22e2_light
                transition: 2
    - choose:
        - conditions:
            - condition: state
              entity_id: "device_tracker.c_pf38fwqx_pari"
              state: "home"
          sequence:
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_tisch
                  - light.yeelink_bslamp2_22e2_light
                transition: 2

- id: turn_off_lights_in_rooms_when_bright_outside
  alias: "Turn off lights in rooms when bright outside"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      above: 20000
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      above: 25
    - platform: sun
      event: sunrise
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_samuel_room_when_dark_outside.attributes.last_triggered) | int > 2400 }}"
  action:
    - service: light.turn_off
      data:
        area_id:
          - 7c05afe47efd44f5a0a064769ad6e105 # Wohnzimmer
          - 33e9a108bf1948e5848f156e0851d50c # Fabians Zimmer
          - b67ac5462e454381aa87f812161d8578 # Samuels Zimmer

- id: turn_off_climates_on_warm_days
  alias: "Turn off Climates on warm days"
  initial_state: true
  trigger:
    platform: numeric_state
    entity_id: sensor.weather_ebersberg_hourly
    attribute: temperature
    above: 14
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[0]['condition'] == 'sunny' }}"
      - condition: template
        value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['condition'] == 'sunny' }}"
      - condition: template
        value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['temperature'] >= 14 }}"
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "off"
      - condition: or
        conditions:
          - condition: template
            value_template: "{{ now().month <= 10 and now().month >= 2 }}"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.thermostate_aus
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "Thermostate wurden ausgeschaltet, da es {{ states.weather.ebersberg_ebersberg.attributes.temperature }}¬∞ hat und sonnig ist."
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_samuel_dummy
        message: "Thermostate wurden ausgeschaltet, da es {{ states.weather.ebersberg_ebersberg.attributes.temperature }}¬∞ hat und sonnig ist."
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"

- id: turn_on_climates_on_cold_days
  alias: "Turn on Climates on cold days"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.weather_ebersberg_hourly
      attribute: temperature
      below: 10
    - platform: sun
      event: sunset
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "on"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_climates_on_cold_days.attributes.last_triggered) | int > 86300 }}"
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: sensor.weather_ebersberg_hourly
                attribute: temperature
                below: 10
              - condition: sun
                after: sunset
                after_offset: "-04:00:00"
              - condition: time
                after: "20:30:00"
              - condition: template
                value_template: "{{ now().month <= 10 and now().month >= 2 }}"
          - condition: template
            value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['temperature'] <= 12 }}"
          - condition: and
            conditions:
              - condition: template
                value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['condition'] != 'sunny' }}"
              - condition: template
                value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['temperature'] <= 14 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "Thermostate sollten wieder eingeschaltet werden, da es jetzt nur noch {{ states.weather.ebersberg_ebersberg.attributes.temperature }} ¬∞C und morgen {{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['temperature'] }} ¬∞C hat. Dies wurde nicht automatisch gemacht!"
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_samuel_dummy
        message: "Thermostate sollten wieder eingeschaltet werden, da es jetzt nur noch {{ states.weather.ebersberg_ebersberg.attributes.temperature }} ¬∞C und morgen {{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['temperature'] }} ¬∞C hat. Dies wurde nicht automatisch gemacht!"
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"

- id: remind_for_gruppentreffen
  alias: "üçª Gruppentreffen Reminder"
  trigger:
    # Trigger approx. 31 hours before the event
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - 111600) | round(-1) }}"
    # Trigger approx. 15 hours before the event
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - 54000) | round(-1) }}"
  condition:
    - condition: and
      conditions:
        - "{{ (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - as_timestamp(now())) < 112600 }}"
        - "{{ (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - as_timestamp(now())) > 0 }}"
        - condition: state
          entity_id: calendar.votgaming_kalender
          attribute: message
          state: "Gruppentreffen"
        # Prevents re-triggering within 50 hours
        - condition: template
          value_template: "{{ as_timestamp(now()) - as_timestamp(this.attributes.last_triggered) | int(0) > 180000 }}"
  action:
    - choose:
        # Case 1: Good weather
        - conditions:
            - condition: or
              conditions:
                - "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['condition'] == 'sunny' }}"
                - "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['condition'] == 'partlycloudy' }}"
            - "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[1]['temperature'] | int >= 18 }}"
          sequence:
            - service: telegram_bot.send_poll
              data:
                target: !secret telegram_chat_5friends
                question: >
                  {% set greetings = ["Obacht!", "Aufgepasst!", "Wohoo!"] %}
                  {{ greetings | random }} Morgen steht unser {{ state_attr('calendar.votgaming_kalender', 'message') }} an!
                  Das Wetter wird super: {{ states.sensor.weather_ebersberg_hourly.attributes.forecast[24].condition }} bei {{ states.sensor.weather_ebersberg_hourly.attributes.forecast[1].temperature }}¬∞C.
                  {% if now().month <= 4 or now().month >= 10 %} Die Sonne scheint bis ‚è∞ {{ state_attr('sun.sun', 'next_dusk') | as_timestamp | timestamp_custom('%H:%M', false) }}.{% endif %}
                  Wo treffen wir uns? ‚òÄÔ∏è
                options:
                  - "See üåä"
                  - "Weiher"
                  - "Fabi"
                  - "Kai & Adri"
                  - "Flo"
                  - "Maxi"
                  - "Bar (z.B. Tropic Bar) üçπ"
                  - "Wo anders (Schreiben wo!)"
                is_anonymous: false
                allows_multiple_answers: true
                disable_notification: true
        - conditions:
            - condition: or
              conditions:
                - "{{ states('sensor.weather_ebersberg_hourly') == 'unavailable' }}"
                - "{{ states('sensor.weather_ebersberg_hourly') == 'unknown' }}"
          sequence:
            - service: telegram_bot.send_poll
              data:
                target: !secret telegram_chat_5friends
                question: >
                  {% set greetings = ["Obacht!", "Aufgepasst!", "Wohoo!"] %}
                  {{ greetings | random }} Morgen ist wieder {{ state_attr('calendar.votgaming_kalender', 'message') }}!
                  {% if now().month <= 4 or now().month >= 10 %} Die Sonne scheint bis ‚è∞ {{ state_attr('sun.sun', 'next_dusk') | as_timestamp | timestamp_custom('%H:%M', false) }}.{% endif %}
                  Wo schlagen wir unser Lager auf?
                options:
                  - "Fabi"
                  - "Kai & Adri"
                  - "Flo"
                  - "Maxi"
                  - "Bar (z.B. Tropic Bar) üçπ"
                  - "Wo anders (Schreiben wo!)"
                is_anonymous: false
                allows_multiple_answers: true
                disable_notification: true
      default:
        - service: telegram_bot.send_poll
          data:
            target: !secret telegram_chat_5friends
            question: >
              {% set greetings = ["Obacht!", "Aufgepasst!", "Wohoo!"] %}
              {{ greetings | random }} Morgen steht unser {{ state_attr('calendar.votgaming_kalender', 'message') }} an!
              Das Wetter wird eher durchwachsen: {{ states.sensor.weather_ebersberg_hourly.attributes.forecast[24].condition }} bei {{ states.sensor.weather_ebersberg_hourly.attributes.forecast[24].temperature }}¬∞C.
              {% if now().month <= 4 or now().month >= 10 %} Die Sonne scheint bis ‚è∞ {{ state_attr('sun.sun', 'next_dusk') | as_timestamp | timestamp_custom('%H:%M', false) }}.{% endif %}
              Wo treffen wir uns? ‚òîÔ∏è
            options:
              - "Fabi"
              - "Kai & Adri"
              - "Flo"
              - "Maxi"
              - "Bar (z.B. Tropic Bar) üçπ"
              - "Trotzdem raus? ü§î"
              - "Wo anders (Schreiben wo!)"
            is_anonymous: false
            allows_multiple_answers: true
            disable_notification: true
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_chat_5friends
        question: >
          {% set cooking_questions = ["Sollen wir was Leckeres zusammen kochen?", "Wer hat Hunger und Lust auf eine gemeinsame Koch-Action?", "Wie w√§r's mit Kochen?"] %}
          {{ cooking_questions | random }} üßë‚Äçüç≥ Essensvorschlag des Tages: {{ states('sensor.chefkoch_daily_recipe') }}.
          Weitere Vorschl√§ge mit /food
        options:
          - "Ja, bin am Start! üòã"
          - "Nein, bin versorgt."
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true

- id: remind_for_board_game_events
  alias: "üé≤ Board Game Reminder"
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - 111600) | round(-1) }}"
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - 54000) | round(-1) }}"
  condition:
    - condition: and
      conditions:
        - "{{ (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - as_timestamp(now())) < 112600 }}"
        - "{{ (as_timestamp(state_attr('calendar.votgaming_kalender', 'start_time')) - as_timestamp(now())) > 0 }}"
        - condition: state
          entity_id: calendar.votgaming_kalender
          attribute: message
          state: "Brettspieltreff"
        - condition: template
          value_template: "{{ as_timestamp(now()) - as_timestamp(this.attributes.last_triggered) | int(0) > 180000 }}"
  action:
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_spieletreff
        question: >
          {% set date = state_attr('calendar.votgaming_kalender', 'start_time') | as_timestamp %}
          Zeit f√ºr eine Runde {{ state_attr('calendar.votgaming_kalender', 'message') }}! Wer ist am üìÖ {{ date | timestamp_custom('%a, %d.%m') }} ab ‚è∞ {{ date | timestamp_custom('%H:%M') }} Uhr dabei?
        options:
          - "Ja, klar! üëç"
          - "Leider nein üëé"
          - "Vielleicht... ü§î"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: false
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_spieletreff
        question: >
          {% set game_questions = ["Worauf habt ihr Lust? üÉè", "Was wird gespielt? üé≤"] %}
          {{ game_questions | random }}
        options:
          - "Catan (max 6)"
          - "Carcassonne (max 5)"
          - "Zombicide (max 10)"
          - "Kemet - Blut & Sand (max 5)"
          - "Wizard (max 6)"
          - "Phase 10 (max 6)"
          - "6 nimmt/Hornochsen (max 10)"
          - "Saboteur (max 10)"
          - "Ticket to ride (max 5)"
          - "Ein anderes Spiel aus der Liste"
        is_anonymous: false
        allows_multiple_answers: true
        disable_notification: true
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_spieletreff
        question: >
          {% set location_questions = ["Und wo treffen wir uns? üè†", "Wo wird gespielt? üè†"] %}
          {{ location_questions | random }}
        options:
          - "Fabi"
          - "Adri & Kai"
          - "Kassandra"
          - "Jani & Samuel"
          - "Daniel & Michelle"
          - "JUZ (sofern frei)"
          - "Tropic Bar Zorneding"
          - "Wo anders (Schreiben wo!)"
        is_anonymous: false
        allows_multiple_answers: true
        disable_notification: true

- id: telegram_squash
  alias: "üè∏ Squash Planning"
  trigger:
    - platform: time
      at: "19:01:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_squash
        message: "üè∏ Neue Woche, neues Gl√ºck. Wann habt ihr Zeit f√ºr ein Match?"
        disable_notification: true
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_squash
        question: "üè∏ Neue Woche, neues Gl√ºck. Wann habt ihr Zeit f√ºr ein Match?"
        options:
          - "Montag"
          - "Dienstag"
          - "Mittwoch"
          - "Donnerstag"
          - "Freitag"
          - "Samstag"
          - "Sonntag"
          - "Diese Woche leider nicht üò¢"
        is_anonymous: false
        allows_multiple_answers: true
        disable_notification: true

- id: remind_for_bouldern
  alias: "üßó Bouldering Planning"
  trigger:
    - platform: time
      at: "19:00:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_bouldern
        message: >
          Hier ist die Auslastungs-Prognose f√ºr die kommende Woche! (Statistik f√ºr 17-19 Uhr, dahinter Tagesdurchschnitt):

          üßó‚Äç‚ôÇÔ∏è **Ost**:
          {% set days_ost = [
            {'day': 'Montag', 'value': states('sensor.boulderwelt_ost_monday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_monday_avg') | float(70)},
            {'day': 'Dienstag', 'value': states('sensor.boulderwelt_ost_tuesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_tuesday_avg') | float(70)},
            {'day': 'Mittwoch', 'value': states('sensor.boulderwelt_ost_wednesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_wednesday_avg') | float(70)},
            {'day': 'Donnerstag', 'value': states('sensor.boulderwelt_ost_thursday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_thursday_avg') | float(70)},
            {'day': 'Freitag', 'value': states('sensor.boulderwelt_ost_friday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_friday_avg') | float(70)}
          ] | selectattr('value', '>', 0) | sort(attribute='value') | list %}
          1. {{ days_ost[0].day }} ({{ days_ost[0].value }}% / Tag: {{ days_ost[0].day_avg }}%)
          2. {{ days_ost[1].day }} ({{ days_ost[1].value }}% / Tag: {{ days_ost[1].day_avg }}%)
          3. {{ days_ost[2].day }} ({{ days_ost[2].value }}% / Tag: {{ days_ost[2].day_avg }}%)

          üßó‚Äç‚ôÄÔ∏è **S√ºd**:
          {% set days_sued = [
            {'day': 'Montag', 'value': states('sensor.boulderwelt_sued_monday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_monday_avg') | float(70)},
            {'day': 'Dienstag', 'value': states('sensor.boulderwelt_sued_tuesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_tuesday_avg') | float(70)},
            {'day': 'Mittwoch', 'value': states('sensor.boulderwelt_sued_wednesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_wednesday_avg') | float(70)},
            {'day': 'Donnerstag', 'value': states('sensor.boulderwelt_sued_thursday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_thursday_avg') | float(70)},
            {'day': 'Freitag', 'value': states('sensor.boulderwelt_sued_friday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_friday_avg') | float(70)}
          ] | selectattr('value', '>', 0) | sort(attribute='value') | list %}
          1. {{ days_sued[0].day }} ({{ days_sued[0].value }}% / Tag: {{ days_sued[0].day_avg }}%)
          2. {{ days_sued[1].day }} ({{ days_sued[1].value }}% / Tag: {{ days_sued[1].day_avg }}%)
          3. {{ days_sued[2].day }} ({{ days_sued[2].value }}% / Tag: {{ days_sued[2].day_avg }}%)

          ‚òÄÔ∏è **Wochenende S√ºd**:
          {% set days_weekend_sued = [
            {'day': 'Samstag', 'value': states('sensor.boulderwelt_sued_saturday_avg') | float(70)},
            {'day': 'Sonntag', 'value': states('sensor.boulderwelt_sued_sunday_avg') | float(70)}
          ] | selectattr('value', '>', 0) | sort(attribute='value') | list %}
          - {{ days_weekend_sued[0].day }} (Tag: {{ days_weekend_sued[0].value }}%)
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_chat_bouldern
        question: "Wann wird gebouldert? üßó"
        options:
          - "Montag"
          - "Dienstag"
          - "Mittwoch"
          - "Donnerstag"
          - "Freitag"
          - "Samstag"
          - "Sonntag"
          - "Diese Woche leider nicht üò¢"
        is_anonymous: false
        allows_multiple_answers: true
        disable_notification: true
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_chat_bouldern
        question: "In welche Halle gehen wir?"
        options:
          - "Ost"
          - "S√ºd"
          - "Woanders (wo?)"
        is_anonymous: false
        allows_multiple_answers: true
        disable_notification: true

- id: remind_for_volleyball
  alias: "üèê Volleyball Training"
  trigger:
    # Triggers every Tuesday at 18:00
    - platform: time
      at: "18:00:00"
  condition:
    - condition: time
      weekday:
        - tue
  action:
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_volleyball # Make sure to define this secret!
        question: >
          {% set motivation = ["Zeit, das Netz zum Gl√ºhen zu bringen!", "Baggern, pritschen, punkten! Wer ist dabei?", "Lasst uns wieder den Ball fliegen lassen!"] %}
          {{ motivation | random }} üèê Diesen Donnerstag um ‚è∞ 19:00 Uhr ist wieder Training. Bist du bereit, alles zu geben?
        options:
          - "Klar, bin hei√ü! üî•"
          - "Muss leider passen üò•"
          - "Noch unsicher ü§î"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: false

- id: update_boulderwelt_sensor_average
  alias: "Update Boulderwelt Sensor Average"
  trigger:
    - platform: time
      at: "23:59:00"
  action:
    - choose:
        - conditions:
            - condition: time
              weekday:
                - mon
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_ost_monday_avg
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean') }}"
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_monday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

        - conditions:
            - condition: time
              weekday:
                - tue
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_ost_tuesday_avg
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean') }}"
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_tuesday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

        - conditions:
            - condition: time
              weekday:
                - wed
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_ost_wednesday_avg
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean') }}"
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_wednesday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

        - conditions:
            - condition: time
              weekday:
                - thu
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_ost_thursday_avg
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean') }}"
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_thursday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

        - conditions:
            - condition: time
              weekday:
                - fri
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_ost_friday_avg
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean') }}"
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_friday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

        - conditions:
            - condition: time
              weekday:
                - sat
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_saturday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

        - conditions:
            - condition: time
              weekday:
                - sun
          sequence:
            - service: input_number.set_value
              data:
                entity_id: input_number.boulderwelt_sued_sunday_avg
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean') }}"

- id: update_boulderwelt_sensor_average_2h
  alias: "Update Boulderwelt Sensor Average 2h"
  trigger:
    - platform: time
      at: "19:00:00"
  conditions:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - choose:
        - conditions:
            - condition: time
              weekday:
                - mon
          sequence:
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_ost_monday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean_2h') }}"
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_sued_monday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean_2h') }}"

        - conditions:
            - condition: time
              weekday:
                - tue
          sequence:
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_ost_tuesday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean_2h') }}"
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_sued_tuesday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean_2h') }}"

        - conditions:
            - condition: time
              weekday:
                - wed
          sequence:
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_ost_wednesday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean_2h') }}"
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_sued_wednesday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean_2h') }}"

        - conditions:
            - condition: time
              weekday:
                - thu
          sequence:
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_ost_thursday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean_2h') }}"
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_sued_thursday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean_2h') }}"

        - conditions:
            - condition: time
              weekday:
                - fri
          sequence:
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_ost_friday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_ost_level_mean_2h') }}"
            - service: input_number.set_value
              continue_on_error: true
              data:
                entity_id: input_number.boulderwelt_sued_friday_avg_2h
                value: "{{ states('sensor.boulderwelt_munchen_sued_level_mean_2h') }}"

- id: turn_on_fridge_for_meetings
  alias: "Turn on fridge for meetings"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - 10800) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) < 43200) and ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: not
        conditions:
          - condition: state
            entity_id: calendar.fabianseitz98_gmail_com
            attribute: message
            state: "Gruppentreffen"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
                - condition: state
                  entity_id: "switch.kuhlschrank"
                  state: "off"
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{ now().month < 4 and now().month > 10 }}"
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ now().month <= 10 and now().month >= 4 }}"
                    - condition: numeric_state
                      entity_id: sensor.weather_ebersberg_hourly
                      attribute: temperature
                      below: 6
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: "Erinnerung: Heute steht {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an."
                disable_notification: true
                inline_keyboard:
                  - "K√ºhlschrank anschalten:/fridge"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
                - condition: state
                  entity_id: input_boolean.abwesend_modus
                  state: "off"
                - condition: state
                  entity_id: "switch.kuhlschrank"
                  state: "off"
                - condition: template
                  value_template: "{{ now().month <= 10 and now().month >= 4 }}" #  Im Winter ist der Keller kalt genug, da muss der K√ºhlschrank nicht an sein.
                - condition: numeric_state
                  entity_id: sensor.weather_ebersberg_hourly
                  attribute: temperature
                  above: 5
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: "Anscheinend steht heute {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an, soll der K√ºhlschrank im Keller eingeschaltet werden?"
                disable_notification: true
                inline_keyboard:
                  - "Anschalten:/fridge"
    - choose:
        - conditions:
            - condition: state
              entity_id: "switch.kuhlschrank"
              state: "off"
            - condition: template
              value_template: "{{ now().month <= 10 and now().month >= 4 }}" #  Im Winter ist der Keller kalt genug, da muss der K√ºhlschrank nicht an sein.
            - condition: state
              entity_id: input_boolean.abwesend_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: !secret strasse
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: none
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: ""
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Monthly Meet"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen in Zorneding"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Geburtstagsfeier"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Spieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Karten- / Brettspieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Brettspieltreff"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Kartenspieleabend"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Anscheinend steht heute {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an, soll der K√ºhlschrank im Keller eingeschaltet werden?"
                disable_notification: true
                inline_keyboard:
                  - "Anschalten:/fridge"

- id: remind_for_door_for_meetings
  alias: "Remind for door for meetings"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - 43200) | round(-1) }}"
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - 43500) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) < 58000) and ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_door_for_meetings.attributes.last_triggered) | int > 7200 }}"
      - condition: template
        value_template: "{{ now().month <= 4 or now().month >= 10 }}" #  Im Sommer ist der Keller warm genug, da muss nicht die W√§rme vom Flur genutzt werden.
      - condition: state
        entity_id: person.fabian
        state: "home"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: !secret strasse
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: none
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Monthly Meet"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen in Zorneding"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Geburtstagsfeier"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Spieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Karten- / Brettspieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Kartenspieleabend"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Demn√§chst steht {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an. T√ºr im Keller √∂ffnen um die W√§rme vom Heizraum zu nutzen?"

- id: remind_for_DST_change_Winter_Sommerzeit_tomorrow
  alias: "Remind tomorrow for DST change - Winter/Sommerzeit"
  trigger:
    platform: time
    at: "12:00:00"
  condition:
    condition: template
    value_template: "{{ now().strftime('%j') == (now() + timedelta(days=1)).strftime('%j') }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ (now() + timedelta(days=1)).strftime('%Z') == 'CEST' }}" # Sommerzeitpr√ºfung
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                disable_notification: true
                message: Die Zeitumstellung ist morgen! Sommerzeit hat begonnen und die Uhrzeit wird um eine Stunde vorgestellt (eine Stunde weniger Schlaf).
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                disable_notification: true
                message: Die Zeitumstellung ist morgen! Sommerzeit hat begonnen und die Uhrzeit wird um eine Stunde vorgestellt (eine Stunde weniger Schlaf).
        - conditions:
            - condition: template
              value_template: "{{ (now() + timedelta(days=1)).strftime('%Z') == 'CET' }}" # Winterzeitpr√ºfung
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                disable_notification: true
                message: Die Zeitumstellung ist morgen! Winterzeit hat begonnen und die Uhrzeit wird um eine Stunde zur√ºckgestellt (eine Stunde mehr Schlaf).
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                disable_notification: true
                message: Die Zeitumstellung ist morgen! Winterzeit hat begonnen und die Uhrzeit wird um eine Stunde zur√ºckgestellt (eine Stunde mehr Schlaf).

- id: remind_for_DST_change_Winter_Sommerzeit
  alias: "Remind for DST change - Winter/Sommerzeit"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ now().timetuple().tm_isdst }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        disable_notification: true
        message: >
          Die Zeitumstellung hat stattgefunden!
          {%- if now().timetuple().tm_isdst | int > 0 -%}
            Sommerzeit hat begonnen und die Uhrzeit wird um eine Stunde vorgestellt (eine Stunde weniger Schlaf).
          {%- else -%}
            Winterzeit hat begonnen und die Uhrzeit wird um eine Stunde zur√ºckgestellt (eine Stunde mehr Schlaf).
          {%- endif -%}
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_samuel_dummy
        disable_notification: true
        message: >
          Die Zeitumstellung hat stattgefunden!
          {%- if now().timetuple().tm_isdst | int > 0 -%}
            Sommerzeit hat begonnen und die Uhrzeit wird um eine Stunde vorgestellt (eine Stunde weniger Schlaf).
          {%- else -%}
            Winterzeit hat begonnen und die Uhrzeit wird um eine Stunde zur√ºckgestellt (eine Stunde mehr Schlaf).
          {%- endif -%}

- id: notify_on_HA_restart
  alias: "Notify on HA restart"
  initial_state: true
  trigger:
    platform: homeassistant
    event: start
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_on_ha_restart.attributes.last_triggered) | int > 1800 }}"
  action:
    - service: frontend.set_theme
      data:
        name: transparentgray-LAB
    #  - service: button.press
    #  target:
    #  entity_id: button.synchronize_devices
    - service: switch.turn_on
      data:
        entity_id:
          - switch.bettlicht
          - switch.bett_gluhbirne
          - switch.lenovo_uhr
          - switch.rollo
          - switch.leds_wohnzimmer
    - choose:
        - conditions:
            - condition: time
              after: "03:10:00"
              before: "03:00:00"
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.automatic_ha_update.attributes.last_triggered) | int > 500 }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Homeassistant wurde soeben gestartet."

- id: turn_on_devices_on_tasmota_restart
  alias: Turn on devices on tasmota restart
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.bettlicht
      from: "unavailable"
      to: "off"
    - platform: state
      entity_id: switch.bettlicht
      from: "unavailable"
      to: "off"
    - platform: state
      entity_id: switch.bettlicht
      from: "unavailable"
      to: "off"
    - platform: state
      entity_id: switch.bettlicht
      from: "unavailable"
      to: "off"
  condition:
    - condition: state
      entity_id: "input_boolean.abwesend_modus"
      state: "off"
  action:
    - service: switch.turn_on
      data:
        entity_id:
          - switch.bettlicht
          - switch.bett_gluhbirne
          - switch.rollo
          - switch.lenovo_uhr
          - switch.leds_wohnzimmer

- id: run_bash_script_with_addon_bash_script_executer_every_hour
  alias: "Run Bash Script with Addon Bash Script Executer every hour"
  initial_state: false
  trigger:
    - platform: time_pattern
      minutes: "/59"
      seconds: 0
  action:
    - service: hassio.addon_start
      data:
        addon: 605cee21_bashscriptexecuter

- id: run_epicgames_free_addon_once_a_week
  alias: "Run Epic Games free addon once a week"
  initial_state: true
  trigger:
    - platform: time
      at: "17:05:00"
  condition:
    - condition: time
      weekday:
        - thu
  action:
    - service: hassio.addon_start
      data:
        addon: db21ed7f_epicgamesfree

- id: turn_on_away_mode
  alias: Turn on Away Mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.abwesend_modus
      to: "on"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.leiser_modus
    - service: switch.turn_off
      data:
        entity_id:
          # - switch.lampe_samuel_s_zimmer
          - switch.samuel_s_zimmer_usb_ports
          - switch.bett_gluhbirne
          - switch.bett_steckdose
          - switch.bettlicht
    - service: cover.close_cover
      target:
        entity_id: all
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
          sequence:
            # - service: climate.set_preset_mode
            #   data:
            #     entity_id: all
            #     preset_mode: "away"
            - service: climate.set_hvac_mode
              data:
                entity_id: all
                hvac_mode: auto
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:00:40"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: turn_off_away_mode
  alias: Turn off Away Mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.abwesend_modus
      to: "off"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.leiser_modus
    - service: switch.turn_on
      data:
        entity_id:
          # - switch.lampe_samuel_s_zimmer
          # - switch.samuel_s_zimmer_usb_ports
          - switch.bett_gluhbirne
          - switch.bettlicht
    - choose:
        - conditions:
            - condition: sun
              before: sunset
          sequence:
            - service: cover.open_cover
              target:
                entity_id: all
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
          sequence:
            # - service: climate.set_preset_mode
            #   data:
            #     entity_id: all
            #     preset_mode: "home"
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.fabian_s_zimmer
                hvac_mode: auto
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:00:40"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: turn_on_climate_off_mode
  alias: Turn on Climate Off mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.thermostate_aus
      to: "on"
  action:
    - service: climate.turn_off
      data:
        entity_id: all

- id: turn_off_climate_off_mode
  alias: Turn off Climate Off mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.thermostate_aus
      to: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: all
        hvac_mode: auto

- id: turn_on_guest_mode
  alias: Turn on Guest Mode mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.gast_modus
      to: "on"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.adaptive_lighting_guest_room
    - service: switch.turn_on
      data:
        entity_id:
          - switch.samuel_s_zimmer_usb_ports
          - switch.steckerleiste_samuel_s_zimmer

- id: turn_off_guest_mode
  alias: Turn on Guest Mode mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.gast_modus
      to: "off"
  action:
    - service: switch.turn_off
      data:
        entity_id:
          - switch.samuel_s_zimmer_usb_ports
          - switch.steckerleiste_samuel_s_zimmer

- id: turn_on_fs_strom
  alias: Turn on FS Strom
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.fabian_pc_strom
      to: "on"
    - platform: state
      entity_id: switch.fabian_schreibtisch
      to: "on"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.fabian_schreibtisch
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.fabian_pc_strom

- id: turn_off_fs_strom
  alias: Turn off FS Strom
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.fabian_pc_strom
      to: "off"
    - platform: state
      entity_id: switch.fabian_schreibtisch
      to: "off"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.fabian_schreibtisch_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.fabian_pc_shutdown
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.fabian_schreibtisch_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.fabian_pc_shutdown
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.fabian_schreibtisch_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.fabian_pc_shutdown
            - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.fabian_schreibtisch_power
                  above: 20
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der PC/Notebook ist noch an und konnte nicht heruntergefahren werden. Daher wurde der Strom nicht ausgeschaltet."
            - service: input_boolean.turn_on
              data:
                entity_id: input_boolean.fabian_pc_strom
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: numeric_state
                  entity_id: sensor.fabian_schreibtisch_power
                  below: 21
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.fabian_schreibtisch
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "off"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.fabian_pc_strom

- id: turn_on_vk_strom
  alias: Turn on SK Strom
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.samuel_pc_strom
      to: "on"
    - platform: state
      entity_id: switch.schreibtisch_samuel
      to: "on"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schreibtisch_samuel
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.samuel_pc_strom

- id: turn_off_vk_strom
  alias: Turn off SK Strom
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.samuel_pc_strom
      to: "off"
    - platform: state
      entity_id: switch.schreibtisch_samuel
      to: "off"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.md3f9bmc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.steckerleiste_samuel_energy_power
                  above: 20
          sequence:
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.md3f9bmc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.steckerleiste_samuel_energy_power
                  above: 20
          sequence:
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: numeric_state
                  entity_id: sensor.steckerleiste_samuel_energy_power
                  above: 20
          sequence:
            - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: and
              conditions:
                #- condition: state
                #  entity_id: device_tracker.md3f9bmc
                #  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "not_home"
                - condition: numeric_state
                  entity_id: sensor.steckerleiste_samuel_energy_power
                  above: 20
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der PC war noch an, obwohl du nicht mehr zu Hause bist. Der Schreibtischstrom wurde nun dennoch ausgeschaltet."
    - service: switch.turn_off
      data:
        entity_id: switch.schreibtisch_samuel
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.schreibtisch_samuel
              state: "off"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.samuel_pc_strom

- id: remind_for_away_mode
  alias: "Remind for away mode"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "home"
      to: "not_home"
      for:
        minutes: 1440
    - platform: state
      entity_id: person.samuel
      from: "home"
      to: "not_home"
      for:
        minutes: 1440
    - platform: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      above: 100000
      for:
        minutes: 5
    - platform: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      above: 100000
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: person.fabian
        state: not_home
      - condition: state
        entity_id: person.samuel
        state: not_home
      - condition: state
        entity_id: "input_boolean.abwesend_modus"
        state: "off"
      - condition: numeric_state
        entity_id: sensor.smart_life_fabian_distance
        above: 80000
      - condition: numeric_state
        entity_id: sensor.smart_life_samuel_distance
        above: 80000
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.kuhlschrank
              state: "on"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Abwesend Modus wurde aktiviert, da keiner daheim ist. Der K√ºhlschrank ist allerdings noch an, bitte ausschalten, falls 7 Tage oder mehr nicht in Verwendung."
            - service: notify.telegram_fabian
              data:
                message: "Abwesend Modus wurde aktiviert, da keiner daheim ist. Der K√ºhlschrank ist allerdings noch an, bitte ausschalten, falls 7 Tage oder mehr nicht in Verwendung."
      default:
        - service: notify.telegram_fabian
          data:
            message: "Abwesend Modus wurde aktiviert, da keiner daheim ist."
        - service: notify.telegram_fabian
          data:
            message: "Abwesend Modus wurde aktiviert, da keiner daheim ist."
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.abwesend_modus

- id: warn_for_state_change_if_in_away_mode
  alias: Warn for state change if in away mode
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - group.wohnzimmer
        - group.fabianszimmer
        - group.samuelszimmer
      from: "off"
      to: "on"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.abwesend_modus"
        state: "on"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.warn_for_state_change_if_in_away_mode.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "ACHTUNG! Es wurde ein Ger√§t eingeschaltet, obwohl der Abwesend Modus aktiviert ist!"
    - service: tts.speak
      continue_on_error: true
      target:
        entity_id: tts.google_de_de
      data:
        media_player_entity_id:
          - media_player.wohnzimmer_uhr
          - media_player.kuche_lautsprecher
          - media_player.samuels_lautsprecher
          - media_player.kuche_lautsprecher
          - media_player.fabians_lautsprecher
        message: Einbrecher sind nicht erw√ºnscht. Du wirst beobachtet und wurdest gefilmt. Verlasse die Wohnung sofort. Die Polizei wird gerufen.

- id: remind_for_pouring
  alias: "Remind for pouring"
  initial_state: false
  trigger:
    platform: time
    at: "16:30:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.abwesend_modus"
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_pouring.attributes.last_triggered) | int > 84600 }}"
      - condition: template
        value_template: "{{ as_timestamp(states.automation.telegram_pouring_done.attributes.last_triggered) | int > 18000 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                message: Bitte die Pflanzen gie√üen.
                target: !secret telegram_chat_fabian
                inline_keyboard:
                  - "Erledigt:/telegrampouringdone"
    - choose:
        - conditions:
            - condition: state
              entity_id: person.samuel
              state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                message: Bitte die Pflanzen gie√üen.
                target: !secret telegram_chat_samuel_dummy
                inline_keyboard:
                  - "Erledigt:/telegrampouringdone"

- id: remind_for_waste_collection
  alias: "Remind for waste collection"
  initial_state: true
  trigger:
    platform: time
    at: "16:00:00"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ (state_attr('sensor.nachste_abholungen', (now() + timedelta(days=1)).strftime('%Y-%m-%d')) != None) }}"
      #- condition: template
      #  value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_waste_put_outside.attributes.last_triggered) | int > 86400 }}"
  action:
    - service: whatsapp.send_buttons
      data:
        target: !secret whatsapp_vermieter
        message: >
          {% set tomorrow = (now() + timedelta(days=1)).strftime('%Y-%m-%d') %}
          {% set pickup = state_attr('sensor.nachste_abholungen', tomorrow) %}

          {% if pickup is not none %}
            {% set weekdays = {'Monday': 'Montag', 'Tuesday': 'Dienstag', 'Wednesday': 'Mittwoch', 'Thursday': 'Donnerstag', 'Friday': 'Freitag', 'Saturday': 'Samstag', 'Sunday': 'Sonntag'} %}
            {% set day_name = weekdays[strptime(tomorrow, '%Y-%m-%d').strftime('%A')] %}
            {% set date_german = as_timestamp(tomorrow) | timestamp_custom('%d.%m.%Y') %}
            {% set verb = 'werden' if ',' in pickup or ' und ' in pickup else 'wird' %}
            {% set items = pickup | replace('Restm√ºll', 'üóëÔ∏è *Restm√ºll*')
                                  | replace('Biotonne', 'üåø *Biotonne*')
                                  | replace('Gelber Sack', '‚ôªÔ∏è *Gelber Sack*')
                                  | replace('Altpapier', 'üìÑ *Altpapier*')
                                  | replace('Papiersamml', 'üìÑ *Papiersammlung*')
                                  | replace('Problemm√ºll', '‚ö†Ô∏è *Problemm√ºll*')
                                  | replace('Gartenabfall', 'üçÇ *Gartenabfall*') %}
            üì£ {{ day_name }}, {{ date_german }} (morgen) {{ verb }} {{ items }} abgeholt. Bitte rechtzeitig rausstellen! üöõ
          {% else %}
            Keine Abholung morgen.
          {% endif %}
        buttons:
          - text: "‚úÖ Erledigt"
            callback_data: "m√ºll_erledigt"
          - text: "üóìÔ∏è Alle Abholungen"
            callback_data: "m√ºllabholung"

- id: foodsharing_basket_available
  alias: "Foodsharing Basket Available"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.foodsharing_48_082236
    #  - platform: template
    #  value_template: {{ states.sensor.foodsharing_48_082236.attributes.baskets[-1]['id'] }}
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.foodsharing_48_082236
        above: "0"
      - condition: template
        value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
  action:
    - service: telegram_bot.send_message
      data:
        message: >
          {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}

          ------------

          {% if state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['picture'] %}
          [Bild]({{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['picture'] }})
          {% endif %}
          [Link](https://foodsharing.de/essenskoerbe/{{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['id'] }})

          {% if not state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['address'] in ['unavailable', 'none'] %}
          Adresse: {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['address'] }}
          {% endif %}

          {% if not state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['maps'] == 'unavailable' %}
          [Google Maps Link]({{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['maps'] }})
          {% endif %}
        target: !secret telegram_foodsharing

- id: foodsharing_basket_available_zorneding
  alias: "Foodsharing Basket Available Zorneding"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.foodsharing_48_082236
    #  - platform: template
    #  value_template: {{ states.sensor.foodsharing_48_082236.attributes.baskets[-1]['id'] }}
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.foodsharing_48_082236
        above: "0"
      - condition: template
        value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
      - condition: or
        conditions:
          - condition: template
            value_template: "{{'Zorneding' in state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['address'] }}"
          - condition: template
            value_template: "{{'Zorneding' in state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "Kai-Adri"
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 1500
          sequence:
            - service: notify.mobile_app_pixel_10_pro
              data:
                title: "Neuer Foodsharing Korb in Zorneding"
                message: >
                  {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.4
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 1500
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                title: "Neuer Foodsharing Korb in Zorneding"
                message: >
                  {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: "home"
                - condition: state
                  entity_id: person.kai
                  state: "Kai-Adri"
                - condition: state
                  entity_id: person.kai
                  state: "JUZ"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_kai
                title: "Neuer Foodsharing Korb in Zorneding"
                message: >
                  {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.adrian
                  state: "home"
                - condition: state
                  entity_id: person.adrian
                  state: "Kai-Adri"
                - condition: state
                  entity_id: person.adrian
                  state: "JUZ"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_adrian
                title: "Neuer Foodsharing Korb in Zorneding"
                message: >
                  {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}

- id: foodsharing_basket_available_muc_east
  alias: "Foodsharing Basket Available MUC East"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.foodsharing_48_117971
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.foodsharing_48_117971
        above: "0"
      - condition: template
        value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
  action:
    - service: telegram_bot.send_message
      data:
        message: >
          {{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['description'] }}

          ------------

          {% if state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['picture'] %}
          [Bild]({{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['picture'] }})
          {% endif %}
          [Link](https://foodsharing.de/essenskoerbe/{{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['id'] }})

          {% if not state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['address'] == 'unavailable' %}
          Adresse: {{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['address'] }}
          {% endif %}

          {% if not state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['maps'] == 'unavailable' %}
          [Google Maps Link]({{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['maps'] }})
          {% endif %}
        target: !secret telegram_foodsharing_muc

- id: too_good_to_go_food_available_zorneding
  alias: "Too good to go food Available Zorneding"
  initial_state: false
  trigger:
    - platform: time
      at: "12:15:00"
  condition:
    - condition: template
      value_template: "{{ (states.sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute.state | int) + (states.sensor.tgtg_neylas_feine_kost.state | int) + (states.sensor.tgtg_organic_garden_tagescafe_vaterstetten.state | int) > 0 }}"
    - condition: or
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "home"
  action:
    - service: telegram_bot.send_message
      data:
        message: >
          Es gibt noch {{ (states.sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute.state | int) + (states.sensor.tgtg_neylas_feine_kost.state | int) + (states.sensor.tgtg_cafe_bonjour_totalenergies_station_kantgtg_organic_garden_tagescafe_vaterstettentstrasse_wurzburg_uberraschungstute_abend.state | int) }} verf√ºgbare Reservierungen bei TGTG. Darunter:


          {% if (states.sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute.state)|int > 0 %}
          {{ state_attr('sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute', 'friendly_name') }}

          {{ state_attr('sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute', 'item_url') }}

          Preis: {{ state_attr('sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute', 'item_price') }} statt {{ state_attr('sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute', 'original_value') }}

          Abholung: {{ state_attr('sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute', 'pickup_start') }} Uhr bis {{ state_attr('sensor.tgtg_fruchtehaus_vaterstetten_uberraschungstute', 'pickup_end') }}


          {% endif %}
          {% if (states.sensor.tgtg_neylas_feine_kost.state)|int > 0 %}
          ---
          {{ state_attr('sensor.tgtg_neylas_feine_kost', 'friendly_name') }}

          {{ state_attr('sensor.tgtg_neylas_feine_kost', 'item_url') }}

          Preis: {{ state_attr('sensor.tgtg_neylas_feine_kost', 'item_price') }} statt {{ state_attr('sensor.tgtg_neylas_feine_kost', 'original_value') }}

          Abholung: {{ state_attr('sensor.tgtg_neylas_feine_kost', 'pickup_start') }} Uhr bis {{ state_attr('sensor.tgtg_neylas_feine_kost', 'pickup_end') }}


          {% endif %}
          {% if (states.sensor.tgtg_organic_garden_tagescafe_vaterstetten.state)|int > 0 %}
          ---
          {{ state_attr('sensor.tgtg_organic_garden_tagescafe_vaterstetten', 'friendly_name') }}

          {{ state_attr('sensor.tgtg_organic_garden_tagescafe_vaterstetten', 'item_url') }}

          Preis: {{ state_attr('sensor.tgtg_organic_garden_tagescafe_vaterstetten', 'item_price') }} statt {{ state_attr('sensor.tgtg_organic_garden_tagescafe_vaterstetten', 'original_value') }}

          Abholung: {{ state_attr('sensor.tgtg_organic_garden_tagescafe_vaterstetten', 'pickup_start') }} Uhr bis {{ state_attr('sensor.tgtg_organic_garden_tagescafe_vaterstetten', 'pickup_end') }}

          {% endif %}
        data:
          disable_web_page_preview: true
        target: !secret telegram_chat_fabian

- id: rewe_discount_keyword_available
  alias: "Rewe Discount Keyword available"
  initial_state: true
  trigger:
    - platform: time
      at: "06:40:00"
  condition:
    - condition: time
      weekday:
        - mon
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.rewe_440421
          state: "unavailable"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_juz_leiter
        data:
          disable_web_page_preview: true
        message: >
          Neue eventuell f√ºr das JUZ relevante Angebote im Rewe Zorneding Prospekt:
          {%- set product_list_loop = state_attr('sensor.rewe_440421', 'discounts') -%}
          {%- for product in product_list_loop -%}
            {% if 'Spezi' in product.product or 'Hell' in product.product or 'Chips' in product.product or 'Silenca' in product.product or 'Oettinger' in product.product %}
              {{ product.price.price }} ‚Ç¨ - {{ product.product }}
              {{ product.picture_link }}
            {%- endif -%}
          {%- endfor -%}

          ---

          #Angebote

    # - service: telegram_bot.send_message
    #   data_template:
    #     target: !secret telegram_chat_fabian
    #     message: >
    #       Neue Angebote diese Woche im Rewe Zorneding Prospekt:
    #       {%- set product_list_loop =  state_attr('sensor.rewe_440421', 'discounts') -%}
    #       {%- for product in product_list_loop -%}
    #         {% if 'Almighurt' in product.product or 'Ehrmann' in product.product or 'Oettinger' in product.product %}

    #       {{product.price.price }} ‚Ç¨ - {{product.product }}

    #       {{ product.picture_link }}
    #         {%- endif -%}
    #       {%- endfor -%}

- id: turn_off_deckenlampe_keller
  alias: "Turn off Deckenlampe Keller"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.fernseher_keller
      to: "off"
    - platform: state
      entity_id: light.flutlicht_keller
      to: "off"
  condition:
    - condition: state
      entity_id: switch.fernseher_keller
      state: "off"
    - condition: state
      entity_id: light.flutlicht_keller
      state: "off"
  action:
    - service: light.turn_off
      data:
        entity_id: light.deckenlampe_keller

- id: automatic_ha_updates
  alias: "Install All Updates on Sunday Night"
  description: Sends a Telegram message with available updates for integrations and installs them every Sunday night at 2 AM.
  trigger:
    - platform: time
      at: "02:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - sun
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        disable_notification: true
        message: >
          Updates will be installed for the following:

          {% set integration_updates = states.update | selectattr('entity_id', 'search', 'update.') | selectattr('state', 'eq', 'on') | list %}
          {% set addon_updates = state_attr('sensor.supervisor_updates', 'addons') %}

          {% if integration_updates | length > 0 %}
          **Integrations**:
          {%- for entity in integration_updates -%}
          - {{ state_attr(entity.entity_id, 'friendly_name') }} ({{ entity.entity_id }})
          {%- endfor %}
          {% else %}
          No integration updates available.
          {% endif %}

          {% if addon_updates is not none and addon_updates | length > 0 %}
          **Add-ons**:
          {%- for addon in addon_updates -%}
          - {{ addon.name }} (Latest: {{ addon.version_latest }})
          {%- endfor %}
          {% else %}
          No add-on updates available.
          {% endif %}
    - delay: "00:05:00"
    - service: homeassistant.update_entity
      target:
        entity_id: all
    - service: hassio.addon_update
      data:
        addon: all
  mode: single

- id: incoming_call_fabian
  alias: "Incoming Call Fabian"
  initial_state: true
  trigger:
    - platform: state
      entity_id: automation.incoming_call_fabian
      to: "test"
  condition:
    - condition: state
      entity_id: "input_boolean.leiser_modus"
      state: "off"
  action:
    - service: media_player.volume_set
      data:
        volume_level: >
          {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
        entity_id: media_player.wohnzimmer_uhr
    - service: tts.speak
      continue_on_error: true
      target:
        entity_id: tts.google_de_de
      data:
        media_player_entity_id:
          #- media_player.wohnzimmer_uhr
          - media_player.fabians_lautsprecher
        message: "Fabian wird soeben von {{ states('sensor.fs_caller') }} angerufen!"
    - service: media_player.media_pause
      data:
        entity_id: media_player.wohnzimmer_tv
    - delay: "00:00:09"
    - service: media_player.volume_set
      data:
        volume_level: >
          {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
        entity_id: media_player.wohnzimmer_uhr
    - service: media_player.turn_off
      data:
        entity_id: media_player.wohnzimmer_uhr
    - service: media_player.turn_off
      data:
        entity_id: media_player.fabians_lautsprecher
    - service: automation.turn_off
      data:
        entity_id: automation.incoming_call_fabian

- id: dwd_weather_warnings
  alias: "DWD Weather Warnings"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.gemeinde_zorneding_current_warning_level
      above: 1
  condition:
    condition: and
    conditions:
      #  Maximal zwei mal am Tag schreiben
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.dwd_weather_warnings.attributes.last_triggered) | int > 43200 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "2"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                disable_notification: true
                message: >
                  Aktuell Wetterwarnung vor markantem Wetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.

                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Bitte alles vom Balkon rein holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "2"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 20000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                disable_notification: true
                message: >
                  Aktuell Wetterwarnung vor markantem Wetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.

                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Bitte alles vom Balkon rein holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "2"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                disable_notification: true
                message: >
                  Aktuell Wetterwarnung vor markantem Wetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.


                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Es wird empfohlen alles von der Terrasse/Balkon rein zu holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "3"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: >
                  Aktuell Wetterwarnung vor Unwetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.

                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Bitte alles vom Balkon rein holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "3"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 30000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: >
                  Aktuell Wetterwarnung vor Unwetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.

                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Bitte alles vom Balkon rein holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "3"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: >
                  Aktuell Wetterwarnung vor Unwetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.


                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Es wird empfohlen alles von der Terrasse/Balkon rein zu holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "4"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 40000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: >
                  *ACHTUNG!!!!* Aktuell Wetterwarnung vor extremen Unwetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.

                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Bitte alles vom Balkon rein holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "4"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 40000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: >
                  *ACHTUNG!!!!* Aktuell Wetterwarnung vor extremen Unwetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.

                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Bitte alles vom Balkon rein holen!{% endif %}*
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "4"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: >
                  *ACHTUNG!!!!* Aktuell Wetterwarnung vor extremen Unwetter in {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.region_name }}.

                  *{{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_headline }}*

                  {{ states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description }}


                  Voraussichtlich ab {{  states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_end }} Uhr.


                  *{% if 'b√∂e' in states.sensor.gemeinde_zorneding_current_warning_level.attributes.warning_1_description %}Es wird empfohlen alles von der Terrasse/Balkon rein zu holen!{% endif %}*

- id: server_temp_warning
  alias: "Server Temp Warning"
  initial_state: false
  trigger:
    - platform: numeric_state
      entity_id: sensor.processor_temperature
      above: 60
    - platform: numeric_state
      entity_id: sensor.processor_temperature
      above: 76
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.server_temp_warning.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "ACHTUNG! Server Temperatur sehr hoch: {{ states.sensor.processor_temperature.state }}"

- id: server_ram_load_warning
  alias: "Server RAM Load Warning"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.memory_use_percent
      above: 85
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.server_ram_load_warning.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "ACHTUNG! Server RAM Auslastung sehr hoch: {{ states.sensor.memory_use_percent.state }}"

- id: turn_on_schloss_on_button_press
  alias: Turn on Schloss on button press
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_button.schloss
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    - delay: "00:00:03"
    - service: switch.turn_on
      data:
        entity_id: switch.schloss

- id: turn_schloss_off_after_turning_on
  alias: Turn Schloss off after turning on
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.schloss
      to: "on"
  action:
    - delay: "00:00:02"
    - service: switch.turn_off
      data:
        entity_id: switch.schloss

- id: turn_on_keller_deckenlampe_on_steckerleiste
  alias: Turn on Keller Deckenlampe on Steckerleiste
  initial_state: false
  trigger:
    - platform: state
      entity_id: switch.frei_keller
      from: "off"
      to: "on"
  action:
    - service: light.turn_on
      data:
        entity_id: light.deckenlampe_keller

- id: turn_off_keller_deckenlampe_on_steckerleiste
  alias: Turn off Keller Deckenlampe on Steckerleiste
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.frei_keller
      to: "off"
  action:
    - service: light.turn_off
      data:
        entity_id: light.deckenlampe_keller

- id: fabi_phone_battery_low
  alias: Fabi Phone Battery low
  initial_state: false
  trigger:
    - platform: numeric_state
      entity_id: sensor.pixel_8_pro_battery_level
      below: 5
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.fabi_phone_battery_low.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data:
        title: "Fabi Akku unter 5%"
        target: !secret telegram_chat_samuel_dummy
        message: ""

- id: mute_cast_music_ads
  alias: Mute Cast Music ads (Spotify, YouTube Music, Deezer, Soundcloud, etc.)
  initial_state: true
  mode: parallel
  max: 20
  trigger:
    - platform: state
      entity_id:
        - media_player.bedroom_tv
        - media_player.schlafzimmer_tv
        - media_player.smart_tv_pro
        - media_player.wohnzimmer_tv
        - media_player.kuche_lautsprecher
        - media_player.schlafzimmer
        - media_player.wohnzimmer_uhr
  condition:
    - condition: template
      value_template: >
        {% set attrs = trigger.to_state.attributes %}
        {% set eid = trigger.entity_id %}
        {% set app = (attrs.app_name | default('') | string | lower) %}
        {% set cid = (attrs.media_content_id | default('') | string | lower) %}
        {% set dur = (attrs.media_duration | default(0) | float(0)) %}
        {% set title = (attrs.media_title | default('') | string | lower) %}
        {% set artist = (attrs.media_artist | default('') | string | lower) %}
        {% set is_muted = attrs.is_volume_muted | default(false) %}

        {% set streaming_apps = ['spotify', 'youtube', 'youtube music', 'soundcloud', 'deezer', 'bluetooth audio'] %}

        {# YouTube Shorts: duration < 40s but no title AND no artist #}
        {% set is_yt_short = (app == 'youtube' and dur > 0 and dur < 40 and title == '' and artist == '') %}

        {# Rule 1: Spotify Specific (Cast) #}
        {% set is_spotify_ad = (app == 'spotify' and (
          cid.startswith('spotify:ad:') or
          cid.startswith('spotify:advertisment:') or
          ('spotify' in cid and 'advertisment' in cid)
        )) %}

        {# Rule 2: Bluetooth Spotify #}
        {% set is_bt_ad = (app == 'bluetooth audio' and (
          (title in ['advertisement', 'werbung', 'sparkasse', 'mehr erfahren', 'arbeitgeber land hesse']) or
          (title == '‚Äî' and dur > 0 and dur < 40) or
          (dur >= 27 and dur <= 31) or
          (dur > 0 and dur < 40 and artist in ['spotify', 'sparkasse', 'prime video', 'sparkasse s√ºdpfalz', 'Sparda-Bank', 'Leapmotor', 'XXXLutz', 'EMIL FREY', 'Salesperson', 'LEAPMOTOR'])
        )) %}

        {# Rule 3: General Streaming Apps with duration < 40s (ignoring YT Shorts AND Bluetooth) #}
        {% set is_short_ad = (app in ['spotify', 'youtube', 'youtube music', 'soundcloud', 'deezer'] and dur > 0 and dur < 40 and not is_yt_short) %}

        {# Final Result #}
        {{ (is_spotify_ad or is_bt_ad or is_short_ad) and not is_muted }}
  action:
    - variables:
        eid: "{{ trigger.entity_id }}"
        # Volume Capture Ladder: from_state -> current_state -> fallback 0.2
        # We avoid capturing 0.0 if already muted by previous parallel run
        prev_volume: >
          {% set from_vol = trigger.from_state.attributes.volume_level | default(-1) | float %}
          {% set to_vol = trigger.to_state.attributes.volume_level | default(-1) | float %}
          {% if from_vol > 0.0 %}
            {{ from_vol }}
          {% elif to_vol > 0.0 %}
            {{ to_vol }}
          {% else %}
            0.2
          {% endif %}
        was_muted: "{{ trigger.from_state.attributes.is_volume_muted | default(false) }}"
    - service: media_player.volume_mute
      continue_on_error: true
      data:
        entity_id: "{{ eid }}"
        is_volume_muted: true
    - service: media_player.volume_set
      continue_on_error: true
      data:
        entity_id: "{{ eid }}"
        volume_level: 0.0
    - delay: >
        {% if eid in ['media_player.bedroom_tv', 'media_player.schlafzimmer_tv', 'media_player.smart_tv_pro', 'media_player.wohnzimmer_tv'] %}
          00:00:01
        {% else %}
          00:00:00
        {% endif %}
    - wait_template: >
        {% set st = states(eid) %}
        {% set app = (state_attr(eid, 'app_name') | default('') | string | lower) %}
        {% set cid = (state_attr(eid, 'media_content_id') | default('') | string | lower) %}
        {% set dur = (state_attr(eid, 'media_duration') | default(0) | float(0)) %}
        {% set title = (state_attr(eid, 'media_title') | default('') | string | lower) %}
        {% set artist = (state_attr(eid, 'media_artist') | default('') | string | lower) %}

        {% set streaming_apps = ['spotify', 'youtube', 'youtube music', 'soundcloud', 'deezer', 'bluetooth audio'] %}

        {# YouTube Shorts logic (strictly dur > 0) #}
        {% set is_yt_short = (app == 'youtube' and dur > 0 and dur < 40 and title == '' and artist == '') %}

        {% set is_spotify_ad = (app == 'spotify' and (
          cid.startswith('spotify:ad:') or
          cid.startswith('spotify:advertisment:') or
          ('spotify' in cid and 'advertisment' in cid)
        )) %}

        {% set is_bt_ad = (app == 'bluetooth audio' and (
          (title in ['advertisement', 'werbung', 'sparkasse', 'mehr erfahren', 'arbeitgeber land hesse', 'Sparda-Bank']) or
          (title == '‚Äî' and dur > 0 and dur < 40) or
          (dur >= 27 and dur <= 31) or
          (dur > 0 and dur < 40 and artist in ['spotify', 'sparkasse', 'prime video', 'sparkasse s√ºdpfalz', 'Leapmotor', 'XXXLutz', 'EMIL FREY', 'Salesperson', 'LEAPMOTOR'])
        )) %}

        {# Release ONLY if confirmed music (>40s), confirmed Short, or stopped #}
        {% set is_confirmed_music = (dur >= 40) or (app in ['spotify', 'bluetooth audio'] and not is_spotify_ad and not is_bt_ad and dur > 0) %}
        {% set is_ad = is_spotify_ad or is_bt_ad or (app != 'bluetooth audio' and app in streaming_apps and dur > 0 and dur < 40 and not is_yt_short) %}
        {{ st in ['idle', 'off', 'unavailable'] or not is_ad }}
      timeout: "00:06:00"
      continue_on_timeout: true
    - service: media_player.volume_set
      continue_on_error: true
      data:
        entity_id: "{{ eid }}"
        volume_level: "{{ prev_volume }}"
    - service: media_player.volume_mute
      continue_on_error: true
      data:
        entity_id: "{{ eid }}"
        is_volume_muted: "{{ was_muted }}"

- id: turn_off_devices_after_power_loss
  alias: Turn off devices after power loss
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - light.bett_gluhbirne
      from: "unavailable"
      to: "on"
  action:
    - service: light.turn_on
      data:
        entity_id:
          - light.bett_gluhbirne

- id: low_battery_thermostats
  alias: Low battery thermostats
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.bad_battery_state
        - binary_sensor.fabian_s_zimmer_battery_state
      from: "off"
      to: "on"
      for:
        hours: 4
    - platform: state
      entity_id:
        - climate.wohnzimmer
        - climate.samuel_s_zimmer
      to: "unavailable"
      for:
        hours: 2
  condition:
    condition: not
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.low_battery_thermostats.attributes.last_triggered) | int > 43200 }}"
      - condition: state
        entity_id: climate.bad
        state: "unavailable"
      - condition: state
        entity_id: climate.fabian_s_zimmer
        state: "unavailable"
  action:
    - service: notify.telegram_fabian
      data:
        message: >
          Die Batterie im Thermostat
          {% if is_state('climate.wohnzimmer', 'unavailable') %}
          Wohnzimmer
          {% endif %}
          {% if is_state('climate.samuel_s_zimmer', 'unavailable') %}
          Samuels Zimmer
          {% endif %}
          {% if is_state('binary_sensor.fabian_s_zimmer_battery_state', 'on') %}
          fabian_s_zimmer
          {% endif %}
          {% if is_state('binary_sensor.bad_battery_state', 'on') %}
          Bad
          {% endif %}
          ist
          {% if is_state('binary_sensor.fabian_s_zimmer_battery_state', 'on') or is_state('binary_sensor.bad_battery_state', 'on') %}
          bald
          {% else %}
          KOMPLETT
          {% endif %}
          leer. Bitte auswechseln! Luftfeuchtigkeitsautomationen & Temperatureinstellungen funktionieren so lange nur eingeschr√§nkt.
    - service: notify.telegram_fabian
      data:
        message: >
          Die Batterie im Thermostat
          {% if is_state('climate.wohnzimmer', 'unavailable') %}
          Wohnzimmer
          {% endif %}
          {% if is_state('climate.samuel_s_zimmer', 'unavailable') %}
          Samuels Zimmer
          {% endif %}
          {% if is_state('binary_sensor.fabian_s_zimmer_battery_state', 'on') %}
          fabian_s_zimmer
          {% endif %}
          {% if is_state('binary_sensor.bad_battery_state', 'on') %}
          Bad
          {% endif %}
          ist
          {% if is_state('binary_sensor.fabian_s_zimmer_battery_state', 'on') or is_state('binary_sensor.bad_battery_state', 'on') %}
          bald
          {% else %}
          KOMPLETT
          {% endif %}
          leer. Bitte auswechseln! Luftfeuchtigkeitsautomationen & Temperatureinstellungen funktionieren so lange nur eingeschr√§nkt.

- id: cast_ha_to_tv_if_idle
  alias: Cast HA to TV if idleing
  trigger:
    - platform: state
      entity_id: media_player.wohnzimmer_tv
      to:
        - "idle"
        - "standby"
      for:
        minutes: 3
  action:
    action: cast.show_lovelace_view
    data:
      entity_id: media_player.wohnzimmer_tv_cast
      view_path: cast

- id: fritzbox_public_ip_change
  alias: Fritzbox Public IP Change
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.fritz_box_3490_external_ip
      not_from:
        - "unavailable"
        - "unknown"
        - ""
        - "Unknown"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.fritzbox_no_internet_access.attributes.last_triggered) | int > 360 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.fritz_box_3490_external_ip
          state: "unavailable"
        - condition: state
          entity_id: sensor.fritz_box_3490_external_ip
          state: ""
        - condition: state
          entity_id: sensor.fritz_box_3490_external_ip
          state: "unknown"
  action:
    - service: notify.telegram_fabian
      data:
        message: "√ñffentliche IP hat sich ge√§ndert zu {{ states.sensor.fritz_box_3490_external_ip.state }}"

#   - id: turn_on_fritzbox_wifi_if_miwifi_is_off
#     alias: Turn on Fritzbox Wifi if Miwifi is off
#     initial_state: true
#     trigger:
#       - platform: state
#         entity_id: sbinary_sensor.xiaomi_abd8_wan_state
#         state: "not_connected"
#       - platform: template
#         value_template: "{{ if not is_state('sbinary_sensor.xiaomi_abd8_wan_state', 'connected'}}"
#     condition:
#       - condition: template
#         value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_fritzbox_wifi_if_miwifi_is_off.attributes.last_triggered) | int > 360 }}"
#       - condition: not
#         conditions:
#           - condition: state
#             entity_id: 'binary_sensor.fritz_box_3490_connection'
#             state: 'not_connected'
#     action:
#       - service: notify.telegram_fabian
#         data:
#           message: 'Miwifi hat kein Internet'

- id: fritzbox_no_internet_access
  alias: Fritzbox no Internet access
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.fritz_box_3490_connection
      from: "Connected"
      to: "Not_Connected"
      for:
        seconds: 15
  condition:
    condition: and
    conditions:
      - condition: time
        after: "10:30:00"
        before: "22:30:00"
      - condition: state
        entity_id: "input_boolean.leiser_modus"
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: person.samuel
            state: home
          - condition: state
            entity_id: person.fabian
            state: home
          - condition: template
            value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.fritzbox_no_internet_access.attributes.last_triggered) | int > 1200 }}"
  action:
    #  - service: rest_command.assistant_broadcast
    #    data:
    #      command: Die Fritzbox hat keine Internet Verbindung und wird nun neugestartet.
    #      user: "homeassistant"
    - service: tts.speak
      continue_on_error: true
      target:
        entity_id: tts.google_de_de
      data:
        media_player_entity_id:
          - media_player.fabians_lautsprecher
          - media_player.wohnzimmer_uhr
          - media_player.kuche_lautsprecher
          - media_player.samuels_lautsprecher
        message: "Die Fritzbox hat keine Internet Verbindung und wird nun neugestartet."
    - service: fritz.reboot
      data:
        host: 192.168.178.1
    - service: automation.turn_on
      data:
        entity_id: automation.fritzbox_internet_access_returned
    - service: automation.turn_off
      data:
        entity_id: automation.fritzbox_no_internet_access

- id: fritzbox_internet_access_returned
  alias: Fritzbox Internet access returned
  initial_state: false
  trigger:
    - platform: state
      entity_id: binary_sensor.fritz_box_3490_connection
      from: "Not_Connected"
      to: "Connected"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "10:30:00"
        before: "22:30:00"
      - condition: state
        entity_id: "input_boolean.leiser_modus"
        state: "off"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            #  - service: rest_command.assistant_broadcast
            #    data:
            #      command: Die Internetverbindung ist wiederhergestellt.
            #      user: "homeassistant"
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.fabians_lautsprecher
                  - media_player.wohnzimmer_uhr
                  - media_player.kuche_lautsprecher
                  - media_player.samuels_lautsprecher
                message: "Die Internetverbindung ist wiederhergestellt."
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Die Fritzbox Internet Verbundung wurde verloren und wurde soeben wiederhergestellt."
    - service: automation.turn_on
      data:
        entity_id: automation.fritzbox_no_internet_access
    - service: automation.turn_off
      data:
        entity_id: automation.fritzbox_internet_access_returned

#  - id: internet_speed_test_poor_fabian
#    alias: Internet Speed Test Poor Fabian
#
#    initial_state: true
#    trigger:
#      - platform: template
#        value_template: "{{ states('sensor.speedtest_download')|float < 40 }}"
#    condition:
#      - condition: template
#        value_template: "{{ states.device_tracker.google_maps_112174659110860535869.state == 'home' }}"
#    action:
#      - service: notify.telegram_fabian
#        data:
#          message: 'Die Internetgeschwindigkeit ist aktuell langsam ( {{ states.sensor.speedtest_download }} Mbit/s ). Eventuell die Fritzbox neustarten?'

#  - id: internet_speed_test_poor_fabian
#    alias: Internet Speed Test Poor samuel
#
#    initial_state: true
#    trigger:
#      - platform: template
#        value_template: "{{ states('sensor.speedtest_download')|float < 30 }}"
#    condition:
#      - condition: template
#        value_template: "{{ states.device_tracker.google_maps_112056758146194246561.state == 'home' }}"
#      - condition: state
#        entity_id: device_tracker.md3f9bmc
#        state: home
#    action:
#      - service: notify.telegram_fabian
#        data:
#          message: 'Die Internetgeschwindigkeit ist aktuell langsam. Eventuell die Fritzbox neustarten?'

#  - id: update_tasmota
#    alias: Update Tasmota
#    initial_state: true
#    trigger:
#      - platform: numeric_state
#        entity_id: sensor.latest_tasmota
#        above: 0
#    action:
#      - service: notify.telegram_fabian
#        data:
#          message: 'Alle Tasmota Ger√§te werden aktualisiert auf Version {{ states.sensor.latest_tasmota.state }}.'
#      - service: mqtt.publish
#        data:
#          topic: cmnd/tasmotas/Upgrade
#          payload: 1

- id: deckenlampe_button_hold
  alias: Deckenlampe Button Hold
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: d75263b1d81c803aac073abd2257aa2d
      type: button_long_press
      subtype: button_1
      discovery_id: 68C63A87B4BF_button_1_HOLD
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: "Light Livingroom"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_wohnzimmer
                  state: "off"
                - condition: state
                  entity_id: light.leds_wohnzimmer
                  state: "unavailable"
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.stehlampe
                  state: "off"
                - condition: state
                  entity_id: light.stehlampe
                  state: "unavailable"
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_wohnzimmer_tv
                  state: "off"
                - condition: state
                  entity_id: light.leds_wohnzimmer_tv
                  state: "unavailable"
          sequence:
            #  - service: light.turn_off
            #    data:
            #      area_id: 7c05afe47efd44f5a0a064769ad6e105 # Wohnzimmer
            #      transition: 2
            #      brightness: 255
            - service: light.turn_on
              data:
                entity_id: light.stehlampe
                transition: 2
                brightness: 255
                color_temp: 225
            - service: light.turn_on
              data:
                entity_id: light.leds_wohnzimmer
                transition: 2
                brightness: 255
                rgb_color: [255, 255, 255]
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_wohnzimmer
                  state: "on"
                  for:
                    seconds: 2
                - condition: state
                  entity_id: light.stehlampe
                  state: "on"
                  for:
                    seconds: 2
                - condition: state
                  entity_id: light.leds_wohnzimmer_tv
                  state: "on"
                  for:
                    seconds: 2
          sequence:
            - service: light.turn_off
              data:
                area_id: 7c05afe47efd44f5a0a064769ad6e105 # Wohnzimmer

- id: deckenlampe_button_double_press
  alias: Deckenlampe Button double press
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: d75263b1d81c803aac073abd2257aa2d
      type: button_double_press
      subtype: button_1
      discovery_id: 68C63A87B4BF_button_1_DOUBLE
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "on"
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.fernseher
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "off"
          sequence:
            - service: switch.turn_on
              data:
                entity_id: switch.fernseher

- id: keller_power_strip_double_press
  alias: Keller power strip double press
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: ebf8e0a468385963dc6561b555ce4e4f
      type: button_double_press
      subtype: button_1
      discovery_id: 24A16007D751_button_1_DOUBLE
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: light.deckenlampe_keller
              state: "on"
          sequence:
            - service: light.turn_off
              data:
                entity_id: light.deckenlampe_keller
    - choose:
        - conditions:
            - condition: state
              entity_id: light.deckenlampe_keller
              state: "off"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.deckenlampe_keller

- id: lichtschalter_button_hold
  alias: Lichtschalter Button Hold
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: 564e0bea23153d99c590e8fe2ef83464
      type: button_long_press
      subtype: button_1
      discovery_id: 68C63AA72808_button_1_HOLD
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: "Light Sleepingroom"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.bett_gluhbirne
                      state: "off"
                    - condition: state
                      entity_id: light.bett_gluhbirne
                      state: "unavailable"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.yeelink_bslamp2_22e2_light
                      state: "off"
                    - condition: state
                      entity_id: light.yeelink_bslamp2_22e2_light
                      state: "unavailable"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.leds_tisch
                      state: "off"
                    - condition: state
                      entity_id: light.leds_tisch
                      state: "unavailable"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.regal
                      state: "off"
                    - condition: state
                      entity_id: light.regal
                      state: "unavailable"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.leds_tisch
                brightness: 255
                transition: 2
            - service: light.turn_on
              data:
                entity_id:
                  - light.bett_gluhbirne
                  - light.yeelink_bslamp2_22e2_light
                brightness: 255
                color_temp: 225
                transition: 2
            - service: light.turn_on
              entity_id: light.regal
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_tisch
                  state: "on"
                  for:
                    seconds: 2
                - condition: state
                  entity_id: light.bett_gluhbirne
                  state: "on"
                  for:
                    seconds: 2
                - condition: state
                  entity_id: light.regal
                  state: "on"
                  for:
                    seconds: 2
                - condition: state
                  entity_id: light.yeelink_bslamp2_22e2_light
                  state: "on"
                  for:
                    seconds: 2
          sequence:
            - service: light.turn_off
              data:
                area_id:
                  - 33e9a108bf1948e5848f156e0851d50c # Fabians Zimmer

- id: lichtschalter_button_double_press
  alias: Lichtschalter Button double press
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: 564e0bea23153d99c590e8fe2ef83464
      type: button_double_press
      subtype: button_1
      discovery_id: 68C63AA72808_button_1_DOUBLE
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "on"
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.fabian_schreibtisch
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_schreibtisch
              state: "off"
          sequence:
            - service: switch.turn_on
              data:
                entity_id: switch.fabian_schreibtisch

- id: restart_bluetooth_on_tv
  alias: Restart Bluetooth on TV
  initial_state: false
  trigger:
    - platform: state
      entity_id: automation.restart_bluetooth_on_tv
      to: "on"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.wohnzimmer_tv
        state: "home"
  action:
    - service: androidtv.adb_command
      data:
        entity_id: media_player.wohnzimmer_tv
        command: "settings put global bluetooth_disabled_profiles 0"
    - delay: "00:00:01"
    - service: androidtv.adb_command
      data:
        entity_id: media_player.wohnzimmer_tv
        command: "settings put global bluetooth_disabled_profiles 1"
    - service: automation.turn_off
      data:
        entity_id: automation.restart_bluetooth_on_tv

- id: notify_for_high_humidity
  alias: Notify for high humidity
  trigger:
    - platform: numeric_state
      entity_id:
        - climate.samuel_s_zimmer
        - climate.wohnzimmer
        - climate.fabian_s_zimmer
        - climate.bad
      attribute: current_humidity
      above: 60
    - platform: state
      entity_id: person.fabian
      from: "not_home"
      to: "home"
      for:
        minutes: 3
    - platform: state
      entity_id: person.samuel
      from: "not_home"
      to: "home"
      for:
        minutes: 3
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.leiser_modus
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_for_high_humidity.attributes.last_triggered) | int > 7200 }}"
      - condition: not
        conditions:
          - condition: state
            entity_id: automation.notify_for_high_humidity
            attribute: last_triggered
            state: none
      - condition: or
        conditions:
          - condition: state
            entity_id: person.samuel
            state: home
          - condition: state
            entity_id: person.fabian
            state: home
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: climate.samuel_s_zimmer
            attribute: current_humidity
            above: 60
          - condition: numeric_state
            entity_id: climate.wohnzimmer
            attribute: current_humidity
            above: 60
          - condition: numeric_state
            entity_id: climate.fabian_s_zimmer
            attribute: current_humidity
            above: 60
          - condition: numeric_state
            entity_id: climate.bad
            attribute: current_humidity
            above: 60
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "on"
              - condition: time
                before: "21:30:00"
              - condition: time
                after: "08:00:00"
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "off"
              - condition: time
                before: "22:00:00"
              - condition: time
                after: "11:00:00"
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: media_player.kuche_lautsprecher
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.kuche_lautsprecher
                - delay: 00:00:05
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.kuche_lautsprecher
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) %}
                      Willkommen zur√ºck Fabi und Samuel
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zur√ºck Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) %}
                      Willkommen zur√ºck Samuel.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.samuel_s_zimmer.attributes.current_humidity) > 60 %}
                      von Samuel,
                      {% endif %}
                      {% if (states.climate.fabian_s_zimmer.attributes.current_humidity) > 60 %}
                      von Fabi,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte l√ºften.
                - delay: 00:00:05
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.kuche_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: media_player.fabians_lautsprecher
                  state: "off"
                - condition: template
                  value_template: "{{ as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240 }}"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.fabians_lautsprecher
                - delay: 00:00:05
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.fabians_lautsprecher
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) %}
                      Willkommen zur√ºck Fabi und Samuel
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zur√ºck Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) %}
                      Willkommen zur√ºck Samuel.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.samuel_s_zimmer.attributes.current_humidity) > 60 %}
                      von Samuel,
                      {% endif %}
                      {% if (states.climate.fabian_s_zimmer.attributes.current_humidity) > 60 %}
                      von Fabi,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte l√ºften.
                - delay: 00:00:05
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.fabians_lautsprecher
        - choose:
            - conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "off"
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
                - condition: state
                  entity_id: input_boolean.gast_modus
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.wohnzimmer_uhr
                - delay: 00:00:05
                - service: tts.speak
                  continue_on_error: true
                  target:
                    entity_id: tts.google_de_de
                  data:
                    media_player_entity_id: media_player.wohnzimmer_uhr
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) %}
                      Willkommen zur√ºck Fabi und Samuel
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zur√ºck Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.samuel.last_changed) | int < 240) %}
                      Willkommen zur√ºck Samuel.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.samuel_s_zimmer.attributes.current_humidity) > 60 %}
                      von Samuel,
                      {% endif %}
                      {% if (states.climate.fabian_s_zimmer.attributes.current_humidity) > 60 %}
                      von Fabi,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte l√ºften.
                - delay: 00:00:03
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.wohnzimmer_uhr
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_tv
                      state: "unavailable"
              sequence:
                - service: notify.wohnzimmer_tv
                  continue_on_error: true
                  data:
                    message: >
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.samuel_s_zimmer.attributes.current_humidity) > 60 %}
                      von Samuel,
                      {% endif %}
                      {% if (states.climate.fabian_s_zimmer.attributes.current_humidity) > 60 %}
                      von Fabi,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte l√ºften.

- id: notify_for_extreme_high_humidity
  alias: Notify for extreme high humidity
  trigger:
    - platform: numeric_state
      entity_id:
        - climate.samuel_s_zimmer
        - climate.wohnzimmer
        - climate.fabian_s_zimmer
        - climate.bad
      attribute: current_humidity
      above: 69
  condition:
    - condition: time
      after: "06:00:00"
    - condition: state
      entity_id: person.samuel
      state: not_home
    - condition: state
      entity_id: person.fabian
      state: not_home
    - condition: state
      entity_id: "input_boolean.abwesend_modus"
      state: "off"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_for_extreme_high_humidity.attributes.last_triggered) | int > 32400 }}"
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.smart_life_fabian_distance
              below: 89000
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: >
                  Achtung, sehr hohe Luftfeuchtigkeit:{% if (states.climate.samuel_s_zimmer.attributes.current_humidity) > 67 %}

                  Luftfeuchtigkeit Samuels Zimmer{{ states.climate.samuel_s_zimmer.attributes.current_humidity }} %.{% endif %}
                  {% if (states.climate.wohnzimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Wohnzimmer{{ states.climate.wohnzimmer.attributes.current_humidity }} %.{% endif %}
                  {% if (states.climate.fabian_s_zimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit fabian_s_zimmer{{ states.climate.fabian_s_zimmer.attributes.current_humidity }} %.{% endif %}
                  {% if (states.climate.bad.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Bad{{ states.climate.bad.attributes.current_humidity }} %.{% endif %}
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.smart_life_fabian_distance
              below: 89000
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: >
                  Achtung, sehr hohe Luftfeuchtigkeit:{% if (states.climate.samuel_s_zimmer.attributes.current_humidity) > 67 %}

                  Luftfeuchtigkeit Samuels Zimmer{{ states.climate.samuel_s_zimmer.attributes.current_humidity }} %.{% endif %}
                  {% if (states.climate.wohnzimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Wohnzimmer{{ states.climate.wohnzimmer.attributes.current_humidity }} %.{% endif %}
                  {% if (states.climate.fabian_s_zimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit fabian_s_zimmer{{ states.climate.fabian_s_zimmer.attributes.current_humidity }} %.{% endif %}
                  {% if (states.climate.bad.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Bad{{ states.climate.bad.attributes.current_humidity }} %.{% endif %}

- id: detect_if_coal_lighter_is_currently_active
  alias: Detect if coal lighter is currently active
  initial_state: true
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 380
      below: 1000
      for:
        seconds: 35
    - platform: state
      entity_id: switch.kohleanzunder
      to: "on"
      for:
        minutes: 1
    - platform: state
      entity_id: input_button.kohleanzunder_timer
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 1080 }}"
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: sensor.keller_steckdose_energy_power
                above: 380
              - condition: state
                entity_id: switch.kohleanzunder
                state: "on"
          - condition: template
            value_template: "{{ as_timestamp(now()) - as_timestamp(states.input_button.kohleanzunder_timer.state) | int < 30 }}"
  action:
    - service: automation.turn_off
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
    - choose:
        #  IF 5 friends are there
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: "JUZ"
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.flo
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: "Kohleanz√ºnder wurde eingeschaltet."
        #  ELSEIF only K&A are there
        - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: person.kai
                          state: home
                        - condition: state
                          entity_id: person.adri
                          state: home
                    - condition: not
                      conditions:
                        - condition: state
                          entity_id: person.flo
                          state: home
                        - condition: state
                          entity_id: person.maxi
                          state: home
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.adri
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.kai
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_afk
                message: "Kohleanz√ºnder wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.adri
                  state: home
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.adri
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_adrian
                message: "Kohleanz√ºnder wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Kohleanz√ºnder wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: "Kohleanz√ºnder wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
      #  ELSE only notify fabian
      default:
        - service: telegram_bot.send_message
          data:
            target: !secret telegram_chat_fabian
            message: "Kohleanz√ºnder wurde eingeschaltet."
            inline_keyboard:
              - "Dauer:/remaining_time"
    #- delay: "00:09:00"
    #- choose:
    #    #  IF 5 friends are there
    #    - conditions:
    #        - condition: or
    #          conditions:
    #            - condition: state
    #              entity_id: person.flo
    #              state: home
    #            - condition: state
    #              entity_id: person.maxi
    #              state: home
    #            - condition: state
    #              entity_id: person.fabian
    #              state: "JUZ"
    #      sequence:
    #        - service: telegram_bot.send_message
    #          data:
    #            target: !secret telegram_chat_5friends
    #            message: "Bitte Kohle wenden."
    #        - service: notify.mobile_app_pixel_10_pro
    #          data:
    #            message: "Bitte Kohle wenden"
    #            data:
    #              push:
    #                sound:
    #                  name: "default"
    #                  critical: 1
    #                  volume: 0.7
    #    #  ELSEIF only K&A are there
    #    - conditions:
    #        - condition: or
    #          conditions:
    #            - condition: and
    #              conditions:
    #                - condition: and
    #                  conditions:
    #                    - condition: state
    #                      entity_id: person.kai
    #                      state: home
    #                    - condition: state
    #                      entity_id: person.adri
    #                      state: home
    #                - condition: not
    #                  conditions:
    #                    - condition: state
    #                      entity_id: person.flo
    #                      state: home
    #                    - condition: state
    #                      entity_id: person.maxi
    #                      state: home
    #            - condition: and
    #              conditions:
    #                - condition: state
    #                  entity_id: person.fabian
    #                  state: "Kai-Adri"
    #                - condition: state
    #                  entity_id: person.adri
    #                  state: "Kai-Adri"
    #                - condition: state
    #                  entity_id: person.kai
    #                  state: "Kai-Adri"
    #      sequence:
    #        - service: telegram_bot.send_message
    #          data:
    #            target: !secret telegram_chat_afk
    #            message: "Bitte Kohle wenden."
    #        - service: notify.mobile_app_pixel_10_pro
    #          data:
    #            message: "Bitte Kohle wenden"
    #            data:
    #              push:
    #                sound:
    #                  name: "default"
    #                  critical: 1
    #                  volume: 0.7
    #    - conditions:
    #        - condition: or
    #          conditions:
    #            - condition: state
    #              entity_id: person.adri
    #              state: home
    #            - condition: and
    #              conditions:
    #                - condition: state
    #                  entity_id: person.fabian
    #                  state: "Kai-Adri"
    #                - condition: state
    #                  entity_id: person.adri
    #                  state: "Kai-Adri"
    #      sequence:
    #        - service: telegram_bot.send_message
    #          data:
    #            target: !secret telegram_chat_adrian
    #            message: "Bitte Kohle wenden."
    #        - service: telegram_bot.send_message
    #          data:
    #            target: !secret telegram_chat_fabian
    #            message: "Bitte Kohle wenden."
    #        - service: notify.mobile_app_pixel_10_pro
    #          data:
    #            message: "Bitte Kohle wenden"
    #            data:
    #              push:
    #                sound:
    #                  name: "default"
    #                  critical: 1
    #                  volume: 0.7
    #    #  ELSE only notify fabian
    #    - conditions:
    #        - condition: and
    #          conditions:
    #            - condition: state
    #              entity_id: person.samuel
    #              state: home
    #        - condition: not
    #          conditions:
    #            - condition: state
    #              entity_id: person.fabian
    #              state: home
    #      sequence:
    #        - service: telegram_bot.send_message
    #          data:
    #            target: !secret telegram_chat_samuel_dummy
    #            message: "Bitte Kohle wenden."
    #  default:
    #    - service: telegram_bot.send_message
    #      data:
    #        target: !secret telegram_chat_fabian
    #        message: "Bitte Kohle wenden."
    #    - service: notify.mobile_app_pixel_10_pro
    #      data:
    #        message: "Bitte Kohle wenden"
    #        data:
    #          push:
    #            sound:
    #              name: "default"
    #              critical: 1
    #              volume: 0.7
    #- choose:
    #    - conditions:
    #        - condition: not
    #          conditions:
    #            - condition: state
    #              entity_id: media_player.keller_tv
    #              state: unavailable
    #      sequence:
    #        - service: androidtv.adb_command
    #          continue_on_error: true
    #          data:
    #            entity_id: media_player.keller_tv
    #            command: "pm clear com.tcl.videoplayer"
    #        - service: androidtv.adb_command
    #          continue_on_error: true
    #          data:
    #            entity_id: media_player.keller_tv
    #            command: "am start -a android.intent.action.VIEW -d /sdcard/jonny_rozay_shisha_smoke.mp4 -t video/mp4"
    #        #  - service: notify.keller_tv
    #        #    continue_on_error: true
    #        #    data:
    #        #      message: "Bitte Kohle wenden."
    - delay: "00:06:00"
    #  - choose:
    #      - conditions:
    #          - condition: not
    #            conditions:
    #              - condition: state
    #                entity_id: media_player.keller_tv
    #                state: unavailable
    #        sequence:
    #          - service: notify.keller_tv
    #            continue_on_error: true
    #            data:
    #              message: "Der Eisschlauch kann schon mal geholt werden."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: JUZ
                - condition: state
                  entity_id: person.fabian
                  state: "Kai-Adri"
                - condition: template
                  value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 14400 }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Der Eisschlauch kann schon mal geholt werden."
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: template
                  value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 14400 }}"
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: "Der Eisschlauch kann schon mal geholt werden."
    - delay: "00:02:00"
    - service: switch.turn_off
      data:
        entity_id: switch.kohleanzunder
    - delay: "00:01:00"
    - choose:
        #  IF 5 friends are there
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: "JUZ"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: "Die Kohle sollte fertig sein! Strom ausschalten nicht vergessen."
            - service: notify.mobile_app_pixel_10_pro
              data:
                message: "Die Kohle sollte fertig sein! Strom ausschalten nicht vergessen."
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.7
        #  ELSEIF only K&A are there
        - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: person.kai
                          state: home
                        - condition: state
                          entity_id: person.adri
                          state: home
                    - condition: not
                      conditions:
                        - condition: state
                          entity_id: person.flo
                          state: home
                        - condition: state
                          entity_id: person.maxi
                          state: home
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.adri
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.kai
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_afk
                message: "Die Kohle sollte fertig sein! Strom ausschalten nicht vergessen."
            - service: notify.mobile_app_pixel_10_pro
              data:
                message: "Die Kohle sollte fertig sein!"
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.7
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.adri
                  state: home
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.adri
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_adrian
                message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
            - service: notify.mobile_app_pixel_10_pro
              data:
                message: "Die Kohle sollte fertig sein!"
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.7
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_samuel_dummy
                message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
      #  ELSE only notify fabian
      default:
        - service: telegram_bot.send_message
          data:
            target: !secret telegram_chat_fabian
            message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
        - service: notify.mobile_app_pixel_10_pro
          data:
            message: "Die Kohle sollte fertig sein!"
            data:
              push:
                sound:
                  name: "default"
                  critical: 1
                  volume: 0.7
    - service: automation.turn_on
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: unavailable
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "pm clear com.tcl.videoplayer"
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/bitte_gib_mir_die_shisha.mp4 -t video/mp4"
            - service: notify.keller_tv
              continue_on_error: true
              data:
                message: "Die Kohle sollte fertig sein!"

- id: check_if_coal_lighter_has_been_forgotten
  alias: Check if coal_lighter has been forgotten
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.kohleanzunder
      to: "on"
      for:
        minutes: 25
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int > 1260 }}"
      - condition: state
        entity_id: switch.kohleanzunder
        state: "on"
  action:
    - choose:
        #  IF 5 friends are there
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: "JUZ"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_5friends
                message: "Der Kohleanzunder wurde vor 25 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
        #  ELSEIF only K&A are there
        - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: and
                      conditions:
                        - condition: state
                          entity_id: person.kai
                          state: home
                        - condition: state
                          entity_id: person.adri
                          state: home
                    - condition: not
                      conditions:
                        - condition: state
                          entity_id: person.flo
                          state: home
                        - condition: state
                          entity_id: person.maxi
                          state: home
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.adri
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.kai
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_afk
                message: "Der Kohleanzunder wurde vor 25 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.adri
                  state: home
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: "Kai-Adri"
                    - condition: state
                      entity_id: person.adri
                      state: "Kai-Adri"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_adrian
                message: "Der Kohleanzunder wurde vor 25 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Der Kohleanzunder wurde vor 25 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
      #  ELSE only notify fabian
      default:
        - service: telegram_bot.send_message
          data:
            target: !secret telegram_chat_fabian
            message: "Der Kohleanzunder wurde vor 25 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."

- id: check_if_washing_machine_has_been_forgotten
  alias: Check if washing machine has been forgotten
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.waschmaschine
      to: "on"
      for:
        hours: 6
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int > 21650 }}"
      - condition: state
        entity_id: switch.waschmaschine
        state: "on"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine wurde vor 6 Stunden eingeschaltet aber die Automation nicht gestartet. Fehler und W√§sche wurde vergessen?"
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine wurde vor 6 Stunden eingeschaltet aber die Automation nicht gestartet. Fehler und W√§sche wurde vergessen?"

- id: detect_if_washing_machine_is_currently_active
  alias: Detect if Washing machine is currently active
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 22
      below: 469
      for:
        seconds: 40
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 1800
      for:
        seconds: 5
    - platform: state
      entity_id: switch.waschmaschine
      to: "on"
      for:
        minutes: 8
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int > 3600 }}"
      - condition: state
        entity_id: switch.waschmaschine
        state: "on"
      - condition: numeric_state
        entity_id: sensor.keller_steckdose_energy_power
        above: 22
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 89000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Die Waschmaschine wurde gestartet. W√§hle das Waschprogramm aus um eine Zeit zu erhalten, wann die Waschmaschine fertig ist:"
                data:
                  inline_keyboard:
                    - "30¬∞ PL:/washerstart30, 40¬∞ PL:/washerstart40, 40¬∞ Koch-Bunt:/washerstart40kb, 20¬∞ Fein:/washerstart20fw, 60¬∞ Koch-Bunt:/washerstart60kb"
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 55000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Die Waschmaschine wurde gestartet. W√§hle das Waschprogramm aus um eine Zeit zu erhalten, wann die Waschmaschine fertig ist:"
                data:
                  inline_keyboard:
                    - "30¬∞ PL:/washerstart30, 40¬∞ PL:/washerstart40, 40¬∞ Koch-Bunt:/washerstart40kb, 20¬∞ Fein:/washerstart20fw, 60¬∞ Koch-Bunt:/washerstart60kb"
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Running
    - service: automation.turn_on
      data:
        entity_id:
          - automation.set_washing_machine_active_when_power_detected
          - automation.set_washing_machine_clean_when_power_drops
    - service: automation.turn_off
      data:
        entity_id:
          - automation.detect_if_coal_lighter_is_currently_active
          - automation.detect_if_washing_machine_is_currently_active

- id: set_washing_machine_active_when_power_detected
  alias: Set washing machine active when power detected
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 22
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: sensor.washing_machine_state
        state: Idle
      - condition: state
        entity_id: sensor.washing_machine_state
        state: Clean
      - condition: state
        entity_id: sensor.washing_machine_state
        state: Finishing
      #  - condition: template
      #    value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 50 }}"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Running

#  When the power drops, move the state of the washing machine to Clean
- id: set_washing_machine_clean_when_power_drops
  alias: Set washing machine clean when power drops
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      below: 6
      for:
        minutes: 3
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_select.washing_machine_status
        state: Running
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 900 }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.set_washing_machine_active_when_power_detected.attributes.last_triggered) | int > 1680 }}"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Clean
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 35000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Die Waschmaschine ist fertig. Bitte ausr√§umen."
                data:
                  inline_keyboard:
                    - "Erledigt:/telegramwasherdone"
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 35000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Die Waschmaschine ist fertig. Bitte ausr√§umen."
                data:
                  inline_keyboard:
                    - "Erledigt:/telegramwasherdone"
    - service: automation.turn_on
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
          - automation.detect_if_coal_lighter_is_currently_active
    - service: switch.turn_off
      data:
        entity_id: switch.waschmaschine
    - service: automation.turn_off
      data:
        entity_id: automation.set_washing_machine_clean_when_power_drops
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "playing"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.wohnzimmer_uhr
                message: "Die Waschmaschine ist fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_lautsprecher
                  state: "playing"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.kuche_lautsprecher
                message: "Die Waschmaschine ist fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.fabians_lautsprecher
                  state: "playing"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.fabians_lautsprecher
                message: "Die Waschmaschine ist fertig."

- id: set_washing_machine_idle_after_timeout
  alias: Set washing machine idle after timeout
  trigger:
    - platform: state
      entity_id: input_select.washing_machine_status
      to: Clean
      for:
        minutes: 120
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Idle

- id: resume_music_in_keller_after_shisha_video
  alias: Resume music in keller after shisha video
  initial_state: true
  trigger:
    - platform: state
      entity_id: media_player.keller_tv
      attribute: app_id
      from: com.tcl.videoplayer
  action:
    - service: media_player.media_play
      data:
        entity_id: media_player.keller_tv

- id: remind_for_finished_rice_cooker
  alias: Remind for finished rice cooker
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.xiaomi_miio_cooker_remaining
      below: 5
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_finished_rice_cooker.attributes.last_triggered) | int > 1200 }}"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
            - service: notify.telegram_fabian
              data:
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "playing"
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.wohnzimmer_uhr
                  - media_player.kuche_lautsprecher
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
    - service: input_select.select_option
      data:
        entity_id: input_select.rice_cooker_program
        option: schnelles Kochen

- id: turn_on_rice_cooker_when_timer_started
  alias: "Turn on rice cooker when timer started"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (states.input_datetime.cooker_start_time.attributes.timestamp) | round(-1) }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.kuchengerate
    - delay: 00:01:00
    - service: switch.turn_on
      data:
        entity_id: switch.xiaomi_miio_cooker
    - service: notify.telegram_fabian
      data:
        message: "Der Reiskocher wurde automatisch angeschaltet im Programm {{ states.input_select.rice_cooker_program.state }}."
    - service: notify.telegram_fabian
      data:
        message: "Der Reiskocher wurde automatisch angeschaltet im Programm {{ states.input_select.rice_cooker_program.state }}."

- id: set_rice_cooker_menu_state
  alias: "Set ricecooker menu state"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.xiaomi_miio_cooker_menu
      not_from:
        - "unavailable"
        - "unknown"
        - ""
        - "Unknown"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Fine Rice"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Kochen 1h"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Keep warm"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "W√§rmen"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Quick Rice"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "schnelles Kochen"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Congee"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Porridge"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Unknown menu"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Sonstiges"

- id: remind_for_finished_airfryer
  alias: Remind for finished airfryer
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.careli_maf05a_d482_left_time
      below: 5
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_finished_airfryer.attributes.last_triggered) | int > 1200 }}"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der Airfryer ist in {{ states.sensor.careli_maf05a_d482_left_time.state }} Minuten fertig."
            - service: notify.telegram_fabian
              data:
                message: "Der Airfryer ist in {{ states.sensor.careli_maf05a_d482_left_time.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "playing"
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id:
                  - media_player.wohnzimmer_uhr
                  - media_player.kuche_lautsprecher
                message: "Der Airfryer ist in {{ states.sensor.careli_maf05a_d482_left_time.state }} Minuten fertig."

- id: kitchen_timer_reminder
  alias: Kitchen Timer Reminder
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.kuche_lautsprecher_timers
      below: 5
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: switch.fernseher
        state: "on"
      - condition: state
        entity_id: switch.fernseher_keller
        state: "on"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der Timer in der K√ºche ist in {{ states.sensor.kuche_lautsprecher_timers.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: person.samuel
              state: home
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der Timer in der K√ºche ist in {{ states.sensor.kuche_lautsprecher_timers.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "on"
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.wohnzimmer_uhr
                message: "Der Timer in der K√ºche ist in {{ states.sensor.kuche_lautsprecher_timers.state }} Minuten fertig."

- id: turn_off_kitchen_devices_after_x_minutes
  alias: "Turn off kitchen devices after x minutes"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.kuchengerate
      to: "on"
      for:
        minutes: 20
    - platform: state
      entity_id: switch.kuchengerate
      from: "off"
      to: "on"
      for:
        minutes: 25
    - platform: state
      entity_id: switch.xiaomi_miio_cooker
      from: "on"
      to: "off"
      for:
        minutes: 40
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.xiaomi_miio_cooker
        state: "off"
      - condition: state
        entity_id: switch.kuchengerate
        state: "on"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.kuchengerate

#   - id: turn_on_airplane_mode_fabi
#     alias: 'Turn on Airplane Mode Fabi'
#     initial_state: true
#     trigger:
#       - platform: time
#         at: '23:30:00'
#       - platform: time
#         at: '03:30:00'
#     condition:
#       condition: and
#       conditions:
#         - condition: time
#           weekday:
#             - mon
#             - tue
#             - wed
#             - thu
#             - sun
#         - condition: state
#           entity_id: device_tracker.pixel_8_pro
#           state: home
#         - condition: template
#           value_template: >
#             {% set domain = 'light' %}
#             {% set state = 'off' %}
#             {{ states[domain] | count == states[domain] | selectattr('state','eq', state) | list | count }}
#     action:
#       - service: notify.mobile_app_pixel_10_pro
#         data:
#           title: "Flugmodus"
#           message: "Flugmodus wurde vergessen und wird nun automatisch aktiviert!"
#         data:
#           data:
#             tag: 'notification-about-sensor'

- id: check_termostat_sleepingroom
  alias: "check thermostats"
  initial_state: true
  trigger:
    platform: time
    at: "19:40:00"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.adaptive_lighting_sleeping_room
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.fabian_s_zimmer
                  state: "auto"
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
          sequence:
            #  - service: notify.telegram_fabian
            #    data:
            #      message: "Das Thermostat in Fabians Zimmer war noch auf {{ states.climate.fabian_s_zimmer.attributes.temperature }} ¬∞C eingestellt und wurde nun automatisch eingeschaltet."
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.fabian_s_zimmer
                hvac_mode: auto

- id: pill_reminder
  alias: "Pill Reminder"
  trigger:
    platform: time
    at: "19:50:00"
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: "29"
          sequence:
            - service: counter.increment
              target:
                entity_id: counter.pille
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: 30
              above: 28
          sequence:
            - service: counter.reset
              target:
                entity_id: counter.pille
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: "21"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Pille nehmen nicht vergessen! Heute ist Tag {{ states.counter.pille.state }} von {{ (states.counter.pille.attributes.maximum) - 1 }}."
                data:
                  inline_keyboard:
                    - "Erledigt:/pilldone, Erinnern in 1h:/pill1h"
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: 22
              above: 20
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Pille nehmen nicht vergessen! Heute ist der letze Tag, an dem du die Pille nehmen musst. Ab morgen kommen f√ºr 7 Tage keine Erinnerungen."
                data:
                  inline_keyboard:
                    - "Erledigt:/pilldone, Erinnern in 1h:/pill1h, Durchnehmen:/pillreset"
            - service: notify.telegram_fabian
              data:
                message: "Heute ist der letze Tag, an dem samuel die Pille nimmt f√ºr 7 Tage."

- id: samuel_forgot_pill
  alias: "samuel forgot pill"
  initial_state: false
  trigger:
    - platform: time
      at: "23:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - sun
      - condition: not
        conditions:
          - condition: state
            entity_id: automation.telegram_pill_marked_done
            attribute: last_triggered
            state: none
      - condition: numeric_state
        entity_id: counter.pille
        below: "22"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_pill_marked_done.attributes.last_triggered) | int > 10800 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.samuel
              state: home
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.fabians_lautsprecher
                message: "Samuel, du hast die Pille vergessen"
    - service: notify.telegram_fabian
      data:
        message: "Du hast die Pille vergessen!"
    - service: notify.mobile_app_samuel_iphone
      data:
        message: "Du hast die Pille vergessen!"
        data:
          push:
            sound:
              name: "default"
              critical: 1
              volume: 1.0

- id: samuel_forgot_pill_weekend
  alias: "samuel forgot pill weekend"
  initial_state: false
  trigger:
    - platform: time
      at: "00:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - fri
          - sat
      - condition: not
        conditions:
          - condition: state
            entity_id: automation.telegram_pill_marked_done
            attribute: last_triggered
            state: none
      - condition: numeric_state
        entity_id: counter.pille
        below: 22
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_pill_marked_done.attributes.last_triggered) | int > 14760 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.samuel
              state: home
          sequence:
            - service: tts.speak
              continue_on_error: true
              target:
                entity_id: tts.google_de_de
              data:
                media_player_entity_id: media_player.fabians_lautsprecher
                message: "Samuel, du hast die Pille vergessen"
    - service: notify.telegram_fabian
      data:
        message: "Du hast die Pille vergessen!"
    - service: notify.mobile_app_samuel_iphone
      data:
        message: "Du hast die Pille vergessen!"
        data:
          push:
            sound:
              name: "default"
              critical: 1
              volume: 1.0

- id: turn_off_everything_in_keller_if_tv_is_unavailable
  alias: Turn off everything in keller if tv is unavailable
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    to: "unavailable"
    for:
      minutes: 10
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.fernseher_keller
        state: "off"
      - condition: state
        entity_id: switch.strom_keller
        state: "off"
  action:
    #- service: switch.turn_off
    #  data:
    #    entity_id: switch.kuhlschrank
    - service: switch.turn_off
      data:
        entity_id: switch.keller_usb_ports

- id: remind_for_light_keller
  alias: Remind for light keller
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    from: "unavailable"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "17:00:00"
        before: "00:00:00"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_light_keller.attributes.last_triggered) | int > 12000 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: group.fabianszimmer
            state: "on"
          - condition: state
            entity_id: group.wohnzimmer
            state: "on"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: >
          Es ist noch Licht oder Strom an im
          {% if (is_state("group.fabianszimmer", "on")) -%}
          fabian_s_zimmer
          {% endif %}
          {% if (is_state("group.wohnzimmer", "on")) -%}
          Wohnzimmer
          {% endif %}
          {% if (is_state("group.samuelszimmer", "on")) -%}
          & Samuels Zimmer
          {% endif %}
          . Ausschalten?

- id: set_climate_living_room_if_in_keller
  alias: Set climate living room if in keller
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    from: "unavailable"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "17:00:00"
        before: "00:00:00"
  action:
    - service: climate.turn_off
      data:
        entity_id: climate.wohnzimmer

- id: set_climate_living_room_if_samuel_and_fabi_at_pc
  alias: Set climate living room if samuel and fabi at PC
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "home"
    - platform: state
      entity_id: device_tracker.md3f9bmc
      to: "home"
    - platform: state
      entity_id: device_tracker.c_pf38fwqx_pari
      to: "home"
    - platform: state
      entity_id: device_tracker.md3f9bmc
      to: "home"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "off"
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.fabian_pc
            state: "home"
          - condition: state
            entity_id: device_tracker.c_pf38fwqx_pari
            state: "home"
          - condition: not
            conditions:
              - condition: state
                entity_id: person.fabian
                state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "switch.schreibtisch_samuel"
            state: "on"
          - condition: not
            conditions:
              - condition: state
                entity_id: person.samuel
                state: "home"
  action:
    - service: climate.set_temperature
      data:
        entity_id: climate.wohnzimmer
        temperature: 16
        hvac_mode: heat
    - service: automation.turn_on
      data:
        entity_id: automation.set_climate_living_room_if_samuel_and_fabi_not_at_pc

- id: set_climate_living_room_if_samuel_and_fabi_not_at_pc
  alias: Set climate living room if samuel and fabi not at PC
  initial_state: false
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "not_home"
    - platform: state
      entity_id: device_tracker.md3f9bmc
      to: "not_home"
    - platform: state
      entity_id: device_tracker.c_pf38fwqx_pari
      to: "not_home"
    - platform: state
      entity_id: switch.schreibtisch_samuel
      to: "off"
  condition:
    - condition: state
      entity_id: "input_boolean.thermostate_aus"
      state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: auto
    - service: automation.turn_off
      data:
        entity_id: automation.set_climate_living_room_if_samuel_and_fabi_not_at_pc

- id: remind_for_guest_mode
  alias: remind for guest mode
  initial_state: false
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    to: "unavailable"
    for:
      minutes: 5
  condition:
    condition: and
    conditions:
      - condition: time
        after: "23:00:00"
        before: "06:00:00"
      - condition: state
        entity_id: "input_boolean.gast_modus"
        state: "off"
      - condition: not
        conditions:
          - condition: state
            entity_id: calendar.fabianseitz98_gmail_com
            attribute: message
            state: "Gruppentreffen"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.gast_modus
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "√úbernachtet heute ein Gast? Gast Modus wurde automatisch eingeschaltet."
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_samuel_dummy
        message: "√úbernachtet heute ein Gast? Gast Modus wurde automatisch eingeschaltet."

- id: set_climate_living_room_if_keller_left
  alias: Set climate living room if keller left
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    to: "unavailable"
    for:
      minutes: 10
  condition:
    condition: and
    conditions:
      - condition: time
        after: "17:00:00"
        before: "00:00:00"
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: auto

- id: notify_on_sbahn_delay_home_work
  alias: "Notify Fabi on sbahn delay Home -> Work"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ state_attr('sensor.zorneding_departures_via_starnberg_nord', 'next_departures')[0]['delayArrival'] | int > 5 }}"
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.pixel_8_pro
            state: home
          - condition: state
            entity_id: device_tracker.redmi_note_10_pro
            state: home
      - condition: time
        after: "06:30:00"
        before: "07:10:00"
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.pixel_8_pro
              state: home
          sequence:
            - service: notify.telegram_fabian
              data:
                title: "Sbahn um {{ state_attr('sensor.zorneding_departures_via_starnberg_nord', 'next_departures')[0]['scheduledDeparture'] }} hat +{{ state_attr('sensor.zorneding_departures_via_starnberg_nord', 'next_departures')[0]['delayDeparture'] }} min Versp√§tung."
                message: "N√§chste Sbahn: {{ state_attr('sensor.zorneding_departures_via_starnberg_nord', 'next_departures')[1]['scheduledDeparture'] }} Uhr"

- id: notify_fabian_on_sbahn_delay_work_home
  alias: "Notify on Sbahn delay Work -> Home"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['delayArrival'] | int > 3 }}"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "16:45:00"
        before: "17:30:00"
        weekday:
          - mon
          - tue
          - wed
          - thu
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: numeric_state
        entity_id: sensor.smart_life_fabian_distance
        below: 89000
      - condition: numeric_state
        entity_id: sensor.smart_life_fabian_distance
        above: 20000
      - condition: not
        conditions:
          - condition: state
            entity_id: person.fabian
            state: home
  action:
    - service: notify.telegram_fabian
      data:
        title: "Sbahn um {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['scheduledDeparture'] }} hat +{{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['delayDeparture'] }} min Versp√§tung."
        message: "N√§chste Sbahn: {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[1]['scheduledDeparture'] }} Uhr"

- id: notify_samuel_fabian_on_way_home
  alias: "Notify samuel Fabian on way home"
  initial_state: false
  trigger:
    - platform: state
      entity_id: sensor.smart_life_fabian_direction_of_travel
      to: "towards"
      for:
        minutes: 6
  condition:
    - condition: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      above: 3000
    - condition: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      below: 30000
    - condition: state
      entity_id: person.samuel
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_longer_distance.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_long_distance.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 3700 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "Arbeit Fabi"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause und ist noch {{ states.sensor.smart_life_fabian_distance.state }} km entfernt von zu Hause."

- id: notify_samuel_fabian_on_way_home_longer_distance
  alias: "Notify samuel Fabian on way home longer distance"
  initial_state: false
  trigger:
    - platform: state
      entity_id: sensor.smart_life_fabian_direction_of_travel
      to: "towards"
      for:
        minutes: 22
  condition:
    - condition: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      above: 29000
    - condition: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      below: 90000
    - condition: state
      entity_id: person.samuel
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_longer_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_long_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 4700 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "Arbeit Fabi"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause und ist noch {{ states.sensor.smart_life_fabian_distance.state }} km entfernt von zu Hause."

- id: notify_samuel_fabian_on_way_home_long_distance
  alias: "Notify samuel Fabian on way home long distance"
  initial_state: false
  trigger:
    - platform: state
      entity_id: sensor.smart_life_fabian_direction_of_travel
      to: "towards"
      for:
        minutes: 50
  condition:
    - condition: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      above: 89000
    - condition: state
      entity_id: person.samuel
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_longer_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_long_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 4600 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "Arbeit Fabi"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause und ist noch {{ states.sensor.smart_life_fabian_distance.state }} km entfernt von zu Hause."

- id: notify_fabian_samuel_on_way_home
  alias: "Notify Fabian samuel on way home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.smart_life_fabian_direction_of_travel
      to: "towards"
      for:
        minutes: 8
  condition:
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      above: 3000
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 30000
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home_longer_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home_long_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.samuel
          state: "arbeit_samuel"
        - condition: state
          entity_id: person.samuel
          state: "Arbeit samuel"
        - condition: state
          entity_id: person.samuel
          state: "Berufsschule"
  action:
    - service: notify.telegram_fabian
      data:
        message: "samuel ist auf dem Weg nach Hause und ist noch {{ states.sensor.smart_life_samuel_distance.state }} km entfernt von zu Hause."

- id: notify_fabian_samuel_on_way_home_longer_distance
  alias: "Notify Fabian samuel on way home longer distance"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.smart_life_samuel_direction_of_travel
      to: "towards"
      for:
        minutes: 15
  condition:
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      above: 29000
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 90000
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home_longer_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home_long_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.samuel
          state: "arbeit_samuel"
        - condition: state
          entity_id: person.samuel
          state: "Berufsschule"
  action:
    - service: notify.telegram_fabian
      data:
        message: "samuel ist auf dem Weg nach Hause und ist noch {{ states.sensor.smart_life_samuel_distance.state }} km entfernt von zu Hause."

- id: notify_fabian_samuel_on_way_home_long_distance
  alias: "Notify Fabian samuel on way home long distance"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.smart_life_samuel_direction_of_travel
      to: "towards"
      for:
        minutes: 30
  condition:
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      above: 89000
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home_longer_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_samuel_on_way_home_long_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.samuel
          state: "arbeit_samuel"
        - condition: state
          entity_id: person.samuel
          state: "Berufsschule"
  action:
    - service: notify.telegram_fabian
      data:
        message: "samuel ist auf dem Weg nach Hause und ist noch {{ states.sensor.smart_life_samuel_distance.state }} km entfernt von zu Hause."

- id: notify_samuel_fabian_on_way_home_from_sta
  alias: "Notify samuel Fabian on way home from STA"
  initial_state: false
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 3600 }}"
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 35000
    - condition: numeric_state
      entity_id: sensor.smart_life_fabian_distance
      above: 10000
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.samuel
                  state: home
                - condition: state
                  entity_id:
                    - input_boolean.leiser_modus
                    - input_boolean.gast_modus
                  state: "off"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.kuche_lautsprecher
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.kuche_lautsprecher
                        - delay: 00:00:02
                        - service: tts.speak
                          continue_on_error: true
                          target:
                            entity_id: tts.google_de_de
                          data:
                            media_player_entity_id: media_player.kuche_lautsprecher
                            message: "Fabian ist auf dem Weg nach Hause und kommt voraussichtlich um {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['arrival'] }} Uhr mit {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['delayDeparture'] }} min Versp√§tung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.kuche_lautsprecher
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.samuels_lautsprecher
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.samuels_lautsprecher
                        - delay: 00:00:02
                        - service: tts.speak
                          continue_on_error: true
                          target:
                            entity_id: tts.google_de_de
                          data:
                            media_player_entity_id: media_player.samuels_lautsprecher
                            message: "Fabian ist auf dem Weg nach Hause und kommt voraussichtlich um {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['arrival'] }} Uhr mit {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['delayDeparture'] }} min Versp√§tung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.samuels_lautsprecher
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.wohnzimmer_uhr
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.wohnzimmer_uhr
                        - delay: 00:00:02
                        - service: tts.speak
                          continue_on_error: true
                          target:
                            entity_id: tts.google_de_de
                          data:
                            media_player_entity_id: media_player.wohnzimmer_uhr
                            message: "Fabian ist auf dem Weg nach Hause und kommt voraussichtlich um {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['arrival'] }} Uhr mit {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['delayDeparture'] }} min Versp√§tung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.wohnzimmer_uhr
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause von Starnberg und kommt voraussichtlich um {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['arrival'] }} Uhr mit {{ state_attr('sensor.starnberg_nord_departures_via_zorneding', 'next_departures')[0]['delayDeparture'] }} min Versp√§tung in Zorneding an."

- id: notify_samuel_fabian_on_way_home_from_gil
  alias: "Notify samuel Fabian on way home from GIL"
  initial_state: false
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi GIL"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_samuel_fabian_on_way_home_from_gil.attributes.last_triggered) | int > 3600 }}"
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 35000
  action:
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause von Gilching und kommt voraussichtlich in 1,25 Stunden nach Hause."

- id: notify_samuel_fabian_on_way_home_from_muc
  alias: "Notify samuel Fabian on way home from MUC"
  initial_state: false
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi MUC"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 35000
  action:
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause von Gr√§felfing und kommt voraussichtlich in einer Stunde in Zorneding an."

- id: notify_samuel_fabian_on_way_home_from_whm
  alias: "Notify samuel Fabian on way home from WHM"
  initial_state: false
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi WHM"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: numeric_state
      entity_id: sensor.smart_life_samuel_distance
      below: 35000
  action:
    - service: notify.telegram_fabian
      data:
        message: "Fabian ist auf dem Weg nach Hause von Weilheim. Da er mit dem Auto f√§hrt ist keine Zeitangabe m√∂glich. Voraussichtlich daheim in ca. 1,5 Stunden."

- id: telegram_send_daily_weather_forecast_fabian
  alias: "Telegram send daily weather forecast fabian"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.pixel_8_pro
      from: "not_home"
      to: "home"
  condition:
    - condition: time
      before: "10:00:00"
    - condition: time
      after: "05:00:00"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_send_daily_weather_forecast_fabian.attributes.last_triggered) | int > 36000 }}"
  action:
    #- service: weather.get_forecasts
    #  data:
    #    type: daily
    #  target:
    #    entity_id: sensor.weather_ebersberg_daily
    #  response_variable: weather_forecast
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        disable_notification: true
        #{{ states.sensor.sensor.ebersberg_temperature_2.attributes.templow }} ¬∞C {{ '\u21F5' }} {{ weather_forecast.forecast.0.temperature }} ¬∞C
        message: >
          Wettervorhersage f√ºr heute {{ states.weather.ebersberg_ebersberg.state }} bei {{ states.weather.ebersberg_ebersberg.attributes.temperature }} ¬∞C
          *Momentan {{ states.sensor.weather_ebersberg_hourly.attributes.forecast[0].temperature }} ¬∞C*


          Niederschlag: {{ states.sensor.ebersberg_precipitation_2.state }} mm/h, Wahrscheinlichkeit: {{ states.sensor.ebersberg_precipitation_probability_2.state }} %.


          {% if states.person.samuel.state != "home" %}Samuel ist nicht daheim.{% endif %}

- id: remind_for_volleyball
  alias: "remind for volleyball"
  initial_state: false
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-2) == (as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - 172800) | round(-2) }}"
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-2) == (as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - 140400) | round(-2) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - as_timestamp(now())) < 173000) and ((as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_volleyball_on_warm_sundays.attributes.last_triggered) | int > 140200 }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_volleyball.attributes.last_triggered) | int > 140200 }}"
  action:
    #- service: shell_command.unpin_all_telegram
    #  data_template:
    #    telegram_bot_api: !secret telegram_bot_api
    #    chat_id: !secret telegram_volleyball
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_volleyball
        question:
          "{%- set date = as_timestamp(states.calendar.volleyballtraining.attributes.start_time) -%}
          {% set weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'] %} {% set weekday_number = date | timestamp_custom('%w') | int %}
          {% set weekday_found = weekday[weekday_number] %} {{weekday_found}} ab {{ as_timestamp(states.calendar.volleyballtraining.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr findet {{ states.calendar.volleyballtraining.attributes.message }} statt. Ich komme? Kadermanagerabstimmung nicht vergessen."
        options:
          - "Ja"
          - "Nein"
          - "Vielleicht"
          - "Nur zeitweise/versp√§tet"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true
    - choose:
        - conditions:
            - condition: template
              value_template: "{{not is_state_attr('calendar.volleyballtraining', 'description', '')}}"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_volleyball
                data:
                  disable_web_page_preview: true
                message: >
                  Zusatzinfos: {{ states.calendar.volleyballtraining.attributes.description }}

- id: remind_for_volleyball_on_warm_sundays
  alias: "Remind for Volleyball on warm Sundays"
  initial_state: false
  trigger:
    - platform: time
      at: "13:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - fri
      - condition: or
        conditions:
          - condition: template
            value_template: "{{state_attr('sensor.weather_ebersberg_daily', 'forecast')[2]['condition'] == 'sunny' }}"
          - condition: template
            value_template: "{{state_attr('sensor.weather_ebersberg_daily', 'forecast')[2]['condition'] == 'partlycloudy' }}"
      - condition: template
        value_template: "{{state_attr('sensor.weather_ebersberg_daily', 'forecast')[2]['temperature'] | int >= 20 }}"
      - condition: template
        value_template: "{{ now().month <= 10 and now().month >= 4 }}"
  action:
    - service: shell_command.unpin_all_telegram
      data:
        telegram_bot_api: !secret telegram_bot_api
        chat_id: !secret telegram_volleyball
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_volleyball
        question:
          "{%- set date = as_timestamp(states.calendar.volleyballtraining.attributes.start_time) -%}{% set weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'] %}
          {% set weekday_number = date | timestamp_custom('%w') | int %} {% set weekday_found = weekday[weekday_number] %} {{weekday_found}} ist das Wetter gut: {{ states.sensor.weather_ebersberg_daily.attributes.forecast[2].condition }}
          bei {{ states.sensor.weather_ebersberg_daily.attributes.forecast[2].temperature }}¬∞ und {{ states.sensor.weather_ebersberg_daily.attributes.forecast[2].wind_speed }} km/h Wind.
          Ich komme zum Beachvolleyball ab {{ as_timestamp(states.calendar.volleyballtraining.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr?"
        options:
          - "Ja"
          - "Nein"
          - "Vielleicht"
          - "Nur zeitweise/versp√§tet"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true
    - choose:
        - conditions:
            - condition: template
              value_template: "{{not is_state_attr('calendar.volleyballtraining', 'description', '')}}"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_volleyball
                data:
                  disable_web_page_preview: true
                message: >
                  Zusatzinfos: {{ states.calendar.volleyballtraining.attributes.description }}
    - service: whatsapp.send_message
      continue_on_error: true
      data:
        target: !secret whatsapp_volleyball_group
        message:
          "{%- set date = as_timestamp(states.calendar.volleyballtraining.attributes.start_time) -%}{% set weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'] %}
          {% set weekday_number = date | timestamp_custom('%w') | int %} {% set weekday_found = weekday[weekday_number] %} {{weekday_found}} ist das Wetter gut: {{ states.sensor.weather_ebersberg_daily.attributes.forecast[2].condition }}
          bei {{ states.sensor.weather_ebersberg_daily.attributes.forecast[2].temperature }}¬∞ und {{ states.sensor.weather_ebersberg_daily.attributes.forecast[2].wind_speed }} km/h Wind. Beachvolleyball ab {{ as_timestamp(states.calendar.volleyballtraining.attributes.start_time) | timestamp_custom('%H:%M', true) }}?"

- id: remind_for_juz
  alias: "remind for juz"
  initial_state: false
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-2) == (as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) - 111600) | round(-2) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) - as_timestamp(now())) < 112600) and ((as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) - as_timestamp(now())) > 0) }}"
  action:
    - service: telegram_bot.send_poll
      data:
        target: !secret telegram_chat_juz_group
        question:
          "Das JUZ hat {%- set date = as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) -%}{% set weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'] %}
          {% set weekday_number = date | timestamp_custom('%w') | int %} {% set weekday_found = weekday[weekday_number] %} {{weekday_found}} ab {{ as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) | timestamp_custom('%H:%M', true) }}
          Uhr f√ºr {{ states.calendar.juz_zorneding_public.attributes.message }} ge√∂ffnet. Wir freuen uns auf euren Besuch! Ich komme?"
        options:
          - "Ja"
          - "Nein"
          - "Vielleicht"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true
    - choose:
        - conditions:
            - condition: template
              value_template: "{{not is_state_attr('calendar.juz_zorneding_public', 'description', '')}}"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_juz_group
                message: >
                  Zusatzinfo: {{ states.calendar.juz_zorneding_public.attributes.description }}
            - service: whatsapp.send_message
              continue_on_error: true
              data:
                target: !secret whatsapp_chat_juz_group
                message:
                  "Das JUZ hat{%- set date = as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) -%}{% set weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'] %} {% set weekday_number = date | timestamp_custom('%w') | int %} {% set weekday_found = weekday[weekday_number] %} {{weekday_found}} ab {{ as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr f√ºr {{ states.calendar.juz_zorneding_public.attributes.message }} ge√∂ffnet. Wir freuen uns auf euren Besuch!
                  Zusatzinfo: {{ states.calendar.juz_zorneding_public.attributes.description }}"
      default:
        - service: whatsapp.send_message
          continue_on_error: true
          data:
            target: !secret whatsapp_chat_juz_group
            message: "Das JUZ hat{%- set date = as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) -%}{% set weekday = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'] %} {% set weekday_number = date | timestamp_custom('%w') | int %} {% set weekday_found = weekday[weekday_number] %} {{weekday_found}} ab {{ as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr f√ºr {{ states.calendar.juz_zorneding_public.attributes.message }} ge√∂ffnet. Wir freuen uns auf euren Besuch!"

- id: send_juz_mails_to_telegram
  alias: "send juz mails to telegram"
  initial_state: false
  trigger:
    - platform: state
      entity_id: sensor.juz_outlook
      attribute: data
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.juz_outlook
        above: "0"
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.juz_outlook
            state: unavailable
          - condition: template
            value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
          - condition: state
            entity_id: sensor.juz_outlook
            attribute: data
            state: ""
          - condition: template
            value_template: "{{'noreply@ionos.de' in state_attr('sensor.juz_outlook', 'data')[0]['sender'] }}"
          - condition: template
            value_template: "{{'Angenommen: ' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Abgelehnt: ' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Willkommen bei OTTO UP Plus' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'OTTO-Kundenkonto: Bitte E-Mail-Adresse best√§tigen.' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'√Ñnderung der Datennutzung' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Deine Rechnung von OTTO' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Deine Bestellung wurde versandt.' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Vorl√§ufig angenommen: ' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Aktualisierte Einladung: ' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Termin abgesagt: ' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Undeliverable: ' in state_attr('sensor.juz_outlook', 'data')[0]['subject'] }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_juz_mail
        message: >
          Neue Mail vom {{ as_timestamp(state_attr('sensor.juz_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

          Absender: {{state_attr('sensor.juz_outlook', 'data')[0]['sender']}}


          *Betreff:* {{state_attr('sensor.juz_outlook', 'data')[0]['subject']}}

          *Inhalt:* {{state_attr('sensor.juz_outlook', 'data')[0]['body'] | truncate(450)}}

- id: send_5freunde_mails_to_telegram
  alias: "send 5freunde mails to telegram"
  initial_state: false
  trigger:
    - platform: state
      entity_id: sensor.5freunde_outlook
      attribute: data
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.5freunde_outlook
        above: "0"
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.5freunde_outlook
            state: unavailable
          - condition: state
            entity_id: sensor.5freunde_outlook
            attribute: data
            state: ""
          - condition: template
            value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
          - condition: template
            value_template: "{{'Angenommen: ' in state_attr('sensor.5freunde_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Abgelehnt: ' in state_attr('sensor.5freunde_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Vorl√§ufig angenommen: ' in state_attr('sensor.5freunde_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Aktualisierte Einladung: ' in state_attr('sensor.5freunde_outlook', 'data')[0]['subject'] }}"
          - condition: template
            value_template: "{{'Termin abgesagt: ' in state_attr('sensor.5freunde_outlook', 'data')[0]['subject'] }}"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{'PayPal' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                - condition: template
                  value_template: "{{'service@paypal.de' in state_attr('sensor.5freunde_outlook', 'data')[0]['sender'] }}"
          sequence:
            - choose:
                - conditions:
                    - condition: or
                      conditions:
                        - condition: template
                          value_template: "{{'Erhaltener Betrag' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                  sequence:
                    - choose:
                        - conditions:
                            - condition: or
                              conditions:
                                - condition: template
                                  value_template: "{{'Mitteilung von' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                          sequence:
                            - service: telegram_bot.send_message
                              data:
                                target: !secret telegram_chat_juz_leiter
                                message: >
                                  Neue PayPal *Einnahme* vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                                  {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(\d+\,?\d+) ‚Ç¨ EUR', index=0, ignorecase=False) }} ‚Ç¨ von: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<=Hallo Fabian Seitz!).*?(?= hat)', index=0, ignorecase=False) }}

                                  F√ºr: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<=:).*?(?=Transaktionsdetails)', index=0, ignorecase=False) }}

                                  #PayPal #PayPalEinnahme
                      default:
                        - service: telegram_bot.send_message
                          data:
                            target: !secret telegram_chat_juz_leiter
                            message: >
                              Neue PayPal *Einnahme* vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                              {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(\d+\,?\d+) ‚Ç¨ EUR', index=0, ignorecase=False) }} ‚Ç¨ von: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<=Hallo Fabian Seitz!).*?(?= hat)', index=0, ignorecase=False) }}

                              #PayPal #PayPalEinnahme
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: "{{'Geb√ºhr' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                          sequence:
                            - service: telegram_bot.send_message
                              data:
                                target: !secret telegram_chat_juz_leiter
                                message: >
                                  Achtung! Person hat nicht per PayPal Freunde bezahlt, daher sind Geb√ºhren angefallen!
                - conditions:
                    - condition: or
                      conditions:
                        - condition: template
                          value_template: "{{'Geld gesendet' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                  sequence:
                    - choose:
                        - conditions:
                            - condition: or
                              conditions:
                                - condition: template
                                  value_template: "{{'Ihre Mitteilung an' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                          sequence:
                            - service: telegram_bot.send_message
                              data:
                                target: !secret telegram_chat_juz_leiter
                                message: >
                                  Neue PayPal *Ausgabe* vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                                  {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(\d+\,?\d+) ‚Ç¨ EUR', index=0, ignorecase=False) }} ‚Ç¨ an: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<= EUR an ).*?(?= gesendet)', index=0, ignorecase=False) }}

                                  F√ºr: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<=Ihre Mitteilung an ).*?(?=Transaktionsdetails)', index=0, ignorecase=False) }}

                                  #PayPal #PayPalAusgabe
                      default:
                        - service: telegram_bot.send_message
                          data:
                            target: !secret telegram_chat_juz_leiter
                            message: >
                              Neue PayPal *Ausgabe* vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                              {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(\d+\,?\d+) ‚Ç¨ EUR', index=0, ignorecase=False) }} ‚Ç¨ an: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<= EUR an ).*?(?= gesendet)', index=0, ignorecase=False) }}

                              #PayPal #PayPalAusgabe
                - conditions:
                    - condition: or
                      conditions:
                        - condition: template
                          value_template: "{{'Einkaufsbetrag' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                  sequence:
                    - service: telegram_bot.send_message
                      data:
                        target: !secret telegram_chat_juz_leiter
                        message: >
                          Neue PayPal *Ausgabe* vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                          {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(\d+\,?\d+) EUREmpf√§nger:', index=0, ignorecase=False) }} ‚Ç¨ an: {{ state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | regex_findall_index(find='(?<= EUR an ).*?(?= autorisiert)', index=0, ignorecase=False) }}

                          #PayPal #PayPalAusgabe
              default:
                - service: telegram_bot.send_message
                  data:
                    target: !secret telegram_chat_juz_leiter
                    message: >
                      Neue PayPal Mail vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                      *Inhalt:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | truncate(400)}}

                      #PayPal
        - conditions:
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{'juzzorneding@gmail.com' in state_attr('sensor.5freunde_outlook', 'data')[0]['to'] }}"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_juz_leiter
                message: >
                  Neue JUZ Gmail Mail vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                  *Absender:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['sender']}}


                  *Betreff:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['subject']}}

                  *Inhalt:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | truncate(400)}}
      default:
        - service: telegram_bot.send_message
          data:
            target: !secret telegram_chat_5friends
            message: >
              Neue Mail vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

              *Absender:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['sender']}}

              *Empf√§nger:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['to'][0]}}


              *Betreff:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['subject']}}

              *Inhalt:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | truncate(400)}}

- id: "ctgpdx_new_version_notification"
  alias: "CTGP-DX: New Version Available"
  description: "Notifies when the CTGP Deluxe version sensor changes to a valid state."
  trigger:
    - platform: state
      entity_id: sensor.ctgp_dx_latest_version
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
    - condition: template
      value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
    - condition: template
      value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: >
          New CTGP-DX Version **{{ states.sensor.ctgp_dx_latest_version.state }}** released at {{ state_attr('sensor.ctgp_dx_latest_version', 'release_date') }} is now available!

          Download: {{ state_attr('sensor.ctgp_dx_latest_version', 'data_provided_by') }}
  mode: single

- id: "gsa_new_version_notification_windows"
  alias: "GSA: New Version Available for Windows"
  description: "Notifies when the GSA version sensor changes to a valid state."
  trigger:
    - platform: state
      entity_id: sensor.global_secure_access_client_windows
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
    - condition: template
      value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
    - condition: template
      value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: >
          New GSA Windows Version **{{ states.sensor.global_secure_access_client_windows.state }}** released at {{ state_attr('sensor.global_secure_access_client_windows', 'release_day') }} is now available!

          Release Notes: {{ state_attr('sensor.global_secure_access_client_windows', 'data_provided_by') }}
  mode: single

- id: "gsa_new_version_notification_macos"
  alias: "GSA: New Version Available for MacOS"
  description: "Notifies when the GSA version sensor changes to a valid state."
  trigger:
    - platform: state
      entity_id: sensor.global_secure_access_client_macos
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state not in ['unknown', 'unavailable'] }}"
    - condition: template
      value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
    - condition: template
      value_template: "{{ trigger.to_state.state != trigger.from_state.state }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: >
          New GSA Windows Version **{{ states.sensor.global_secure_access_client_macos.state }}** released at {{ state_attr('sensor.global_secure_access_client_macos', 'release_day') }} is now available!

          Release Notes: {{ state_attr('sensor.global_secure_access_client_macos', 'data_provided_by') }}
  mode: single

- id: notification_on_new_kadermanager_comment
  alias: "Benachrichtigung bei neuem Kadermanager Kommentar"
  trigger:
    - platform: state
      entity_id: sensor.kadermanager_zorro
  condition:
    condition: template
    value_template: >
      {% set old_comments = trigger.from_state.attributes.events[0].comments if trigger.from_state.attributes.events else [] %}
      {% set new_comments = trigger.to_state.attributes.events[0].comments if trigger.to_state.attributes.events else [] %}
      {{ new_comments != old_comments }}
  action:
    - service: whatsapp.send_message
      data:
        target: !secret whatsapp_volleyball_group
        message: >
          {% set latest_comment = states.sensor.kadermanager_zorro.attributes.events[0].comments[0] %}
          {% set author = latest_comment.author %}
          {% set text = latest_comment.text %}
          {% set messages = [
            "üì£ *Neuer Kommentar von " ~ author ~ ":*\n\n" ~ text,
            "üí¨ *" ~ author ~ " hat geschrieben:*\n\n" ~ text,
            "*Neues von " ~ author ~ ":*\n\n" ~ text,
            "üëÄ *Ein neuer Kommentar von " ~ author ~ ":*\n\n" ~ text
          ] %}
          {{ messages | random }}

- id: notification_on_new_kadermanager_comment_tischabwischer
  alias: "Benachrichtigung bei neuem Kadermanager Kommentar 2. Mannschaft"
  trigger:
    - platform: state
      entity_id: sensor.kadermanager_tischabwischer
  condition:
    condition: template
    value_template: >
      {% set old_comments = trigger.from_state.attributes.events[0].comments if trigger.from_state.attributes.events else [] %}
      {% set new_comments = trigger.to_state.attributes.events[0].comments if trigger.to_state.attributes.events else [] %}
      {{ new_comments != old_comments }}
  action:
    - service: whatsapp.send_message
      data:
        target: !secret whatsapp_volleyball_tischabwischer
        message: >
          {% set latest_comment = states.sensor.kadermanager_tischabwischer.attributes.events[0].comments[0] %}
          {% set author = latest_comment.author %}
          {% set text = latest_comment.text %}
          {% set messages = [
            "üì£ *Neuer Kommentar von " ~ author ~ ":*\n\n" ~ text,
            "üí¨ *" ~ author ~ " hat geschrieben:*\n\n" ~ text,
            "*Neues von " ~ author ~ ":*\n\n" ~ text,
            "üëÄ *Ein neuer Kommentar von " ~ author ~ ":*\n\n" ~ text
          ] %}
          {{ messages | random }}

- id: remind_for_volleyball_by_kadermanager
  alias: "Erinnerung f√ºr Volleyball via Kadermanager"
  initial_state: true
  trigger:
    - platform: template
      value_template: >
        {% set event = state_attr('sensor.kadermanager_zorro', 'events')[0] %}
        {% set event_date = event['date'] %}
        {% set event_time = event['time'] %}
        {% set event_type = event['type'] %}
        {% set event_datetime = strptime(event_date + ' ' + event_time, '%Y-%m-%d %H:%M') %}
        {% set reminder_days = 2 if event_type != 'Spiel' else 4 %}
        {% set reminder_datetime = event_datetime - timedelta(days=reminder_days) %}
        {% set rounded_reminder_datetime = reminder_datetime.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if reminder_datetime.minute >= 30 else 0) %}
        {% set now = now() %}
        {% set rounded_now = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if now.minute >= 30 else 0)).replace(tzinfo=None) %}
        {{ rounded_reminder_datetime == rounded_now }}
    - platform: template
      value_template: >
        {% set event_date = state_attr('sensor.kadermanager_zorro', 'events')[0]['date'] %}
        {% set event_time = state_attr('sensor.kadermanager_zorro', 'events')[0]['time'] %}
        {% set event_datetime = strptime(event_date + ' ' + event_time, '%Y-%m-%d %H:%M') %}
        {% set reminder_datetime = event_datetime - timedelta(days=1, hours=12) %}
        {% set rounded_reminder_datetime = reminder_datetime.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if reminder_datetime.minute >= 30 else 0) %}
        {% set now = now() %}
        {% set rounded_now = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if now.minute >= 30 else 0)).replace(tzinfo=None) %}
        {{ rounded_reminder_datetime == rounded_now }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_volleyball_on_warm_sundays.attributes.last_triggered) | int(0) > 302400 }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_volleyball_by_kadermanager.attributes.last_triggered) | int(0) > 302400 }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {% set events = state_attr('sensor.kadermanager_zorro', 'events') %}
                {% set event_0 = events[0] if events | length > 0 else None %}
                {% if events | length > 1 %}
                  {% set event_1 = events[1] %}
                  {% if event_0['date'] == event_1['date'] %}
                    {% if event_0['type'] == 'Spiel' %}
                      true
                    {% elif event_1['type'] == 'Spiel' %}
                      true
                    {% elif event_0['type'] == 'Sonstiges' %}
                      false
                    {% elif event_1['type'] == 'Sonstiges' %}
                      false
                    {% else %}
                      false
                    {% endif %}
                  {% else %}
                    {{ event_0['type'] == 'Spiel' }}
                  {% endif %}
                {% elif event_0 is not none %}
                  {{ event_0['type'] == 'Spiel' }}
                {% else %}
                  false
                {% endif %}
            - condition: template
              value_template: "{{ state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['type'] == 'Spiel' }}"
            - condition: template
              value_template: >
                {% set event = state_attr('sensor.kadermanager_zorro', 'events')[0] %}
                {% set date = strptime(event['date'], '%Y-%m-%d') %}
                {% set tischabwischer_event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
                {% set tischabwischer_date = strptime(tischabwischer_event['date'], '%Y-%m-%d') %}
                {{ date.strftime('%Y-%m-%d') == tischabwischer_date.strftime('%Y-%m-%d') }}
          sequence:
            - service: whatsapp.send_message
              continue_on_error: true
              data:
                target: !secret whatsapp_volleyball_group
                message: >
                  {% set events = state_attr('sensor.kadermanager_zorro', 'events') %}
                  {% set event_0 = events[0] if events | length > 0 else None %}
                  {% if events | length > 1 and events[0]['date'] == events[1]['date'] %}
                    {% set zorro_event = events | selectattr('type', 'eq', 'Spiel') | first | default(events[0]) %}
                  {% else %}
                    {% set zorro_event = event_0 %}
                  {% endif %}
                  {%- set tischabwischer_event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
                  {%- set zorro_date = strptime(zorro_event['date'], '%Y-%m-%d') %}
                  {%- set weekday = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'][zorro_date.weekday()] %}
                  {% set tischabwischer_schedule_text = "" %}
                  {% if states('sensor.dieliga_schedule_tsv_zorneding_ii') not in ['unknown', 'unavailable'] and state_attr('sensor.dieliga_schedule_tsv_zorneding_ii', 'total_games') %}
                    {%- set t_games = state_attr('sensor.dieliga_schedule_tsv_zorneding_ii', 'total_games') %}
                    {%- set t_completed = (state_attr('sensor.dieliga_schedule_tsv_zorneding_ii', 'completed_games') | default(0)) + 1 %}
                    {%- set tischabwischer_schedule_text = '(' ~ t_completed ~ '. von ' ~ t_games ~ ')' %}
                  {% endif %}
                  {% set zorro_schedule_text = "" %}
                  {% if states('sensor.dieliga_schedule_tsv_zorneding_iii') not in ['unknown', 'unavailable'] and state_attr('sensor.dieliga_schedule_tsv_zorneding_iii', 'total_games') %}
                    {%- set z_games = state_attr('sensor.dieliga_schedule_tsv_zorneding_iii', 'total_games') %}
                    {%- set z_completed = (state_attr('sensor.dieliga_schedule_tsv_zorneding_iii', 'completed_games') | default(0)) + 1 %}
                    {%- set zorro_schedule_text = '(' ~ z_completed ~ '. von ' ~ z_games ~ ')' %}
                  {% endif %}
                  *üèê Doppelter Spieltag am {{ weekday }}! üèê*

                  *Mannschaft 3:*
                  {{ zorro_event['type'] }} {{ zorro_schedule_text }} "{{ zorro_event['title'] }}" um ‚è∞ {{ zorro_event['time'] }} Uhr.
                  *Zusagen:* {{ zorro_event['in_count'] }}
                  {% set z_min = 6 if 'Heim' in zorro_event['title'] else 8 %}
                  {% if zorro_event['in_count'] < z_min -%}
                  Wir brauchen noch Verst√§rkung! Bitte tragt euch zeitnah ein: {{ zorro_event['link'] }}
                  {% else -%}
                  Bitte alle im Kadermanager abstimmen: {{ zorro_event['link'] }}
                  {% endif %}

                  ---
                  *Mannschaft 2:*
                  {{ tischabwischer_event['type'] }} {{ tischabwischer_schedule_text }} am selben Tag um ‚è∞ {{ tischabwischer_event['time'] }} Uhr: "{{ tischabwischer_event['title'] }}".
                  *Zusagen:* {{ tischabwischer_event['in_count'] }}
                  {% set t_min = 6 if 'Heim' in tischabwischer_event['title'] else 7 %}
                  {% if tischabwischer_event['in_count'] < t_min -%}
                  Auch hier fehlen noch Zusagen! Bitte eintragen: {{ tischabwischer_event['link'] }}
                  {% endif %}

                  ---
                  {% if 'Heim' in zorro_event['title'] and 'Heim' in tischabwischer_event['title'] %}
                  *üõéÔ∏è Schiri-Info:* Beide Teams haben ein Heimspiel! Bitte denkt daran, euch gegenseitig Schiedsrichter zu stellen und meldet euch bei Verf√ºgbarkeit! Danke!
                  {% elif 'Heim' in zorro_event['title'] %}
                  *üõéÔ∏è Schiri-Info:* Mannschaft 3 hat ein Heimspiel und braucht einen Schiedsrichter. Wer kann pfeifen? Bitte melden!
                  {% elif 'Heim' in tischabwischer_event['title'] %}
                  *üõéÔ∏è Schiri-Info:* Mannschaft 2 hat ein Heimspiel und braucht einen Schiedsrichter. Wer kann pfeifen? Bitte melden!
                  {% endif %}

                  {% if zorro_date.weekday() == 1 %}
                  *Wichtig:* Wegen der beiden Spiele findet an diesem Tag KEIN Training statt!
                  {% endif %}
        - conditions:
            - condition: template
              value_template: >
                {% set events = state_attr('sensor.kadermanager_zorro', 'events') %}
                {% set event_0 = events[0] if events | length > 0 else None %}
                {% if events | length > 1 %}
                  {% set event_1 = events[1] %}
                  {% if event_0['date'] == event_1['date'] %}
                    {{ event_0['type'] == 'Spiel' or event_1['type'] == 'Spiel' }}
                  {% else %}
                    {{ event_0['type'] == 'Spiel' }}
                  {% endif %}
                {% elif event_0 is not none %}
                  {{ event_0['type'] == 'Spiel' }}
                {% else %}
                  false
                {% endif %}
          sequence:
            - service: whatsapp.send_message
              continue_on_error: true
              data:
                target: !secret whatsapp_volleyball_zorro_group
                message: >
                  {% set events = state_attr('sensor.kadermanager_zorro', 'events') %}
                  {% if events | length > 1 and events[0]['date'] == events[1]['date'] %}
                    {% set zorro_event = events | selectattr('type', 'eq', 'Spiel') | first | default(events[0]) %}
                  {% else %}
                    {% set zorro_event = events[0] %}
                  {% endif %}
                  {%- set date = strptime(zorro_event['date'], '%Y-%m-%d') %}
                  {%- set weekday = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][date.weekday()] %}
                  {% set zorro_schedule_text = "" %}
                  {% if states('sensor.dieliga_schedule_tsv_zorneding_iii') not in ['unknown', 'unavailable'] and state_attr('sensor.dieliga_schedule_tsv_zorneding_iii', 'total_games') %}
                    {%- set z_games = state_attr('sensor.dieliga_schedule_tsv_zorneding_iii', 'total_games') %}
                    {%- set z_completed = (state_attr('sensor.dieliga_schedule_tsv_zorneding_iii', 'completed_games') | default(0)) + 1 %}
                    {%- set zorro_schedule_text = '(' ~ z_completed ~ '. von ' ~ z_games ~ ')' %}
                  {% endif %}
                  {% set zorro_scoreboard_text = "" %}
                  {% if states('sensor.dieliga_scoreboard_tsv_zorneding_iii') not in ['unknown', 'unavailable'] %}
                    {%- set score = states('sensor.dieliga_scoreboard_tsv_zorneding_iii') | int(0) %}
                    {% if score > 0 and score <= 5 and state_attr('sensor.dieliga_scoreboard_tsv_zorneding_iii', 'teams') %}
                      {%- set teams_count = state_attr('sensor.dieliga_scoreboard_tsv_zorneding_iii', 'teams') | length %}
                      {%- set zorro_scoreboard_text = '\nüìä *Aktuelle Ligaplatzierung:* Platz ' ~ score ~ ' von ' ~ teams_count %}
                    {% endif %}
                  {% endif %}

                  *üèê SPIELTAGS-ALARM! üèê*

                  *Was:* {{ zorro_event['type'] }} {{ zorro_schedule_text }} "{{ zorro_event['title'] }}"

                  *Wann:* üìÖ {{ weekday }}, {{ date.strftime('%d.%m.') }} um ‚è∞ {{ zorro_event['time'] }} Uhr

                  *Zusagen:* {{ zorro_event['in_count'] }}
                  {% set min_player = 6 if 'Heim' in zorro_event['title'] else 7 %}
                  {% if zorro_event['in_count'] < min_player %}


                  Wir brauchen noch Verst√§rkung f√ºr den Spieltag! Bitte tragt euch zeitnah ein, damit geplant werden kann:
                  {{ zorro_event['link'] }}
                  {% else %}


                  Nicht vergessen, im Kadermanager abzustimmen:
                  {{ zorro_event['link'] }}
                  {% endif %}
                  {{ zorro_scoreboard_text }}
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ strptime(state_attr('sensor.kadermanager_zorro', 'events')[0]['date'], '%Y-%m-%d').weekday() == 1 }}"
                  sequence:
                    - service: whatsapp.send_message
                      continue_on_error: true
                      data:
                        target: !secret whatsapp_volleyball_group
                        message: >
                          *üí° Info:* Wegen des Spiels von Mannschaft 3 findet das kommende Training nur mit Mannschaft 2 statt.
                          {% set zorro_event = state_attr('sensor.kadermanager_zorro', 'events') | selectattr('type', 'eq', 'Spiel') | first %}
                          {% if 'Heim' in zorro_event['title'] %}
                          Freiwillige Schiedsrichter sind herzlich willkommen!
                          {% endif %}

                          Bitte tragt euch dennoch f√ºr das Training ein, zum planen.
                          {{ zorro_event['link'] }}
        - conditions: # Beachvolleyball
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{ 'sunny' in state_attr('sensor.weather_ebersberg_daily', 'forecast')[2]['condition'] }}"
                - condition: template
                  value_template: "{{ 'partlycloudy' in state_attr('sensor.weather_ebersberg_daily', 'forecast')[2]['condition'] }}"
            - condition: template
              value_template: "{{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[2]['temperature'] | int >= 20 }}"
            - condition: template
              value_template: "{{ now().month <= 10 and now().month >= 4 }}"
            - condition: template
              value_template: "{{ state_attr('sensor.kadermanager_zorro', 'events')[0]['type'] != 'Spiel' }}"
          sequence:
            - service: whatsapp.send_message
              continue_on_error: true
              data:
                target: !secret whatsapp_volleyball_group
                message: >
                  {%- set event = state_attr('sensor.kadermanager_zorro', 'events')[0] %}
                  {%- set date = strptime(event['date'], '%Y-%m-%d') -%}
                  {%- set days_until_event = (date - now().date()).days -%}
                  {%- set weekday = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][date.weekday()] %}
                  *‚òÄÔ∏è Beach-Wetter am {{ weekday }}! ‚òÄÔ∏è*

                  Die Vorhersage meldet {{ state_attr('sensor.weather_ebersberg_daily', 'forecast')[days_until_event].temperature }}¬∞C!
                  {% if weekday in ["Samstag", "Sonntag"] %}
                  Wer ist ab ‚è∞ {{ event['time'] }} Uhr f√ºr eine Runde im Sand dabei?
                  {% else %}
                  Wer hat Lust, vor dem Hallentraining (‚è∞ {{ (as_timestamp(event.date + ' ' + event.time) - 7200) | timestamp_custom('%H:%M', true) }} Uhr) zu beachen?
                  {% endif %}

                  *Wichtig:* Bitte trotzdem f√ºr die Halle eintragen, damit wir wissen, wer sp√§ter noch kommt:
                  {{ event['link'] }}
      default:
        - service: whatsapp.send_message
          data:
            target: !secret whatsapp_volleyball_group
            message: >
              {%- set event = state_attr('sensor.kadermanager_zorro', 'events')[0] %}
              {%- set date = strptime(event['date'], '%Y-%m-%d') %}
              {%- set weekday = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][date.weekday()] %}
              {%- set date_formatted = date.strftime('%d.%m.') %}
              {%- set in_count = event['in_count'] %}
              {%- set event_type = event['type'] %}
              {%- set event_title = event['title'] %}
              {%- set event_time = event['time'] %}
              {%- set event_link = event['link'] %}
              {%- set motivation_text = "" %}
              {% if event_type == 'Training' and in_count in [10, 11] %}
              {% set motivation_text = "\n\n*Super!* Wir sind schon " ~ in_count ~ "! Wer macht die 12 voll f√ºr ein perfektes 6 gegen 6? üí™" %}
              {% elif event_type == 'Training' and in_count < 10 %}
              {% set motivation_text = "\n\nDa geht noch was! Bitte tragt euch flei√üig ein, damit wir gut planen k√∂nnen." %}
              {% endif %}

              {% set messages = [
                "üëã *Kurze Erinnerung!*\n\n*N√§chstes Event:*\nüèê " ~ event_type ~ " \"" ~ event_title ~ "\"\nüìÖ " ~ weekday ~ ", " ~ date_formatted ~ " um ‚è∞ " ~ event_time ~ " Uhr\n\n*Aktueller Stand:* " ~ in_count ~ " Zusagen." ~ motivation_text ~ "\n\nHier geht's zum Feedback:\n" ~ event_link,
                "üèê *Nicht vergessen: " ~ event_type ~ " am " ~ weekday ~ "!*\n\nAlle Infos im √úberblick:\n*Was:* \"" ~ event_title ~ "\"\n*Wann:* " ~ date_formatted ~ " um " ~ event_time ~ " Uhr\n\nBisher sind wir " ~ in_count ~ " Leute." ~ motivation_text ~ "\n\nBitte hier eintragen:\n" ~ event_link,
                "üó£Ô∏è *Aufgepasst, Volleyball-Freunde!* \n\nUnser n√§chstes Event steht an:\n" ~ event_type ~ " \"" ~ event_title ~ "\"\nüìÖ " ~ weekday ~ ", " ~ date_formatted ~ "\n‚è∞ " ~ event_time ~ " Uhr\n\n" ~ in_count ~ " sind schon dabei." ~ motivation_text ~ "\n\nTragt euch hier ein:\n" ~ event_link
              ] %}
              {{ messages | random }}

- id: remind_for_volleyball_by_kadermanager_2_mannschaft
  alias: "Erinnerung f√ºr Volleyball via Kadermanager (Mannschaft 2)"
  initial_state: true
  trigger:
    - platform: template
      value_template: >
        {% set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
        {% set event_date = event['date'] %}
        {% set event_time = event['time'] %}
        {% set event_type = event['type'] %}
        {% set event_datetime = strptime(event_date + ' ' + event_time, '%Y-%m-%d %H:%M') %}
        {% set reminder_days = 2 if event_type != 'Spiel' else 5 %}
        {% set reminder_datetime = event_datetime - timedelta(days=reminder_days) %}
        {% set rounded_reminder_datetime = reminder_datetime.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if reminder_datetime.minute >= 30 else 0) %}
        {% set now = now() %}
        {% set rounded_now = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if now.minute >= 30 else 0)).replace(tzinfo=None) %}
        {{ rounded_reminder_datetime == rounded_now }}
    - platform: template
      value_template: >
        {% set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
        {% set event_date = event['date'] %}
        {% set event_time = event['time'] %}
        {% set event_type = event['type'] %}
        {% set event_datetime = strptime(event_date + ' ' + event_time, '%Y-%m-%d %H:%M') %}
        {% set reminder_days = 1 if event_type != 'Spiel' else 3 %}
        {% set reminder_datetime = event_datetime - timedelta(days=reminder_days) %}
        {% set rounded_reminder_datetime = reminder_datetime.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if reminder_datetime.minute >= 30 else 0) %}
        {% set now = now() %}
        {% set rounded_now = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if now.minute >= 30 else 0)).replace(tzinfo=None) %}
        {{ rounded_reminder_datetime == rounded_now }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_volleyball_by_kadermanager_2_mannschaft.attributes.last_triggered) | int(0) > 302400 }}"
  action:
    - choose:
        - conditions:
            - condition: template # Check if Zorro team has no game
              value_template: >
                {% set events = state_attr('sensor.kadermanager_zorro', 'events') %}
                {% set event_0 = events[0] if events | length > 0 else None %}
                {% if events | length > 1 %}
                  {% set event_1 = events[1] %}
                  {% if event_0['date'] == event_1['date'] %}
                    {{ event_0['type'] != 'Spiel' and event_1['type'] != 'Spiel' }}
                  {% else %}
                    {{ event_0['type'] != 'Spiel' }}
                  {% endif %}
                {% elif event_0 is not none %}
                  {{ event_0['type'] != 'Spiel' }}
                {% else %}
                  true
                {% endif %}
            - condition: template
              value_template: "{{ state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['type'] == 'Spiel' }}"
          sequence:
            - service: whatsapp.send_message
              continue_on_error: true
              data:
                target: !secret whatsapp_volleyball_tischabwischer
                message: >
                  {%- set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
                  {%- set date = strptime(event['date'], '%Y-%m-%d') %}
                  {%- set weekday = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][date.weekday()] %}
                  {% set schedule_text = "" %}
                  {% if states('sensor.dieliga_schedule_tsv_zorneding_ii') not in ['unknown', 'unavailable'] and state_attr('sensor.dieliga_schedule_tsv_zorneding_ii', 'total_games') %}
                    {%- set completed_games = (state_attr('sensor.dieliga_schedule_tsv_zorneding_ii', 'completed_games') | default(0)) + 1 %}
                    {%- set total_games = state_attr('sensor.dieliga_schedule_tsv_zorneding_ii', 'total_games') %}
                    {%- set schedule_text = '(' ~ completed_games ~ '. von ' ~ total_games ~ ')' %}
                  {% endif %}
                  {% set scoreboard_text = "" %}
                  {% if states('sensor.dieliga_scoreboard_tsv_zorneding_ii') not in ['unknown', 'unavailable'] %}
                    {%- set score = states('sensor.dieliga_scoreboard_tsv_zorneding_ii') | int(0) %}
                    {% if score > 0 and score <= 5 and state_attr('sensor.dieliga_scoreboard_tsv_zorneding_ii', 'teams') %}
                      {%- set teams_count = state_attr('sensor.dieliga_scoreboard_tsv_zorneding_ii', 'teams') | length %}
                      {%- set scoreboard_text = '\nüìä *Aktuelle Ligaplatzierung:* Platz ' ~ score ~ ' von ' ~ teams_count %}
                    {% endif %}
                  {% endif %}

                  *üèê SPIELTAGS-ALARM! üèê*

                  *Was:* {{ event['type'] }} {{ schedule_text }} "{{ event['title'] }}"

                  *Wann:* üìÖ {{ weekday }}, {{ date.strftime('%d.%m.') }} um ‚è∞ {{ event['time'] }} Uhr

                  *Zusagen:* {{ event['in_count'] }}
                  {% set min_player = 6 if 'Heim' in event['title'] else 7 %}
                  {% if event['in_count'] < min_player %}


                  Auf geht's, wir brauchen noch Mitspieler! Bitte tragt euch zeitnah ein:
                  {{ event['link'] }}
                  {% else %}


                  Stimmt bitte zeitnah im Kadermanager ab:
                  {{ event['link'] }}
                  {% endif %}
                  {{ scoreboard_text }}
            - choose:
                - conditions:
                    - condition: template
                      value_template: >
                        {% set events = state_attr('sensor.kadermanager_tischabwischer', 'events') %}
                        {% set ns = namespace(found=false) %}

                        {% if events is not none and events | length > 0 %}
                          {% set date0 = strptime(events[0].date, '%Y-%m-%d') %}

                          {# Bedingung A: Event 0 ist ein Dienstag #}
                          {% if date0.weekday() == 1 %}
                            {% set ns.found = true %}
                          {% endif %}

                          {# Bedingung B: Event 1 existiert, ist Di und 1 Tag nach Event 0 #}
                          {% if events | length > 1 %}
                            {% set date1 = strptime(events[1].date, '%Y-%m-%d') %}
                            {% if (date1.date() - date0.date()).days == 1 and date1.weekday() == 1 %}
                              {% set ns.found = true %}
                            {% endif %}
                          {% endif %}
                        {% endif %}

                        {{ ns.found }}
                  sequence:
                    - service: whatsapp.send_message
                      data:
                        target: !secret whatsapp_volleyball_group
                        message: >
                          *üí° Info:* Wegen des Spiels von Mannschaft 2 findet das kommende Training nur mit Mannschaft 3 statt.
                          {% set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
                          {% if 'Heim' in event['title'] %}
                          Freiwillige Schiedsrichter sind herzlich willkommen!
                          {% endif %}

                          Bitte tragt euch dennoch f√ºr das Training ein, zum planen.
      default:
        - service: whatsapp.send_message
          data:
            target: !secret whatsapp_volleyball_tischabwischer
            message: >
              {%- set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
              {%- set date = strptime(event['date'], '%Y-%m-%d') %}
              {%- set weekday = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][date.weekday()] %}
              {%- set date_formatted = date.strftime('%d.%m.') %}
              {%- set in_count = event['in_count'] %}
              {%- set event_type = event['type'] %}
              {%- set event_title = event['title'] %}
              {%- set event_time = event['time'] %}
              {%- set event_link = event['link'] %}
              {% set messages = [
                "üëã *Kurze Erinnerung!*\n\n*N√§chstes Event:*\nüèê " ~ event_type ~ " \"" ~ event_title ~ "\"\nüìÖ " ~ weekday ~ ", " ~ date_formatted ~ " um ‚è∞ " ~ event_time ~ " Uhr\n\n*Aktueller Stand:* " ~ in_count ~ " Zusagen.\n\nHier geht's zur Abstimmung:\n" ~ event_link,
                "üèê *Nicht vergessen: " ~ event_type ~ " am " ~ weekday ~ "!*\n\nAlle Infos im √úberblick:\n*Was:* \"" ~ event_title ~ "\"\n*Wann:* " ~ date_formatted ~ " um " ~ event_time ~ " Uhr\n\nBisher sind wir " ~ in_count ~ " Leute.\n\nBitte hier abstimmen:\n" ~ event_link
              ] %}
              {{ messages | random }}

- id: remind_for_volleyball_by_kadermanager_low_participants
  alias: "Kadermanager Erinnerung bei zu wenigen Spielern (Mannschaft 2)"
  initial_state: true
  trigger:
    - platform: template
      value_template: >
        {% set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
        {% set event_date = event['date'] %}
        {% set event_time = event['time'] %}
        {% set event_datetime = strptime(event_date + ' ' + event_time, '%Y-%m-%d %H:%M') %}
        {% set reminder_datetime = event_datetime - timedelta(days=2) %}
        {% set rounded_reminder_datetime = reminder_datetime.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if reminder_datetime.minute >= 30 else 0) %}
        {% set now = now() %}
        {% set rounded_now = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if now.minute >= 30 else 0)).replace(tzinfo=None) %}
        {{ rounded_reminder_datetime == rounded_now }}
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: >
          {{ state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['type'] == 'Spiel' }}
      - condition: template
        value_template: >
          {{ state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['in_count'] < 7 }}
  action:
    - service: whatsapp.send_message
      data:
        target: !secret whatsapp_volleyball_tischabwischer
        message: >
          *üö® Spieler-Alarm f√ºr Mannschaft 2! üö®*

          F√ºr das Ligaspiel am
          {% set event = state_attr('sensor.kadermanager_tischabwischer', 'events')[0] %}
          {%- set date = strptime(event['date'], '%Y-%m-%d') %}
          {%- set weekday = ['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'][date.weekday()] %}
          {{ weekday }} um ‚è∞ {{ event['time'] }} Uhr haben wir erst *{{ state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['in_count'] }}* Zusagen.

          {% set accepted_players = state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['players']['accepted_players'] %}
          {% if accepted_players %}
          *‚úÖ Zugesagt haben:*
          {{ accepted_players | join(', ') }}
          {% endif %}

          {% set declined_players = state_attr('sensor.kadermanager_tischabwischer', 'events')[0]['players']['declined_players'] %}
          {% if declined_players %}
          *‚ùå Abgesagt haben:*
          {{ declined_players | join(', ') }}
          {% endif %}

          Bitte tragt euch dringend ein, ansonsten m√ºssen wir das Spiel verschieben:
          {{ event['link'] }}

- id: kadermanager_participant_count_reminder
  alias: "Kadermanager Teilnehmer-Erinnerung f√ºr Trainer"
  initial_state: true
  trigger:
    - platform: template
      value_template: >
        {% set event_date = state_attr('sensor.kadermanager_zorro', 'events')[0]['date'] %}
        {% set event_time = state_attr('sensor.kadermanager_zorro', 'events')[0]['time'] %}
        {% set event_datetime = strptime(event_date + ' ' + event_time, '%Y-%m-%d %H:%M') %}
        {% set reminder_datetime = event_datetime - timedelta(hours=3) %}
        {% set rounded_reminder_datetime = reminder_datetime.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if reminder_datetime.minute >= 30 else 0) %}
        {% set now = now() %}
        {% set rounded_now = (now.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1 if now.minute >= 30 else 0)).replace(tzinfo=None) %}
        {{ rounded_reminder_datetime == rounded_now }}
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: template
                value_template: "{{ state_attr('sensor.kadermanager_zorro', 'events')[0]['type'] == 'Training' }}"
              - condition: template
                value_template: "{{ strptime(state_attr('sensor.kadermanager_zorro', 'events')[0]['date'], '%Y-%m-%d').weekday() == 1 }}" #Tuesday
          - condition: template
            value_template: "{{ state_attr('sensor.kadermanager_zorro', 'events')[0]['type'] == 'Sonstiges' }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_participant_count_on_kadermanager.attributes.last_triggered) | int(0) > 64800 }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ strptime(state_attr('sensor.kadermanager_zorro', 'events')[0]['date'], '%Y-%m-%d').weekday() == 1 }}"
          sequence:
            - service: whatsapp.send_message
              data:
                target: !secret whatsapp_volleyball_orga
                message: >
                  *üèê √úbersicht f√ºr heute:*
                  *Zusagen:* {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['in_count'] }}

                  *‚úÖ Dabei:*
                  {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['players']['accepted_players'] | join(', ') }}

                  *‚ùå Nicht dabei:*
                  {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['players']['declined_players'] | join(', ') }}

                  *Link:* {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['link'] }}
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {{ 'Fabian S' not in state_attr('sensor.kadermanager_zorro', 'events')[0]['players']['declined_players'] }}
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 40000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: >
                  *üèê √úbersicht f√ºr heute:* [Kadermanager]({{ state_attr('sensor.kadermanager_zorro', 'events')[0]['link'] }})
                  *Zusagen:* {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['in_count'] }}

                  *‚úÖ Dabei:* {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['players']['accepted_players'] | join(', ') }}
                  *‚ùå Nicht dabei:* {{ state_attr('sensor.kadermanager_zorro', 'events')[0]['players']['declined_players'] | join(', ') }}

- id: open_covers_when_sunrise
  alias: "Open all covers when sun rise"
  trigger:
    - platform: sun
      event: sunrise
    - platform: time
      at: "08:00:00"
    - platform: time
      at: "11:00:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "off"
      # - condition: or
      #  conditions:
      #    - condition: state
      #      entity_id: person.fabian
      #      state: home
      #    - condition: state
      #      entity_id: person.samuel
      #      state: home
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "off"
              - condition: time
                after: "10:00:00"
                before: "16:30:00"
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "on"
              - condition: time
                after: "07:30:00"
                before: "16:30:00"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.abwesend_modus
              state: "on"
          sequence:
            - service: cover.set_cover_position
              target:
                entity_id: all
              data:
                position: 30
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.abwesend_modus
              state: "off"
            - condition: state
              entity_id: device_tracker.fabian_iphone_2
              state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: cover.fabians_zimmer_rollo
                  state: "open"
          sequence:
            - choose:
                - conditions:
                    - condition: numeric_state
                      entity_id: sensor.weather_ebersberg_hourly
                      above: 22
                    - condition: or
                      conditions:
                        - condition: template
                          value_template: "{{state_attr('sensor.weather_ebersberg_hourly', 'forecast')[0]['condition'] == 'sunny' }}"
                        - condition: template
                          value_template: "{{state_attr('sensor.weather_ebersberg_hourly', 'forecast')[0]['condition'] == 'partlycloudy' }}"
                  sequence:
                    - service: cover.set_cover_position
                      target:
                        entity_id:
                          - cover.fabians_zimmer_rollo
                      data:
                        position: 60
              default:
                - service: cover.set_cover_position
                  target:
                    entity_id: cover.fabians_zimmer_rollo
                  data:
                    position: 30
                - delay: "00:03:00"
                - service: cover.open_cover
                  target:
                    entity_id: cover.fabians_zimmer_rollo
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.abwesend_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
          sequence:
            - choose:
                - conditions:
                    - condition: numeric_state
                      entity_id: sensor.weather_ebersberg_hourly
                      above: 22
                    - condition: or
                      conditions:
                        - condition: template
                          value_template: "{{state_attr('sensor.weather_ebersberg_hourly', 'forecast')[0]['condition'] == 'sunny' }}"
                        - condition: template
                          value_template: "{{state_attr('sensor.weather_ebersberg_hourly', 'forecast')[0]['condition'] == 'partlycloudy' }}"
                  sequence:
                    - service: cover.set_cover_position
                      target:
                        entity_id:
                          - cover.wohnzimmer_rollo_fenster
                          - cover.wohnzimmer_rollo_tur
                      data:
                        position: 60
              default:
                - service: cover.open_cover
                  target:
                    entity_id:
                      - cover.wohnzimmer_rollo_fenster
                      - cover.wohnzimmer_rollo_tur
    - service: light.turn_off
      entity_id: all

- id: lower_covers_when_sunset
  alias: "lower all covers when sun set"
  trigger:
    platform: sun
    event: sunset
    offset: "00:15:00"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.bett_usb_ports
    - parallel:
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: cover.wohnzimmer_rollo_fenster
                      state: "closed"
                    - condition: state
                      entity_id: cover.wohnzimmer_rollo_tur
                      state: "closed"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: binary_sensor.wohnzimmer_open_window
                          state: "on"
                      sequence:
                        - delay: "00:15:00"
                - service: cover.set_cover_position
                  target:
                    entity_id:
                      - cover.wohnzimmer_rollo_fenster
                      - cover.wohnzimmer_rollo_tur
                  data:
                    position: 23
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: cover.fabians_zimmer_rollo
                      state: "closed"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: binary_sensor.fabian_s_open_window
                          state: "on"
                      sequence:
                        - delay: "00:15:00"
                - choose:
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.weather_ebersberg_hourly
                          attribute: temperature
                          above: 20
                      sequence:
                        - service: cover.set_cover_position
                          target:
                            entity_id: cover.fabians_zimmer_rollo
                          data:
                            position: 45
                  default:
                    - service: cover.set_cover_position
                      target:
                        entity_id: cover.fabians_zimmer_rollo
                      data:
                        position: 33

- id: lower_covers_when_very_bright_outside
  alias: "lower all covers when very brigt outside"
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      above: 15000
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      above: 70
  condition:
    condition: and
    conditions:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.weather_ebersberg_hourly
            attribute: forecast[0].condition
            state: "rainy"
      - condition: time
        after: "13:30:00"
        before: "17:30:00"
      - condition: state
        entity_id: input_boolean.abwesend_modus
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.lower_covers_when_very_bright_outside.attributes.last_triggered) | int > 3600 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.fabian_pc_strom
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: cover.fabians_zimmer_rollo
                  state: "closed"
          sequence:
            - service: cover.set_cover_position
              target:
                entity_id: cover.fabians_zimmer_rollo
              data:
                position: 59
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: cover.wohnzimmer_rollo_fenster
                  state: "closed"
          sequence:
            - service: cover.set_cover_position
              target:
                entity_id: cover.wohnzimmer_rollo_fenster
              data:
                position: 75
            - service: cover.set_cover_position
              target:
                entity_id: cover.wohnzimmer_rollo_tur
              data:
                position: 90

- id: open_covers_when_darker_outside
  alias: "open all covers when darker outside"
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      below: 20000
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      above: 70
  condition:
    condition: and
    conditions:
      - condition: time
        after: "11:30:00"
        before: "17:30:00"
      - condition: state
        entity_id: input_boolean.abwesend_modus
        state: "off"
      - condition: numeric_state
        entity_id: sensor.dwd_illuminance
        above: 6000
      - condition: numeric_state
        entity_id: sensor.fabian_s_zuhause_solar_percentage
        above: 10
      - condition: sun
        before: sunset
      - condition: numeric_state
        entity_id: sensor.weather_ebersberg_hourly
        below: 25
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: cover.fabians_zimmer_rollo
              attribute: current_position
              below: 85
          sequence:
            - service: cover.open_cover
              target:
                entity_id: cover.fabians_zimmer_rollo
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: cover.wohnzimmer_rollo_fenster
              attribute: current_position
              below: 95
          sequence:
            - service: cover.open_cover
              target:
                entity_id:
                  - cover.wohnzimmer_rollo_fenster
                  - cover.wohnzimmer_rollo_tur

- id: lower_covers_when_hot_outside
  alias: "lower covers when hot outside"
  trigger:
    - platform: numeric_state
      entity_id: sensor.weather_ebersberg_hourly
      above: 23
  condition:
    condition: and
    conditions:
      - condition: time
        after: "11:30:00"
        before: "17:30:00"
      - condition: state
        entity_id: input_boolean.abwesend_modus
        state: "off"
      - condition: or
        conditions:
          - condition: template
            value_template: "{{state_attr('sensor.weather_ebersberg_hourly', 'forecast')[0]['condition'] == 'sunny' }}"
          - condition: template
            value_template: "{{state_attr('sensor.weather_ebersberg_hourly', 'forecast')[0]['condition'] == 'partlycloudy' }}"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.fabian_pc_strom
                      state: "on"
                  sequence:
                    - service: cover.set_cover_position
                      target:
                        entity_id: cover.fabians_zimmer_rollo
                      data:
                        position: 80
              default:
                - service: cover.set_cover_position
                  target:
                    entity_id:
                      - cover.wohnzimmer_rollo_fenster
                      - cover.wohnzimmer_rollo_tur
                      - cover.fabians_zimmer_rollo
                  data:
                    position: 60
      default:
        - service: cover.set_cover_position
          target:
            entity_id: all
          data:
            position: 25

- id: close_all_covers_when_sun_set
  alias: "Close all covers at evening"
  trigger:
    - platform: time
      at: "21:50:00"
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-2) == (as_timestamp(states.automation.lower_all_covers_when_sun_set.attributes.last_triggered) + 2700) | round(-2) }}"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.lower_all_covers_when_sun_set.attributes.last_triggered) | int > 3200 }}"
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: cover.wohnzimmer_rollo_fenster
                      state: "closed"
                    - condition: state
                      entity_id: cover.wohnzimmer_rollo_tur
                      state: "closed"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: device_tracker.wohnzimmer_tv
                          state: "home"
                        - condition: state
                          entity_id: switch.fernseher
                          state: "on"
                      sequence:
                        - service: light.turn_on
                          data:
                            entity_id:
                              - light.leds_wohnzimmer_tv
                              - light.leds_wohnzimmer
                              - light.stehlampe
                            transition: 2
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: binary_sensor.wohnzimmer_open_window
                          state: "on"
                      sequence:
                        - delay: "00:15:00"
                - service: cover.close_cover
                  target:
                    entity_id:
                      - cover.wohnzimmer_rollo_fenster
                      - cover.wohnzimmer_rollo_tur
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: cover.fabians_zimmer_rollo
                      state: "closed"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: device_tracker.fabian_pc
                          state: home
                      sequence:
                        - service: light.turn_on
                          data:
                            entity_id:
                              - light.leds_tisch
                              - light.mibedsidelamp2_22e2
                            transition: 2
                        - service: light.turn_on
                          data:
                            entity_id:
                              - light.regal
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: binary_sensor.fabian_s_open_window
                          state: "on"
                      sequence:
                        - delay: "00:15:00"
                - choose:
                    - conditions:
                        - condition: numeric_state
                          entity_id: sensor.weather_ebersberg_hourly
                          above: 20
                        - condition: state
                          entity_id: binary_sensor.workday_sensor
                          state: "on"
                      sequence:
                        - service: cover.set_cover_position
                          target:
                            entity_id: cover.fabians_zimmer_rollo
                          data:
                            position: 33
                    - conditions:
                        - condition: state
                          entity_id: binary_sensor.workday_sensor
                          state: "off"
                      sequence:
                        - service: cover.close_cover
                          target:
                            entity_id: cover.fabians_zimmer_rollo
                  default:
                    - service: cover.set_cover_position
                      target:
                        entity_id: cover.fabians_zimmer_rollo
                      data:
                        position: 23

- id: telegram_pill_1h
  alias: "Telegram pill 1h"
  initial_state: false
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/pill1h"
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pill1h
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, eine Stunde"
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - delay: "00:60:00"
    - service: notify.telegram_fabian
      data:
        message: "Pille nehmen nicht vergessen!"
        data:
          inline_keyboard:
            - "Erledigt:/pilldone, Erinnern1h:/pill1h"

- id: telegram_pill_marked_done
  alias: "Telegram pill marked done"
  initial_state: false
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/pilldone"
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pilldone
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_reset_pill_counter
  alias: "Telegram reset pill counter"
  initial_state: false
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/pillreset"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay. Du nimmst die Pille durch."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - service: counter.configure
      data:
        entity_id: counter.pille
        value: 28

- id: telegram_washing_mashine_set_program_30_degrees_pflegeleicht
  alias: "Telegram Washing mashine set program 30 degrees pflegeleicht"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/washerstart30"
  action:
    - service: telegram_bot.answer_callback_query
      continue_on_error: true
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, Programm gesetzt."
    - service: telegram_bot.edit_replymarkup
      continue_on_error: true
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 20000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "30 Grad Pflegeleicht wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "30 Grad Pflegeleicht wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."

- id: telegram_washing_mashine_set_program_20_degrees_feinwasche
  alias: "Telegram Washing mashine set program 20 degrees feinwasche"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/washerstart20fw"
  action:
    - service: telegram_bot.answer_callback_query
      continue_on_error: true
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, Programm gesetzt."
    - service: telegram_bot.edit_replymarkup
      continue_on_error: true
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 20000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "20 Grad Feinw√§sche wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "20 Grad Feinw√§sche wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."

- id: telegram_washing_mashine_set_program_60_degrees_koch_bunt
  alias: "Telegram Washing mashine set program 60 degrees koch bunt"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/washerstart60kb"
  action:
    - service: telegram_bot.answer_callback_query
      continue_on_error: true
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, Programm gesetzt."
    - service: telegram_bot.edit_replymarkup
      continue_on_error: true
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 20000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "60 Grad Koch-/Buntw√§sche wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "60 Grad Koch-/Buntw√§sche wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."

- id: telegram_washing_mashine_set_program_40_degrees_pflegeleicht
  alias: "Telegram Washing mashine set program 40 degrees pflegeleicht"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/washerstart40"
  action:
    - service: telegram_bot.answer_callback_query
      continue_on_error: true
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, Programm gesetzt."
    - service: telegram_bot.edit_replymarkup
      continue_on_error: true
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 20000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "40 Grad Pflegeleicht wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "40 Grad Pflegeleicht wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."

- id: telegram_washing_mashine_set_program_40_degrees_koch_bunt
  alias: "Telegram Washing mashine set program 40 degrees Koch Bunt"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/washerstart40kb"
  action:
    - service: telegram_bot.answer_callback_query
      continue_on_error: true
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, Programm gesetzt."
    - service: telegram_bot.edit_replymarkup
      continue_on_error: true
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 20000
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "40 Grad Koch-/Buntw√§sche wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "40 Grad Koch-/Buntw√§sche wurde als Waschmaschinen Programm ausgew√§hlt. Voraussichtlich fertig um {{ states.sensor.washing_machine_finish_time.state }} Uhr."

- id: telegram_shutdown_fpc
  alias: "Telegram shutdown fpc"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/shutdownfpc"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "PC wird heruntergefahren, Strom wird ausgeschaltet."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.fabian_pc_strom

- id: telegram_hibernate_fpc
  alias: "Telegram hibernate fpc"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/hibernatefpc"
  action:
    - service: system_bridge.send_command
      data:
        bridge: adad8b8056b4dfcde2399824f9be1dd5
        command: shutdown
        arguments: "/h /t 0"
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "OK, PC wird in Ruhezustand gestellt."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_shutdown_npc
  alias: "Telegram shutdown npc"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/shutdownnpc"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "PC wird heruntergefahren, Strom wird ausgeschaltet."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.samuel_pc_strom

- id: telegram_hibernate_npc
  alias: "Telegram hibernate npc"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/hibernatenpc"
  action:
    - service: system_bridge.send_command
      data:
        bridge: adad8b8056b4dfcde239???
        command: shutdown
        arguments: "/h /t 0"
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "OK, PC wird in Ruhezustand gestellt."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_reboot_ha
  alias: Telegram Reboot HA
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_command
    event_data:
      command: "/rebootha"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "Restarting Homeassistant Container..."
    - service: homeassistant.restart

- id: telegram_reboot
  alias: Telegram Reboot
  initial_state: false
  trigger:
    platform: event
    event_type: telegram_command
    event_data:
      command: "/reboot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "Rebooting Server..."
    - delay: 00:00:05
    - service: shell_command.restartha

- id: telegram_help
  alias: Telegram Help
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/help"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/help@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: >
          Hier sind ein paar Befehle:

          /admin - √úbersicht der Admin Befehle
          /food - zuf√§lliger Essensvorschlag

- id: telegram_admin
  alias: Telegram Admin
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/admin"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/admin@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: >
          Hier sind ein paar Befehle:

          /rebootha - Neustart Homeassistant Container
          /reboot - Neustart Homeassistant Core
          /status - Homeassistant Status
          /updateha - Homeassistant Update starten

- id: telegram_status
  alias: Telegram Status
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/status"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/status@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "System is online! Current time: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}."

- id: telegram_essen
  alias: Telegram Essen
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/food"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/food@smartlife_ha_bot"
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/foodno"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "foodno@smartlife_ha_bot"
  action:
    - service: telegram_bot.answer_callback_query
      continue_on_error: true
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, neues Essen."
    - service: telegram_bot.edit_replymarkup
      continue_on_error: true
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - service: homeassistant.reload_config_entry
      target:
        entity_id: sensor.chefkoch_random_recipe
    - delay: "00:00:01"
    - service: telegram_bot.send_message
      data:
        title: "Zufallsessensvorschlag: "
        target: "{{ trigger.event.data.chat_id }}"
        message: >
          **Rezept:** {{ states.sensor.chefkoch_random_recipe.state }}


          {{ state_attr('sensor.chefkoch_random_recipe', 'url') }}

          {% if state_attr('sensor.chefkoch_random_recipe', 'totalTime') %}
          **Zubereitungszeit:** {{ state_attr('sensor.chefkoch_random_recipe', 'totalTime') }}
          {% endif %}

          {% if state_attr('sensor.chefkoch_random_recipe', 'ingredients') %}
          **Zutaten:** {{ state_attr('sensor.chefkoch_random_recipe', 'ingredients') | join(', ') }}
          {% endif %}

          {% if state_attr('sensor.chefkoch_random_recipe', 'calories') %}
          **Kalorien:** {{ state_attr('sensor.chefkoch_random_recipe', 'calories') }}
          {% endif %}

          {% if state_attr('sensor.chefkoch_random_recipe', 'category') %}
          **Kategorie:** {{ state_attr('sensor.chefkoch_random_recipe', 'category') }}
          {% endif %}
        disable_notification: true
        inline_keyboard:
          - "Ja:/foodyes, Nein:/foodno"

- id: telegram_essen_vegan
  alias: Telegram Essen Vegan
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/foodv"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/foodv@smartlife_ha_bot"
  action:
    - service: homeassistant.reload_config_entry
      target:
        entity_id: sensor.chefkoch_vegan_recipe
    - delay: "00:00:01"
    - service: telegram_bot.send_message
      data:
        title: "Veganer Zufallsessensvorschlag: "
        target: "{{ trigger.event.data.chat_id }}"
        message: >
          **Rezept:** {{ states.sensor.chefkoch_vegan_recipe.state }}


          {{ state_attr('sensor.chefkoch_vegan_recipe', 'url') }}

          {% if state_attr('sensor.chefkoch_vegan_recipe', 'totalTime') %}
          **Zubereitungszeit:** {{ state_attr('sensor.chefkoch_vegan_recipe', 'totalTime') }}
          {% endif %}

          {% if state_attr('sensor.chefkoch_vegan_recipe', 'ingredients') %}
          **Zutaten:** {{ state_attr('sensor.chefkoch_vegan_recipe', 'ingredients') | join(', ') }}
          {% endif %}

          {% if state_attr('sensor.chefkoch_vegan_recipe', 'calories') %}
          **Kalorien:** {{ state_attr('sensor.chefkoch_vegan_recipe', 'calories') }}
          {% endif %}

          {% if state_attr('sensor.chefkoch_vegan_recipe', 'category') %}
          **Kategorie:** {{ state_attr('sensor.chefkoch_vegan_recipe', 'category') }}
          {% endif %}
        disable_notification: true
        inline_keyboard:
          - "Ja:/foodyes, Nein:/foodno"

- id: telegram_food_yes
  alias: "Telegram food yes"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/foodyes"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: !secret telegram_chat_samuel
        inline_keyboard: []
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: !secret telegram_chat_fabian
        inline_keyboard: []

- id: telegram_answer_no
  alias: "Telegram answer no"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/telegramno"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/telegramno@smartlife_ha_bot"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: whatsapp_waste_put_outside
  alias: "WhatsApp waste put outside"
  initial_state: true
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: >
        {{ ('m√ºll' in trigger.event.data.content | lower and ('erledigt' in trigger.event.data.content | lower or 'raus' in trigger.event.data.content | lower))
           or trigger.event.data.content | lower == 'm√ºll_erledigt' }}
  action:
    - service: automation.trigger
      entity_id: automation.telegram_waste_put_outside
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: "Spitze! üöõüí® Der M√ºll wurde rausgestellt."

- id: telegram_waste_put_outside
  alias: "Telegram waste put outside"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/telegramwastedone"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/telegramwastedone@smartlife_ha_bot"
  action:
    - if:
        - condition: template
          value_template: "{{ trigger is defined and trigger.platform == 'event' }}"
      then:
        - service: telegram_bot.answer_callback_query
          data:
            callback_query_id: "{{ trigger.event.data.id }}"
            message: "Spitze! üöõüí® Der M√ºll wurde rausgestellt."
        - service: telegram_bot.edit_replymarkup
          data:
            message_id: "{{ trigger.event.data.message.message_id }}"
            chat_id: "{{ trigger.event.data.chat_id }}"
            inline_keyboard: []

- id: telegram_dust_bin_emptied
  alias: "Telegram dust bin emptied"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/telegramdustbindone"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/telegramdustbindone@smartlife_ha_bot"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Spitze!"
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_washer_emptied
  alias: "Telegram washer emptied"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/telegramwasherdone"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/telegramwasherdone@smartlife_ha_bot"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Spitze!"
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine wurde ausger√§umt."
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine wurde ausger√§umt."

- id: telegram_pouring_done
  alias: "Telegram pouring done"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/telegrampouringdone"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/telegrampouringdone@smartlife_ha_bot"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Spitze!"
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    #- service: notify.telegram_fabian
    #  data:
    #    message: "Die Pflanzen wurden gegossen."
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.gemeinde_zorneding_current_warning_level
              state: "2"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 20000
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Die Pflanzen wurden gegossen."

- id: telegram_answer_cancel_light_turn_off
  alias: "Telegram answer cancel light turn off"
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: "/cancellight"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Licht wird in 20 Minuten NICHT ausgeschaltet."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_remaining_time_coal_lighter
  alias: Telegram Remaining Time Coal Lighter
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/remaining_time"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/remaining_time"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/remaining_time@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "{{ states.sensor.coal_lighter_finish_duration.attributes.friendly_name }} ist in ungef√§hr {{ states.sensor.coal_lighter_finish_duration.state }} Minuten fertig."
        disable_notification: true

- id: telegram_start_coal_lighter_timer
  alias: Telegram Start Coal Lighter Timer
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/shisha"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/shisha"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/shisha@smartlife_ha_bot"
  action:
    - service: input_button.press
      target:
        entity_id: input_button.kohleanzunder_timer
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "Kohleanz√ºnder Timer wurde gestartet."
        disable_notification: true

- id: telegram_phoenixbad_feedback
  alias: Telegram Phoenix-Bad Feedback
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/phoenix"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/ph√∂nix"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/phoenix@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: >
          *Ph√∂nix-Bad Ottobrunn Auslastung:*

          - *Die aktuelle Auslastung im Ph√∂nix Bad betr√§gt:*

            * Schwimmbadbereich: {{ states('sensor.pool_occupancy') | default('?', true) }}%
            * Sauna: {{ states('sensor.sauna_occupancy') | default('?', true) }}%

- id: telegram_turn_off_fridge
  alias: Telegram Turn off fridge
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_callback
      event_data:
        data: "/fridgeoff"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/fridgeoff@smartlife_ha_bot"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_turn_off_fridge.attributes.last_triggered) | int > 4600 }}"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.kuhlschrank
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.chat_id }}"
        message: "Okay, wird ausgeschaltet."
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "K√ºhlschrank wurde ausgeschaltet."
        disable_notification: true

- id: telegram_ha_update
  alias: Telegram HA Update
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_command
    event_data:
      command: "/updateha"
  action:
    - service: update.install
      target:
        entity_id: update.home_assistant_core_update
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "HA Update gestartet."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_ha_os_update
  alias: Telegram HA OS Update
  initial_state: true
  trigger:
    platform: event
    event_type: telegram_command
    event_data:
      command: "/updateos"
  action:
    - service: update.install
      target:
        entity_id: update.home_assistant_operating_system_update
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "OS Update gestartet."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []

- id: telegram_send_weather_forecast
  alias: "Telegram send weather forecast"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/weather"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/weather@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        disable_notification: true
        message: >
          Wettervorhersage f√ºr heute {{ states.weather.ebersberg_ebersberg.state }} bei {{ states.weather.ebersberg_ebersberg.attributes.temperature }} ¬∞C
          *Momentan {{ states.sensor.weather_ebersberg_hourly.attributes.forecast[0].temperature }} ¬∞C*


          Niederschlag: {{ states.sensor.ebersberg_precipitation_2.state }} mm/h, Wahrscheinlichkeit: {{ states.sensor.ebersberg_precipitation_probability_2.state }} %.

- id: turn_on_strom_k√ºhlschrank
  alias: "Turn on Strom K√ºhlschrank"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/k√ºhlschrank"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/kuehlschrank"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/fridge"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/fridge@smartlife_ha_bot"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.kuhlschrank
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        # target: "{{ trigger.event.data.chat_id }}"
        message: "K√ºhlschrank im Keller wurde angeschaltet. Achtung: Wird hier√ºber NICHT ausgeschaltet!"

- id: turn_on_climates
  alias: "Turn on Climates"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/climateson"
  action:
    - service: telegram_bot.answer_callback_query
      data:
        callback_query_id: "{{ trigger.event.data.id }}"
        message: "Okay, werden eingeschaltet."
    - service: telegram_bot.edit_replymarkup
      data:
        message_id: "{{ trigger.event.data.message.message_id }}"
        chat_id: "{{ trigger.event.data.chat_id }}"
        inline_keyboard: []
    - service: input_boolean.turn_off
      data:
        entity_id: switch.climate_off

- id: find_phone_fabian
  alias: "Find Fabians Phone by sound"
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_button.find_fabian_s_phone_by_sound
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/lostfabian"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/lostfabian@smartlife_ha_bot"
  action:
    - service: notify.mobile_app_fabian_iphone
      data:
        message: "This phone is marked as lost! +49176 66334870"
        data:
          push:
            sound:
              name: "default"
              critical: 1
              volume: 1.0
    - service: icloud.play_sound
      data:
        account: !secret vapid_email
        device_name: Fabian-iPhone

- id: find_ipad_fabian
  alias: "Find Fabians ipad by sound"
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_button.find_fabian_s_ipad_by_sound
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/lostfabian"
  action:
    - service: icloud.play_sound
      data:
        account: !secret vapid_email
        device_name: Fabian-iPad

- id: telegram_urgent_message
  alias: "Telegram urgent message"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/urgent"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/urgent@smartlife_ha_bot"
  action:
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        message: "Alle Google Homes werden Fabi/samuel √ºber eine wichtige Nachricht bescheid geben."
    #- service: notify.mobile_app_fabian_iphone
    #  data:
    #    message: "Wichtige Nachricht, schau auf dein Handy!"
    #    data:
    #      push:
    #        sound:
    #          name: "default"
    #          critical: 1
    #          volume: 0.4
    - service: media_player.volume_set
      data:
        volume_level: 0.7
        entity_id: media_player.wohnzimmer_uhr
    - service: tts.speak
      entity_id:
        - media_player.wohnzimmer_uhr
        - media_player.kuche_speaker
        - media_player.fabians_lautsprecher
      data:
        message: >
          Wichtige Nachricht von
          {% if (is_state("trigger.event.data.user_id", "649657901")) -%}
          Fabian
          {% elif (is_state("trigger.event.data.user_id", "654536464")) -%}
          samuel
          {% elif (is_state("trigger.event.data.user_id", "665446537")) -%}
          Kai
          {% elif (is_state("trigger.event.data.user_id", "159366362")) -%}
          Adri
          {% elif (is_state("trigger.event.data.user_id", "668937527")) -%}
          Flo
          {% elif (is_state("trigger.event.data.user_id", "610791756")) -%}
          Maxi
          {% else %}
          jemandem
          {% endif %}
          Schau auf dein Handy!
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: input_boolean.gast_modus
                  state: "on"
          sequence:
            - service: tts.speak
              entity_id: media_player.gastezimmer_mini
              data:
                message: >
                  Wichtige Nachricht von
                  {% if (is_state("trigger.event.data.user_id", "649657901")) -%}
                  Fabian
                  {% elif (is_state("trigger.event.data.user_id", "654536464")) -%}
                  samuel
                  {% elif (is_state("trigger.event.data.user_id", "665446537")) -%}
                  Kai
                  {% elif (is_state("trigger.event.data.user_id", "159366362")) -%}
                  Adri
                  {% elif (is_state("trigger.event.data.user_id", "668937527")) -%}
                  Flo
                  {% elif (is_state("trigger.event.data.user_id", "610791756")) -%}
                  Maxi
                  {% else %}
                  jemandem
                  {% endif %}
                  Schau auf dein Handy!
    - service: media_player.volume_set
      data:
        volume_level: 0.3
        entity_id: media_player.wohnzimmer_uhr

- id: telegram_open_door
  alias: "Telegram open door"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/open"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/open@smartlife_ha_bot"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/alohomora"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: switch.schloss
                  state: "unavailable"
          sequence:
            - service: switch.turn_on
              data:
                entity_id: switch.schloss
            - service: telegram_bot.send_message
              data:
                target: "{{ trigger.event.data.chat_id }}"
                # target: "{{ trigger.event.data.chat_id }}"
                message: "Gartentor wurde ge√∂ffnet."
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: switch.schloss
                  state: "unavailable"
          sequence:
            - service: telegram_bot.send_message
              data:
                target: "{{ trigger.event.data.chat_id }}"
                message: "Der Gartentor√∂ffner ist aktuell offline. Das Gartentor wurde NICHT ge√∂ffnet. Fabian wurde informiert. Bitte nutze /klingel stattdessen."
            - service: notify.telegram_fabian
              data:
                message: "Gartentor√∂ffner ist offline! Bitte neustarten."

- id: telegram_virtual_bell
  alias: "Telegram virtual bell"
  initial_state: true
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/klingel"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/klingel@smartlife_ha_bot"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    - service: notify.mobile_app_fabian_iphone
      data:
        message: "Es klingelt! Jemand ist da."
        data:
          push:
            sound:
              name: "default"
              critical: 1
              volume: 0.7
    - service: media_player.volume_set
      data:
        volume_level: 0.7
        entity_id: media_player.wohnzimmer_uhr
    - service: tts.speak
      entity_id:
        - media_player.wohnzimmer_uhr
        - media_player.kuche_speaker
      data:
        message: >
          Ding Dong, es klingelt.
          {% if is_state_attr('trigger.event.data', 'user_id', '649657901') %}
            Fabian
          {% elif is_state_attr('trigger.event.data', 'user_id', '654536464') %}
            samuel
          {% elif is_state_attr('trigger.event.data', 'user_id', '665446537') %}
            Kai
          {% elif is_state_attr('trigger.event.data', 'user_id', '159366362') %}
            Adri
          {% else %}
            Jemand
          {% endif %}
          ist da.
    - service: telegram_bot.send_message
      data:
        target: "{{ trigger.event.data.chat_id }}"
        # target: "{{ trigger.event.data.chat_id }}"
        message: "Klingel in Wohnung aktiviert. Gartentor wurde ge√∂ffnet."
    - service: media_player.volume_set
      data:
        volume_level: 0.3
        entity_id: media_player.wohnzimmer_uhr
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              data:
                entity_id: media_player.wohnzimmer_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/doorbell.wav -t audio/wav"
            - service: notify.wohnzimmer_tv
              continue_on_error: true
              data:
                message: >
                  Ding Dong, es klingelt.
                  {% if is_state_attr('trigger.event.data', 'user_id', '649657901') %}
                    Fabian
                  {% elif is_state_attr('trigger.event.data', 'user_id', '654536464') %}
                    samuel
                  {% elif is_state_attr('trigger.event.data', 'user_id', '665446537') %}
                    Kai
                  {% elif is_state_attr('trigger.event.data', 'user_id', '159366362') %}
                    Adri
                  {% else %}
                    Jemand
                  {% endif %}
                  ist da.
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/doorbell.wav -t audio/wav"
            - service: notify.keller_tv
              continue_on_error: true
              data_template:
                message: >
                  Ding Dong, es klingelt.
                  {% if is_state_attr('trigger.event.data', 'user_id', '649657901') %}
                    Fabian
                  {% elif is_state_attr('trigger.event.data', 'user_id', '654536464') %}
                    samuel
                  {% elif is_state_attr('trigger.event.data', 'user_id', '665446537') %}
                    Kai
                  {% elif is_state_attr('trigger.event.data', 'user_id', '159366362') %}
                    Adri
                  {% else %}
                    Jemand
                  {% endif %}
                  ist da.

- id: "squash_detailed_informations"
  alias: "Squash - Detailed Slot Notification"
  description: "Sends a notification with the count and list of all free slots."
  trigger:
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/squash"
    - platform: event
      event_type: telegram_command
      event_data:
        command: "/squash@smartlife_ha_bot"
  condition:
    - condition: template
      value_template: "{{ states.ssensor.eversports_squash_next_available.state != 'Keine freien Slots' }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: "{{ trigger.event.data.chat_id }}"
        message: >
          Der n√§chste Freie Platz ist um {{ states('sensor.eversports_squash_next_available') }} Uhr verf√ºgbar.
          Insgesamt sind heute {{ state_attr('sensor.eversports_squash_next_available', 'available_slots_count') }} buchbare Platzzeiten verf√ºgbar.

          Alle freien Zeiten: {{ state_attr('sensor.eversports_squash_next_available', 'available_slots_list') | join(', ') }}
        data:
          inline_keyboard:
            - "Website|https://www.eversports.de/widget/w/hwhk63"
    - service: notify.telegram_fabian
      data:
        message: "Pille nehmen nicht vergessen!"
        data:
          inline_keyboard:
            - "Erledigt:/pilldone, Erinnern1h:/pill1h"
  mode: single

- id: remind_to_open_doors_for_vacuum
  alias: "Remind to open doors for vacuum"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.schedule.reinigung.attributes.next_event) - 1800) | round(-1) }}"
  condition:
    - condition: state
      entity_id: input_boolean.abwesend_modus
      state: "off"
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
    - condition: state
      entity_id: input_boolean.leiser_modus
      state: "off"
    - condition: state
      entity_id: schedule.reinigung
      state: "off"
    - condition: not
      conditions:
        - condition: state
          entity_id: vacuum.valetudo_dreamez10pro
          state: "cleaning"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.samuel
              state: "home"
          sequence:
            - service: notify.telegram_fabian
              data_template:
                message: "Die geplante Staubsauger Reinigung startet in 30 Minuten. Bitte alle T√ºren √∂ffnen."
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: notify.telegram_fabian
              data_template:
                message: "Die geplante Staubsauger Reinigung startet in 30 Minuten. Bitte alle T√ºren √∂ffnen."

- id: turn_on_vacuum_weekly
  alias: "Turn on vacuum weekly"
  initial_state: true
  trigger:
    - platform: state
      entity_id: schedule.reinigung
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.abwesend_modus
      state: "off"
    - condition: state
      entity_id: input_boolean.leiser_modus
      state: "off"
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.staubsauger
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            # if Fabi & samuel not at home clean all rooms
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["6", "3", "4", "2", "5"], "customOrder": true}'
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            # else if only fabi is not at home clean all rooms except fabians room
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["6", "3", "4", "5"], "customOrder": true}'
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["6", "3", "4"], "customOrder": true}'
      default:
        # default if fabi & samuel at home: clean only living room, floor & kitchen
        - service: mqtt.publish
          data:
            topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
            payload: '{"segment_ids": ["6", "3", "4", "2"], "customOrder": true}'

- id: vacuum_cleaner_error
  alias: "Vacuum Cleaner Error"
  initial_state: true
  trigger:
    - platform: state
      entity_id: vacuum.valetudo_dreamez10pro
      to: "error"
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != 'unavailable' }}"
    - condition: template
      value_template: "{{ trigger.from_state.state != 'unknown' }}"
  action:
    - delay: "00:00:30"
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                message: >
                  James hat ein Problem: {{ states.sensor.valetudo_dreamez10pro_error_description.state }}

                  Die Reinigung wurde daher unterbrochen.
                target: !secret telegram_chat_fabian
        - conditions:
            - condition: state
              entity_id: person.samuel
              state: "home"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                message: >
                  James hat ein Problem: {{ states.sensor.valetudo_dreamez10pro_error_description.state }}

                  Die Reinigung wurde daher unterbrochen.
                target: !secret telegram_chat_samuel

- id: james_room_cleaning
  alias: "James Raum Reinigiung"
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_button.james_room_cleaning
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "Wohnzimmer"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["6"]}'
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "K√ºche"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["4"]}'
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "Fabians-Zimmer"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["2"]}'
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "Samuels-Zimmer"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["5"]}'
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "Bad"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["1"]}'
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "Flur"
          sequence:
            - service: mqtt.publish
              data:
                topic: valetudo/dreamez10pro/MapSegmentationCapability/clean/set
                payload: '{"segment_ids": ["3"]}'
        - conditions:
            - condition: state
              entity_id: input_select.vacuum_cleaning_location
              state: "Gesamt"
          sequence:
            - service: vacuum.start
              data:
                entity_id: vacuum.valetudo_dreamez10pro
    - delay: "00:30:00"
    - service: input_select.select_option
      data:
        entity_id: input_select.vacuum_cleaning_location
        option: "Gesamt"

- id: vacuum_reset_water_level
  alias: "Reset the Vacuum water level"
  trigger:
    - platform: state
      entity_id: vacuum.valetudo_dreamez10pro
      from: "Returning to dock"
      to: "docked"
  action:
    - service: select.select_option
      data:
        entity_id: select.valetudo_dreamez10pro_water_grade
        option: "medium"
    - service: select.select_option
      data:
        entity_id: select.valetudo_dreamez10pro_operation_mode
        option: "vacuum_and_mop"

- id: warning_for_closed_doors
  alias: "Warning for closed doors"
  trigger:
    - platform: state
      entity_id: vacuum.valetudo_dreamez10pro
      to: "returning"
      for:
        minutes: 1
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.valetudo_dreamez10pro_current_statistics_area
        below: 220
      - condition: numeric_state
        entity_id: sensor.valetudo_dreamez10pro_current_statistics_area
        above: 10
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_vacuum_weekly.attributes.last_triggered) | int < 5400 }}"
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.smart_life_fabian_distance
              below: 70
          sequence:
            - service: notify.telegram_fabian
              data_template:
                message: "Anscheinend waren T√ºren bei der geplanten Reinigung geschlossen. Daher wurden nicht alle R√§ume gesaugt."

- id: trigger_a_full_dust_bin_reminder
  alias: "Trigger a full dust bin reminder"
  trigger:
    - platform: state
      entity_id: automation.trigger_a_full_dust_bin_reminder
      to: "on"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_samuel_distance
                  below: 10
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                message: "Der Staubbeh√§lter des Staubsaugroboters k√∂nnte langsam voll sein und sollte geleert werden."
                target: !secret telegram_chat_samuel
                inline_keyboard:
                  - "Erledigt:/telegramdustbindone"
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.smart_life_fabian_distance
                  below: 10
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: telegram_bot.send_message
              data:
                message: "Der Staubbeh√§lter des Staubsaugroboters k√∂nnte langsam voll sein und sollte geleert werden."
                target: !secret telegram_chat_fabian
                inline_keyboard:
                  - "Erledigt:/telegramdustbindone"

- id: vacuum_cleaner_counter
  alias: "Set Counter with Cleaner Runs and remind for emptying and refilling"
  trigger:
    - platform: state
      entity_id: vacuum.valetudo_dreamez10pro
      from: "docked"
      for:
        minutes: 2
  condition:
    condition: not
    conditions:
      - condition: state
        entity_id: vacuum.valetudo_dreamez10pro
        state: unavailable
      - condition: state
        entity_id: vacuum.valetudo_dreamez10pro
        state: idle
  action:
    - service: counter.decrement
      target:
        entity_id: counter.vacuum_water_level
    - choose:
        - conditions:
            - condition: state
              entity_id: select.valetudo_dreamez10pro_water_grade
              state: high
          sequence:
            - service: counter.decrement
              target:
                entity_id: counter.vacuum_water_level
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.vacuum_water_level
              below: 1
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.samuel
                      state: home
                  sequence:
                    - service: notify.telegram_fabian
                      data_template:
                        message: "Der Wassertank des Staubsaugroboters sollte zeitnah aufgef√ºllt werden."
            - choose:
                - conditions:
                    - condition: state
                      entity_id: person.fabian
                      state: home
                  sequence:
                    - service: notify.telegram_fabian
                      data_template:
                        message: "Der Wassertank des Staubsaugroboters sollte zeitnah aufgef√ºllt werden."
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ states('counter.vacuum_runs')|float % 30 == 0 }}"
          sequence:
            - service: automation.trigger
              entity_id: automation.trigger_a_full_dust_bin_reminder
        - conditions:
            - condition: template
              value_template: "{{ states('counter.vacuum_runs')|float % 30 != 0 }}"
          sequence:
            - service: counter.increment
              target:
                entity_id: counter.vacuum_runs

- id: vacuum_water_refilled
  alias: "Vacuum Water refilled"
  trigger:
    - platform: state
      entity_id: binary_sensor.valetudo_dreamez10pro_water_tank_attachment
      from: "off"
      to: "on"
      for:
        seconds: 5
  condition:
    condition: not
    conditions:
      - condition: state
        entity_id: vacuum.valetudo_dreamez10pro
        state: unavailable
      - condition: numeric_state
        entity_id: counter.vacuum_water_level
        above: 90
  action:
    - service: counter.reset
      target:
        entity_id: counter.vacuum_water_level
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.samuel
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data_template:
                message: "Der Wassertank des Staubsaugroboters wurde soeben aufgef√ºllt."
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data_template:
                message: "Der Wassertank des Staubsaugroboters wurde soeben aufgef√ºllt."

- id: turn_off_staubsauger_after_x_hours
  alias: "Turn off staubsauger after x hours"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.staubsauger
      to: "on"
      for:
        minutes: 150
    - platform: state
      entity_id: switch.staubsauger
      from: "off"
      to: "on"
      for:
        minutes: 360
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.staubsauger

- id: whatsapp_status_bot
  alias: WhatsApp Status Bot
  description: "Replies to 'Status' with detailed system health."
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: "{{ trigger.event.data.content | lower == 'status' }}"
  action:
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: >
          ‚úÖ *Home Assistant Online*

          üïí *Zeit:* {{ now().strftime('%H:%M') }} Uhr

          üìÖ *Datum:* {{ now().strftime('%d.%m.%Y') }}

          üíª *System Health:*
          - CPU: {{ states('sensor.processor_use') | default('?', true) }}%
          - RAM: {{ states('sensor.memory_use_percent') | default('?', true) }}%
          - Disk: {{ states('sensor.disk_use_percent') | default('?', true) }}%
          - Uptime:
          {%- if states('sensor.last_boot') not in ['unknown', 'unavailable', 'None'] -%}
            {{ relative_time(states('sensor.last_boot') | as_datetime) }}
          {%- elif states('sensor.uptime') not in ['unknown', 'unavailable', 'None'] -%}
            {{ states('sensor.uptime') }}
          {%- else -%}
            ?
          {%- endif %}

          üîó *Source:* https://faserf.github.io/ha-whatsapp/

- id: whatsapp_beer_bot
  alias: "WhatsApp Bot: Beer Keyword"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: >
        {{ 'beer' in trigger.event.data.content | lower or
          'cheers' in trigger.event.data.content | lower or
          'bier' in trigger.event.data.content | lower or
          'prost' in trigger.event.data.content | lower }}
  action:
    - service: whatsapp.send_reaction
      data:
        target: "{{ trigger.event.data.sender }}"
        reaction: "üç∫"
        message_id: "{{ trigger.event.data.raw.key.id }}"

- id: whatsapp_hype_bot
  alias: "WhatsApp Bot: Hype/Victory Reaction"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: >
        {{ 'geil' in trigger.event.data.content | lower or
          'stark' in trigger.event.data.content | lower or
          'sieg' in trigger.event.data.content | lower or
          'gewonnen' in trigger.event.data.content | lower or
          'sauber' in trigger.event.data.content | lower }}
  action:
    - service: whatsapp.send_reaction
      data:
        target: "{{ trigger.event.data.sender }}"
        reaction: "üî•"
        message_id: "{{ trigger.event.data.raw.key.id }}"

- id: whatsapp_help_bot
  alias: "WhatsApp Bot: Help"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: "{{ trigger.event.data.content | lower == 'help' }}"
  action:
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: >
          ü§ñ *HA WhatsApp Bot Befehle*


          üìä *Status:* Systemstatus anzeigen

          üóëÔ∏è *M√ºllabholung:* N√§chste Abholung

          üåä *Phoenix:* Aktuelle Auslastung im Ph√∂nixbad Ottobrunn

          üßó‚Äç‚ôÇÔ∏è *Boulderwelt:* Auslastungsstatistiken f√ºr Boulderwelt MUC S√ºd & Ost

          üç∫ *Bier:* Prost!

          ü§° *Witz:* Erz√§hl mir was Lustiges

          ‚ùì *Help:* Diese Hilfe anzeigen

- id: whatsapp_danke_bot
  alias: "WhatsApp Bot: Thank you Reaction"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: >
        {{ 'Danke' in trigger.event.data.content or 'Thanks' in trigger.event.data.content }}
  action:
    - service: whatsapp.send_reaction
      data:
        target: "{{ trigger.event.data.sender }}"
        reaction: "üôè"
        message_id: "{{ trigger.event.data.raw.key.id }}"

- id: whatsapp_waste_bot
  alias: "WhatsApp Bot: Waste Collection"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: "{{ 'm√ºllabholung' in trigger.event.data.content | lower or 'abfallabholung' in trigger.event.data.content | lower }}"
  action:
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: >
          ‚ôªÔ∏è *Abfallkalender:*

          - üöõ *N√§chste Abholungen in Zorneding:*
            {%- set attributes = states.sensor.nachste_abholungen.attributes %}
            {%- set dates = attributes.keys() | select('match', '^\\d{4}-\\d{2}-\\d{2}$') | sort %}
            {%- set weekdays = {'Monday': 'Montag', 'Tuesday': 'Dienstag', 'Wednesday': 'Mittwoch', 'Thursday': 'Donnerstag', 'Friday': 'Freitag', 'Saturday': 'Samstag', 'Sunday': 'Sonntag'} %}
            {%- for date in dates[:5] %}
            {%- set pickup = attributes[date] %}
            {%- set delta = ((as_timestamp(date) - as_timestamp(now().strftime('%Y-%m-%d'))) / 86400) | int %}
            {%- set day_name = weekdays[strptime(date, '%Y-%m-%d').strftime('%A')] %}
            {%- set date_german = as_timestamp(date) | timestamp_custom('%d.%m.%Y') %}
            {%- set items = pickup | replace('Restm√ºll', 'üóëÔ∏è *Restm√ºll*')
                                  | replace('Biotonne', 'üåø *Biotonne*')
                                  | replace('Gelber Sack', '‚ôªÔ∏è *Gelber Sack*')
                                  | replace('Altpapier', 'üìÑ *Altpapier*')
                                  | replace('Papiersamml', 'üìÑ *Papiersammlung*')
                                  | replace('Problemm√ºll', '‚ö†Ô∏è *Problemm√ºll*')
                                  | replace('Gartenabfall', 'üçÇ *Gartenabfall*') %}
            {%- if delta == 0 %}
            * üìÖ **Heute, {{ day_name }} ({{ date_german }})**: {{ items }}
            {%- elif delta == 1 %}
            * üìÖ **Morgen, {{ day_name }} ({{ date_german }})**: {{ items }}
            {%- elif delta < 7 %}
            * üìÖ **{{ day_name }}, in {{ delta }} Tagen ({{ date_german }})**: {{ items }}
            {%- else %}
            * üìÖ **{{ day_name }}, {{ date_german }}**: {{ items }}
            {%- endif %}
            {%- endfor %}

- id: whatsapp_boulderwelt_bot
  alias: "WhatsApp Bot: Boulderwelt"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: "{{ 'boulderwelt' in trigger.event.data.content | lower }}"
  action:
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: >
          Hier ist die Auslastungs-Prognose der besten Tage f√ºr die kommende Woche! (Statistik f√ºr 17-19 Uhr, dahinter Tagesdurchschnitt):

          üßó‚Äç‚ôÇÔ∏è **Ost**:
          {% set days_ost = [
            {'day': 'Montag', 'value': states('sensor.boulderwelt_ost_monday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_monday_avg') | float(70)},
            {'day': 'Dienstag', 'value': states('sensor.boulderwelt_ost_tuesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_tuesday_avg') | float(70)},
            {'day': 'Mittwoch', 'value': states('sensor.boulderwelt_ost_wednesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_wednesday_avg') | float(70)},
            {'day': 'Donnerstag', 'value': states('sensor.boulderwelt_ost_thursday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_thursday_avg') | float(70)},
            {'day': 'Freitag', 'value': states('sensor.boulderwelt_ost_friday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_ost_friday_avg') | float(70)}
          ] | selectattr('value', '>', 0) | sort(attribute='value') | list %}
          1. {{ days_ost[0].day }} ({{ days_ost[0].value }}% / Tag: {{ days_ost[0].day_avg }}%)

          2. {{ days_ost[1].day }} ({{ days_ost[1].value }}% / Tag: {{ days_ost[1].day_avg }}%)

          3. {{ days_ost[2].day }} ({{ days_ost[2].value }}% / Tag: {{ days_ost[2].day_avg }}%)


          üßó‚Äç‚ôÄÔ∏è **S√ºd**:
          {% set days_sued = [
            {'day': 'Montag', 'value': states('sensor.boulderwelt_sued_monday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_monday_avg') | float(70)},
            {'day': 'Dienstag', 'value': states('sensor.boulderwelt_sued_tuesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_tuesday_avg') | float(70)},
            {'day': 'Mittwoch', 'value': states('sensor.boulderwelt_sued_wednesday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_wednesday_avg') | float(70)},
            {'day': 'Donnerstag', 'value': states('sensor.boulderwelt_sued_thursday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_thursday_avg') | float(70)},
            {'day': 'Freitag', 'value': states('sensor.boulderwelt_sued_friday_avg_2h') | float(70), 'day_avg': states('sensor.boulderwelt_sued_friday_avg') | float(70)}
          ] | selectattr('value', '>', 0) | sort(attribute='value') | list %}
          1. {{ days_sued[0].day }} ({{ days_sued[0].value }}% / Tag: {{ days_sued[0].day_avg }}%)

          2. {{ days_sued[1].day }} ({{ days_sued[1].value }}% / Tag: {{ days_sued[1].day_avg }}%)

          3. {{ days_sued[2].day }} ({{ days_sued[2].value }}% / Tag: {{ days_sued[2].day_avg }}%)


          ‚òÄÔ∏è **Wochenende S√ºd**:
          {% set days_weekend_sued = [
            {'day': 'Samstag', 'value': states('sensor.boulderwelt_sued_saturday_avg') | float(70)},
            {'day': 'Sonntag', 'value': states('sensor.boulderwelt_sued_sunday_avg') | float(70)}
          ] | selectattr('value', '>', 0) | sort(attribute='value') | list %}
          - {{ days_weekend_sued[0].day }} (Tag: {{ days_weekend_sued[0].value }}%)

- id: whatsapp_phoenixbad_bot
  alias: "WhatsApp Bot: Phoenix-Bad"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: "{{ 'phoenix' in trigger.event.data.content | lower or 'ph√∂nix' in trigger.event.data.content | lower }}"
  action:
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: >
          *Ph√∂nix-Bad Ottobrunn Auslastung:*


          *Schwimmbadbereich:* {{ states('sensor.pool_occupancy') | default('?', true) }}%

          *Sauna:* {{ states('sensor.sauna_occupancy') | default('?', true) }}%

- id: whatsapp_joke_bot
  alias: "WhatsApp Bot: Joke"
  trigger:
    - platform: event
      event_type: whatsapp_message_received
  condition:
    - condition: template
      value_template: "{{ 'witz' in trigger.event.data.content | lower }}"
  action:
    - service: whatsapp.send_message
      data:
        target: "{{ trigger.event.data.sender }}"
        message: >
          üòÇ *Witz des Moments:*

          {{ [
            "Warum k√∂nnen Geister so schlecht l√ºgen? Weil sie so leicht zu durchschauen sind.",
            "Was ist gr√ºn und klopft an die T√ºr? Ein Klopfsalat.",
            "Warum gehen Ameisen nicht in die Kirche? Weil sie In-Sekten sind.",
            "Was macht ein Clown im B√ºro? Faxen.",
            "Ich habe einen Witz √ºber UDP, aber ich bin mir nicht sicher, ob er ankommt.",
            "Was ist der Unterschied zwischen einem Saxophon und einer Kettens√§ge? Das Vibrato.",
            "Egal wie gut du schl√§fst, Albert schl√§ft wie Einstein.",
            "Was essen Autos am liebsten? Parkpl√§tzchen.",
            "Warum trinken M√§use keinen Alkohol? Weil sie Angst vor dem Kater haben.",
            "Wie nennt man einen Boomerang, der nicht zur√ºckkommt? Stock.",
            "Was ist wei√ü und st√∂rt beim Essen? Eine Lawine.",
            "Was macht ein Pirat am Computer? Er dr√ºckt die Enter-Taste.",
            "Was macht ein Mathematiker im Garten? Wurzeln ziehen."
          ] | random }}

- id: "volleyball_new_training_inquiry_mail"
  alias: "Volleyball Training: Forward New Email to WhatsApp"
  description: "Sends a WhatsApp message on new training inquiry."
  mode: single
  trigger:
    - platform: event
      event_type: imap_content
  condition:
    # Check if the email was sent to the correct mailbox
    - condition: template
      value_template: "{{ trigger.event.data['username'] | lower | trim == 'volleyballtraining.zorneding@gmail.com' }}"
    # Ignore emails from Google Account notifications
    - condition: template
      value_template: "{{ 'no-reply@accounts.google.com' not in trigger.event.data['sender'] and not trigger.event.data['sender'].endswith('@google.com') }}"
  action:
    - service: whatsapp.send_message
      continue_on_error: true
      data:
        target: !secret whatsapp_volleyball_orga
        message: |
          üèê *Neue Trainingsanfrage* wurde per E-Mail empfangen.

          üìÖ *Datum:* {{ as_timestamp(trigger.event.data['date']) | timestamp_custom('%d.%m.%Y %H:%M') }}
          üë§ *Von:* {{ trigger.event.data['sender'] }}
          üìù *Betreff:* {{ trigger.event.data['subject'] }}

          --------(max 800 Zeichen)------------

          {{ trigger.event.data['text'] | default(trigger.event.data['body']) | default('Kein Textinhalt (evtl. nur HTML)') | truncate(800) }}
