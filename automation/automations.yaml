---
- id: turn_off_everything_except_guest_room_if_nobody_is_at_home
  alias: "Turn off everything except guest room if nobody is at home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "home"
      to: "not_home"
      for:
        minutes: 1
    - platform: state
      entity_id: person.nessie
      from: "home"
      to: "not_home"
      for:
        minutes: 1
  condition:
    condition: not
    conditions:
      - condition: state
        entity_id: person.fabian
        state: home
      - condition: state
        entity_id: person.nessie
        state: home
  action:
    - service: light.turn_off
      data:
        area_id:
          - "{{ area_id('Wohnzimmer') }}"
          - "{{ area_id('Schlafzimmer') }}"
          - "{{ area_id('Keller') }}"
    - service: switch.turn_off
      data:
        area_id:
          - "{{ area_id('Wohnzimmer') }}"
          - "{{ area_id('Keller') }}"
    - service: switch.turn_off
      data:
        entity_id:
          - switch.bett_usb_ports
    - service: media_player.turn_off
      data:
        area_id:
          - "{{ area_id('Wohnzimmer') }}"
          - "{{ area_id('Schlafzimmer') }}"
          - "{{ area_id('Kueche') }}"
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_pc
              state: "home"
            - condition: numeric_state
              entity_id: sensor.schlafzimmer_power
              above: 20
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Keiner ist mehr zu Hause! Fabian-PC ist allerdings noch an!"
                data:
                  inline_keyboard:
                    - "Herunterfahren:/shutdownfpc, Ruhezustand:/hibernatefpc"
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.rgb_pc
              state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Keiner ist mehr zu Hause. Nessie-PC ist allerdings noch an und wurde nicht ausgeschaltet!"
                data:
                  inline_keyboard:
                    - "Herunterfahren:/shutdownfpc, Ruhezustand:/hibernatefpc"
            - service: notify.telegram_nessie
              data:
                message: "Keiner ist mehr zu Hause. Nessie-PC ist allerdings noch an und wurde nicht ausgeschaltet!"
                data:
                  inline_keyboard:
                    - "Herunterfahren:/shutdownnpc, Ruhezustand:/hibernatenpc"
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_pc
              state: "not_home"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.fabian_pc_strom
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.rgb_pc
              state: "not_home"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.nessie_pc_strom
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.gastezimmer
                  state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.gastezimmer
                hvac_mode: auto
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.wohnzimmer
                  state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.wohnzimmer
                hvac_mode: auto
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.schlafzimmer
                  state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.schlafzimmer
                hvac_mode: auto
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.bad
                  state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.bad
                hvac_mode: auto
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
          sequence:
            - service: light.turn_off
              data:
                area_id: "{{ area_id('Gaestezimmer') }}"
            - service: media_player.turn_off
              data:
                entity_id: media_player.gastezimmer_mini
            # - service: select.select_option
            # data:
            # option: min
            # target:
            # entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
            # - delay: '00:00:40'
            # - service: select.select_option
            # data:
            # option: min
            # target:
            # entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: turn_on_5ghz_wifi_and_ssh_off_if_coming_home
  alias: "Turn on 5ghz wifi and ssh off if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "not_home"
      to: "home"
    - platform: state
      entity_id: person.nessie
      from: "not_home"
      to: "home"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.abwesend_modus
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:00:40"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
    # - service: switch.turn_off
    # data:
    # entity_id: switch.fritzbox_3490_portforward_ssh

- id: open_door_for_fabian
  alias: "Open the door for Fabian if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "not_home"
      to: "home"
    - platform: numeric_state
      entity_id: proximity.home_fabian
      below: 2
      for:
        seconds: 5
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: Volleyball
        - condition: state
          entity_id: person.fabian
          state: Einkaufen
        - condition: state
          entity_id: device_tracker.fabian_iphone_2
          state: home
        - condition: numeric_state
          entity_id: person.fabian
          attribute: gps_accuracy
          above: 500
    - condition: or
      conditions:
        - condition: numeric_state
          entity_id: proximity.home_fabian
          below: 3
        - condition: not
          conditions:
            - condition: state
              entity_id: proximity.home_fabian
              attribute: dir_of_travel
              state: "away_from"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 300 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_nessie_if_coming_home.attributes.last_triggered) | int > 180 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "Gartentor wurde automatisch geöffnet, da du gleich daheim bist."

- id: open_door_for_nessie
  alias: "Open the door for Nessie if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.nessie
      from: "not_home"
      to: "home"
    - platform: numeric_state
      entity_id: proximity.home_nessie
      below: 2
      for:
        seconds: 2
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: device_tracker.nessie_iphone_2
          state: home
        - condition: state
          entity_id: person.nessie
          state: Volleyball
        - condition: state
          entity_id: person.nessie
          state: Einkaufen
        - condition: numeric_state
          entity_id: person.nessie
          attribute: gps_accuracy
          above: 500
    - condition: or
      conditions:
        - condition: numeric_state
          entity_id: proximity.home_nessie
          below: 3
        - condition: not
          conditions:
            - condition: state
              entity_id: proximity.home_nessie
              attribute: dir_of_travel
              state: "away_from"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_nessie_if_coming_home.attributes.last_triggered) | int > 300 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss

- id: open_door_for_adri
  alias: "Open the door for Adri if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.adri
      from: "not_home"
      to: "home"
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: device_tracker.iphone
          state: home
    - condition: numeric_state
      entity_id: person.adri
      attribute: gps_accuracy
      below: 400
    - condition: or
      conditions:
        - condition: state
          entity_id: person.fabian
          state: home
        - condition: state
          entity_id: person.nessie
          state: home
    # - condition: not
    #   conditions:
    #     - condition: state
    #       entity_id: proximity.home_ka
    #       attribute: dir_of_travel
    #       state: 'away_from'
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_nessie_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_adri_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_kai_if_coming_home.attributes.last_triggered) | int > 300 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_adrian
        message: "Gartentor wurde automatisch geöffnet, da du gleich bei Fabi bist und die Google Homes klingeln."
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: time
                  before: "22:00:00"
                - condition: time
                  after: "10:00:00"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: notify.mobile_app_fabian_iphone
              data:
                message: "Adri ist gleich da"
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.7
            - service: media_player.volume_set
              data:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.wohnzimmer_uhr
            - service: tts.google_say
              entity_id:
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
              data:
                message: "Adri ist gleich da."
            - service: media_player.volume_set
              data:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.wohnzimmer_uhr
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/doorbell.wav -t audio/wav"
            - service: notify.keller_tv
              continue_on_error: true
              data:
                message: "Adri ist gleich da."

- id: open_door_for_kai
  alias: "Open the door for Kai if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.kai
      from: "not_home"
      to: "home"
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: device_tracker.ks_2
          state: home
    - condition: numeric_state
      entity_id: person.kai
      attribute: gps_accuracy
      below: 400
    - condition: or
      conditions:
        - condition: state
          entity_id: person.fabian
          state: home
        - condition: state
          entity_id: person.nessie
          state: home
    # - condition: not
    #   conditions:
    #     - condition: state
    #       entity_id: proximity.home_ka
    #       attribute: dir_of_travel
    #       state: 'away_from'
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_nessie_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_adri_if_coming_home.attributes.last_triggered) | int > 300 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_kai_if_coming_home.attributes.last_triggered) | int > 180 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_kai
        message: "Gartentor wurde automatisch geöffnet, da du gleich bei Fabi bist und die Google Homes klingeln."
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: time
                  before: "22:00:00"
                - condition: time
                  after: "10:00:00"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: notify.mobile_app_fabian_iphone
              data:
                message: "Kai ist gleich da"
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.7
            - service: media_player.volume_set
              data:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.wohnzimmer_uhr
            - service: tts.google_say
              entity_id:
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
              data:
                message: "Kai ist gleich da."
            - service: media_player.volume_set
              data:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.wohnzimmer_uhr
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/doorbell.wav -t audio/wav"
            - service: notify.keller_tv
              continue_on_error: true
              data:
                message: "Kai ist gleich da."

- id: open_door_for_flo
  alias: "Open the door for Flo if coming home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.flo
      from: "not_home"
      to: "home"
  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: device_tracker.galaxy_s_22
          state: home
    - condition: numeric_state
      entity_id: person.flo
      attribute: gps_accuracy
      below: 250
    - condition: or
      conditions:
        - condition: state
          entity_id: person.fabian
          state: home
        - condition: state
          entity_id: person.nessie
          state: home
    # - condition: not
    #   conditions:
    #     - condition: state
    #       entity_id: proximity.home_ka
    #       attribute: dir_of_travel
    #       state: 'away_from'
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_fabian_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_nessie_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_adri_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_kai_if_coming_home.attributes.last_triggered) | int > 180 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.open_the_door_for_flo_if_coming_home.attributes.last_triggered) | int > 300 }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss
    # - service: telegram_bot.send_message
    #   data:
    #     target: !secret telegram_chat_flo
    #     message: 'Gartentor wurde automatisch geöffnet, da du gleich bei Fabi bist und die Google Homes klingeln.'
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: time
                  before: "22:00:00"
                - condition: time
                  after: "10:00:00"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: notify.mobile_app_fabian_iphone
              data:
                message: "Flo ist gleich da"
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.7
            - service: media_player.volume_set
              data:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.wohnzimmer_uhr
            - service: tts.google_say
              entity_id:
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
              data:
                message: "Flo ist gleich da."
            - service: media_player.volume_set
              data:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.wohnzimmer_uhr
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/doorbell.wav -t audio/wav"
            - service: notify.keller_tv
              continue_on_error: true
              data:
                message: "Flo ist gleich da."

# - id: notify_if_someone_joined_lan_play_server
#   alias: Notify if someone joined lan play server
#   trigger:
#     - platform: numeric_state
#       entity_id: sensor.switch_lan_play_online
#       above: 0
#   condition:
#     - condition: template
#       value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_if_someone_joined_lan_play_server.attributes.last_triggered) | int > 300 }}"
#   action:
#     - service: telegram_bot.send_message
#       data_template:
#         target: !secret telegram_chat_fabian
#         message: 'Jemand ist dem LAN-Play Server beigetreten. Spieleranzahl: {{ states.sensor.switch_lan_play_online.state }}'

#  - id: turn_on_ventilator_if_coming_home
#    alias: 'Turn on ventilator if coming home'
#    initial_state: true
#    trigger:
#      - platform: state
#        entity_id: person.fabian
#        from: 'not_home'
#        to: 'home'
#      - platform: state
#        entity_id: person.nessie
#        from: 'not_home'
#        to: 'home'
#    condition:
#      condition: and
#      conditions:
#        - condition: numeric_state
#          entity_id: 'weather.dwd_weather_ebersberg_1h'
#          attribute: temperature
#          above: 22
#        - condition: time
#          after: '12:00:00'
#          before: '21:00:00'
#    action:
#      - service: switch.turn_on
#        data:
#          entity_id: switch.ventilator

- id: turn_off_light_at_night_notify
  alias: "Turn off light at night - notify"
  initial_state: true
  trigger:
    platform: time
    at: "00:30:00"
  condition:
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
    - condition: template
      value_template: >
        {% set domain = 'light' %}
        {% set state = 'on' %}
        {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
            - condition: template
              value_template: >
                {% set domain = 'light' %}
                {% set state = 'on' %}
                {{ states[domain] | selectattr('state','eq', state) | list | count > 1 }}
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Alle Lichter werden in 20 Minuten ausgeschaltet, außer im Keller."
                inline_keyboard:
                  - "Abbruch:/cancellight, Okay:/telegramno"
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                message: "Alle Lichter werden in 20 Minuten ausgeschaltet, außer im Keller."
                inline_keyboard:
                  - "Abbruch:/cancellight, Okay:/telegramno"
    - choose:
        - conditions:
            - condition: state
              entity_id: media_player.keller_tv
              state: "unavailable"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Alle Lichter werden in 20 Minuten ausgeschaltet."
                inline_keyboard:
                  - "Abbruch:/cancellight, Okay:/telegramno"
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                message: "Alle Lichter werden in 20 Minuten ausgeschaltet."
                inline_keyboard:
                  - "Abbruch:/cancellight, Okay:/telegramno"

- id: turn_off_light_at_night
  alias: "Turn off light at night"
  initial_state: true
  trigger:
    platform: time
    at: "00:50:00"
  condition:
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
    - condition: template
      value_template: >
        {% set domain = 'light' %}
        {% set state = 'on' %}
        {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_answer_cancel_light_turn_off.attributes.last_triggered) | int > 1500 }}"
  action:
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {% set domain = 'light' %}
                {% set state = 'on' %}
                {{ states[domain] | selectattr('state','eq', state) | list | count > 1 }}
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: light.turn_off
              data:
                area_id:
                  - "{{ area_id('Wohnzimmer') }}"
                  - "{{ area_id('Schlafzimmer') }}"
                  - "{{ area_id('Gaestezimmer') }}"
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Alle Lichter (außer im Keller) wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                message: "Alle Lichter (außer im Keller) wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
    - choose:
        - conditions:
            - condition: state
              entity_id: media_player.keller_tv
              state: "unavailable"
          sequence:
            - service: light.turn_off
              entity_id: all
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Alle Lichter wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                message: "Alle Lichter wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."

- id: turn_off_devices_at_night_notify
  alias: "Turn off devices at night - notify"
  initial_state: true
  trigger:
    platform: time
    at: "04:30:00"
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: switch.fernseher
          state: "on"
        - condition: state
          entity_id: switch.kuhlschrank
          state: "on"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Fernseher & Kühlschrank werden in 20 Minuten ausgeschaltet."
        inline_keyboard:
          - "Abbruch:/cancellight, Okay:/telegramno"

- id: turn_off_devices_at_night
  alias: "Turn off devices at night"
  initial_state: true
  trigger:
    platform: time
    at: "04:50:00"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: switch.fernseher
                  state: "on"
                - condition: state
                  entity_id: switch.kuhlschrank
                  state: "on"
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_answer_cancel_light_turn_off.attributes.last_triggered) | int > 1500 }}"
          sequence:
            - service: switch.turn_off
              entity_id:
                - switch.fernseher
                - switch.kuhlschrank
            - service: media_player.turn_off
              entity_id: media_player.keller_tv
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Fernseher & Kühlschrank wurden automatisch ausgeschaltet, da diese vermutlich vergessen wurden."
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ as_timestamp(now()) - as_timestamp(states.sensor.zorneding_to_leuchtenbergring.last_updated) | int > 16400 }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.home_assistant_core_update
                      state: "on"
                  sequence:
                    - service: telegram_bot.send_message
                      data_template:
                        target: !secret telegram_chat_fabian
                        message: >
                          Home Assistant {{ states.update.home_assistant_core_update.attributes.latest_version }} wird nun installiert um HA neuzustarten, da DB API Verbindung verloren wurde.

                          Changelog HA: {{ states.update.home_assistant_core_update.attributes.release_url }}
                    - service: update.install
                      data:
                        entity_id: update.home_assistant_core_update
              default:
                - service: telegram_bot.send_message
                  data_template:
                    target: !secret telegram_chat_fabian
                    message: "Starte Homeassistant neu, da DB API Verbindung verloren wurde."
                - service: homeassistant.restart

- id: set_high_climate_to_lower_value
  alias: "Set high climate to lower value"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: "climate.gastezimmer"
      attribute: temperature
      above: 20
      for:
        minutes: 20
    - platform: numeric_state
      entity_id: "climate.schlafzimmer"
      attribute: temperature
      above: 20
      for:
        minutes: 20
    - platform: numeric_state
      entity_id: "climate.bad"
      attribute: temperature
      above: 20
      for:
        minutes: 10
    - platform: numeric_state
      entity_id: "climate.wohnzimmer"
      attribute: temperature
      above: 22
      for:
        minutes: 12
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.gastezimmer"
              attribute: temperature
              above: 20
            - condition: state
              entity_id: "climate.gastezimmer"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.gastezimmer
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.schlafzimmer"
              attribute: temperature
              above: 20
            - condition: state
              entity_id: "climate.schlafzimmer"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.schlafzimmer
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.bad"
              attribute: temperature
              above: 20
            - condition: state
              entity_id: "climate.bad"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.bad
                temperature: 20
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "climate.wohnzimmer"
              attribute: temperature
              above: 22
            - condition: state
              entity_id: "climate.wohnzimmer"
              state: "heat"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.wohnzimmer
                temperature: 20
                hvac_mode: heat

- id: set_climate_at_night
  alias: "Set climate at night"
  initial_state: true
  trigger:
    platform: time
    at: "00:50:00"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.thermostate_aus
              state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id:
                  - climate.wohnzimmer
                  - climate.schlafzimmer
                  - climate.bad
                hvac_mode: "auto"
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.thermostate_aus
              state: "on"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id:
                  - climate.wohnzimmer
                  - climate.schlafzimmer
                  - climate.bad
                hvac_mode: "off"
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.gastezimmer
                hvac_mode: "auto"
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "on"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.gastezimmer
                hvac_mode: "off"

- id: set_climate_on_weekdays
  alias: "Set climate on weekdays"
  initial_state: true
  trigger:
    - platform: time
      at: "16:15:00"
    - platform: time
      at: "21:00:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - sun
    - condition: state
      entity_id: input_boolean.thermostate_aus
      state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: "auto"

- id: set_wifi_settings_at_night
  alias: "Set wifi settings at night"
  initial_state: true
  trigger:
    - platform: time
      at: "00:00:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: state
      entity_id: switch.fernseher_keller
      state: "off"
    - condition: state
      entity_id: switch.fernseher
      state: "off"
    - condition: state
      entity_id: input_boolean.gast_modus
      state: "off"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: set_wifi_settings_at_morning
  alias: "Set wifi settings at morning"
  initial_state: true
  trigger:
    - platform: time
      at: "00:06:15"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: remind_for_unavailable_device
  alias: "Remind for unavailable device"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.unavailable_entities
      above: 0
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_unavailable_device.attributes.last_triggered) | int > 3200 }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.automatic_ha_updates.attributes.last_triggered) | int > 3200 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        disable_notification: true
        message: >
          {% if is_state("sensor.unavailable_entities", "1")%}
          Es ist eine Entität nicht verfügbar.
          {% else %}
          Es sind {{ states.sensor.unavailable_entities.state }} Entitäten nicht erreichbar.
          {% endif %}
          Darunter folgende Entitäten:

          {{ states.sensor.unavailable_entities.attributes.entities }}

- id: activate_guest_mode_if_guest_is_here
  alias: "Activate guest mode if guest is here"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.isi
      to: "home"
    - platform: time
      at: "01:00:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.activate_guest_mode_if_guest_is_here.attributes.last_triggered) | int > 86400 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: person.isi
            state: "home"
          - condition: state
            entity_id: person.adri
            state: "home"
          - condition: state
            entity_id: person.kai
            state: "home"
          - condition: state
            entity_id: person.nathalie
            state: "home"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.gast_modus
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Gast Modus wurde aktiviert, da jemand vermutlich übernachtet. Automationen im Gästezimmer sind dadurch eingeschränkt."
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: "Gast Modus wurde aktiviert, da jemand vermutlich übernachtet. Automationen im Gästezimmer sind dadurch eingeschränkt."

- id: deactivate_guest_mode_if_no_guest_is_here
  alias: "Deactivate guest mode if no guest is here"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.isi
      to: "not_home"
      for:
        days: 1
    - platform: state
      entity_id: input_boolean.gast_modus
      to: "on"
      for:
        days: 1
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "on"
      - condition: state
        entity_id: person.isi
        state: "not_home"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.gast_modus
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Gast Modus wurde deaktiviert, da niemand mehr zu Besuch ist."

- id: reactivate_adguard_protection
  alias: "Reactivate Adguard Protection"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.adguard_protection
      to: "off"
      for:
        hours: 12
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.adguard_protection
    - service: switch.turn_on
      data:
        entity_id: switch.adguard_filtering
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Adguard wurde wieder eingeschaltet."

- id: deactivate_silent_mode_after_12_hours
  alias: "Deactivate silent mode after 12 hours"
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.leiser_modus
      to: "on"
      for:
        hours: 12
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.leiser_modus
        state: "on"
      - condition: state
        entity_id: input_boolean.abwesend_modus
        state: "off"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Der Leise Modus sollte deaktiviert werden, da er bereits seit 12 Stunden aktiv ist."
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: "Der Leise Modus sollte deaktiviert werden, da er bereits seit 12 Stunden aktiv ist."

- id: remind_fabi_to_ventilate
  alias: "Remind Fabi to ventilate"
  initial_state: false
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "home"
      for:
        hours: 4
    - platform: state
      entity_id: device_tracker.nsta0552
      to: "home"
      for:
        hours: 4
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.schlafzimmer
        attribute: current_humidity
        above: 55
      - condition: time
        before: "22:00:00"
      - condition: state
        entity_id: input_boolean.leiser_modus
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.fabian_pc
            state: "home"
          - condition: state
            entity_id: device_tracker.nsta0552
            state: "home"
  action:
    - service: tts.google_say
      entity_id: media_player.schlafzimmer_speaker
      data_template:
        message: >
          Du bist nun seit 4 Stunden am PC und solltest einmal lüften und aufstehen.
    - service: notify.telegram_fabian
      data:
        message: "Du bist nun seit 4 Stunden am PC und solltest einmal lüften und aufstehen."

- id: turn_on_light_and_climate_if_fpc_starts
  alias: "Turn on light and climate if fpc starts"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.fabian_strom
      to: "on"
      for:
        seconds: 5
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.wohnzimmer_tv
            state: "not_home"
          - condition: state
            entity_id: switch.fernseher
            state: "off"
  action:
    - choose:
        - conditions:
            - condition: time
              after: "16:00:00"
            - condition: numeric_state
              entity_id: sensor.dwd_illuminance
              below: 2000
            - condition: numeric_state
              entity_id: sensor.fabian_s_zuhause_solar_percentage
              below: 15
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.wohnzimmer_tv
                  state: "not_home"
                - condition: state
                  entity_id: switch.fernseher
                  state: "off"
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.leds_tisch
                brightness: 255
                transition: 2
            - delay: "00:04:00"
            - service: light.turn_on
              data:
                entity_id: light.prismatik
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "weather.dwd_weather_ebersberg_1h"
              attribute: temperature
              below: 16
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: time
              after: "08:45:00"
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.wohnzimmer_tv
                  state: "not_home"
                - condition: state
                  entity_id: switch.fernseher
                  state: "off"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.schlafzimmer_open_window
                      state: "on"
                  sequence:
                    - delay: "00:25:00"
            - service: climate.set_temperature
              data:
                entity_id: climate.schlafzimmer
                temperature: 19
                hvac_mode: heat

- id: turn_off_tleds_and_climate_if_fpc_stops
  alias: "Turn off tleds and climate if fpc stops"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      from: "home"
      to: "not_home"
      for:
        minutes: 1
    - platform: state
      entity_id: device_tracker.nsta0552
      from: "home"
      to: "not_home"
      for:
        minutes: 1
    - platform: numeric_state
      entity_id: sensor.schlafzimmer_power
      below: 20
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.fabian_pc
        state: "not_home"
        for:
          minutes: 1
      - condition: state
        entity_id: device_tracker.nsta0552
        state: "not_home"
        for:
          seconds: 20
      - condition: numeric_state
        entity_id: sensor.schlafzimmer_power
        below: 20
  action:
    - service: light.turn_off
      data:
        entity_id: light.leds_tisch
    - service: media_player.volume_set
      data:
        volume_level: >
          {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
        entity_id: media_player.schlafzimmer_speaker
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_boolean.thermostate_aus
                  state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.schlafzimmer
                hvac_mode: "auto"

- id: turn_on_light_and_climate_if_npc_started
  alias: "Turn on light and climate if npc started"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.nessie_pc
      to: "on"
      for:
        seconds: 5
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "weather.dwd_weather_ebersberg_1h"
              attribute: temperature
              below: 17
            - condition: state
              entity_id: "input_boolean.gast_modus"
              state: "off"
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: time
              after: "17:30:00"
            - condition: not
              conditions:
                - condition: state
                  entity_id: "climate.gastezimmer"
                  state: "off"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.gastezimmer
                temperature: 21.5
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: "weather.dwd_weather_ebersberg_1h"
              attribute: temperature
              below: 17
            - condition: state
              entity_id: "input_boolean.gast_modus"
              state: "off"
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: time
              before: "17:31:00"
            - condition: not
              conditions:
                - condition: state
                  entity_id: "climate.gastezimmer"
                  state: "off"
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.gastezimmer
                temperature: 20.0
                hvac_mode: heat
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: and
                  conditions:
                    - condition: numeric_state
                      entity_id: sensor.dwd_illuminance
                      below: 2000
                    - condition: time
                      after: "16:00:00"
                - condition: and
                  conditions:
                    - condition: numeric_state
                      entity_id: sensor.fabian_s_zuhause_solar_percentage
                      below: 20
                    - condition: time
                      after: "16:00:00"
                - condition: and
                  conditions:
                    - condition: numeric_state
                      entity_id: sensor.fabian_s_zuhause_solar_percentage
                      below: 20
                    - condition: numeric_state
                      entity_id: sensor.dwd_illuminance
                      below: 2000
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.lampe_gastezimmer
              data:
                transition: 2
                brightness: 255
                # color_mode: white
            - service: light.turn_on
              target:
                entity_id: light.leds_gastezimmer
              data:
                transition: 2
                brightness: 255
                rgb_color: [255, 255, 255]

- id: turn_off_lights_and_climate_if_npc_stopped
  alias: "Turn off lights and climate if npc stopped"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.nessie_pc_energy_power
      below: 15
      for:
        seconds: 30
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.gast_modus"
        state: "off"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
          sequence:
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.gastezimmer
                hvac_mode: "auto"
    - service: light.turn_off
      data:
        area_id:
          - "{{ area_id('Gaestezimmer') }}"
    - service: media_player.volume_set
      data:
        volume_level: >
          {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
        entity_id: media_player.gastezimmer_mini

- id: turn_off_strom_if_npc_stops
  alias: "Turn off strom if npc stops"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.vku_lb_20
      from: "home"
      to: "not_home"
      for:
        minutes: 5
    - platform: numeric_state
      entity_id: sensor.nessie_pc_energy_power
      below: 25
      for:
        minutes: 10
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.nessie_pc_energy_power
        below: 25
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.nessie_pc

- id: turn_off_strom_if_fpc_stops
  alias: "Turn off strom if fpc stops"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.schlafzimmer_power
      below: 25
      for:
        minutes: 10
    - platform: state
      entity_id: device_tracker.nsta0552
      from: "home"
      to: "not_home"
      for:
        minutes: 5
    - platform: state
      entity_id: device_tracker.fabian_pc
      from: "home"
      to: "not_home"
      for:
        minutes: 60
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.schlafzimmer_power
        below: 25
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.fabian_strom

- id: adb_uninstall_apps_when_tv_starts
  alias: "ADB uninstall apps when tv starts"
  initial_state: false
  trigger:
    - platform: state
      entity_id: media_player.wohnzimmer_tv
      from: "unavailable"
    - platform: state
      entity_id: media_player.keller_tv
      from: "unavailable"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.smartalexa
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.android.camera2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.inputmethod.international
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.google.android.music
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.appmarket2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 tv.wuaki.apptv
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.MultiScreenInteraction_TV
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer.resource
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.usercenter
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.messagebox
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.waterfall.overseas
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.gallery
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.google.android.videos
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 au.com.stan.and
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.dashboard
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.notereminder
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.wohnzimmer_tv
                command: pm uninstall -k --user 0 com.tcl.useragreement
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: "unavailable"
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.smartalexa
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.android.camera2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.inputmethod.international
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.google.android.music
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.appmarket2
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 tv.wuaki.apptv
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.MultiScreenInteraction_TV
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.partnercustomizer.resource
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.usercenter
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.messagebox
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.waterfall.overseas
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.gallery
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.google.android.videos
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 au.com.stan.and
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.dashboard
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.notereminder
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: pm uninstall -k --user 0 com.tcl.useragreement

- id: turn_on_light_climate_if_tv_starts
  alias: "Turn on light and climate if tv starts"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.wohnzimmer_tv
      from: "not_home"
      to: "home"
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.dwd_illuminance
              below: 3000
            - condition: time
              after: "14:00:00"
            - condition: numeric_state
              entity_id: sensor.fabian_s_zuhause_solar_percentage
              below: 15
          sequence:
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_wohnzimmer_tv
                  - light.leds_wohnzimmer
                  - light.yeelight_color_0x36dc050
                transition: 2
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: numeric_state
              entity_id: "weather.dwd_weather_ebersberg_1h"
              attribute: temperature
              below: 17
          sequence:
            - service: climate.set_temperature
              data:
                entity_id: climate.wohnzimmer
                temperature: 21.5
                hvac_mode: heat

- id: turn_off_climate_if_tv_stops
  alias: "Turn off climate if tv stops"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.wohnzimmer_tv
      from: "home"
      to: "not_home"
  condition:
    - condition: state
      entity_id: "input_boolean.thermostate_aus"
      state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: "auto"

- id: remind_for_open_window_bathroom
  alias: "Remind for open window bathroom"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.bad_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.bad_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.bad
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.bad_heating
        above: 35
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: state
              entity_id: person.nessie
              state: "home"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: tts.google_say
              entity_id: media_player.gastezimmer_mini
              data:
                message: Es wurde vergessen das Fenster im Bad zu schließen.
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.nessie
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: tts.google_say
              entity_id:
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
                - media_player.schlafzimmer_speaker
              data:
                message: Es wurde eventuell vermutlich vergessen das Fenster im Bad zu schließen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schließen."
        - service: notify.telegram_nessie
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schließen."

- id: remind_for_open_window_sleeping_room
  alias: "Remind for open window sleeping room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.schlafzimmer_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.schlafzimmer_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.schlafzimmer
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.schlafzimmer_heating
        above: 35
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: state
              entity_id: person.nessie
              state: "home"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: tts.google_say
              entity_id: media_player.gastezimmer_mini
              data:
                message: Es wurde eventuell vergessen das Fenster im Schlafzimmer zu schließen.
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.nessie
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: tts.google_say
              entity_id:
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
              data:
                message: Es wurde vermutlich vergessen das Fenster im Schlafzimmer zu schließen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Schlafzimmer zu schließen."
        - service: notify.telegram_nessie
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Schlafzimmer zu schließen."

- id: remind_for_open_window_living_room
  alias: "Remind for open window living room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.wohnzimmer_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.wohnzimmer_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.wohntimmer
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.wohnzimmer_heating
        above: 35
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: state
              entity_id: person.nessie
              state: "home"
            - condition: state
              entity_id: person.fabian
              state: "home"
          sequence:
            - service: tts.google_say
              entity_id: media_player.gastezimmer_mini
              data:
                message: Es wurde eventuell vergessen das Fenster im Wohnzimmer zu schließen.
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.nessie
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
          sequence:
            - service: tts.google_say
              entity_id:
                - media_player.kuche_speaker
                - media_player.schlafzimmer_speaker
              data:
                message: Es wurde eventuell vergessen das Fenster im Wohnzimmer zu schließen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schließen."
        - service: notify.telegram_nessie
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Bad zu schließen."

- id: remind_for_open_window_guest_room
  alias: "Remind for open window guest room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.gastezimmer_open_window
      to: "off"
      for:
        minutes: 31
    - platform: state
      entity_id: binary_sensor.gastezimmer_open_window
      to: "off"
      for:
        minutes: 45
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: climate.gastezimmer
        attribute: current_temperature
        below: 18
      - condition: numeric_state
        entity_id: sensor.gastezimmer_heating
        above: 85
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.nessie
                  state: "home"
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "off"
          sequence:
            - service: tts.google_say
              entity_id:
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
                - media_player.schlafzimmer_speaker
              data:
                message: Es wurde eventuell vergessen das Fenster im Gästezimmer zu schließen.
      default:
        - service: notify.telegram_fabian
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Gästezimmer zu schließen."
        - service: notify.telegram_nessie
          data:
            message: "Es wurde vermutlich vergessen das Fenster im Gästezimmer zu schließen."

- id: remind_for_open_window_after_5_minutes_in_bathroom
  alias: "Remind for open window after 5 minutes in bathroom"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.bad_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.bad"
        attribute: current_temperature
        below: 21
      - condition: time
        before: "23:00:00"
      - condition: time
        after: "07:50:00"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "on"
          sequence:
            - service: notify.mobile_app_nessie_iphone
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1
            - service: notify.mobile_app_fabian_iphone
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: state
                  entity_id: device_tracker.nsta0552
                  state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  state: "off"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
            - service: notify.mobile_app_fabian_iphone
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.schlafzimmer_speaker
            - service: tts.google_say
              entity_id: media_player.schlafzimmer_speaker
              data:
                message: Das Fenster im Bad kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.schlafzimmer_speaker
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.rgb_pc
                  state: "home"
                - condition: state
                  entity_id: device_tracker.vku_lb_20
                  state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  state: "off"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
            - service: notify.mobile_app_nessie_iphone
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.gastezimmer_mini
            - service: tts.google_say
              entity_id: media_player.gastezimmer_mini
              data:
                message: Das Fenster im Bad kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.gastezimmer_mini
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Bad kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.kuche_speaker
            - service: tts.google_say
              entity_id: media_player.kuche_speaker
              data:
                message: Das Fenster im Bad kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.kuche_speaker
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
          sequence:
            - service: notify.wohnzimmer_tv
              continue_on_error: true
              data:
                message: Das Fenster im Bad kann wieder geschlossen werden.
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "off"
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.wohnzimmer_uhr
            - service: tts.google_say
              entity_id: media_player.wohnzimmer_uhr
              data:
                message: Das Fenster im Bad kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.wohnzimmer_uhr

- id: remind_for_open_window_after_5_minutes_in_sleeping_room
  alias: "Remind for open window after 5 minutes in sleeping room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.schlafzimmer_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.schlafzimmer"
        attribute: current_temperature
        below: 19
      - condition: time
        before: "23:00:00"
      - condition: time
        after: "07:50:00"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "on"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Schlafzimmer kann wieder geschlossen werden."
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Schlafzimmer kann wieder geschlossen werden."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.rgb_pc
                  state: "home"
                - condition: state
                  entity_id: device_tracker.vku_lb_20
                  state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  state: "off"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Schlafzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.gastezimmer_mini
            - service: tts.google_say
              entity_id: media_player.gastezimmer_mini
              data:
                message: Das Fenster im Schlafzimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.gastezimmer_mini
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Schlafzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Schlafzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.kuche_speaker
            - service: tts.google_say
              entity_id: media_player.kuche_speaker
              data:
                message: Das Fenster im Schlafzimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.kuche_speaker
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
          sequence:
            - service: notify.wohnzimmer_tv
              continue_on_error: true
              data:
                message: Das Fenster im Schlafzimmer kann wieder geschlossen werden.
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "off"
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.wohnzimmer_uhr
            - service: tts.google_say
              entity_id: media_player.wohnzimmer_uhr
              data:
                message: Das Fenster im Schlafzimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.wohnzimmer_uhr

- id: remind_for_open_window_after_5_minutes_in_living room
  alias: "Remind for open window after 5 minutes in living room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.wohnzimmer_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.wohnzimmer"
        attribute: current_temperature
        below: 20
      - condition: state
        entity_id: switch.fernseher
        state: "off"
      - condition: time
        before: "23:00:00"
      - condition: time
        after: "07:50:00"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "on"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id:
                    - device_tracker.nsta0552
                  state: "home"
                - condition: state
                  entity_id:
                    - device_tracker.fabian_pc
                  state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  state: "off"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.schlafzimmer_speaker
            - service: tts.google_say
              entity_id: media_player.schlafzimmer_speaker
              data:
                message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.schlafzimmer_speaker
    - choose:
        - conditions:
            - condition: state
              entity_id:
                - device_tracker.rgb_pc
                - device_tracker.vku_lb_20
              match: any
              state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  state: "off"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.gastezimmer_mini
            - service: tts.google_say
              entity_id: media_player.gastezimmer_mini
              data:
                message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.gastezimmer_mini
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: state
                  entity_id: device_tracker.nsta0552
                  state: "home"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Wohnzimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.kuche_speaker
            - service: tts.google_say
              entity_id: media_player.kuche_speaker
              data:
                message: Das Fenster im Wohnzimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.kuche_speaker

- id: remind_for_open_window_after_5_minutes_in_guest_room
  alias: "Remind for open window after 5 minutes in guest room"
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.gastezimmer_open_window
      to: "on"
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: "climate.gastezimmer"
        attribute: current_temperature
        below: 20
      - condition: time
        before: "23:00:00"
      - condition: time
        after: "07:50:00"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: input_boolean.leiser_modus
                  state: "on"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Gästezimmer kann wieder geschlossen werden."
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Gästezimmer kann wieder geschlossen werden."
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: state
                  entity_id: device_tracker.nsta0552
                  state: "home"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  state: "off"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Gästezimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.schlafzimmer_speaker
            - service: tts.google_say
              entity_id: media_player.schlafzimmer_speaker
              data:
                message: Das Fenster im Gästezimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.schlafzimmer_speaker
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Das Fenster im Gästezimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Das Fenster im Gästezimmer kann wieder geschlossen werden."
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.kuche_speaker
            - service: tts.google_say
              entity_id: media_player.kuche_speaker
              data:
                message: Das Fenster im Gästezimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.kuche_speaker
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
          sequence:
            - service: notify.wohnzimmer_tv
              continue_on_error: true
              data:
                message: Das Fenster im Gästezimmer kann wieder geschlossen werden.
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "off"
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "idle"
          sequence:
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                entity_id: media_player.wohnzimmer_uhr
            - service: tts.google_say
              entity_id: media_player.wohnzimmer_uhr
              data:
                message: Das Fenster im Gästezimmer kann wieder geschlossen werden.
            - service: media_player.volume_set
              data_template:
                volume_level: >
                  {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                entity_id: media_player.wohnzimmer_uhr

- id: turn_off_bett_if_no_device_is_charging
  alias: "Turn off bett if no device is charging"
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - sensor.fabian_ipadpro_battery_state
        - sensor.fabian_phone_battery_state
        - sensor.nessie_iphone_battery_state
      to: "discharging"
    - platform: state
      entity_id:
        - sensor.fabian_ipadpro_battery_state
        - sensor.fabian_phone_battery_state
        - sensor.nessie_iphone_battery_state
      to: "Not Charging"
    - platform: numeric_state
      entity_id:
        - sensor.fabian_ipadpro_battery_state
        - sensor.fabian_iphone_battery_state
        - sensor.nessie_iphone_battery_state
      above: 90
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.bett_usb_ports
        state: "on"
      # - condition: or
      #   conditions:
      #     - condition: state
      #       entity_id: sensor.fabian_ipadpro_battery_state
      #       state: 'discharging'
      #     - condition: numeric_state
      #       entity_id: sensor.fabian_ipadpro_battery_state
      #       above: 90
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.fabian_phone_battery_state
            state: "discharging"
          - condition: numeric_state
            entity_id: sensor.fabian_iphone_battery_state
            above: 80
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.nessie_iphone_battery_state
            state: "discharging"
          - condition: numeric_state
            entity_id: sensor.nessie_phone_battery_level
            above: 80
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.bett_usb_ports

- id: turn_off_bett_after_x_hours
  alias: "Turn off bett after x hours"
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.bett_usb_ports
      to: "on"
      for:
        minutes: 180
    - platform: state
      entity_id: switch.bett_usb_ports
      to: "on"
      for:
        minutes: 360
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.bett_usb_ports
        state: "on"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.bett_usb_ports

- id: turn_on_lights_in_morning
  alias: "Turn on lights in morning"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_iphone_2
      from: "not_home"
      to: "home"
    - platform: state
      entity_id: device_tracker.nessie_iphone_2
      from: "not_home"
      to: "home"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "05:00:00"
      - condition: time
        before: "09:00:00"
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_morning.attributes.last_triggered) | int > 1800 }}"
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: device_tracker.fabian_iphone_2
                state: home
              - condition: state
                entity_id: device_tracker.nessie_iphone_2
                state: home
          - condition: and
            conditions:
              - condition: state
                entity_id: device_tracker.nessie_iphone_2
                state: home
              - condition: not
                conditions:
                  - condition: state
                    entity_id: person.fabian
                    state: home
          - condition: and
            conditions:
              - condition: state
                entity_id: device_tracker.fabian_iphone_2
                state: home
              - condition: not
                conditions:
                  - condition: state
                    entity_id: person.nessie
                    state: home
  action:
    - delay: "00:04:30"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: numeric_state
                  entity_id: sensor.dwd_illuminance
                  below: 2000
                - condition: numeric_state
                  entity_id: sensor.fabian_s_zuhause_solar_percentage
                  below: 20
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.adaptive_lighting_sleeping_room
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_tisch
                  - light.yeelight_bslamp2_0x13fea10f
                brightness: 2
            - delay: "00:02:30"
            - service: automation.trigger
              entity_id: automation.increase_lights_in_morning
    - delay: "00:00:30"
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: state
              entity_id: input_boolean.gast_modus
              state: "off"
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: climate.gastezimmer
                  attribute: current_humidity
                  above: 60
                - condition: numeric_state
                  entity_id: climate.wohnzimmer
                  attribute: current_humidity
                  above: 60
                - condition: numeric_state
                  entity_id: climate.schlafzimmer
                  attribute: current_humidity
                  above: 60
                - condition: numeric_state
                  entity_id: climate.bad
                  attribute: current_humidity
                  above: 60
          sequence:
            - service: automation.trigger
              entity_id: automation.notify_for_high_humidity
    # - service: light.turn_on
    #   data_template:
    #     entity_id: light.bett_gluhbirne
    #     brightness: 100
    #     rgb_color: >
    #       {% if state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['condition'] == 'snowy' %}
    #       [255,255,255]
    #       {% elif state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['condition'] == 'rainy' %}
    #       [0,0,255]
    #       {% elif state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['condition'] == 'sunny' %}
    #       [0,255,0]
    #       {% else %}
    #       [0,0,0]
    #       {% endif %}
    # - delay: '00:05:00'
    # - service: light.turn_off
    #   data:
    #     entity_id:
    #       - light.yeelight_bslamp2_0x13fea10f
    - delay: "00:20:00"
    - service: switch.turn_on
      data:
        entity_id: switch.adaptive_lighting_sleeping_room
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_pc
              state: "not_home"
            - condition: state
              entity_id: "device_tracker.nsta0552"
              state: "not_home"
          sequence:
            - service: light.turn_off
              data:
                entity_id:
                  - light.leds_tisch

- id: increase_lights_in_morning
  alias: "Increase lights in morning"
  initial_state: false
  mode: restart
  trigger:
    - platform: state
      entity_id: automation.increase_lights_in_morning
      to: "on"
  condition:
    condition: and
    conditions:
      - condition: not
        conditions:
          - condition: state
            entity_id: light.yeelight_bslamp2_0x13fea10f
            state: "off"
          - condition: state
            entity_id: light.leds_tisch
            state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: light.leds_tisch
            state: "unavailable"
          - condition: not
            conditions:
              - condition: state
                entity_id: light.leds_tisch
                attribute: brightness
                state: "255"
  action:
    - delay: "00:00:15"
    - choose:
        - conditions:
            - condition: state
              entity_id: light.leds_tisch
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.leds_tisch
                  attribute: brightness
                  state: "255"
          sequence:
            - service: light.turn_on
              entity_id: light.leds_tisch
              data_template:
                brightness: "{{states.light.leds_tisch.attributes.brightness + 5}}"
            - service: light.turn_on
              data:
                entity_id: light.regal
    - choose:
        - conditions:
            - condition: state
              entity_id: light.yeelight_bslamp2_0x13fea10f
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.yeelight_bslamp2_0x13fea10f
                  attribute: brightness
                  state: "255"
          sequence:
            - service: light.turn_on
              entity_id: light.yeelight_bslamp2_0x13fea10f
              data_template:
                brightness: "{{states.light.yeelight_bslamp2_0x13fea10f.attributes.brightness + 5}}"
    - choose:
        - conditions:
            - condition: state
              entity_id: light.leds_tisch
              state: "on"
            - condition: state
              entity_id: light.yeelight_bslamp2_0x13fea10f
              state: "on"
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.leds_tisch
                  attribute: brightness
                  state: "255"
                - condition: state
                  entity_id: light.yeelight_bslamp2_0x13fea10f
                  attribute: brightness
                  state: "255"
          sequence:
            - service: automation.trigger
              data:
                entity_id: automation.increase_lights_in_morning

- id: Remind for leaving in the morning
  alias: "Remind for leaving in the morning"
  initial_state: true
  trigger:
    - platform: time
      at: "06:55:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.leiser_modus"
        state: "off"
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.nessie_iphone_2
            state: home
          - condition: state
            entity_id: device_tracker.fabian_iphone_2
            state: home
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: "input_boolean.gast_modus"
                  state: "off"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: device_tracker.nessie_iphone_2
                      state: home
                    - condition: state
                      entity_id: device_tracker.fabian_iphone_2
                      state: home
              sequence:
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.1 }}
                    entity_id:
                      - media_player.wohnzimmer_uhr
                      - media_player.kuche_speaker
                - service: tts.google_say
                  entity_id:
                    - media_player.wohnzimmer_uhr
                    - media_player.kuche_speaker
                  data_template:
                    message: >
                      Es ist {{ now().hour }} Uhr {{ now().minute }} .
                      Die Sbahn um {{ states.sensor.zorneding_to_leuchtenbergring.attributes.departure }} Uhr hat voraussichtlich
                      {% if state_attr('sensor.zorneding_to_leuchtenbergring', 'delay') == 1 %}
                      eine Minute
                      {% elif state_attr('sensor.zorneding_to_leuchtenbergring', 'delay') >= 1 %}
                      {{ states.sensor.zorneding_to_leuchtenbergring.attributes.delay }} Minuten
                      {% else %}
                      keine
                      {% endif %} Verspätung.
                - delay: "00:00:12"
                - choose:
                    - conditions:
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: binary_sensor.schlafzimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.gastezimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.wohnzimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.bad_open_window
                              state: "on"
                      sequence:
                        - parallel:
                            - service: tts.google_say
                              entity_id: media_player.wohnzimmer_uhr
                              data_template:
                                message: >
                                  Das Fenster im {% if is_state('binary_sensor.schlafzimmer_open_window', 'on') %}
                                    Schlafzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.gastezimmer_open_window', 'on') %}
                                    Gästezimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.wohnzimmer_open_window', 'on') %}
                                    Wohnzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.bad_open_window', 'on') %}
                                    Bad
                                  {% endif %}
                                  muss noch geschlossen werden.
                            - service: tts.google_say
                              entity_id: media_player.kuche_speaker
                              data_template:
                                message: >
                                  Das Fenster im {% if is_state('binary_sensor.schlafzimmer_open_window', 'on') %}
                                    Schlafzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.gastezimmer_open_window', 'on') %}
                                    Gästezimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.wohnzimmer_open_window', 'on') %}
                                    Wohnzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.bad_open_window', 'on') %}
                                    Bad
                                  {% endif %}
                                  muss noch geschlossen werden.
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id:
                      - media_player.wohnzimmer_uhr
                      - media_player.kuche_speaker
        - choose:
            - conditions:
                - condition: and
                  conditions:
                    - condition: state
                      entity_id: device_tracker.nessie_iphone_2
                      state: home
                    - condition: state
                      entity_id: device_tracker.fabian_iphone_2
                      state: home
              sequence:
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.1 }}
                    entity_id: media_player.schlafzimmer_speaker
                - service: tts.google_say
                  entity_id: media_player.schlafzimmer_speaker
                  data_template:
                    message: >
                      Es ist {{ now().hour }} Uhr {{ now().minute }} .
                      Die Sbahn um {{ states.sensor.zorneding_to_leuchtenbergring.attributes.departure }} Uhr hat voraussichtlich
                      {% if state_attr('sensor.zorneding_to_leuchtenbergring', 'delay') == 1 %}
                      eine Minute
                      {% elif state_attr('sensor.zorneding_to_leuchtenbergring', 'delay') >= 1 %}
                      {{ states.sensor.zorneding_to_leuchtenbergring.attributes.delay }} Minuten
                      {% else %}
                      keine
                      {% endif %} Verspätung.
                - delay: "00:00:12"
                - choose:
                    - conditions:
                        - condition: or
                          conditions:
                            - condition: state
                              entity_id: binary_sensor.schlafzimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.gastezimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.wohnzimmer_open_window
                              state: "on"
                            - condition: state
                              entity_id: binary_sensor.bad_open_window
                              state: "on"
                      sequence:
                        - parallel:
                            - service: tts.google_say
                              entity_id: media_player.schlafzimmer_speaker
                              data_template:
                                message: >
                                  Das Fenster im {% if is_state('binary_sensor.schlafzimmer_open_window', 'on') %}
                                    Schlafzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.gastezimmer_open_window', 'on') %}
                                    Gästezimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.wohnzimmer_open_window', 'on') %}
                                    Wohnzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.bad_open_window', 'on') %}
                                    Bad
                                  {% endif %}
                                  muss noch geschlossen werden.
                            - service: tts.google_say
                              entity_id: media_player.kuche_speaker
                              data_template:
                                message: >
                                  Das Fenster im {% if is_state('binary_sensor.schlafzimmer_open_window', 'on') %}
                                    Schlafzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.gastezimmer_open_window', 'on') %}
                                    Gästezimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.wohnzimmer_open_window', 'on') %}
                                    Wohnzimmer
                                  {% endif %}
                                  {% if is_state('binary_sensor.bad_open_window', 'on') %}
                                    Bad
                                  {% endif %}
                                  muss noch geschlossen werden.
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.schlafzimmer_speaker

- id: turn_on_light_in_sleeping_room_if_tv_turned_off
  alias: "Turn on light in sleeping room if tv turned off"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.wohnzimmer_tv
      from: "home"
      to: "not_home"
      for:
        seconds: 5
    - platform: state
      entity_id: switch.fernseher
      to: "off"
      for:
        seconds: 5
  condition:
    - condition: time
      after: "21:00:00"
      before: "23:50:00"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_light_in_sleeping_room_if_tv_turned_off.attributes.last_triggered) | int > 1800 }}"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.bett_gluhbirne
                  state: unavailable
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.bett_gluhbirne
                brightness: 255
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: light.yeelight_bslamp2_0x13fea10f
                  state: unavailable
          sequence:
            - service: light.turn_on
              data:
                entity_id: light.yeelight_bslamp2_0x13fea10f
                brightness: 255
                color_temp: 279
    - service: light.turn_off
      data:
        entity_id:
          - light.leds_tisch
          - light.regal
    - delay: "00:04:00"
    - service: light.turn_off
      data:
        area_id:
          - "{{ area_id('Wohnzimmer') }}"

- id: turn_on_lights_in_livingroom_when_dark_outside
  alias: "Turn on lights in livingroom when dark outside"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      below: 1800
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      below: 18
    - platform: sun
      event: sunset
      offset: "-00:30:00"
  condition:
    - condition: state
      entity_id: device_tracker.wohnzimmer_tv
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_livingroom_when_dark_outside.attributes.last_triggered) | int > 1800 }}"
  action:
    - service: light.turn_on
      data:
        entity_id:
          - light.leds_wohnzimmer_tv
          - light.leds_wohnzimmer
          - light.yeelight_color_0x36dc050
        transition: 2

- id: turn_off_prismatik_during_the_day
  alias: "Turn off Prismatik during the day"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "home"
      for:
        minutes: 2
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.dwd_illuminance
        above: 2000
      - condition: numeric_state
        entity_id: sensor.fabian_s_zuhause_solar_percentage
        above: 20
  action:
    - delay: "00:04:00"
    - service: light.turn_off
      data:
        entity_id: light.prismatik

- id: turn_on_lights_in_sleeping_room_when_sun_set
  alias: "Turn on lights in sleeping room when sun set"
  trigger:
    platform: sun
    event: sunset
    offset: "-00:05:00"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "device_tracker.wohnzimmer_tv"
        state: "not_home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "device_tracker.fabian_pc"
            state: "home"
          - condition: state
            entity_id: "device_tracker.nsta0552"
            state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "person.fabian"
            state: "home"
          - condition: state
            entity_id: "person.nessie"
            state: "home"
  action:
    - service: light.turn_on
      data:
        entity_id: light.leds_tisch
        brightness: 255
        transition: 2
    - delay: "00:04:00"
    - service: light.turn_on
      data:
        entity_id: light.prismatik

- id: Turn_on_lights_in_sleeping_room_when_cloudy
  alias: "Turn on lights in sleeping room when cloudy"
  initial_state: false
  trigger:
    - platform: sun
      event: sunset
      offset: "-02:00:00"
    - platform: state
      entity_id: weather.dwd_weather_ebersberg_1h
      to: "cloudy"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: weather.dwd_weather_ebersberg_1h
        state: cloudy
      - condition: sun
        after: sunset
        after_offset: "-02:00:00"
      - condition: or
        conditions:
          - condition: state
            entity_id: "device_tracker.fabian_pc"
            state: "home"
          - condition: state
            entity_id: "device_tracker.nsta0552"
            state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "person.fabian"
            state: "home"
          - condition: state
            entity_id: "person.nessie"
            state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.wohnzimmer_tv
            state: "not_home"
          - condition: state
            entity_id: switch.fernseher
            state: "off"
  action:
    - service: light.turn_on
      data:
        entity_id: light.leds_tisch
        brightness: 255
        transition: 2
    - delay: "00:04:00"
    - service: light.turn_on
      data:
        entity_id: light.prismatik

- id: turn_on_lights_in_guest_room_when_dark_outside
  alias: "Turn on lights in guest room when dark outside"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      below: 2000
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      below: 27
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: sensor.dwd_illuminance
                below: 2000
              - condition: time
                after: "15:00:00"
          - condition: numeric_state
            entity_id: sensor.fabian_s_zuhause_solar_percentage
            below: 20
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_guest_room_when_dark_outside.attributes.last_triggered) | int > 1800 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: "person.fabian"
            state: "home"
          - condition: state
            entity_id: "person.nessie"
            state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "device_tracker.rgb_pc"
            state: "home"
          # - condition: and
          # conditions:
          # - condition: state
          # entity_id: 'device_tracker.vku_lb_20'
          #  state: 'home'
          # - condition: state
          # entity_id: 'switch.nessie_pc'
          # state: 'on'
  action:
    - service: light.turn_on
      data:
        area_id:
          - "{{ area_id('Gaestezimmer') }}"
        transition: 2

- id: turn_off_lights_in_rooms_when_bright_outside
  alias: "Turn off lights in rooms when bright outside"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_illuminance
      above: 2510
    - platform: numeric_state
      entity_id: sensor.fabian_s_zuhause_solar_percentage
      above: 25
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_lights_in_guest_room_when_dark_outside.attributes.last_triggered) | int > 2400 }}"
  action:
    - service: light.turn_off
      data:
        area_id:
          - "{{ area_id('Wohnzimmer') }}"
          - "{{ area_id('Schlafzimmer') }}"
          - "{{ area_id('Gaestezimmer') }}"

- id: turn_off_climates_on_warm_days
  alias: "Turn off Climates on warm days"
  initial_state: true
  trigger:
    platform: numeric_state
    entity_id: weather.dwd_weather_ebersberg_1h
    attribute: temperature
    above: 14
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['condition'] == 'sunny' }}"
      - condition: template
        value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['condition'] == 'sunny' }}"
      - condition: template
        value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['temperature'] >= 14 }}"
      # - condition: state
      #   entity_id: 'weather.dwd_weather_ebersberg_1h'
      #   state: 'sunny'
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "off"
      - condition: or
        conditions:
          - condition: template
            value_template: "{{ now().month <= 10 and now().month >= 2 }}"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.thermostate_aus
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Thermostate wurden ausgeschaltet, da es {{ states.weather.dwd_weather_ebersberg_1h.attributes.temperature }} ° hat und sonnig ist."
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: "Thermostate wurden ausgeschaltet, da es {{ states.weather.dwd_weather_ebersberg_1h.attributes.temperature }} ° hat und sonnig ist."
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"

- id: turn_on_climates_on_cold_days
  alias: "Turn on Climates on cold days"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: weather.dwd_weather_ebersberg_1h
      attribute: temperature
      below: 10
    - platform: sun
      event: sunset
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "on"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_climates_on_cold_days.attributes.last_triggered) | int > 86300 }}"
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: numeric_state
                entity_id: weather.dwd_weather_ebersberg_1h
                attribute: temperature
                below: 10
              - condition: sun
                after: sunset
                after_offset: "-04:00:00"
              - condition: time
                after: "20:30:00"
              - condition: template
                value_template: "{{ now().month <= 10 and now().month >= 2 }}"
          - condition: template
            value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['temperature'] <= 12 }}"
          - condition: and
            conditions:
              - condition: template
                value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['condition'] != 'sunny' }}"
              - condition: template
                value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['temperature'] <= 14 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: 'Thermostate sollten wieder eingeschaltet werden, da es jetzt nur noch {{ states.weather.dwd_weather_ebersberg_1h.attributes.temperature }} °C und morgen {{state_attr("weather.dwd_weather_ebersberg", "forecast")[1]["temperature"]}} °C hat. Dies wurde nicht automatisch gemacht!'
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: 'Thermostate sollten wieder eingeschaltet werden, da es jetzt nur noch {{ states.weather.dwd_weather_ebersberg_1h.attributes.temperature }} °C und morgen {{state_attr("weather.dwd_weather_ebersberg", "forecast")[1]["temperature"]}} °C hat. Dies wurde nicht automatisch gemacht!'
        disable_notification: true
        inline_keyboard:
          - "Einschalten:/climateson"

- id: remind_for_polygon_events
  alias: "remind for Polygon Events"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - 172800) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - as_timestamp(now())) < 173800) and ((as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_polygon_events.attributes.last_triggered) | int > 86700 }}"
      - condition: not
        conditions:
          - condition: state
            entity_id: calendar.votgaming_kalender
            attribute: message
            state: "Gruppentreffen"
  action:
    - service: telegram_bot.send_poll
      data_template:
        target: !secret telegram_chat_polygon
        question: "Es findet am {{ as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) | timestamp_custom('%d.%m.%Y %H:%M', true) }} Uhr {{ states.calendar.votgaming_kalender.attributes.message }} statt. Ich bin dabei?"
        options:
          - "Ja"
          - "Nein"
          - "Wahrscheinlich schon"
        is_anonymous: false
        allows_multiple_answers: false

- id: remind_for_gruppentreffen
  alias: "remind for Gruppentreffen"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - 111600) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - as_timestamp(now())) < 112600) and ((as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: state
        entity_id: calendar.votgaming_kalender
        attribute: message
        state: "Gruppentreffen"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: or
                  conditions:
                    - condition: template
                      value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['condition'] == 'sunny' }}"
                    - condition: template
                      value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['condition'] == 'partlycloudy' }}"
                - condition: template
                  value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[1]['temperature'] | int >= 18 }}"
          sequence:
            - service: telegram_bot.send_poll
              data_template:
                target: !secret telegram_chat_5friends
                question: "Morgen ist {{ states.calendar.votgaming_kalender.attributes.message }}. Es wird {{ states.weather.dwd_weather_ebersberg_1h.attributes.forecast[24].condition }} bei {{ states.weather.dwd_weather_ebersberg_1h.attributes.forecast[1].temperature }} °. Wo treffen wir uns?"
                options:
                  - "See"
                  - "Weiher"
                  - "Fabi Keller"
                  - "Kai & Adri"
                  - "Flo"
                  - "Maxi"
                  - "Wo anders (Schreiben wo!)"
                is_anonymous: false
                allows_multiple_answers: true
                disable_notification: true
      default:
        - service: telegram_bot.send_poll
          data_template:
            target: !secret telegram_chat_5friends
            question: "Morgen ist {{ states.calendar.votgaming_kalender.attributes.message }}. Es wird {{ states.weather.dwd_weather_ebersberg_1h.attributes.forecast[24].condition }} bei {{ states.weather.dwd_weather_ebersberg_1h.attributes.forecast[24].temperature }} °. Wo treffen wir uns?"
            options:
              - "Fabi Keller"
              - "Kai & Adri"
              - "Flo"
              - "Maxi"
              - "JUZ"
              - "Draußen trotz nicht so gutem Wetter"
              - "Wo anders (Schreiben wo!)"
            is_anonymous: false
            allows_multiple_answers: true
            disable_notification: true
    - service: telegram_bot.send_poll
      data_template:
        target: !secret telegram_chat_5friends
        question: "Shisha (wenn Treffen in keinem geschlossenem Raum)?"
        options:
          - "Ja"
          - "Nein"
          - "Mir egal"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true

- id: turn_on_fridge_for_meetings
  alias: "Turn on fridge for meetings"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - 10800) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) < 43200) and ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: not
        conditions:
          - condition: state
            entity_id: calendar.fabianseitz98_gmail_com
            attribute: message
            state: "Gruppentreffen"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
                - condition: state
                  entity_id: "switch.kuhlschrank"
                  state: "off"
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{ now().month < 4 and now().month > 10 }}"
                - condition: and
                  conditions:
                    - condition: template
                      value_template: "{{ now().month <= 10 and now().month >= 4 }}"
                    - condition: numeric_state
                      entity_id: weather.dwd_weather_ebersberg_1h
                      attribute: temperature
                      below: 6
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Erinnerung: Heute steht {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an."
                disable_notification: true
                inline_keyboard:
                  - "Kühlschrank anschalten:/fridge"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
                - condition: state
                  entity_id: input_boolean.abwesend_modus
                  state: "off"
                - condition: state
                  entity_id: "switch.kuhlschrank"
                  state: "off"
                - condition: template
                  value_template: "{{ now().month <= 10 and now().month >= 4 }}" # Im Winter ist der Keller kalt genug, da muss der Kühlschrank nicht an sein.
                - condition: numeric_state
                  entity_id: weather.dwd_weather_ebersberg_1h
                  attribute: temperature
                  above: 5
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Anscheinend steht heute {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an, soll der Kühlschrank im Keller eingeschaltet werden?"
                disable_notification: true
                inline_keyboard:
                  - "Anschalten:/fridge"
    - choose:
        - conditions:
            - condition: state
              entity_id: "switch.kuhlschrank"
              state: "off"
            - condition: template
              value_template: "{{ now().month <= 10 and now().month >= 4 }}" # Im Winter ist der Keller kalt genug, da muss der Kühlschrank nicht an sein.
            - condition: state
              entity_id: input_boolean.abwesend_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: !secret strasse
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: none
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: ""
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Monthly Meet"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen in Zorneding"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Geburtstagsfeier"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Spieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Karten- / Brettspieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Kartenspieleabend"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Anscheinend steht heute {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an, soll der Kühlschrank im Keller eingeschaltet werden?"
                disable_notification: true
                inline_keyboard:
                  - "Anschalten:/fridge"

- id: remind_for_door_for_meetings
  alias: "Remind for door for meetings"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - 43200) | round(-1) }}"
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.votgaming_kalender.attributes.start_time) - 43500) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) < 58000) and ((as_timestamp(states.calendar.fabianseitz98_gmail_com.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_door_for_meetings.attributes.last_triggered) | int > 7200 }}"
      - condition: template
        value_template: "{{ now().month <= 4 or now().month >= 10 }}" # Im Sommer ist der Keller warm genug, da muss nicht die Wärme vom Flur genutzt werden.
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: !secret strasse
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: location
                  state: none
            - condition: or
              conditions:
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Gruppentreffen"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Monthly Meet"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Treffen in Zorneding"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Geburtstagsfeier"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Spieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Karten- / Brettspieleabend"
                - condition: state
                  entity_id: calendar.fabianseitz98_gmail_com
                  attribute: message
                  state: "Kartenspieleabend"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: "Demnächst steht {{ states.calendar.fabianseitz98_gmail_com.attributes.message }} an. Tür im Keller öffnen um die Wärme vom Heizraum zu nutzen?"

- id: remind_for_DST_change_Winter_Sommerzeit
  alias: "Remind for DST change - Winter/Sommerzeit"
  initial_state: true
  trigger:
    # - platform: time
    # at: '15:30:00'
    - platform: template
      value_template: "{{ now().timetuple().tm_isdst }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        disable_notification: true
        message: >
          Die Zeitumstellung hat stattgefunden!
          {%- if now().timetuple().tm_isdst | int > 0 -%}
            Sommerzeit hat begonnen und die Uhrzeit wird um eine Stunde vorgestellt (eine Stunde weniger Schlaf).
          {%- else -%}
            Winterzeit hat begonnen und die Uhrzeit wird um eine Stunde zurückgestellt (eine Stunde mehr Schlaf).
          {%- endif -%}
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        disable_notification: true
        message: >
          Die Zeitumstellung hat stattgefunden!
          {%- if now().timetuple().tm_isdst | int > 0 -%}
            Sommerzeit hat begonnen und die Uhrzeit wird um eine Stunde vorgestellt (eine Stunde weniger Schlaf).
          {%- else -%}
            Winterzeit hat begonnen und die Uhrzeit wird um eine Stunde zurückgestellt (eine Stunde mehr Schlaf).
          {%- endif -%}

- id: notify_on_HA_restart
  alias: "Notify on HA restart"
  initial_state: true
  trigger:
    platform: homeassistant
    event: start
  condition:
    - condition: time
      after: "03:10:00"
      before: "03:00:00"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_on_ha_restart.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.automatic_ha_update.attributes.last_triggered) | int > 500 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_off_devices_at_night.attributes.last_triggered) | int > 500 }}"
  action:
    - service: frontend.set_theme
      data:
        name: transparentgray-LAB
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Homeassistant wurde soeben gestartet."
    # - service: button.press
    # target:
    # entity_id: button.synchronize_devices

- id: run_bash_script_with_addon_bash_script_executer_every_hour
  alias: "Run Bash Script with Addon Bash Script Executer every hour"
  initial_state: false
  trigger:
    - platform: time_pattern
      minutes: "/59"
      seconds: 0
  action:
    - service: hassio.addon_start
      data:
        addon: 605cee21_bashscriptexecuter

- id: turn_on_away_mode
  alias: Turn on Away Mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.abwesend_modus
      to: "on"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.leiser_modus
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
          sequence:
            - service: climate.set_preset_mode
              data:
                entity_id: all
                preset_mode: "away"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:00:40"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "min"
          sequence:
            - service: select.select_option
              data:
                option: min
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: turn_off_away_mode
  alias: Turn off Away Mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.abwesend_modus
      to: "off"
  action:
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.leiser_modus
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
          sequence:
            - service: climate.set_preset_mode
              data:
                entity_id: all
                preset_mode: "home"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_2_4g_signal_strength
    - delay: "00:00:40"
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength
                  state: "max"
          sequence:
            - service: select.select_option
              data:
                option: max
              target:
                entity_id: select.miwifi_28_d1_27_fc_ab_d8_wifi_5g_signal_strength

- id: turn_on_climate_off_mode
  alias: Turn on Climate Off mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.thermostate_aus
      to: "on"
  action:
    - service: climate.turn_off
      data:
        entity_id: all

- id: turn_off_climate_off_mode
  alias: Turn off Climate Off mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.thermostate_aus
      to: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: all
        hvac_mode: auto

- id: turn_on_guest_mode
  alias: Turn on Guest Mode mode
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.gast_modus
      to: "on"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.adaptive_lighting_guest_room

- id: turn_on_fs_strom
  alias: Turn on FS Strom
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.fabian_pc_strom
      to: "on"
    - platform: state
      entity_id: switch.fabian_strom
      to: "on"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.fabian_strom
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.fabian_pc_strom

- id: turn_off_fs_strom
  alias: Turn off FS Strom
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.fabian_pc_strom
      to: "off"
    - platform: state
      entity_id: switch.fabian_strom
      to: "off"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.schlafzimmer_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.fabian_pc_shutdown
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.schlafzimmer_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.fabian_pc_shutdown
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.schlafzimmer_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.fabian_pc_shutdown
            - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "on"
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.schlafzimmer_power
                  above: 20
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der PC/Notebook ist noch an und konnte nicht heruntergefahren werden. Daher wurde der Strom nicht ausgeschaltet."
            - service: input_boolean.turn_on
              data:
                entity_id: input_boolean.fabian_pc_strom
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: numeric_state
                  entity_id: sensor.schlafzimmer_power
                  below: 21
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.fabian_strom
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "off"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.fabian_pc_strom

- id: turn_on_vk_strom
  alias: Turn on VK Strom
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.nessie_pc_strom
      to: "on"
    - platform: state
      entity_id: switch.nessie_pc
      to: "on"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.nessie_pc
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.nessie_pc_strom

- id: turn_off_vk_strom
  alias: Turn off VK Strom
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_boolean.nessie_pc_strom
      to: "off"
    - platform: state
      entity_id: switch.nessie_pc
      to: "off"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.rgb_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.nessie_pc_energy_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.rgb_pc_shutdown
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.rgb_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.nessie_pc_energy_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.rgb_pc_shutdown
            - delay: "00:30:00"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.rgb_pc
                  state: "home"
                - condition: numeric_state
                  entity_id: sensor.nessie_pc_energy_power
                  above: 20
          sequence:
            - service: button.press
              target:
                entity_id: button.rgb_pc_shutdown
            - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: state
                  entity_id: device_tracker.rgb_pc
                  state: "home"
                - condition: state
                  entity_id: device_tracker.vku_lb_20
                  state: "not_home"
                - condition: numeric_state
                  entity_id: sensor.nessie_pc_energy_power
                  above: 20
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Der PC ist noch an und konnte nicht heruntergefahren werden. Daher wurde der Strom nicht ausgeschaltet."
            - service: notify.telegram_fabian
              data:
                message: "Nessie PC ist noch an und konnte nicht heruntergefahren werden. Daher wurde der Strom nicht ausgeschaltet."
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: numeric_state
                  entity_id: sensor.nessie_pc_energy_power
                  below: 21
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.nessie_pc
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.nessie_pc
              state: "off"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: input_boolean.nessie_pc_strom

- id: remind_for_away_mode
  alias: "Remind for away mode"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "home"
      to: "not_home"
      for:
        minutes: 1440
    - platform: state
      entity_id: person.nessie
      from: "home"
      to: "not_home"
      for:
        minutes: 1440
    - platform: numeric_state
      entity_id: proximity.home_fabian
      above: 100
      for:
        minutes: 5
    - platform: numeric_state
      entity_id: proximity.home_nessie
      above: 100
      for:
        minutes: 5
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: person.fabian
        state: not_home
      - condition: state
        entity_id: person.nessie
        state: not_home
      - condition: state
        entity_id: "input_boolean.abwesend_modus"
        state: "off"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Away Mode wurde aktiviert, da keiner daheim ist."
    - service: notify.telegram_nessie
      data:
        message: "Away Mode wurde aktiviert, da keiner daheim ist."
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.abwesend_modus

- id: warn_for_state_change_if_in_away_mode
  alias: Warn for state change if in away mode
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - group.wohnzimmer
        - group.schlafzimmer
        - group.gastezimmer
      from: "off"
      to: "on"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.abwesend_modus"
        state: "on"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.warn_for_state_change_if_in_away_mode.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_fabian
        message: "ACHTUNG! Es wurde ein Gerät eingeschaltet, obwohl der Abwesend Modus aktiviert ist!"
    - service: telegram_bot.send_message
      data:
        target: !secret telegram_chat_nessie
        message: "ACHTUNG! Es wurde ein Gerät eingeschaltet, obwohl der Abwesend Modus aktiviert ist!"
    - service: tts.google_say
      entity_id:
        - media_player.wohnzimmer_uhr
        - media_player.kuche_speaker
        - media_player.gastezimmer_mini
        - media_player.kuche_speaker
        - media_player.schlafzimmer_speaker
      data:
        message: Einbrecher sind nicht erwünscht. Du wirst beobachtet und wurdest gefilmt. Verlasse die Wohnung sofort. Die Polizei wird gerufen.

- id: remind_for_waste_collection
  alias: "Remind for waste collection"
  initial_state: true
  trigger:
    platform: time
    at: "16:00:00"
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.bioabfall
            state: "Morgen"
          - condition: state
            entity_id: sensor.altpapier
            state: "Morgen"
      - condition: state
        entity_id: "input_boolean.abwesend_modus"
        state: "off"
  action:
    - service: telegram_bot.send_message
      data_template:
        message: >
          Morgen wird {% if states.sensor.bioabfall.state == "Morgen" %}die Biomülltonne{% endif %}{% if states.sensor.altpapier.state == "Morgen" %}das Altpapier{% endif %} abgeholt. Bitte rausstellen.
        target: !secret telegram_chat_fabian
    - service: telegram_bot.send_message
      data_template:
        message: >
          Morgen wird {% if states.sensor.bioabfall.state == "Morgen" %}die Biomülltonne{% endif %}{% if states.sensor.altpapier.state == "Morgen" %}das Altpapier{% endif %} abgeholt. Bitte rausstellen.
        target: !secret telegram_chat_nessie

- id: foodsharing_basket_available
  alias: "Foodsharing Basket Available"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.foodsharing_48_082236
    # - platform: template
    # value_template: {{ states.sensor.foodsharing_48_082236.attributes.baskets[-1]['id'] }}
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.foodsharing_48_082236
        above: "0"
      - condition: template
        value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        message: >
          {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}

          ------------

          {% if not state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['picture'] == 'unavailable' %}
          Bild: {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['picture'] }}
          {% endif %}

          Link: https://foodsharing.de/essenskoerbe/{{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['id'] }}

          {% if not state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['address'] == 'unavailable' %}
          Adresse: {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['address'] }}
          {% endif %}

          Google Maps Link: {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['maps'] }}
        target: !secret telegram_foodsharing

- id: foodsharing_basket_available_zorneding
  alias: "Foodsharing Basket Available Zorneding"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.foodsharing_48_082236
    # - platform: template
    # value_template: {{ states.sensor.foodsharing_48_082236.attributes.baskets[-1]['id'] }}
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.foodsharing_48_082236
        above: "0"
      - condition: template
        value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
      - condition: or
        conditions:
          - condition: template
            value_template: "{{'Zorneding' in state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['address'] }}"
          - condition: template
            value_template: "{{'Zorneding' in state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: "home"
          sequence:
            - service: notify.mobile_app_nessie_iphone
              data_template:
                title: "Neuer Foodsharing Korb in Zorneding"
                message: >
                  {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: numeric_state
                  entity_id: proximity.home_fabian
                  below: 5
          sequence:
            - service: notify.mobile_app_fabian_iphone
              data_template:
                title: "Neuer Foodsharing Korb in Zorneding"
                message: >
                  {{ state_attr('sensor.foodsharing_48_082236', 'baskets')[0]['description'] }}
                data:
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.4

- id: foodsharing_basket_available_muc_east
  alias: "Foodsharing Basket Available MUC East"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.foodsharing_48_117971
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.foodsharing_48_117971
        above: "0"
      - condition: template
        value_template: "{{ trigger.to_state.state|int > trigger.from_state.state|int }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        message: >
          {{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['description'] }}

          ------------

          {% if not state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['picture'] == 'unavailable' %}
          Bild: {{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['picture'] }}
          {% endif %}

          Link: https://foodsharing.de/essenskoerbe/{{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['id'] }}

          {% if not state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['address'] == 'unavailable' %}
          Adresse: {{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['address'] }}
          {% endif %}

          Google Maps Link: {{ state_attr('sensor.foodsharing_48_117971', 'baskets')[0]['maps'] }}
        target: !secret telegram_foodsharing_muc

- id: rewe_discount_keyword_available
  alias: "Rewe Discount Keyword available"
  initial_state: true
  trigger:
    - platform: time
      at: "06:40:00"
  condition:
    - condition: time
      weekday:
        - mon
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.rewe_440421
          state: "unavailable"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_juz_leiter
        message: >
          Neue eventuell für das JUZ relevante Angebote im Rewe Zorneding Prospekt:
          {%- set product_list_loop =  state_attr('sensor.rewe_440421', 'discounts') -%}
          {%- for product in product_list_loop -%}
            {% if 'Spezi' in product.product or 'Hell' in product.product or 'Chips' in product.product or 'Silenca' in product.product or 'Oettinger' in product.product %}

          {{product.price.price }} € - {{product.product }}

          {{ product.picture_link }}
            {%- endif -%}
          {%- endfor -%}
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: >
          Neue Angebote diese Woche im Rewe Zorneding Prospekt:
          {%- set product_list_loop =  state_attr('sensor.rewe_440421', 'discounts') -%}
          {%- for product in product_list_loop -%}
            {% if 'Almighurt' in product.product or 'Ehrmann' in product.product or 'Oettinger' in product.product %}

          {{product.price.price }} € - {{product.product }}

          {{ product.picture_link }}
            {%- endif -%}
          {%- endfor -%}

- id: automatic_ha_updates
  alias: "Automatic HA Updates"
  initial_state: true
  trigger:
    - platform: time
      at: "04:00:00"
    - platform: time
      at: "05:10:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - sun
      - condition: template
        value_template: >
          {% set domain = 'update' %}
          {% set state = 'on' %}
          {{ states[domain] | selectattr('state','eq', state) | list | count > 0 }}
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: sensor.hacs
              above: 0
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  {% if is_state("sensor.hacs", "1")%}
                  Es gibt ein verfügbares HACS Update.
                  {% else %}
                  Es gibt {{ states.sensor.hacs.state }} verfügbare HACS Updates.
                  {% endif %}
                  Folgende Updates werden nun automatisch installiert:
                  {% if states.update.waste_collection_schedule_update.state == "on" %}
                  {{ states.update.waste_collection_schedule_update.attributes.friendly_name }} Changelog: {{ states.update.waste_collection_schedule_update.attributes.release_url }} - von Version {{state_attr('update.waste_collection_schedule_update', 'installed_version')}} zu Version {{state_attr('update.waste_collection_schedule_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.deutscher_wetterdienst_update.state == "on" %}
                  {{ states.update.deutscher_wetterdienst_update.attributes.friendly_name }} Changelog: {{ states.update.deutscher_wetterdienst_update.attributes.release_url }} - von Version {{state_attr('update.deutscher_wetterdienst_update', 'installed_version')}} zu Version {{state_attr('update.deutscher_wetterdienst_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.foodsharing_de_update.state == "on" %}
                  {{ states.update.foodsharing_de_update.attributes.friendly_name }} Changelog: {{ states.update.foodsharing_de_update.attributes.release_url }} - von Version {{state_attr('update.foodsharing_de_update', 'installed_version')}} zu Version {{state_attr('update.foodsharing_de_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.google_home_update.state == "on" %}
                  {{ states.update.google_home_update.attributes.friendly_name }} Changelog: {{ states.update.google_home_update.attributes.release_url }} - von Version {{state_attr('update.google_home_update', 'installed_version')}} zu Version {{state_attr('update.google_home_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.hacs_update.state == "on" %}
                  {{ states.update.hacs_update.attributes.friendly_name }}  Changelog: {{ states.update.hacs_update.attributes.release_url }} - von Version {{state_attr('update.hacs_update', 'installed_version')}} zu Version {{state_attr('update.hacs_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.local_tuya_update.state == "on" %}
                  {{ states.update.local_tuya_update.attributes.friendly_name }} Changelog: {{ states.update.local_tuya_update.attributes.release_url }} - von Version {{state_attr('update.local_tuya_update', 'installed_version')}} zu Version {{state_attr('update.local_tuya_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.miwifi_update.state == "on" %}
                  {{ states.update.miwifi_update.attributes.friendly_name }} Changelog: {{ states.update.miwifi_update.attributes.release_url }} - von Version {{state_attr('update.miwifi_update', 'installed_version')}} zu Version {{state_attr('update.miwifi_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.rki_covid_numbers_update.state == "on" %}
                  {{ states.update.rki_covid_numbers_update.attributes.friendly_name }} Changelog: {{ states.update.rki_covid_numbers_update.attributes.release_url }} - von Version {{state_attr('update.rki_covid_numbers_update', 'installed_version')}} zu Version {{state_attr('update.rki_covid_numbers_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.ytube_music_player_update.state == "on" %}
                  {{ states.update.ytube_music_player_update.attributes.friendly_name }} Changelog: {{ states.update.ytube_music_player_update.attributes.release_url }} - von Version {{state_attr('update.ytube_music_player_update', 'installed_version')}} zu Version {{state_attr('update.ytube_music_player_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.office_365_integration_update.state == "on" %}
                  {{ states.update.office_365_integration_update.attributes.friendly_name }} Changelog: {{ states.update.office_365_integration_update.attributes.release_url }} - von Version {{state_attr('update.office_365_integration_update', 'installed_version')}} zu Version {{state_attr('update.office_365_integration_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.toogoodtogo_update.state == "on" %}
                  {{ states.update.toogoodtogo_update.attributes.friendly_name }} Changelog: {{ states.update.toogoodtogo_update.attributes.release_url }} - von Version {{state_attr('update.toogoodtogo_update', 'installed_version')}} zu Version {{state_attr('update.toogoodtogo_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.adaptive_lighting_update.state == "on" %}
                  {{ states.update.adaptive_lighting_update.attributes.friendly_name }} Changelog: {{ states.update.adaptive_lighting_update.attributes.release_url }} - von Version {{state_attr('update.adaptive_lighting_update', 'installed_version')}} zu Version {{state_attr('update.adaptive_lighting_update', 'latest_version')}}.
                  {% endif %}
                  {% if states.update.rewe_discounts_update.state == "on" %}
                  {{ states.update.rewe_discounts_update.attributes.friendly_name }} Changelog: {{ states.update.rewe_discounts_update.attributes.release_url }} - von Version {{state_attr('update.rewe_discounts_update', 'installed_version')}} zu Version {{state_attr('update.rewe_discounts_update', 'latest_version')}}.
                  {% endif %}
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.waste_collection_schedule_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.waste_collection_schedule_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.deutscher_wetterdienst_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.deutscher_wetterdienst_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.foodsharing_de_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.foodsharing_de_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.google_home_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.google_home_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.hacs_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.hacs_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.local_tuya_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.local_tuya_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.miwifi_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.miwifi_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.rki_covid_numbers_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.rki_covid_numbers_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.ytube_music_player_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.ytube_music_player_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.office_365_integration_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.office_365_integration_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.toogoodtogo_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.toogoodtogo_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.adaptive_lighting_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.adaptive_lighting_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.rewe_discounts_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.rewe_discounts_update
            - choose:
                - conditions:
                    - condition: state
                      entity_id: update.deutsche_bahn_update
                      state: "on"
                  sequence:
                    - service: update.install
                      data:
                        entity_id: update.deutsche_bahn_update
              # default:
              # - service: update.install
              # data:
              # entity_id: all
            - delay: "00:02:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: update.adguard_home_update
              state: "on"
            - condition: state
              entity_id: "input_boolean.abwesend_modus"
              state: "off"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  Adguard Home Update {{ states.update.adguard_home_update.attributes.latest_version }} wird nun installiert.

                  Changelog: {{ states.update.adguard_home_update.attributes.release_summary }}
            - service: update.install
              data:
                entity_id: update.adguard_home_update
            - delay: "00:02:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: update.home_assistant_supervisor_update
              state: "on"
          sequence:
            - service: update.install
              data:
                entity_id: update.home_assistant_supervisor_update
            - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: update.vaultwarden_bitwarden_update
              state: "on"
            - condition: state
              entity_id: "input_boolean.abwesend_modus"
              state: "off"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                disable_notification: true
                message: >
                  Vaultwarden Update {{ states.update.vaultwarden_bitwarden_update.attributes.latest_version }} wird nun installiert.

                  Changelog: {{ states.update.vaultwarden_bitwarden_update.attributes.release_summary }}
            - service: update.install
              data:
                entity_id: update.vaultwarden_bitwarden_update
            - delay: "00:02:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: update.fritz_box_3490_fritz_os
              state: "on"
            - condition: state
              entity_id: "input_boolean.abwesend_modus"
              state: "off"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  FritzBox Firmware Update {{ states.update.fritz_box_3490_fritz_os.attributes.latest_version }} wird nun installiert.

                  Changelog: {{ states.update.fritz_box_3490_fritz_os.attributes.release_url }}
            - service: update.install
              data:
                entity_id: update.fritz_box_3490_fritz_os
            - delay: "00:12:00"
    - choose:
        - conditions:
            - condition: state
              entity_id: update.home_assistant_core_update
              state: "on"
            - condition: state
              entity_id: "input_boolean.abwesend_modus"
              state: "off"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  Home Assistant {{ states.update.home_assistant_core_update.attributes.latest_version }} wird nun installiert.

                  Changelog HA: {{ states.update.home_assistant_core_update.attributes.release_url }}
            - service: hassio.addon_restart
              data:
                addon: a0d7b954-ssh
            - delay: "00:00:30"
            - service: update.install
              data:
                entity_id: update.home_assistant_core_update
        - conditions:
            - condition: state
              entity_id: update.home_assistant_operating_system_update
              state: "on"
            - condition: state
              entity_id: "input_boolean.abwesend_modus"
              state: "off"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  Home Assistant OS {{ states.update.home_assistant_operating_system_update.attributes.latest_version }} wird nun installiert.

                  Changelog OS: {{ states.update.home_assistant_operating_system_update.attributes.release_url }}
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: >
                  Raspberry Pi OS wird automatisch aktualisiert. Vaultwarden wird daher zeitweise nicht verfügbar sein für ungefähr 15 Minuten.
            - service: hassio.addon_restart
              data:
                addon: a0d7b954-ssh
            - delay: "00:00:30"
            - service: update.install
              data:
                entity_id: update.home_assistant_operating_system_update

# - id: incoming_call_fabian
#   alias: 'Incoming Call Fabian'
#   initial_state: true
#   trigger:
#     - platform: state
#       entity_id: automation.incoming_call_fabian
#       to: 'on'
#   condition:
#     - condition: state
#       entity_id: 'input_boolean.leiser_modus'
#       state: 'off'
#   action:
#     - service: media_player.volume_set
#       data:
#         volume_level: >
# {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
#         entity_id: media_player.wohnzimmer_uhr
#     - service: tts.google_say
#       entity_id:
#       - media_player.wohnzimmer_uhr
#       - media_player.schlafzimmer_speaker
#       data_template:
#         message: "Fabian wird soeben von {{ states('sensor.fs_caller') }} angerufen!"
#     - service: media_player.media_pause
#       data:
#         entity_id: media_player.wohnzimmer_tv
#     - delay: '00:00:09'
#     - service: media_player.volume_set
#       data:
#         volume_level: >
# {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
#         entity_id: media_player.wohnzimmer_uhr
#     - service: automation.turn_off
#       data:
#         entity_id: automation.incoming_call_fabian
#     - service: media_player.turn_off
#       data:
#         entity_id: media_player.wohnzimmer_uhr
#     - service: media_player.turn_off
#       data:
#         entity_id: media_player.schlafzimmer_speaker

# - id: incoming_call_nessie
#   alias: 'Incoming Call Nessie'
#   initial_state: true
#   trigger:
#     - platform: state
#       entity_id: automation.incoming_call_nessie
#       to: 'on'
#   condition:
#     - condition: state
#       entity_id: 'input_boolean.leiser_modus'
#       state: 'off'
#   action:
#     - service: media_player.volume_set
#       data:
#         volume_level: 0.7
#         entity_id: media_player.wohnzimmer_uhr
#     - service: tts.google_say
#       entity_id:
#       - media_player.wohnzimmer_uhr
#       - media_player.schlafzimmer_speaker
#       data:
#         message: 'Nessie wird soeben angerufen!'
#     - delay: '00:00:10'
#     - service: media_player.volume_set
#       data:
#         volume_level: 0.3
#         entity_id: media_player.wohnzimmer_uhr
#     - service: automation.turn_off
#       data:
#         entity_id: automation.incoming_call_nessie
#     - service: media_player.turn_off
#       data:
#         entity_id: media_player.wohnzimmer_uhr
#     - service: media_player.turn_off
#       data:
#         entity_id: media_player.schlafzimmer_speaker

# not in use, as the attribute contains "EUR" which makes it unusable for numeric_state
#  - id: coinbase_balance_high
#    alias: 'Coinbase balance high'
#    initial_state: true
#    trigger:
#      - platform: template
#        value_template: {{ states.sensor.coinbase_btc_wallet.attributes.["Balance in native currency"] |replace(“EUR”,"")|replace(“ ”,"")|float| int > 220 }}
#      - platform: numeric_state
#        entity_id: sensor.coinbase_btc_wallet
#        attribute: "Balance in native currency"
#        above: 220
#    condition:
#      condition: and
#      conditions:
# Maximal einmal am Tag schreiben
#        - condition: template
#          value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.coinbase_balance_high.attributes.last_triggered) | int > 86400 }}"
#    action:
#      - service: telegram_bot.send_message
#        data_template:
#          target: !secret telegram_chat_fabian
#          message: 'Aktueller Bitcoin Wert ist hoch: {{ states.sensor.coinbase_btc_wallet.attributes.["Balance in native currency"] }} .'

- id: dwd_weather_warnings
  alias: "DWD Weather Warnings"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.dwd_weather_warnings_current_warning_level
      above: 1
  condition:
    condition: and
    conditions:
      # Maximal zwei mal am Tag schreiben
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.dwd_weather_warnings.attributes.last_triggered) | int > 43200 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "2"
            - condition: numeric_state
              entity_id: proximity.home_fabian
              below: 20
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                disable_notification: true
                message: >
                  Aktuell Wetterwarnung vor markantem Wetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "2"
            - condition: numeric_state
              entity_id: proximity.home_nessie
              below: 20
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                disable_notification: true
                message: >
                  Aktuell Wetterwarnung vor markantem Wetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "2"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_jutta
                disable_notification: true
                message: >
                  Aktuell Wetterwarnung vor markantem Wetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "3"
            - condition: numeric_state
              entity_id: proximity.home_fabian
              below: 20
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  Aktuell Wetterwarnung vor Unwetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "3"
            - condition: numeric_state
              entity_id: proximity.home_nessie
              below: 20
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                message: >
                  Aktuell Wetterwarnung vor Unwetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "3"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_jutta
                message: >
                  Aktuell Wetterwarnung vor Unwetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "4"
            - condition: numeric_state
              entity_id: proximity.home_fabian
              below: 20
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_fabian
                message: >
                  ACHTUNG!!!! Aktuell Wetterwarnung vor extremen Unwetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}
                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "4"
            - condition: numeric_state
              entity_id: proximity.home_nessie
              below: 20
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_nessie
                message: >
                  ACHTUNG!!!! Aktuell Wetterwarnung vor extremen Unwetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}

                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.dwd_weather_warnings_current_warning_level
              state: "4"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_jutta
                message: >
                  ACHTUNG!!!! Aktuell Wetterwarnung vor extremen Unwetter in {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.region_name }}.
                  *{{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_headline }}*
                  {{ states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_description }}

                  Voraussichtlich ab {{  states.sensor.dwd_weather_warnings_current_warning_level.attributes.warning_1_end }} Uhr.

- id: server_temp_warning
  alias: "Server Temp Warning"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.processor_temperature
      above: 60
    - platform: numeric_state
      entity_id: sensor.processor_temperature
      above: 76
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.server_temp_warning.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "ACHTUNG! Server Temperatur sehr hoch: {{ states.sensor.processor_temperature.state }}"

- id: server_ram_load_warning
  alias: "Server RAM Load Warning"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.memory_use_percent
      above: 85
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.raspberrypi_ram_load_warning.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "ACHTUNG! Server RAM Auslastung sehr hoch: {{ states.sensor.memory_use_percent.state }}"

- id: turn_on_schloss_on_button_press
  alias: Turn on Schloss on button press
  initial_state: true
  trigger:
    - platform: state
      entity_id: input_button.schloss
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.schloss

- id: turn_schloss_off_after_turning_on
  alias: Turn Schloss off after turning on
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.schloss
      to: "on"
  action:
    - delay: "00:00:01"
    - service: switch.turn_off
      data:
        entity_id: switch.schloss

- id: nessie_phone_battery_low
  alias: Nessie Phone Battery low
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.nessie_iphone_battery_state
      below: 5
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.nessie_phone_battery_low.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        title: "Nessie Akku unter 5%"
        target: !secret telegram_chat_fabian
        message: ""

- id: fabi_phone_battery_low
  alias: Fabi Phone Battery low
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.fabian_iphone_battery_state
      below: 5
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.fabi_phone_battery_low.attributes.last_triggered) | int > 3600 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        title: "Fabi Akku unter 5%"
        target: !secret telegram_chat_nessie
        message: ""

- id: mute_cast_spotify_ads
  alias: Mute Cast Spotify ads
  initial_state: false
  mode: single
  trigger:
    - platform: state
      entity_id:
        - media_player.wohnzimmer_uhr
        - media_player.kuche_speaker
        - media_player.schlafzimmer_speaker
        - media_player.gastezimmer_mini
        - media_player.wohnzimmer_tv_cast
        - media_player.mini_gruppe
        - media_player.keller_tv_cast
      attribute: media_title
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.wohnzimmer_uhr
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.wohnzimmer_uhr
                is_volume_muted: false
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.kuche_speaker
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.kuche_speaker
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.kuche_speaker
                is_volume_muted: false
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.schlafzimmer_speaker
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.schlafzimmer_speaker
                is_volume_muted: false
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.gastezimmer_mini
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.gastezimmer_mini
                is_volume_muted: false
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv_cast
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv_cast
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.wohnzimmer_tv_cast
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.wohnzimmer_tv_cast
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_tv_cast
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.wohnzimmer_tv_cast
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.wohnzimmer_tv_cast
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.wohnzimmer_tv_cast
                is_volume_muted: false
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.mini_gruppe
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.mini_gruppe
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.mini_gruppe
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.mini_gruppe
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.mini_gruppe
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.mini_gruppe
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.mini_gruppe
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.mini_gruppe
                is_volume_muted: false
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv_cast
                  attribute: is_volume_muted
                  state: "false"
            - condition: or
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv_cast
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.keller_tv_cast
                  attribute: media_title
                  state: "Advertisement"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.keller_tv_cast
                is_volume_muted: true
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv_cast
                  attribute: media_title
                  state: "Advertisement"
                - condition: state
                  entity_id: media_player.keller_tv_cast
                  attribute: media_title
                  state: "Spotify"
                - condition: state
                  entity_id: media_player.keller_tv_cast
                  attribute: is_volume_muted
                  state: "true"
          sequence:
            - service: media_player.volume_mute
              data:
                entity_id: media_player.keller_tv_cast
                is_volume_muted: false

- id: turn_off_devices_after_power_loss
  alias: Turn off devices after power loss
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - light.bett_gluhbirne
      from: "unavailable"
      to: "on"
  action:
    - service: light.turn_on
      data:
        entity_id:
          - light.bett_gluhbirne

- id: low_battery_thermostats
  alias: Low battery thermostats
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.bad_battery_state
        - binary_sensor.schlafzimmer_battery_state
      from: "off"
      to: "on"
    - platform: state
      entity_id:
        - climate.wohnzimmer
        - climate.gastezimmer
      to: "unavailable"
      for:
        hours: 2
  condition:
    condition: not
    conditions:
      - condition: state
        entity_id: climate.bad
        state: "unavailable"
      - condition: state
        entity_id: climate.schlafzimmer
        state: "unavailable"
  action:
    - service: notify.telegram_fabian
      data_template:
        message: >
          Die Batterie im Thermostat
          {% if is_state('climate.wohnzimmer', 'unavailable') %}
          Wohnzimmer
          {% endif %}
          {% if is_state('climate.gastezimmer', 'unavailable') %}
          Gästezimmer
          {% endif %}
          {% if is_state('binary_sensor.schlafzimmer_battery_state', 'on') %}
          Schlafzimmer
          {% endif %}
          {% if is_state('binary_sensor.bad_battery_state', 'on') %}
          Bad
          {% endif %}
          ist
          {% if is_state('binary_sensor.schlafzimmer_battery_state', 'on') or is_state('binary_sensor.bad_battery_state', 'on') %}
          bald
          {% else %}
          KOMPLETT
          {% endif %}
          leer. Bitte auswechseln! Luftfeuchtigkeitsautomationen funktionieren so lange nur eingeschränkt.
    - service: notify.telegram_nessie
      data_template:
        message: >
          Die Batterie im Thermostat
          {% if is_state('climate.wohnzimmer', 'unavailable') %}
          Wohnzimmer
          {% endif %}
          {% if is_state('climate.gastezimmer', 'unavailable') %}
          Gästezimmer
          {% endif %}
          {% if is_state('binary_sensor.schlafzimmer_battery_state', 'on') %}
          Schlafzimmer
          {% endif %}
          {% if is_state('binary_sensor.bad_battery_state', 'on') %}
          Bad
          {% endif %}
          ist
          {% if is_state('binary_sensor.schlafzimmer_battery_state', 'on') or is_state('binary_sensor.bad_battery_state', 'on') %}
          bald
          {% else %}
          KOMPLETT
          {% endif %}
          leer. Bitte auswechseln! Luftfeuchtigkeitsautomationen funktionieren so lange nur eingeschränkt.

- id: cast_ha_to_tv_if_idle
  alias: Cast HA to TV if idleing
  trigger:
    - platform: state
      entity_id: media_player.wohnzimmer_tv
      to:
        - "idle"
        - "standby"
      for:
        minutes: 3
  action:
    service: cast.show_lovelace_view
    data:
      entity_id: media_player.wohnzimmer_tv_cast
      view_path: cast

- id: fritzbox_public_ip_change
  alias: Fritzbox Public IP Change
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.fritz_box_3490_external_ip
      not_from:
        - "unavailable"
        - "unknown"
        - ""
        - "Unknown"
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.fritzbox_no_internet_access.attributes.last_triggered) | int > 360 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.fritz_box_3490_external_ip
          state: unavailable
  action:
    - service: notify.telegram_fabian
      data:
        message: "Öffentliche IP hat sich geändert zu {{ states.sensor.fritz_box_3490_external_ip.state }}"

#  - id: turn_on_fritzbox_wifi_if_miwifi_is_off
#    alias: Turn on Fritzbox Wifi if Miwifi is off
#    initial_state: true
#    trigger:
#      - platform: state
#        entity_id: sbinary_sensor.xiaomi_abd8_wan_state
#        state: "not_connected"
#      - platform: template
#        value_template: "{{ if not is_state('sbinary_sensor.xiaomi_abd8_wan_state', 'connected'}}"
#    condition:
#      - condition: template
#        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.turn_on_fritzbox_wifi_if_miwifi_is_off.attributes.last_triggered) | int > 360 }}"
#      - condition: not
#        conditions:
#          - condition: state
#            entity_id: 'binary_sensor.fritz_box_3490_connection'
#            state: 'not_connected'
#    action:
#      - service: notify.telegram_fabian
#        data:
#          message: 'Miwifi hat kein Internet'

- id: fritzbox_no_internet_access
  alias: Fritzbox no Internet access
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.fritz_box_3490_connection
      from: "Connected"
      to: "Not_Connected"
      for:
        seconds: 15
  condition:
    condition: and
    conditions:
      - condition: time
        after: "10:30:00"
        before: "22:30:00"
      - condition: state
        entity_id: "input_boolean.leiser_modus"
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: person.nessie
            state: home
          - condition: state
            entity_id: person.fabian
            state: home
          - condition: template
            value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.fritzbox_no_internet_access.attributes.last_triggered) | int > 1200 }}"
  action:
    # - service: rest_command.assistant_broadcast
    #   data:
    #     command: Die Fritzbox hat keine Internet Verbindung und wird nun neugestartet.
    #     user: "homeassistant"
    - service: tts.google_say
      entity_id:
        - media_player.schlafzimmer_speaker
        - media_player.wohnzimmer_uhr
        - media_player.kuche_speaker
        - media_player.gastezimmer_mini
      data:
        message: "Die Fritzbox hat keine Internet Verbindung und wird nun neugestartet."
    - service: fritz.reboot
      data:
        host: 192.168.178.1
    - service: automation.turn_on
      data:
        entity_id: automation.fritzbox_internet_access_returned
    - service: automation.turn_off
      data:
        entity_id: automation.fritzbox_no_internet_access

- id: fritzbox_internet_access_returned
  alias: Fritzbox Internet access returned
  initial_state: false
  trigger:
    - platform: state
      entity_id: binary_sensor.fritz_box_3490_connection
      from: "Not_Connected"
      to: "Connected"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "10:30:00"
        before: "22:30:00"
      - condition: state
        entity_id: "input_boolean.leiser_modus"
        state: "off"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.nessie
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            # - service: rest_command.assistant_broadcast
            #   data:
            #     command: Die Internetverbindung ist wiederhergestellt.
            #     user: "homeassistant"
            - service: tts.google_say
              entity_id:
                - media_player.schlafzimmer_speaker
                - media_player.wohnzimmer_uhr
                - media_player.kuche_speaker
                - media_player.gastezimmer_mini
              data:
                message: "Die Internetverbindung ist wiederhergestellt."
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.nessie
                  state: home
                - condition: state
                  entity_id: person.fabian
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data:
                target: !secret telegram_chat_fabian
                message: "Die Fritzbox Internet Verbundung wurde verloren und wurde soeben wiederhergestellt."
    - service: automation.turn_on
      data:
        entity_id: automation.fritzbox_no_internet_access
    - service: automation.turn_off
      data:
        entity_id: automation.fritzbox_internet_access_returned

# - id: internet_speed_test_poor_fabian
#   alias: Internet Speed Test Poor Fabian
#
#   initial_state: true
#   trigger:
#     - platform: template
#       value_template: "{{ states('sensor.speedtest_download')|float < 40 }}"
#   condition:
#     - condition: template
#       value_template: "{{ states.device_tracker.google_maps_112174659110860535869.state == 'home' }}"
#   action:
#     - service: notify.telegram_fabian
#       data:
#         message: 'Die Internetgeschwindigkeit ist aktuell langsam ( {{ states.sensor.speedtest_download }} Mbit/s ). Eventuell die Fritzbox neustarten?'

# - id: internet_speed_test_poor_fabian
#   alias: Internet Speed Test Poor Nessie
#
#   initial_state: true
#   trigger:
#     - platform: template
#       value_template: "{{ states('sensor.speedtest_download')|float < 30 }}"
#   condition:
#     - condition: template
#       value_template: "{{ states.device_tracker.google_maps_112056758146194246561.state == 'home' }}"
#     - condition: state
#       entity_id: device_tracker.rgb_pc
#       state: home
#   action:
#     - service: notify.telegram_nessie
#       data:
#         message: 'Die Internetgeschwindigkeit ist aktuell langsam. Eventuell die Fritzbox neustarten?'

# - id: update_tasmota
#   alias: Update Tasmota
#   initial_state: true
#   trigger:
#     - platform: numeric_state
#       entity_id: sensor.latest_tasmota
#       above: 0
#   action:
#     - service: notify.telegram_fabian
#       data:
#         message: 'Alle Tasmota Geräte werden aktualisiert auf Version {{ states.sensor.latest_tasmota.state }}.'
#     - service: mqtt.publish
#       data:
#         topic: cmnd/tasmotas/Upgrade
#         payload: 1

- id: deckenlampe_button_hold
  alias: Deckenlampe Button Hold
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: d75263b1d81c803aac073abd2257aa2d
      type: button_long_press
      subtype: button_1
      discovery_id: 68C63A87B4BF_button_1_HOLD
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: "Light Livingroom"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_wohnzimmer
                  state: "off"
                - condition: state
                  entity_id: light.leds_wohnzimmer
                  state: "unavailable"
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.yeelight_color_0x36dc050
                  state: "off"
                - condition: state
                  entity_id: light.yeelight_color_0x36dc050
                  state: "unavailable"
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_wohnzimmer_tv
                  state: "off"
                - condition: state
                  entity_id: light.leds_wohnzimmer_tv
                  state: "unavailable"
          sequence:
            # - service: light.turn_off
            #   data:
            #     area_id: "{{ area_id('Wohnzimmer') }}"
            #     transition: 2
            #     brightness: 255
            - service: light.turn_on
              data:
                entity_id: light.yeelight_color_0x36dc050
                transition: 2
                brightness: 255
                color_temp: 225
            - service: light.turn_on
              data:
                entity_id: light.leds_wohnzimmer
                transition: 2
                brightness: 255
                rgb_color: [255, 255, 255]
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_wohnzimmer
                  state: "on"
                  for:
                    seconds: 1
                - condition: state
                  entity_id: light.yeelight_color_0x36dc050
                  state: "on"
                  for:
                    seconds: 1
                - condition: state
                  entity_id: light.leds_wohnzimmer_tv
                  state: "on"
                  for:
                    seconds: 1
          sequence:
            - service: light.turn_off
              data:
                area_id: "{{ area_id('Wohnzimmer') }}"

- id: deckenlampe_button_double_press
  alias: Deckenlampe Button double press
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: d75263b1d81c803aac073abd2257aa2d
      type: button_double_press
      subtype: button_1
      discovery_id: 68C63A87B4BF_button_1_DOUBLE
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "on"
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.fernseher
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "off"
          sequence:
            - service: switch.turn_on
              data:
                entity_id: switch.fernseher

- id: lichtschalter_button_hold
  alias: Lichtschalter Button Hold
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: 564e0bea23153d99c590e8fe2ef83464
      type: button_long_press
      subtype: button_1
      discovery_id: 68C63AA72808_button_1_HOLD
    - platform: event
      event_type: ios.action_fired
      event_data:
        actionName: "Light Sleepingroom"
  action:
    - choose:
        - conditions:
            - condition: and
              conditions:
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.bett_gluhbirne
                      state: "off"
                    - condition: state
                      entity_id: light.bett_gluhbirne
                      state: "unavailable"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.yeelight_bslamp2_0x13fea10f
                      state: "off"
                    - condition: state
                      entity_id: light.yeelight_bslamp2_0x13fea10f
                      state: "unavailable"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.leds_tisch
                      state: "off"
                    - condition: state
                      entity_id: light.leds_tisch
                      state: "unavailable"
                - condition: or
                  conditions:
                    - condition: state
                      entity_id: light.regal
                      state: "off"
                    - condition: state
                      entity_id: light.regal
                      state: "unavailable"
          sequence:
            - service: light.turn_on
              data:
                entity_id:
                  - light.leds_tisch
                brightness: 255
                transition: 2
            - service: light.turn_on
              data:
                entity_id:
                  - light.bett_gluhbirne
                  - light.yeelight_bslamp2_0x13fea10f
                brightness: 255
                color_temp: 225
                transition: 2
            - service: light.turn_on
              entity_id: light.regal
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: light.leds_tisch
                  state: "on"
                  for:
                    seconds: 1
                - condition: state
                  entity_id: light.bett_gluhbirne
                  state: "on"
                  for:
                    seconds: 1
                - condition: state
                  entity_id: light.regal
                  state: "on"
                  for:
                    seconds: 1
                - condition: state
                  entity_id: light.yeelight_bslamp2_0x13fea10f
                  state: "on"
                  for:
                    seconds: 1
          sequence:
            - service: light.turn_off
              data:
                area_id:
                  - "{{ area_id('Schlafzimmer') }}"

- id: lichtschalter_button_double_press
  alias: Lichtschalter Button double press
  initial_state: true
  trigger:
    - platform: device
      domain: tasmota
      device_id: 564e0bea23153d99c590e8fe2ef83464
      type: button_double_press
      subtype: button_1
      discovery_id: 68C63AA72808_button_1_DOUBLE
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "on"
          sequence:
            - service: switch.turn_off
              data:
                entity_id: switch.fabian_strom
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fabian_strom
              state: "off"
          sequence:
            - service: switch.turn_on
              data:
                entity_id: switch.fabian_strom

- id: restart_bluetooth_on_tv
  alias: Restart Bluetooth on TV
  initial_state: false
  trigger:
    - platform: state
      entity_id: automation.restart_bluetooth_on_tv
      to: "on"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.wohnzimmer_tv
        state: "home"
  action:
    - service: androidtv.adb_command
      data:
        entity_id: media_player.wohnzimmer_tv
        command: "settings put global bluetooth_disabled_profiles 0"
    - delay: "00:00:01"
    - service: androidtv.adb_command
      data:
        entity_id: media_player.wohnzimmer_tv
        command: "settings put global bluetooth_disabled_profiles 1"
    - service: automation.turn_off
      data:
        entity_id: automation.restart_bluetooth_on_tv

- id: notify_for_high_humidity
  alias: Notify for high humidity
  trigger:
    - platform: numeric_state
      entity_id:
        - climate.gastezimmer
        - climate.wohnzimmer
        - climate.schlafzimmer
        - climate.bad
      attribute: current_humidity
      above: 60
    - platform: state
      entity_id: person.fabian
      from: "not_home"
      to: "home"
      for:
        minutes: 3
    - platform: state
      entity_id: person.nessie
      from: "not_home"
      to: "home"
      for:
        minutes: 3
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.leiser_modus
        state: "off"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_for_high_humidity.attributes.last_triggered) | int > 7200 }}"
      - condition: not
        conditions:
          - condition: state
            entity_id: automation.notify_for_high_humidity
            attribute: last_triggered
            state: none
      - condition: or
        conditions:
          - condition: state
            entity_id: person.nessie
            state: home
          - condition: state
            entity_id: person.fabian
            state: home
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: climate.gastezimmer
            attribute: current_humidity
            above: 60
          - condition: numeric_state
            entity_id: climate.wohnzimmer
            attribute: current_humidity
            above: 60
          - condition: numeric_state
            entity_id: climate.schlafzimmer
            attribute: current_humidity
            above: 60
          - condition: numeric_state
            entity_id: climate.bad
            attribute: current_humidity
            above: 60
      - condition: or
        conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "on"
              - condition: time
                before: "21:30:00"
              - condition: time
                after: "08:00:00"
          - condition: and
            conditions:
              - condition: state
                entity_id: binary_sensor.workday_sensor
                state: "off"
              - condition: time
                before: "22:00:00"
              - condition: time
                after: "11:00:00"
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.kuche_speaker
                - delay: 00:00:02
                - service: tts.google_say
                  entity_id: media_player.kuche_speaker
                  data_template:
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie und Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zurück Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.gastezimmer.attributes.current_humidity) > 60 %}
                      Gästezimmer,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.schlafzimmer.attributes.current_humidity) > 60 %}
                      Schlafzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte lüften.
                - delay: 00:00:05
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.kuche_speaker
        - choose:
            - conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.schlafzimmer_speaker
                - delay: 00:00:02
                - service: tts.google_say
                  entity_id: media_player.schlafzimmer_speaker
                  data_template:
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie und Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zurück Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.gastezimmer.attributes.current_humidity) > 60 %}
                      Gästezimmer,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.schlafzimmer.attributes.current_humidity) > 60 %}
                      Schlafzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte lüften.
                - delay: 00:00:05
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.schlafzimmer_speaker
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.gast_modus
                  state: "off"
                - condition: state
                  entity_id: media_player.gastezimmer_mini
                  state: "off"
              sequence:
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.gastezimmer_mini
                - delay: 00:00:02
                - service: tts.google_say
                  entity_id: media_player.gastezimmer_mini
                  data_template:
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie und Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zurück Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.gastezimmer.attributes.current_humidity) > 60 %}
                      Gästezimmer,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.schlafzimmer.attributes.current_humidity) > 60 %}
                      Schlafzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte lüften.
                - delay: 00:00:05
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.gastezimmer_mini
        - choose:
            - conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "off"
                - condition: state
                  entity_id: media_player.wohnzimmer_tv
                  state: "unavailable"
              sequence:
                - service: media_player.volume_set
                  data_template:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                    entity_id: media_player.wohnzimmer_uhr
                - service: tts.google_say
                  entity_id: media_player.wohnzimmer_uhr
                  data_template:
                    message: >
                      {% if (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) and (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie und Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.fabian.last_changed) | int < 240) %}
                      Willkommen zurück Fabi.
                      {% elif (as_timestamp(now()) - as_timestamp(states.person.nessie.last_changed) | int < 240) %}
                      Willkommen zurück Nessie.
                      {% endif %}
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.gastezimmer.attributes.current_humidity) > 60 %}
                      Gästezimmer,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.schlafzimmer.attributes.current_humidity) > 60 %}
                      Schlafzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte lüften.
                - delay: 00:00:03
                - service: media_player.volume_set
                  data:
                    volume_level: >
                      {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                    entity_id: media_player.wohnzimmer_uhr
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: media_player.wohnzimmer_tv
                      state: "unavailable"
              sequence:
                - service: notify.wohnzimmer_tv
                  continue_on_error: true
                  data_template:
                    message: >
                      Die Luftfeuchtigkeit ist zu hoch im Raum
                      {% if (states.climate.gastezimmer.attributes.current_humidity) > 60 %}
                      Gästezimmer,
                      {% endif %}
                      {% if (states.climate.wohnzimmer.attributes.current_humidity) > 60 %}
                      Wohnzimmer,
                      {% endif %}
                      {% if (states.climate.schlafzimmer.attributes.current_humidity) > 60 %}
                      Schlafzimmer,
                      {% endif %}
                      {% if (states.climate.bad.attributes.current_humidity) > 60 %}
                      Bad,
                      {% endif %}
                      Bitte lüften.

- id: notify_for_extreme_high_humidity
  alias: Notify for extreme high humidity
  trigger:
    - platform: numeric_state
      entity_id:
        - climate.gastezimmer
        - climate.wohnzimmer
        - climate.schlafzimmer
        - climate.bad
      attribute: current_humidity
      above: 67
  condition:
    - condition: time
      after: "06:00:00"
    - condition: state
      entity_id: person.nessie
      state: not_home
    - condition: state
      entity_id: person.fabian
      state: not_home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_for_extreme_high_humidity.attributes.last_triggered) | int > 32400 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: >
          Achtung, sehr hohe Luftfeuchtigkeit.{% if (states.climate.gastezimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Gästezimmer{{ states.climate.gastezimmer.attributes.current_humidity }} %.{% endif %}
          {% if (states.climate.wohnzimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Wohnzimmer{{ states.climate.wohnzimmer.attributes.current_humidity }} %.{% endif %}
          {% if (states.climate.schlafzimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Schlafzimmer{{ states.climate.schlafzimmer.attributes.current_humidity }} %.{% endif %}
          {% if (states.climate.bad.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Bad{{ states.climate.bad.attributes.current_humidity }} %.{% endif %}
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: >
          Achtung, sehr hohe Luftfeuchtigkeit.{% if (states.climate.gastezimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Gästezimmer{{ states.climate.gastezimmer.attributes.current_humidity }} %.{% endif %}
          {% if (states.climate.wohnzimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Wohnzimmer{{ states.climate.wohnzimmer.attributes.current_humidity }} %.{% endif %}
          {% if (states.climate.schlafzimmer.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Schlafzimmer{{ states.climate.schlafzimmer.attributes.current_humidity }} %.{% endif %}
          {% if (states.climate.bad.attributes.current_humidity) > 67 %} Luftfeuchtigkeit Bad{{ states.climate.bad.attributes.current_humidity }} %.{% endif %}

- id: detect_if_coal_lighter_is_currently_active
  alias: Detect if coal lighter is currently active
  initial_state: true
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 470
      below: 540
      for:
        seconds: 35
    - platform: state
      entity_id: switch.kohleanzunder
      to: "on"
      for:
        minutes: 2
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 1080 }}"
      - condition: state
        entity_id: switch.kohleanzunder
        state: "on"
      - condition: numeric_state
        entity_id: sensor.keller_steckdose_energy_power
        above: 420
        below: 570
  action:
    - service: automation.turn_off
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
          - automation.detect_if_pizzamaker_is_currently_active
    - choose:
        # IF 5 friends are there
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Kohleanzünder wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
        # ELSEIF only K&A are there
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: home
                - condition: state
                  entity_id: person.adri
                  state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: "Kohleanzünder wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
      # ELSE only notify fabian
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_fabian
            message: "Kohleanzünder wurde eingeschaltet."
            inline_keyboard:
              - "Dauer:/remaining_time"
    - delay: "00:09:00"
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Bitte Kohle wenden."
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: home
                - condition: state
                  entity_id: person.adri
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: "Bitte Kohle wenden."
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_fabian
            message: "Bitte Kohle wenden."
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: unavailable
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "pm clear com.tcl.videoplayer"
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/jonny_rozay_shisha_smoke.mp4 -t video/mp4"
            # - service: notify.keller_tv
            #   continue_on_error: true
            #   data:
            #     message: "Bitte Kohle wenden."
    - delay: "00:06:00"
    # - choose:
    #     - conditions:
    #         - condition: not
    #           conditions:
    #             - condition: state
    #               entity_id: media_player.keller_tv
    #               state: unavailable
    #       sequence:
    #         - service: notify.keller_tv
    #           continue_on_error: true
    #           data:
    #             message: "Der Eisschlauch kann schon mal geholt werden."
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Der Eisschlauch kann schon mal geholt werden."
    - delay: "00:02:00"
    - service: switch.turn_off
      data:
        entity_id: switch.kohleanzunder
    - delay: "00:01:00"
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: home
                - condition: state
                  entity_id: person.adri
                  state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_fabian
            message: "Die Kohle sollte fertig sein! Strom wurde ausgeschaltet."
    - service: automation.turn_on
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
          - automation.detect_if_pizzamaker_is_currently_active
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.keller_tv
                  state: unavailable
          sequence:
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "pm clear com.tcl.videoplayer"
            - service: androidtv.adb_command
              continue_on_error: true
              data:
                entity_id: media_player.keller_tv
                command: "am start -a android.intent.action.VIEW -d /sdcard/bitte_gib_mir_die_shisha.mp4 -t video/mp4"
            - service: notify.keller_tv
              continue_on_error: true
              data:
                message: "Die Kohle sollte fertig sein!"

- id: detect_if_pizzamaker_is_currently_active
  alias: Detect if pizzamaker is currently active
  initial_state: true
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 1100
      below: 1250
      for:
        seconds: 35
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_pizzamaker_is_currently_active.attributes.last_triggered) | int > 600 }}"
      - condition: state
        entity_id: switch.kohleanzunder
        state: "on"
  action:
    - service: automation.turn_off
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
          - automation.detect_if_coal_lighter_is_currently_active
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Der Pizzamaker wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: home
                - condition: state
                  entity_id: person.adri
                  state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: "Der Pizzamaker wurde eingeschaltet."
                inline_keyboard:
                  - "Dauer:/remaining_time"
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_fabian
            message: "Der Pizzamaker wurde eingeschaltet."
            inline_keyboard:
              - "Dauer:/remaining_time"
    - delay: "00:05:00"
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Das Gericht im Pizzamaker sollte fertig sein! Strom wird in 5 min ausgeschaltet."
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: home
                - condition: state
                  entity_id: person.adri
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: "Das Gericht im Pizzamaker sollte fertig sein! Strom wird in 5 min ausgeschaltet."
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_fabian
            message: "Das Gericht im Pizzamaker sollte fertig sein! Strom wird in 5 min ausgeschaltet."
    - service: automation.turn_on
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
          - automation.detect_if_coal_lighter_is_currently_active
    - service: androidtv.adb_command
      data:
        entity_id: media_player.keller_tv
        command: "pm clear com.tcl.videoplayer"
    - service: androidtv.adb_command
      data:
        entity_id: media_player.keller_tv
        command: "am start -a android.intent.action.VIEW -d /sdcard/raab_pizza.mp4 -t video/mp4"
    - delay: "00:05:00"
    - service: switch.turn_off
      data:
        entity_id: switch.kohleanzunder

- id: check_if_coal_lighter_has_been_forgotten
  alias: Check if coal_lighter has been forgotten
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.kohleanzunder
      to: "on"
      for:
        minutes: 22
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int > 1260 }}"
      - condition: state
        entity_id: switch.kohleanzunder
        state: "on"
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_5friends
                message: "Der Kohleanzunder wurde vor 22 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
                inline_keyboard:
                  - "Dauer:/remaining_time"
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.kai
                  state: home
                - condition: state
                  entity_id: person.adri
                  state: home
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.flo
                  state: home
                - condition: state
                  entity_id: person.maxi
                  state: home
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_afk
                message: "Der Kohleanzunder wurde vor 22 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
                inline_keyboard:
                  - "Dauer:/remaining_time"
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_fabian
            message: "Der Kohleanzunder wurde vor 22 Minuten eingeschaltet aber die Automationen nicht gestartet. Ggf. Fehler und die Kohle ist fertig."
            inline_keyboard:
              - "Dauer:/remaining_time"

- id: check_if_washing_machine_has_been_forgotten
  alias: Check if washing machine has been forgotten
  initial_state: true
  trigger:
    - platform: state
      entity_id: switch.waschmaschine
      to: "on"
      for:
        hours: 6
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int > 21650 }}"
      - condition: state
        entity_id: switch.waschmaschine
        state: "on"
  action:
    - service: notify.telegram_nessie
      data:
        message: "Die Waschmaschine wurde vor 6 Stunden eingeschaltet aber die Automation nicht gestartet. Fehler und Wäsche wurde vergessen?"
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine wurde vor 6 Stunden eingeschaltet aber die Automation nicht gestartet. Fehler und Wäsche wurde vergessen?"

- id: detect_if_washing_machine_is_currently_active
  alias: Detect if Washing machine is currently active
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 22
      below: 469
      for:
        seconds: 40
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 1800
      for:
        seconds: 5
    - platform: state
      entity_id: switch.waschmaschine
      to: "on"
      for:
        minutes: 8
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int > 3600 }}"
      - condition: state
        entity_id: switch.waschmaschine
        state: "on"
      - condition: numeric_state
        entity_id: sensor.keller_steckdose_energy_power
        above: 22
  action:
    - service: notify.telegram_nessie
      data:
        message: "Die Waschmaschine wurde gestartet. Wähle das Waschprogramm aus um eine Zeit zu erhalten, wann die Waschmaschine fertig ist:"
        data:
          inline_keyboard:
            - "30° PL:/washerstart30, 40° PL:/washerstart40, 40° Koch-Bunt:/washerstart40kb, 20° Fein:/washerstart20fw, 60° Koch-Bunt:/washerstart60kb"
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine wurde gestartet. Wähle das Waschprogramm aus um eine Zeit zu erhalten, wann die Waschmaschine fertig ist:"
        data:
          inline_keyboard:
            - "30° PL:/washerstart30, 40° PL:/washerstart40, 40° Koch-Bunt:/washerstart40kb, 20° Fein:/washerstart20fw, 60° Koch-Bunt:/washerstart60kb"
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Running
    - service: automation.turn_on
      data:
        entity_id:
          - automation.set_washing_machine_active_when_power_detected
          - automation.set_washing_machine_clean_when_power_drops
    - service: automation.turn_off
      data:
        entity_id:
          - automation.detect_if_coal_lighter_is_currently_active
          - automation.detect_if_pizzamaker_is_currently_active
          - automation.detect_if_washing_machine_is_currently_active

- id: set_washing_machine_active_when_power_detected
  alias: Set washing machine active when power detected
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      above: 22
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: sensor.washing_machine_state
        state: Idle
      - condition: state
        entity_id: sensor.washing_machine_state
        state: Clean
      - condition: state
        entity_id: sensor.washing_machine_state
        state: Finishing
      # - condition: template
      #   value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 50 }}"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Running

# When the power drops, move the state of the washing machine to Clean
- id: set_washing_machine_clean_when_power_drops
  alias: Set washing machine clean when power drops
  trigger:
    - platform: numeric_state
      entity_id: sensor.keller_steckdose_energy_power
      below: 6
      for:
        minutes: 2
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_select.washing_machine_status
        state: Running
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.detect_if_coal_lighter_is_currently_active.attributes.last_triggered) | int > 900 }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.set_washing_machine_active_when_power_detected.attributes.last_triggered) | int > 1020 }}"
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Clean
    - service: notify.telegram_nessie
      data:
        message: "Die Waschmaschine ist fertig."
    - service: notify.telegram_fabian
      data:
        message: "Die Waschmaschine ist fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "playing"
          sequence:
            - service: tts.google_say
              entity_id: media_player.wohnzimmer_uhr
              data:
                message: "Die Waschmaschine ist fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.kuche_speaker
                  state: "playing"
          sequence:
            - service: tts.google_say
              entity_id: media_player.kuche_speaker
              data:
                message: "Die Waschmaschine ist fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.schlafzimmer_speaker
                  state: "playing"
          sequence:
            - service: tts.google_say
              entity_id: media_player.schlafzimmer_speaker
              data:
                message: "Die Waschmaschine ist fertig."
    - service: automation.turn_on
      data:
        entity_id:
          - automation.detect_if_washing_machine_is_currently_active
          - automation.detect_if_coal_lighter_is_currently_active
          - automation.detect_if_pizzamaker_is_currently_active
    - service: switch.turn_off
      data:
        entity_id: switch.waschmaschine
    - service: automation.turn_off
      data:
        entity_id: automation.set_washing_machine_clean_when_power_drops

- id: set_washing_machine_idle_after_timeout
  alias: Set washing machine idle after timeout
  trigger:
    - platform: state
      entity_id: input_select.washing_machine_status
      to: Clean
      for:
        minutes: 120
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.washing_machine_status
        option: Idle

- id: resume_music_in_keller_after_shisha_video
  alias: Resume music in keller after shisha video
  initial_state: true
  trigger:
    - platform: state
      entity_id: media_player.keller_tv
      attribute: app_id
      from: com.tcl.videoplayer
  action:
    - service: media_player.media_play
      data:
        entity_id: media_player.keller_tv

- id: remind_for_finished_rice_cooker
  alias: Remind for finished rice cooker
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.xiaomi_miio_cooker_remaining
      below: 5
  condition:
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_finished_rice_cooker.attributes.last_triggered) | int > 1200 }}"
  action:
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.nessie
                  state: "home"
          sequence:
            - service: notify.telegram_nessie
              data_template:
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
            - service: notify.telegram_fabian
              data_template:
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.leiser_modus
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: media_player.wohnzimmer_uhr
                  state: "playing"
            - condition: or
              conditions:
                - condition: state
                  entity_id: person.fabian
                  state: "home"
                - condition: state
                  entity_id: person.nessie
                  state: "home"
          sequence:
            - service: tts.google_say
              entity_id: media_player.wohnzimmer_uhr
              data_template:
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
            - service: tts.google_say
              entity_id: media_player.kuche_speaker
              data_template:
                message: "Der Reiskocher ist in {{ states.sensor.xiaomi_miio_cooker_remaining.state }} Minuten fertig."
    - service: input_select.select_option
      data:
        entity_id: input_select.rice_cooker_program
        option: schnelles Kochen

- id: turn_on_rice_cooker_when_timer_started
  alias: "Turn on rice cooker when timer started"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (states.input_datetime.cooker_start_time.attributes.timestamp) | round(-1) }}"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.xiaomi_miio_cooker
    - service: notify.telegram_nessie
      data_template:
        message: "Der Reiskocher wurde automatisch angeschaltet im Programm {{ states.input_select.rice_cooker_program.state }}."
    - service: notify.telegram_fabian
      data_template:
        message: "Der Reiskocher wurde automatisch angeschaltet im Programm {{ states.input_select.rice_cooker_program.state }}."

- id: set_rice_cooker_menu_state
  alias: "Set ricecooker menu state"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.xiaomi_miio_cooker_menu
      not_from:
        - "unavailable"
        - "unknown"
        - ""
        - "Unknown"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Fine Rice"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Kochen 1h"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Keep warm"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Wärmen"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Quick Rice"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "schnelles Kochen"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Congee"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Porridge"
    - choose:
        - conditions:
            - condition: state
              entity_id: sensor.xiaomi_miio_cooker_menu
              state: "Unknown menu"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.rice_cooker_program
                option: "Sonstiges"

- id: kitchen_timer_reminder
  alias: Kitchen Timer Reminder
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: sensor.kuche_speaker_timers
      below: 5
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: switch.fernseher
        state: "on"
      - condition: state
        entity_id: switch.fernseher_keller
        state: "on"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.fabian
              state: home
          sequence:
            - service: notify.telegram_fabian
              data:
                message: "Der Timer in der Küche ist in {{ states.sensor.kuche_speaker_timers.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Der Timer in der Küche ist in {{ states.sensor.kuche_speaker_timers.state }} Minuten fertig."
    - choose:
        - conditions:
            - condition: state
              entity_id: switch.fernseher
              state: "on"
          sequence:
            - service: tts.google_say
              entity_id: media_player.wohnzimmer_uhr
              data:
                message: "Der Timer in der Küche ist in {{ states.sensor.kuche_speaker_timers.state }} Minuten fertig."

#  - id: turn_on_airplane_mode_fabi
#    alias: 'Turn on Airplane Mode Fabi'
#    initial_state: true
#    trigger:
#      - platform: time
#        at: '23:30:00'
#      - platform: time
#        at: '03:30:00'
#    condition:
#      condition: and
#      conditions:
#        - condition: time
#          weekday:
#            - mon
#            - tue
#            - wed
#            - thu
#            - sun
#        - condition: state
#          entity_id: device_tracker.fabian_iphone_2
#          state: home
#        - condition: template
#          value_template: >
#            {% set domain = 'light' %}
#            {% set state = 'off' %}
#            {{ states[domain] | count == states[domain] | selectattr('state','eq', state) | list | count }}
#    action:
#      - service: notify.mobile_app_fabian_iphone
#        data_template:
#          title: "Flugmodus"
#          message: "Flugmodus wurde vergessen und wird nun automatisch aktiviert!"
#        data:
#          data:
#            tag: 'notification-about-sensor'

- id: check_termostat_sleepingroom
  alias: "check thermostats"
  initial_state: true
  trigger:
    platform: time
    at: "19:40:00"
  action:
    - service: switch.turn_on
      data:
        entity_id: switch.adaptive_lighting_sleeping_room
    - choose:
        - conditions:
            - condition: state
              entity_id: "input_boolean.thermostate_aus"
              state: "off"
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.schlafzimmer
                  state: "auto"
                - condition: state
                  entity_id: device_tracker.fabian_pc
                  state: "home"
          sequence:
            # - service: notify.telegram_fabian
            #   data:
            #     message: "Das Thermostat im Schlafzimmer war noch auf {{ states.climate.schlafzimmer.attributes.temperature }} °C eingestellt und wurde nun automatisch eingeschaltet."
            - service: climate.set_hvac_mode
              data:
                entity_id: climate.schlafzimmer
                hvac_mode: auto

- id: pill_reminder
  alias: "Pill Reminder"
  trigger:
    platform: time
    at: "19:50:00"
  action:
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: "29"
          sequence:
            - service: counter.increment
              target:
                entity_id: counter.pille
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: 30
              above: 28
          sequence:
            - service: counter.reset
              target:
                entity_id: counter.pille
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: "21"
          sequence:
            - service: notify.telegram_nessie
              data_template:
                message: "Pille nehmen nicht vergessen! Heute ist Tag {{ states.counter.pille.state }} von {{ (states.counter.pille.attributes.maximum) - 1 }}."
                data:
                  inline_keyboard:
                    - "Erledigt:/pilldone, Erinnern in 1h:/pill1h"
            - service: notify.mobile_app_nessie_iphone
              data_template:
                title: "Pillen Reminder"
                message: "Pille nehmen nicht vergessen! Heute ist Tag {{ states.counter.pille.state }} von {{ (states.counter.pille.attributes.maximum) - 1 }}."
                data:
                  actions:
                    - action: "pilldone"
                      title: "Erledigt"
                    - action: "pill1h"
                      title: "Erinnern in 1h"
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1
    - choose:
        - conditions:
            - condition: numeric_state
              entity_id: counter.pille
              below: 22
              above: 20
          sequence:
            - service: notify.telegram_nessie
              data:
                message: "Pille nehmen nicht vergessen! Heute ist der letze Tag, an dem du die Pille nehmen musst. Ab morgen kommen für 7 Tage keine Erinnerungen."
                data:
                  inline_keyboard:
                    - "Erledigt:/pilldone, Erinnern in 1h:/pill1h, Durchnehmen:/pillreset"
            - service: notify.telegram_fabian
              data:
                message: "Heute ist der letze Tag, an dem Nessie die Pille nimmt für 7 Tage."
            - service: notify.mobile_app_nessie_iphone
              data_template:
                title: "Pillen Reminder"
                message: "Pille nehmen nicht vergessen! Heute ist der letze Tag, an dem du die Pille nehmen musst. Ab morgen kommen für 7 Tage keine Erinnerungen."
                data:
                  actions:
                    - action: "pilldone"
                      title: "Erledigt"
                    - action: "pill1h"
                      title: "Erinnern in 1h"
                  push:
                    sound:
                      name: "default"
                      critical: 1
                      volume: 0.1

- id: nessie_forgot_pill
  alias: "Nessie forgot pill"
  initial_state: true
  trigger:
    - platform: time
      at: "23:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - sun
      - condition: not
        conditions:
          - condition: state
            entity_id: automation.telegram_pill_marked_done
            attribute: last_triggered
            state: none
      - condition: numeric_state
        entity_id: counter.pille
        below: "22"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_pill_marked_done.attributes.last_triggered) | int > 10800 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
          sequence:
            - service: tts.google_say
              entity_id: media_player.schlafzimmer_speaker
              data:
                message: "Nessie, du hast die Pille vergessen"
    - service: notify.telegram_nessie
      data:
        message: "Du hast die Pille vergessen!"
    - service: notify.mobile_app_nessie_iphone
      data:
        message: "Du hast die Pille vergessen!"
        data:
          push:
            sound:
              name: "default"
              critical: 1
              volume: 1.0

- id: nessie_forgot_pill_weekend
  alias: "Nessie forgot pill weekend"
  initial_state: true
  trigger:
    - platform: time
      at: "00:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - fri
          - sat
      - condition: not
        conditions:
          - condition: state
            entity_id: automation.telegram_pill_marked_done
            attribute: last_triggered
            state: none
      - condition: numeric_state
        entity_id: counter.pille
        below: 22
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_pill_marked_done.attributes.last_triggered) | int > 14760 }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: person.nessie
              state: home
          sequence:
            - service: tts.google_say
              entity_id: media_player.schlafzimmer_speaker
              data:
                message: "Nessie, du hast die Pille vergessen"
    - service: notify.telegram_nessie
      data:
        message: "Du hast die Pille vergessen!"
    - service: notify.mobile_app_nessie_iphone
      data:
        message: "Du hast die Pille vergessen!"
        data:
          push:
            sound:
              name: "default"
              critical: 1
              volume: 1.0

- id: tagliche_essensvorschlage
  alias: "Tagliche Essensvorschlage"
  initial_state: false
  trigger:
    platform: time
    at: "16:00:00"
  action:
    - service: shell_command.randomfood
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Gericht heute zubereiten?"
        disable_notification: true
        inline_keyboard:
          - "Ja:/foodyes, Nein:/telegramno"
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: "Gericht heute zubereiten?"
        disable_notification: true
        inline_keyboard:
          - "Ja:/foodyes, Nein:/foodno"

- id: turn_off_everything_in_keller_if_tv_is_unavailable
  alias: Turn off everything in keller if tv is unavailable
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    to: "unavailable"
    for:
      minutes: 10
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: switch.fernseher_keller
        state: "off"
      - condition: state
        entity_id: switch.strom_keller
        state: "off"
  action:
    - service: switch.turn_off
      data:
        entity_id: switch.kuhlschrank
    - service: switch.turn_off
      data:
        entity_id: switch.keller_usb_ports

- id: remind_for_light_keller
  alias: Remind for light keller
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    from: "unavailable"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "17:00:00"
        before: "00:00:00"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_light_keller.attributes.last_triggered) | int > 12000 }}"
      - condition: or
        conditions:
          - condition: state
            entity_id: group.schlafzimmer
            state: "on"
          - condition: state
            entity_id: group.wohnzimmer
            state: "on"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: >
          Es ist noch Licht oder Strom an im
          {% if (is_state("group.schlafzimmer", "on")) -%}
          Schlafzimmer
          {% endif %}
          {% if (is_state("group.wohnzimmer", "on")) -%}
          Wohnzimmer
          {% endif %}
          {% if (is_state("group.gastezimmer", "on")) -%}
          & Gästezimmer
          {% endif %}
          . Ausschalten?

- id: set_climate_living_room_if_in_keller
  alias: Set climate living room if in keller
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    from: "unavailable"
  condition:
    condition: and
    conditions:
      - condition: time
        after: "17:00:00"
        before: "00:00:00"
  action:
    - service: climate.turn_off
      data:
        entity_id: climate.wohnzimmer

- id: set_climate_living_room_if_nessie_and_fabi_at_pc
  alias: Set climate living room if nessie and fabi at PC
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "home"
    - platform: state
      entity_id: device_tracker.rgb_pc
      to: "home"
    - platform: state
      entity_id: device_tracker.nsta0552
      to: "home"
    - platform: state
      entity_id: device_tracker.vku_lb_20
      to: "home"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "off"
      - condition: state
        entity_id: input_boolean.gast_modus
        state: "off"
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.fabian_pc
            state: "home"
          - condition: state
            entity_id: device_tracker.nsta0552
            state: "home"
          - condition: not
            conditions:
              - condition: state
                entity_id: person.fabian
                state: "home"
      - condition: or
        conditions:
          - condition: state
            entity_id: "switch.nessie_pc"
            state: "on"
          - condition: not
            conditions:
              - condition: state
                entity_id: person.nessie
                state: "home"
  action:
    - service: climate.set_temperature
      data:
        entity_id: climate.wohnzimmer
        temperature: 16
        hvac_mode: heat
    - service: automation.turn_on
      data:
        entity_id: automation.set_climate_living_room_if_nessie_and_fabi_not_at_pc

- id: set_climate_living_room_if_nessie_and_fabi_not_at_pc
  alias: Set climate living room if nessie and fabi not at PC
  initial_state: false
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_pc
      to: "not_home"
    - platform: state
      entity_id: device_tracker.rgb_pc
      to: "not_home"
    - platform: state
      entity_id: device_tracker.nsta0552
      to: "not_home"
    - platform: state
      entity_id: switch.nessie_pc
      to: "off"
  condition:
    - condition: state
      entity_id: "input_boolean.thermostate_aus"
      state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: auto
    - service: automation.turn_off
      data:
        entity_id: automation.set_climate_living_room_if_nessie_and_fabi_not_at_pc

- id: remind_for_guest_mode
  alias: remind for guest mode
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    to: "unavailable"
    for:
      minutes: 5
  condition:
    condition: and
    conditions:
      - condition: time
        after: "23:00:00"
        before: "06:00:00"
      - condition: state
        entity_id: "input_boolean.gast_modus"
        state: "off"
      - condition: not
        conditions:
          - condition: state
            entity_id: calendar.fabianseitz98_gmail_com
            attribute: message
            state: "Gruppentreffen"
  action:
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.gast_modus
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        message: "Übernachtet heute ein Gast? Gast Modus wurde automatisch eingeschaltet."
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        message: "Übernachtet heute ein Gast? Gast Modus wurde automatisch eingeschaltet."

- id: set_climate_living_room_if_keller_left
  alias: Set climate living room if keller left
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.keller_tv
    to: "unavailable"
    for:
      minutes: 10
  condition:
    condition: and
    conditions:
      - condition: time
        after: "17:00:00"
        before: "00:00:00"
      - condition: state
        entity_id: "input_boolean.thermostate_aus"
        state: "off"
  action:
    - service: climate.set_hvac_mode
      data:
        entity_id: climate.wohnzimmer
        hvac_mode: auto

- id: remind_for_checking_google_maps_ha_cookie
  alias: "Remind for checking google maps ha cookie"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.google_maps_112174659110860535869
      attribute: source_type
      to: null
      for:
        minutes: 30
    - platform: state
      entity_id: device_tracker.google_maps_112056758146194246561
      attribute: source_type
      to: null
      for:
        minutes: 30
  action:
    - service: notify.telegram_fabian
      data:
        message: "Der Google Maps Homeassistant Coockie scheint abgelaufen zu sein. Bitte erneuern. In der Zwischenzeit funktionieren keine Google Maps Automationen."

- id: notify_on_sbahn_delay_home_work
  alias: "Notify Fabi on sbahn delay Home -> Work"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: "sensor.zorneding_to_leuchtenbergring"
      attribute: delay
      above: 5
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: state
            entity_id: device_tracker.fabian_iphone_2
            state: home
          - condition: state
            entity_id: device_tracker.nessie_iphone_2
            state: home
      - condition: time
        after: "06:30:00"
        before: "07:10:00"
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.fabian_iphone_2
              state: home
          sequence:
            - service: notify.telegram_fabian
              data:
                title: "Sbahn um {{ states.sensor.zorneding_to_leuchtenbergring.attributes.departure }} hat +{{ states.sensor.zorneding_to_leuchtenbergring.attributes.delay }} min Verspätung."
                message: "Nächste Sbahn: {{ states.sensor.zorneding_to_leuchtenbergring.attributes.next }} Uhr"
    - choose:
        - conditions:
            - condition: state
              entity_id: device_tracker.nessie_iphone_2
              state: home
          sequence:
            - service: notify.telegram_nessie
              data:
                title: "Sbahn um {{ states.sensor.zorneding_to_leuchtenbergring.attributes.departure }} hat +{{ states.sensor.zorneding_to_leuchtenbergring.attributes.delay }} min Verspätung."
                message: "Nächste Sbahn: {{ states.sensor.zorneding_to_leuchtenbergring.attributes.next }} Uhr"

- id: notify_fabian_on_sbahn_delay_work_home
  alias: "Notify on Sbahn delay Work -> Home"
  initial_state: true
  trigger:
    - platform: numeric_state
      entity_id: "sensor.starnberg_nord_to_zorneding"
      attribute: delay
      above: 3
  condition:
    condition: and
    conditions:
      - condition: time
        after: "16:45:00"
        before: "17:30:00"
        weekday:
          - mon
          - tue
          - wed
          - thu
      - condition: state
        entity_id: binary_sensor.workday_sensor
        state: "on"
      - condition: numeric_state
        entity_id: proximity.home_fabian
        below: 89
      - condition: numeric_state
        entity_id: proximity.home_fabian
        above: 20
      - condition: not
        conditions:
          - condition: state
            entity_id: person.fabian
            state: home
  action:
    - service: notify.telegram_fabian
      data:
        title: "Sbahn um {{ states.sensor.starnberg_nord_to_zorneding.attributes.departure }} Uhr nach Hause +{{ states.sensor.starnberg_nord_to_zorneding.attributes.delay }} min."
        message: "Nächste Sbahn: {{ states.sensor.starnberg_nord_to_zorneding.attributes.next }} Uhr"

- id: notify_on_sbahn_delay_work_nessie_home
  alias: "Notify on Sbahn delay Work Nessie -> Home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.nessie
      from: "Arbeit Nessie"
      to: "not_home"
  condition:
    - condition: numeric_state
      entity_id: "sensor.leuchtenbergring_to_zorneding"
      attribute: delay
      above: 3
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    - service: notify.telegram_nessie
      data:
        message: "Sbahn in Leuchtenbergring um {{ states.sensor.leuchtenbergring_to_zorneding.attributes.departure }} Uhr hat voraussichtlich {{ states.sensor.leuchtenbergring_to_zorneding.attributes.delay }} min Verspätung."

- id: notify_kai_adri_come_to_visit
  alias: "Notify Kai Adri come to visit"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_ka
      attribute: dir_of_travel
      to: "towards"
  condition:
    - condition: numeric_state
      entity_id: proximity.home_ka
      below: 7
    - condition: numeric_state
      entity_id: proximity.home_ka
      above: 1
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_kai_adri_come_to_visit.attributes.last_triggered) | int > 1800 }}"
    - condition: or
      conditions:
        - condition: not
          conditions:
            - condition: state
              entity_id: person.kai
              state: "Kai-Adri"
            - condition: state
              entity_id: person.adri
              state: "Kai-Adri"
    - condition: not
      conditions:
        - condition: and
          conditions:
            - condition: time
              after: "18:00:00"
              before: "22:30:00"
              weekday: sun
  action:
    - service: notify.telegram_fabian
      data_template:
        message: >
          {% if (not is_state("person.kai", "Kai-Adri")) -%}Kai {% endif %}{% if (not is_state("person.adri", "Kai-Adri")) -%} Adri{% endif %} ist auf dem Weg nach Zorneding und noch {{ states.proximity.home_ka.state }} km entfernt von zu Hause.

- id: notify_nessie_fabian_on_way_home
  alias: "Notify Nessie Fabian on way home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_fabian
      attribute: dir_of_travel
      to: "towards"
      for:
        minutes: 6
  condition:
    - condition: numeric_state
      entity_id: proximity.home_fabian
      above: 3
    - condition: numeric_state
      entity_id: proximity.home_fabian
      below: 30
    - condition: state
      entity_id: person.nessie
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_longer_distance.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_long_distance.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 3700 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "Arbeit Fabi"
  action:
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause und ist noch {{ states.proximity.home_fabian.state }} km entfernt von zu Hause."

- id: notify_nessie_fabian_on_way_home_longer_distance
  alias: "Notify Nessie Fabian on way home longer distance"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_fabian
      attribute: dir_of_travel
      to: "towards"
      for:
        minutes: 22
  condition:
    - condition: numeric_state
      entity_id: proximity.home_fabian
      above: 29
    - condition: numeric_state
      entity_id: proximity.home_fabian
      below: 90
    - condition: state
      entity_id: person.nessie
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_longer_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_long_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 4700 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "Arbeit Fabi"
  action:
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause und ist noch {{ states.proximity.home_fabian.state }} km entfernt von zu Hause."

- id: notify_nessie_fabian_on_way_home_long_distance
  alias: "Notify Nessie Fabian on way home long distance"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_fabian
      attribute: dir_of_travel
      to: "towards"
      for:
        minutes: 50
  condition:
    - condition: numeric_state
      entity_id: proximity.home_fabian
      above: 89
    - condition: state
      entity_id: person.nessie
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_longer_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_long_distance.attributes.last_triggered) | int > 4600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 4600 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.fabian
          state: "Arbeit Fabi"
  action:
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause und ist noch {{ states.proximity.home_fabian.state }} km entfernt von zu Hause."

- id: notify_fabian_nessie_on_way_home
  alias: "Notify Fabian Nessie on way home"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_nessie
      attribute: dir_of_travel
      to: "towards"
      for:
        minutes: 8
  condition:
    - condition: numeric_state
      entity_id: proximity.home_nessie
      above: 3
    - condition: numeric_state
      entity_id: proximity.home_nessie
      below: 30
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_longer_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_long_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_work.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_berufsschule.attributes.last_triggered) | int > 3600 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.nessie
          state: "arbeit_nessie"
        - condition: state
          entity_id: person.nessie
          state: "Arbeit Nessie"
        - condition: state
          entity_id: person.nessie
          state: "Berufsschule"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Nessie ist auf dem Weg nach Hause und ist noch {{ states.proximity.home_nessie.state }} km entfernt von zu Hause."

- id: notify_fabian_nessie_on_way_home_longer_distance
  alias: "Notify Fabian Nessie on way home longer distance"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_nessie
      attribute: dir_of_travel
      to: "towards"
      for:
        minutes: 15
  condition:
    - condition: numeric_state
      entity_id: proximity.home_nessie
      above: 29
    - condition: numeric_state
      entity_id: proximity.home_nessie
      below: 90
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_longer_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_long_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_work.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_berufsschule.attributes.last_triggered) | int > 3600 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.nessie
          state: "arbeit_nessie"
        - condition: state
          entity_id: person.nessie
          state: "Berufsschule"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Nessie ist auf dem Weg nach Hause und ist noch {{ states.proximity.home_nessie.state }} km entfernt von zu Hause."

- id: notify_fabian_nessie_on_way_home_long_distance
  alias: "Notify Fabian Nessie on way home long distance"
  initial_state: true
  trigger:
    - platform: state
      entity_id: proximity.home_nessie
      attribute: dir_of_travel
      to: "towards"
      for:
        minutes: 30
  condition:
    - condition: numeric_state
      entity_id: proximity.home_nessie
      above: 89
    - condition: state
      entity_id: person.fabian
      state: home
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_longer_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_long_distance.attributes.last_triggered) | int > 1800 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_work.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_berufsschule.attributes.last_triggered) | int > 3600 }}"
    - condition: not
      conditions:
        - condition: state
          entity_id: person.nessie
          state: "arbeit_nessie"
        - condition: state
          entity_id: person.nessie
          state: "Berufsschule"
  action:
    - service: notify.telegram_fabian
      data:
        message: "Nessie ist auf dem Weg nach Hause und ist noch {{ states.proximity.home_nessie.state }} km entfernt von zu Hause."

- id: notify_nessie_fabian_on_way_home_from_sta
  alias: "Notify Nessie Fabian on way home from STA"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_from_sta.attributes.last_triggered) | int > 3600 }}"
    - condition: numeric_state
      entity_id: proximity.home_nessie
      below: 35
    - condition: numeric_state
      entity_id: proximity.home_fabian
      above: 10
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.nessie
                  state: home
                - condition: state
                  entity_id:
                    - input_boolean.leiser_modus
                    - input_boolean.gast_modus
                  state: "off"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.kuche_speaker
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.kuche_speaker
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.kuche_speaker
                          data_template:
                            message: "Fabian ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.starnberg_nord_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.starnberg_nord_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.kuche_speaker
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.gastezimmer_mini
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.gastezimmer_mini
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.gastezimmer_mini
                          data_template:
                            message: "Fabian ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.starnberg_nord_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.starnberg_nord_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.gastezimmer_mini
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.wohnzimmer_uhr
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.wohnzimmer_uhr
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.wohnzimmer_uhr
                          data_template:
                            message: "Fabian ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.starnberg_nord_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.starnberg_nord_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.wohnzimmer_uhr
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause von Starnberg und kommt voraussichtlich um {{ states.sensor.starnberg_nord_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.starnberg_nord_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."

- id: notify_nessie_fabian_on_way_home_from_gil
  alias: "Notify Nessie Fabian on way home from GIL"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi GIL"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_nessie_fabian_on_way_home_from_gil.attributes.last_triggered) | int > 3600 }}"
    - condition: numeric_state
      entity_id: proximity.home_nessie
      below: 35
  action:
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause von Gilching und kommt voraussichtlich in 1,25 Stunden nach Hause."

- id: notify_nessie_fabian_on_way_home_from_muc
  alias: "Notify Nessie Fabian on way home from MUC"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi MUC"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: numeric_state
      entity_id: proximity.home_nessie
      below: 35
  action:
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause von Gräfelfing und kommt voraussichtlich in einer Stunde in Zorneding an."

- id: notify_nessie_fabian_on_way_home_from_whm
  alias: "Notify Nessie Fabian on way home from WHM"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.fabian
      from: "Arbeit Fabi WHM"
      to: "not_home"
  condition:
    - condition: time
      after: "14:00:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: numeric_state
      entity_id: proximity.home_nessie
      below: 35
  action:
    - service: notify.telegram_nessie
      data:
        message: "Fabian ist auf dem Weg nach Hause von Weilheim. Da er mit dem Auto fährt ist keine Zeitangabe möglich. Voraussichtlich daheim in ca. 1,5 Stunden."

- id: notify_fabian_nessie_on_way_home_from_work
  alias: "Notify Fabian Nessie on way home from work"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.nessie
      from: "Arbeit Nessie"
      to: "not_home"
  condition:
    - condition: time
      after: "13:15:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: numeric_state
      entity_id: proximity.home_fabian
      below: 35
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_work.attributes.last_triggered) | int > 3600 }}"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_berufsschule.attributes.last_triggered) | int > 3600 }}"
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: state
                  entity_id:
                    - input_boolean.leiser_modus
                    - input_boolean.gast_modus
                  state: "off"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.kuche_speaker
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.kuche_speaker
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.kuche_speaker
                          data_template:
                            message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.leuchtenbergring_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.leuchtenbergring_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.kuche_speaker
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.schlafzimmer_speaker
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.schlafzimmer_speaker
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.schlafzimmer_speaker
                          data_template:
                            message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.leuchtenbergring_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.leuchtenbergring_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.schlafzimmer_speaker
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.wohnzimmer_uhr
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.wohnzimmer_uhr
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.wohnzimmer_uhr
                          data_template:
                            message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.leuchtenbergring_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.leuchtenbergring_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:08
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.wohnzimmer_uhr
    - service: notify.telegram_fabian
      data:
        message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.leuchtenbergring_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.leuchtenbergring_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."

- id: notify_fabian_nessie_on_way_home_from_berufsschule
  alias: "Notify Fabian Nessie on way home from Berufsschule"
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.nessie
      from: "Berufsschule"
      to: "not_home"
  condition:
    - condition: time
      after: "13:15:00"
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: numeric_state
      entity_id: proximity.home_fabian
      below: 35
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.notify_fabian_nessie_on_way_home_from_berufsschule.attributes.last_triggered) | int > 3600 }}"
  action:
    - parallel:
        - choose:
            - conditions:
                - condition: state
                  entity_id: person.fabian
                  state: home
                - condition: state
                  entity_id:
                    - input_boolean.leiser_modus
                    - input_boolean.gast_modus
                  state: "off"
              sequence:
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.kuche_speaker
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.kuche_speaker
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.kuche_speaker
                          data_template:
                            message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:05
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.kuche_speaker
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.schlafzimmer_speaker
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.schlafzimmer_speaker
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.schlafzimmer_speaker
                          data_template:
                            message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:05
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.schlafzimmer_speaker
                - choose:
                    - conditions:
                        - condition: state
                          entity_id: media_player.wohnzimmer_uhr
                          state: "off"
                      sequence:
                        - service: media_player.volume_set
                          data_template:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) }}
                            entity_id: media_player.wohnzimmer_uhr
                        - delay: 00:00:02
                        - service: tts.google_say
                          entity_id: media_player.wohnzimmer_uhr
                          data_template:
                            message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."
                        - delay: 00:00:05
                        - service: media_player.volume_set
                          data:
                            volume_level: >
                              {{ ((states.input_number.lautstarke_ansagen.state) | float * 0.1) | round(1) | float - 0.2 }}
                            entity_id: media_player.wohnzimmer_uhr
    - service: notify.telegram_fabian
      data:
        message: "Nessie ist auf dem Weg nach Hause und kommt voraussichtlich um {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.arrival }} Uhr mit {{ states.sensor.donnersbergerbruecke_to_zorneding.attributes.delay }} min Verspätung in Zorneding an."

- id: telegram_send_daily_weather_forecast_fabian
  alias: "Telegram send daily weather forecast fabian"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.fabian_iphone_2
      from: "not_home"
      to: "home"
  condition:
    - condition: time
      before: "10:00:00"
    - condition: time
      after: "05:00:00"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_send_daily_weather_forecast_fabian.attributes.last_triggered) | int > 36000 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_fabian
        disable_notification: true
        message: >
          Wettervorhersage für heute
          {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['condition']}}
          *Momentan {{ states.weather.dwd_weather_ebersberg_1h.attributes.temperature }} °C*
          {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['templow']}} °C {{ '\u21F5' }} {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['temperature']}} °C

          Niederschlag: {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['precipitation']}} mm/h, Wahrscheinlichkeit: {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['precipitation_probability']}} %.
          Corona 7 Tage Inzidenzwert: {{ states.sensor.lk_ebersberg_weekincidence.state }} .

- id: telegram_send_daily_weather_forecast_nessie
  alias: "Telegram send daily weather forecast nessie"
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.nessie_iphone_2
      from: "not_home"
      to: "home"
  condition:
    - condition: time
      before: "10:00:00"
    - condition: time
      after: "05:00:00"
    - condition: template
      value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.telegram_send_daily_weather_forecast_nessie.attributes.last_triggered) | int > 10800 }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_nessie
        disable_notification: true
        message: >
          Wettervorhersage für heute
          {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['condition']}}
          *Momentan {{ states.weather.dwd_weather_ebersberg_1h.attributes.temperature }} °C*
          {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['templow']}} °C {{ '\u21F5' }} {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['temperature']}} °C

          Niederschlag: {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['precipitation']}} mm/h, Wahrscheinlichkeit: {{state_attr('weather.dwd_weather_ebersberg', 'forecast')[0]['precipitation_probability']}} %.
          Corona 7 Tage Inzidenzwert: {{ states.sensor.lk_ebersberg_weekincidence.state }} .

- id: remind_for_volleyball
  alias: "remind for volleyball"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - 172800) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - as_timestamp(now())) < 173800) and ((as_timestamp(states.calendar.volleyballtraining.attributes.start_time) - as_timestamp(now())) > 0) }}"
      - condition: template
        value_template: "{{ as_timestamp(now()) - as_timestamp(states.automation.remind_for_volleyball_on_warm_sundays.attributes.last_triggered) | int > 172800 }}"
  action:
    - service: shell_command.unpin_all_telegram
      data_template:
        telegram_bot_api: !secret telegram_bot_api
        chat_id: !secret telegram_volleyball
    - service: telegram_bot.send_poll
      data_template:
        target: !secret telegram_volleyball
        question: "Übermorgen ab {{ as_timestamp(states.calendar.volleyballtraining.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr findet {{ states.calendar.volleyballtraining.attributes.message }} statt. Ich komme?"
        options:
          - "Ja"
          - "Nein"
          - "Vielleicht"
          - "Nur zeitweise/verspätet"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true
    - choose:
        - conditions:
            - condition: template
              value_template: "{{not is_state_attr('calendar.volleyballtraining', 'description', '')}}"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_volleyball
                message: >
                  Zusatzinfos: {{ states.calendar.volleyballtraining.attributes.description }}

- id: remind_for_volleyball_on_warm_sundays
  alias: "Remind for Volleyball on warm Sundays"
  initial_state: true
  trigger:
    - platform: time
      at: "13:00:00"
  condition:
    condition: and
    conditions:
      - condition: time
        weekday:
          - fri
      - condition: or
        conditions:
          - condition: template
            value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[2]['condition'] == 'sunny' }}"
          - condition: template
            value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[2]['condition'] == 'partlycloudy' }}"
      - condition: template
        value_template: "{{state_attr('weather.dwd_weather_ebersberg', 'forecast')[2]['temperature'] | int >= 20 }}"
      - condition: template
        value_template: "{{ now().month <= 10 and now().month >= 4 }}"
  action:
    - service: shell_command.unpin_all_telegram
      data_template:
        telegram_bot_api: !secret telegram_bot_api
        chat_id: !secret telegram_volleyball
    - service: telegram_bot.send_poll
      data_template:
        target: !secret telegram_volleyball
        question: "Übermorgen ist das Wetter gut: {{ states.weather.dwd_weather_ebersberg.attributes.forecast[1].condition }} bei {{ states.weather.dwd_weather_ebersberg.attributes.forecast[1].temperature }} °. Ich komme zum Beachvolleyball ab {{ as_timestamp(states.calendar.volleyballtraining.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr?"
        options:
          - "Ja"
          - "Nein"
          - "Vielleicht"
          - "Nur zeitweise/verspätet"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true
    - choose:
        - conditions:
            - condition: template
              value_template: "{{not is_state_attr('calendar.volleyballtraining', 'description', '')}}"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_volleyball
                message: >
                  Zusatzinfos: {{ states.calendar.volleyballtraining.attributes.description }}

- id: remind_for_juz
  alias: "remind for juz"
  initial_state: true
  trigger:
    - platform: template
      value_template: "{{ as_timestamp(now()) | round(-1) == (as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) - 111600) | round(-1) }}"
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: "{{ ((as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) - as_timestamp(now())) < 112600) and ((as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) - as_timestamp(now())) > 0) }}"
  action:
    - service: telegram_bot.send_poll
      data_template:
        target: !secret telegram_chat_juz_group
        question: "Das JUZ hat morgen ab {{ as_timestamp(states.calendar.juz_zorneding_public.attributes.start_time) | timestamp_custom('%H:%M', true) }} Uhr für {{ states.calendar.juz_zorneding_public.attributes.message }} geöffnet. Wir freuen uns auf euren Besuch! Ich komme?"
        options:
          - "Ja"
          - "Nein"
          - "Vielleicht"
        is_anonymous: false
        allows_multiple_answers: false
        disable_notification: true
    - choose:
        - conditions:
            - condition: template
              value_template: "{{not is_state_attr('calendar.juz_zorneding_public', 'description', '')}}"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_juz_group
                message: >
                  Zusatzinfos: {{ states.calendar.juz_zorneding_public.attributes.description }}

- id: send_juz_mails_to_telegram
  alias: "send juz mails to telegram"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.juz_outlook
      attribute: data
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.juz_outlook
        above: "0"
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.juz_outlook
            state: unavailable
          - condition: state
            entity_id: sensor.juz_outlook
            attribute: data
            state: ""
          - condition: template
            value_template: "{{'noreply@ionos.de' in state_attr('sensor.juz_outlook', 'data')[0]['sender'] }}"
  action:
    - service: telegram_bot.send_message
      data_template:
        target: !secret telegram_chat_juz_mail
        message: >
          Neue Mail vom {{ as_timestamp(state_attr('sensor.juz_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

          Absender: {{state_attr('sensor.juz_outlook', 'data')[0]['sender']}}


          *Betreff:* {{state_attr('sensor.juz_outlook', 'data')[0]['subject']}}

          *Inhalt:* {{state_attr('sensor.juz_outlook', 'data')[0]['body'] | truncate(450)}}

- id: send_5freunde_mails_to_telegram
  alias: "send 5freunde mails to telegram"
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.5freunde_outlook
      attribute: data
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: sensor.5freunde_outlook
        above: "0"
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.5freunde_outlook
            state: unavailable
          - condition: state
            entity_id: sensor.5freunde_outlook
            attribute: data
            state: ""
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{'PayPal' in state_attr('sensor.5freunde_outlook', 'data')[0]['body'] }}"
                - condition: template
                  value_template: "{{'juzzorneding@gmail.com' in state_attr('sensor.5freunde_outlook', 'data')[0]['to'] }}"
          sequence:
            - service: telegram_bot.send_message
              data_template:
                target: !secret telegram_chat_juz_leiter
                message: >
                  Neue Mail vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

                  *Absender:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['sender']}}

                  *Empfänger:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['to'][0]}}


                  *Betreff:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['subject']}}

                  *Inhalt:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | truncate(400)}}
      default:
        - service: telegram_bot.send_message
          data_template:
            target: !secret telegram_chat_5friends
            message: >
              Neue Mail vom {{ as_timestamp(state_attr('sensor.5freunde_outlook', 'data')[0]['received']) | timestamp_custom("%d.%m.%Y %H:%M", true) }}:

              *Absender:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['sender']}}

              *Empfänger:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['to'][0]}}


              *Betreff:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['subject']}}

              *Inhalt:* {{state_attr('sensor.5freunde_outlook', 'data')[0]['body'] | truncate(400)}}
