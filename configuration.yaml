homeassistant:
  auth_providers:
    - type: homeassistant
    - type: trusted_networks
      trusted_networks:
        - 127.0.0.1
        - ::1
        - 192.168.1.0/24
        - 192.168.178.0/24
        - fd00::/8
      allow_bypass_login: true
    - type: legacy_api_password
      api_password: !secret http_password
  # Name of the location where Home Assistant is running
  name: Fabian's Smart Home
  #URLs
  external_url: !secret baseurl
  internal_url: "https://192.168.178.2:8123"
  # Location required to calculate the time the sun rises and sets
  latitude: !secret latitude
  longitude: !secret longitude
  # Impacts weather/sunrise data (altitude above sea level in meters)
  elevation: !secret elevation
  # metric for Metric, imperial for Imperialf
  #unit_system: metricbinary_sensor.snapshots_stale
  # Pick yours from here: http://en.wikipedia.org/wiki/List_of_tz_database_time_zones
  time_zone: Europe/Berlin
  # Customization file
  customize: !include customize.yaml
  #allowlist_external_dirs:
  #  - "/share/scripts"

zone:
  # This will override the default home zone
  - name: Home
    latitude: !secret latitude
    longitude: !secret longitude
    radius: 100
    icon: mdi:account-multiple

  - name: Arbeit Fabi
    latitude: !secret latitude_work
    longitude: !secret longitude_work
    radius: 250
    icon: mdi:school

  - name: Arbeit Fabi WHM
    latitude: !secret latitude_work_whm
    longitude: !secret longitude_work_whm
    radius: 250
    icon: mdi:school

  - name: Arbeit Fabi MUC
    latitude: !secret latitude_work_muc
    longitude: !secret longitude_work_muc
    radius: 250
    icon: mdi:school

  - name: Arbeit Fabi GIL
    latitude: !secret latitude_work_gil
    longitude: !secret longitude_work_gil
    radius: 250
    icon: mdi:school

  - name: Arbeit Nessie
    latitude: !secret latitude_work_nessie
    longitude: !secret longitude_work_nessie
    radius: 250
    icon: mdi:school

# Enables configuration UI
config:
system_health:
api:
mobile_app:

http:
  ssl_certificate: !secret ssl_certificate
  ssl_key: !secret ssl_key

recorder:
  purge_keep_days: 7
  exclude:
    domains:
      - automation
      - weblink
      - updater
      - scene
      - calendar
    entities:
      - sun.sun # Don't record sun data
      - sensor.last_boot # Comes from 'systemmonitor' sensor platform
      - sensor.date
      - sensor.fsphone_charging
      - sensor.vkphone_charging
      - sensor.fs_smspin
      - sensor.fs_caller
      - sensor.lichtschalter
      - sensor.deckenlampe
      - device_tracker.fabianpc
      - device_tracker.fabiantablet
      - device_tracker.nessiepc
      - device_tracker.tv

# Checks for available updates
updater:
  # Optional, allows Home Assistant developers to focus on popular components.
  include_used_components: true

# Discover some devices automatically
discovery:

# Enables support for tracking state changes over time
history:

# View all events in a logbook
logbook:

logger:
  default: warning
  logs:
    custom_components.localtuya: debug

# Enables a map showing the location of tracked devices
map:

# Track the sun
sun:

device_tracker:
  - platform: fritz
    host: 192.168.178.1
    password: !secret fritzbox
    interval_seconds: 8
    consider_home: 30
    new_device_defaults:
      track_new_devices: False
    #OpenWRT Router
  #- platform: luci
  #  host: 192.168.178.8
  #  username: root
  #  password: !secret fritzbox
  #  new_device_defaults:
  #    track_new_devices: False
  - platform: google_maps
    username: !secret gmaps_mail
    max_gps_accuracy: 1000
    new_device_defaults:
      track_new_devices: False

telegram_bot:
  - platform: polling
    api_key: !secret telegram_bot_api
    allowed_chat_ids:
      - !secret telegram_chat_fabian
      - !secret telegram_chat_nessie
      - !secret telegram_chat_adrian
      - !secret telegram_chat_kai
      - !secret telegram_chat_flo
      - !secret telegram_chat_maxi
      - !secret telegram_chat_fabio
      - !secret telegram_chat_yannick
      - !secret telegram_chat_lars
      - !secret telegram_chat_5friends
      - !secret telegram_chat_afk
      - !secret telegram_chat_jek_group
      - !secret telegram_chat_triemagisch

notify:
  - name: telegram_fabian
    platform: telegram
    chat_id: !secret telegram_chat_fabian
  - name: telegram_nessie
    platform: telegram
    chat_id: !secret telegram_chat_nessie
  - name: telegram_adrian
    platform: telegram
    chat_id: !secret telegram_chat_adrian
  - platform: html5
    name: browser
    vapid_pub_key: !secret vapid_pub_key
    vapid_prv_key: !secret vapid_prv_key
    vapid_email: !secret vapid_email

media_player:
  - platform: androidtv
    name: Wohnzimmer TV
    device_class: androidtv
    host: 192.168.178.11
    adb_server_ip: 127.0.0.1
    apps:
      com.liskovsoft.videomanager: "Smart YoutTube TV"
      exp.animo.fireanime: "FireAnime"
      com.amazon.amazonvideo.livingroom: "Amazon Prime Video"
      com.valvesoftware.steamlink: "Steam Link"
      com.zdf.android.mediathek: "ZDF Mediathek"
      tv.emby.embyatv: "Emby"
      com.google.android.apps.mediashell: "Chromecast"
      de.prosiebensat1digital.prosieben: "Pro7"
      com.tcl.tv: "HDMI"
    state_detection_rules:
      "com.google.android.tvlauncher":
        - "standby"
      "com.tcl.tv":
        - "standby"
      "com.netflix.ninja":
        - "playing":
            "media_session_state": 3
        - "paused":
            "media_session_state": 2
      "com.spotify.tv.android":
        - "playing":
            "media_session_state": 3
        - "paused":
            "media_session_state": 2
      "com.google.android.apps.mediashell":
        - "audio_state"
      "com.liskovsoft.videomanager":
        - "playing":
            "media_session_state": 3
  - platform: androidtv
    name: Keller TV
    device_class: androidtv
    host: 192.168.178.13
    adb_server_ip: 127.0.0.1
    apps:
      com.liskovsoft.videomanager: "Smart YoutTube TV"
      exp.animo.fireanime: "FireAnime"
      com.amazon.amazonvideo.livingroom: "Amazon Prime Video"
      com.valvesoftware.steamlink: "Steam Link"
      com.zdf.android.mediathek: "ZDF Mediathek"
      tv.emby.embyatv: "Emby"
      com.google.android.apps.mediashell: "Chromecast"
      de.prosiebensat1digital.prosieben: "Pro7"
      com.tcl.tv: "HDMI"
    state_detection_rules:
      "com.google.android.tvlauncher":
        - "standby"
      "com.tcl.tv":
        - "standby"
      "com.netflix.ninja":
        - "playing":
            "media_session_state": 3
        - "paused":
            "media_session_state": 2
      "com.spotify.tv.android":
        - "playing":
            "media_session_state": 3
        - "paused":
            "media_session_state": 2
      "com.google.android.apps.mediashell":
        - "audio_state"
      "com.liskovsoft.videomanager":
        - "playing":
            "media_session_state": 3
  - platform: mpd
    host: 127.0.0.1

#speedtestdotnet:
#  server_id: 21514

climate:
  - platform: generic_thermostat
    name: RPI Cooling Fan Controller
    heater: switch.rpi_cooling_fan
    target_sensor: sensor.processor_temperature
    min_temp: 55
    max_temp: 80
    ac_mode: true
    target_temp: 55
    cold_tolerance: 0.1
    hot_tolerance: 0.1
    min_cycle_duration:
      seconds: 30
    keep_alive:
      minutes: 5
    initial_hvac_mode: "cool"

tado:
  username: !secret defaultmail
  password: !secret githubpass

shell_command:
  #create_keys: 'ssh-keygen -b 2048 -t rsa -f my.key -q -N "" && cp ~/.ssh/id_rsa.pub id_rsa.pub'
  #ssh_command: /usr/bin/ssh -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -i /config/my.key test@192.168.1.3 'bash /home/admin/script.sh'
  randomfood: "curl https://smartlife.ddns.net/api/index.php?key=hassio&action=randomfood&input={{ telegram_sender }}&secinput={{ vegetarisch }}"
  foodyes: "curl https://smartlife.ddns.net/api/index.php?key=hassio&action=foodyes"
  jek_telegram: !secret telegram_jek_open_command
  restartha: "hassio.host_reboot"
  hibernatefpc: "curl http://192.168.178.59:5001/hibernate"
  hibernatenpc: "curl http://192.168.178.44:5001/hibernate"
  shutdownnpc: "curl http://192.168.178.44:5001/shutdown"
  #overtime_input: 'curl https://smartlife.ddns.net/api/index.php?key=hassio&action=overtime_input&input={{ hours_overtime }}'

rest_command:
  assistant_broadcast:
    url: http://192.168.178.2:3000/assistant
    method: POST
    content_type: "application/json"
    payload: '{"command":"{{ command }}", "user":"username", "broadcast":true}'

  assistant_converse:
    url: http://192.168.178.2:3000/assistant
    method: POST
    content_type: "application/json"
    payload: '{"command":"{{ command }}", "user":"username", "converse":true}'

  assistant_relay:
    url: http://192.168.178.2:3000/assistant
    method: POST
    content_type: "application/json"
    payload: '{"command":"{{ command }}", "user":"username"}'

#coinbase:
#  api_key: !secret coinbase_key
#  api_secret: !secret coinbase_secret
#  account_balance_currencies:
#    - BTC
#  exchange_rate_currencies:
#    - BTC

sensor:
  - platform: mqtt
    state_topic: "lichtschalter/stat/BUTTON1T"
    name: lichtschalter
    #qos: 1
    #expire_after: "1"  # Forget what just happen
  - platform: mqtt
    state_topic: "deckenlampe/stat/BUTTON1T"
    name: deckenlampe
  - platform: template
    sensors:
      washing_machine_state:
        value_template: "{{ states.input_select.washing_machine_status.state}}"
        friendly_name: "Waschmaschine Status"
      washing_machine_mode:
        value_template: >
          {% if (as_timestamp(now()) - as_timestamp(states.automation.telegram_washing_mashine_set_program_30_degrees_pflegeleicht.attributes.last_triggered) ) < 7200 %}
            30° Pflegeleicht
          {% elif (as_timestamp(now()) - as_timestamp(states.automation.telegram_washing_mashine_set_program_40_degrees_pflegeleicht.attributes.last_triggered) ) < 7200 %}
            40° Pflegeleicht
          {% else %}
            Unbekannt
          {% endif %}
        friendly_name: "Waschmaschinen Modus"
      washing_machine_finish_time:
        value_template: >
          {% if not (as_timestamp(now()) - as_timestamp(states.automation.set_washing_machine_clean_after_timeout.attributes.last_triggered) ) > 3600 %}
            0
          {% else %}
          {% if (as_timestamp(now()) - as_timestamp(states.automation.telegram_washing_mashine_set_program_30_degrees_pflegeleicht.attributes.last_triggered) ) < 7200 %}
            {{ (as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int + (9780) ) | timestamp_custom("%H:%M", false) }}
          {% elif (as_timestamp(now()) - as_timestamp(states.automation.telegram_washing_mashine_set_program_40_degrees_pflegeleicht.attributes.last_triggered) ) < 7200 %}
            {{ (as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int + (9780) ) | timestamp_custom("%H:%M", false) }}
          {% else %}
            0
          {% endif %}
          {% endif %}
        friendly_name: "Waschmaschine Uhrzeit ca. fertig"
        unit_of_measurement: "Uhr"
      washing_machine_finish_duration:
        value_template: >
          {% if (as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) + 9780 - as_timestamp(now()) > 0 ) %}
            {{ (as_timestamp(states.automation.detect_if_washing_machine_is_currently_active.attributes.last_triggered) | int + (9780) | int - as_timestamp(now()) ) | timestamp_custom("%H:%M", false) }}
          {% else %}
            0
          {% endif %}
        friendly_name: "Waschmaschine Dauer ca. fertig"
        unit_of_measurement: "Stunden"
  - platform: systemmonitor
    resources:
      - type: disk_use_percent
        arg: /
      - type: memory_use_percent
      - type: processor_temperature
  - platform: fritzbox_netmonitor
  #- platform: emby_upcoming_media
  #  api_key: YOUR_EMBY_API_KEY
  #  user_id: YOUR_EMBY_USER_ID
  #  host: !secret emby_host
  #  port: 8096
  #  ssl: True
  #  max: 5
  #  use_backdrop: true
  #  include:
  #    - Movies
  #    - TV Shows
  - platform: deutsche_bahn
    from: !secret fabian_work
    to: !secret sbahn_home
    only_direct: true
  - platform: deutsche_bahn
    from: !secret nessie_work
    to: !secret sbahn_home
    only_direct: true
  - platform: deutsche_bahn
    from: !secret sbahn_home
    to: !secret nessie_work
    only_direct: true
  - platform: deutsche_bahn
    from: Westkreuz
    to: !secret sbahn_home
    only_direct: true
  - platform: template
    sensors:
      fs_smspin:
        friendly_name: "Fabi SMS PIN"
        value_template: "not_set"
  - platform: template
    sensors:
      fs_caller:
        friendly_name: "Fabi Anrufer"
        value_template: "unbekannter"
  - platform: dwd_weather_warnings
    region_name: !secret dwd_cell_id

light:
  #MagicHue LEDs
  - platform: flux_led
    devices:
      192.168.178.250:
        name: LEDs Gästezimmer
      192.168.178.249:
        name: LEDs Tisch
        mode: rgb

no_ip:
  domain: !secret domain
  username: !secret noip_username
  password: !secret noip_pw

homekit:
  filter:
    exclude_domains:
      - automation
      - script
      - sensor
      - climate
      - binary_sensor
    exclude_entity_globs:
      - device_tracker.google_maps*
      - device_tracker.*iPhone*
      - device_tracker.*9_pro*
      - device_tracker.*tablet*
      - device_tracker.*iPad*
      - media_player.*_cast
      - switch.*_shutdown
      - sensor.*_open_window
      - switch.fritzbox_*
    exclude_entities:
      - binary_sensor.updater
      - device_tracker.flophone
      - device_tracker.maxiphone
      - device_tracker.fabianhackbook
      - input_boolean.silent_mode
      - media_player.mini_gruppe
      - climate.rpi_cooling_fan_controller
      - switch.rpi_cooling_fan
      - switch.adguard_protection
      - switch.adguard_filtering
      - switch.fritzbox_guest_wifi
      - switch.fritzbox_portforward_bitwarden
      - switch.fritzbox_portforward_bookstracks
      - switch.fritzbox_portforward_homeassistant
      - switch.fritzbox_portforward_http_server
      - switch.fritzbox_portforward_https_server
      - switch.fritzbox_portforward_ssh
      - switch.fritzbox_portforward_tasmoadmin
      - switch.fritzbox_wifi
      - switch.fritzbox_wifi_5ghz
      - media_player.mpd
      - switch.frei

mqtt:
  broker: core-mosquitto
  username: !secret mqttuser
  password: !secret mqttpass
  discovery: true

switch:
  - platform: rpi_gpio
    ports:
      4: RPI Cooling Fan
  - platform: command_line
    switches:
      fabian_pc_shutdown:
        command_off: "curl http://192.168.178.59:5001/shutdown"
  - platform: command_line
    switches:
      nessie_pc_shutdown:
        command_off: "curl http://192.168.178.44:5001/shutdown"
  #- platform: sonoff_lan_mode_r3
  #name: Bett
  #device_id: 100016e326
  #api_key: 1bed0f5f-3848-4ab3-9b89-fb43faade84b
  #icon: mdi:power-plug
  # - platform: sonoff_lan_mode_r3
  #   name: Waschmaschine
  #   device_id: 1000915e4d
  #   api_key: 11604ccd-1f58-47f2-acd1-816861348b1a
  #   icon: mdi:washing-machine
  # - platform: sonoff_lan_mode_r3
  #   name: Sonoff Steckdose
  #   device_id: 1000134649
  #   api_key: b7bbed8a-33b2-4260-ae2e-89a00fbd85c2
  #   icon: mdi:power-plug

google_assistant:
  project_id: !secret google_assistant_id
  service_account: !include Homeassistant SmartLife-f9d43c517637.json
  report_state: true
  #api_key: !secret google_assistant_api
  exposed_domains:
    - switch
    - light
  expose_by_default: true
  entity_config:
    #Disabled Entitys
    switch.schloss:
      expose: false
    switch.frei:
      expose: false
    switch.nessie_pc_shutdown:
      expose: false
    switch.fabian_pc_shutdown:
      expose: false
    light.keller_gluhbirne:
      expose: false
    switch.fritzbox_7530_guest_wifi:
      expose: false
    switch.fritzbox_7530_portforward_bitwarden:
      expose: false
    switch.fritzbox_7530_portforward_bookstracks:
      expose: false
    switch.fritzbox_7530_portforward_homeassistant:
      expose: false
    switch.fritzbox_7530_portforward_http_server:
      expose: false
    switch.fritzbox_7530_portforward_https_server:
      expose: false
    switch.fritzbox_7530_portforward_ssh:
      expose: false
    switch.fritzbox_7530_portforward_tasmoadmin:
      expose: false
    switch.fritzbox_7530_portforward_nginx_proxy:
      expose: false
    switch.fritzbox_7530_wifi:
      expose: false
    switch.fritzbox_7530_wifi_5ghz:
      expose: false
    switch.rpi_cooling_fan:
      expose: false
    climate.rpi_cooling_fan_controller:
      expose: false
    switch.adguard_protection:
      expose: false
    switch.adguard_filtering:
      expose: false
      name: Adblocker
    #Enabled Entitys
    ##Schlafzimmer
    switch.fabian_strom:
      name: Strom Schlafzimmer
      expose: true
      room: Schlafzimmer
    switch.bett:
      name: Bett Steckdose
      expose: true
      room: Schlafzimmer
    switch.regal_leds:
      expose: True
      room: Schlafzimmer
    switch.lichtschalter:
      name: Licht Schalter
      expose: True
      room: Schlafzimmer
    light.bett_gluhbirne:
      name: Bett Licht
      expose: true
      room: Schlafzimmer
    light.leds_tisch:
      expose: true
      room: Schlafzimmer
    light.yeelight_strip1_34ce008b1863:
      expose: true
      room: Schlafzimmer
    ##Gästezimmer
    light.lampe_gastezimmer:
      name: Nachtlampe
      expose: true
      room: Gästezimmer
    light.leds_gastezimmer:
      expose: true
      room: Gästezimmer
    switch.nessie_pc:
      expose: True
      room: Gästezimmer
    ##Wohnzimmer
    switch.deckenlampe:
      name: Deckenlampe Licht
      expose: true
      room: Wohnzimmer
    light.leds_wohnzimmer:
      expose: true
      room: Wohnzimmer
    light.yeelight_color1_34ce008bcc9d:
      expose: True
      room: Wohnzimmer
    switch.fernseher:
      name: Strom Fernseher
      expose: True
      room: Wohnzimmer
    switch.staubsauger:
      expose: True
      room: Wohnzimmer
    ##Keller & Bad
    switch.waschmaschine:
      expose: true
      room: Keller

google:
  client_id: !secret google_calendar_client_id
  client_secret: !secret google_calendar_client_secret
  track_new_calendar: false

# Text to speech
tts:
  - platform: google_translate
    service_name: google_say
    language: "de"
    base_url: !secret baseurl

input_select:
  washing_machine_status:
    name: Washing Machine Status
    options:
      - Idle
      - Running
      - Finishing
      - Clean
    initial: Idle

input_boolean: !include input_boolean.yaml
frontend:
  themes: !include_dir_merge_named themes
group: !include groups.yaml
automation: !include automations.yaml
script: !include scripts.yaml
